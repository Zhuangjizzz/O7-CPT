# 5.4 VOLTAGE COMPARATORS

After the op amp, the voltage comparator is probably the most popular high-gain amplifier. Its function is to compare two analog inputs $v_{P}$ and $v_{N}$ and yield a binaryvalued output such as

$$
\begin{array}{ll}
v_{O}=V_{O L} & \text { for } v_{P}<v_{N} \\
v_{O}=V_{O H} & \text { for } v_{P}>v_{N} \tag{5.43b}
\end{array}
$$

where $V_{O L}$ and $V_{O H}$ are prescribed logic levels such as the familiar TTL/CMOScompatible voltages $V_{O L}=0 \mathrm{~V}$ and $V_{O H}=5 \mathrm{~V}$. Aptly called a decision circuit, the comparator can also be viewed as a 1-bit analog-to-digital converter. Figure 5.20a shows the comparator's circuit symbol, whereas Fig. 5.20b shows the voltage transfer curve (VTC) implied by Eq. (5.43). As we know, the slope of a VTC represents gain, so the VTC of Fig. $5.20 b$ implies an amplifier having infinite gain and saturating at $V_{O L}$ and $V_{O H}$.

Infinite gain is physically impossible, so the VTC of a real-life comparator is more likely as in Fig. 5.20c, where we estimate voltage gain as

$$
\begin{equation*}
a \cong \frac{V_{O H}-V_{O L}}{V_{I H}-V_{I L}} \tag{5.44}
\end{equation*}
$$

with $V_{I L}$ and $V_{I H}$ representing the values of $v_{I}$ at which $a=1 \mathrm{~V} / \mathrm{V}$. Accordingly, Eq. (5.43) changes to

$$
\begin{array}{ll}
v_{O}=V_{O L} & \text { for } v_{P}<\left(v_{N}+V_{I L}\right) \\
v_{O}=V_{O H} & \text { for } v_{P}>\left(v_{N}+V_{I H}\right) \tag{5.45b}
\end{array}
$$

Moreover, we have

$$
\begin{equation*}
v_{O}=a\left(v_{P}-v_{N}\right) \quad \text { for }\left(v_{N}+V_{I L}\right)<v_{P}<\left(v_{N}+V_{I H}\right) \tag{5.45c}
\end{equation*}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-001.jpg?height=403&width=1190&top_left_y=1637&top_left_x=199)

FIGURE 5.20 (a) Circuit symbol for the voltage comparator. (b) Idealized VTC, and (c) real-life VTC.

It is apparent that the real-life VTC of Fig. 5.20c is only an approximation to the ideal VTC of Fig. 5.20b. However, the closer $V_{I L}$ and $V_{I H}$ are to each other, the higher the gain and the closer the VTC to ideal.

As a high-gain amplifier, the voltage comparator bears strong similarities to the op amp (in fact, we use the same circuit symbol for both). However, they differ in two important respects:

- Op amps are intended to operate with negative feedback, whereas comparators are not. In Chapter 7 we shall see that in order to stave off possible oscillation, an op amp is equipped with a frequency-compensation network which, in its simplest form, consists of a mere capacitance, such as $C_{c}$ in Figs. 5.1, 5.13 and 5.16. In Chapter 6 we shall see that $C_{c}$ slows down the dynamics of the op amp considerably. Comparators, on the other hand, do not need to be frequency compensated because voltage comparison does not involve negative feedback (in fact, a compensation capacitance would only slow down the comparator unnecessarily). Freed of compensation requirements, comparators operate at full speed (voltage-comparator dynamics are investigated in Chapter 6).
- The output saturation voltages of op amps are not digitally compatible (for instance, a 741 op amp powered from $\pm 15-\mathrm{V}$ supplies saturates at about $\pm 13 \mathrm{~V}$, a far cry from TTL/CMOS logic levels). Conversely, voltage-comparator output stages are designed with this type of compatibility in mind.

If speed and logic compatibility are not of concern, then an op amp can indeed be used as a voltage comparator. However, most comparator applications require specialized circuits that have been optimized for this specific operation. To get a feel, let us examine some typical bipolar and CMOS voltage-comparator realizations.

### The LM339 Voltage Comparator

This popular bipolar comparator, available in a quad package from most analog IC manufacturers, is depicted in simplified form in Fig. 5.21. We identify the following blocks:

- The 1 st or input stage consists of the EC pair $Q_{2}{ }^{-} Q_{3}$ and the active load $Q_{5}{ }^{-}$ $Q_{6} . Q_{2}$ and $Q_{3}$ are buffered by the voltage followers $Q_{1}$ and $Q_{4}$ to achieve very low input bias currents ( 25 nA according to the data sheets). Also, thanks to the additional $V_{E B}$ drop introduced by each buffer, the IVR extends all the way down to ground potential. (In fact, $v_{P}$ and $v_{N}$ can be driven few tenths of a volt below ground without causing malfunction.) The function of the diodes is to provide protection against excessive reverse bias as well as more rapid turn off for $Q_{2}$ and $Q_{3}$. Using half-circuit analysis we readily find the (loaded) gain of this stage as

$$
\begin{equation*}
a_{1}=\frac{v_{b 7}}{v_{p}-v_{n}}=\frac{r_{\pi 2}}{r_{e 1}+r_{\pi 2}} g_{m 3}\left(r_{o 3} / / r_{o 6} / / r_{\pi 7}\right) \cong g_{m 3} r_{\pi 7} \tag{5.46}
\end{equation*}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-003.jpg?height=802&width=1088&top_left_y=214&top_left_x=203)

FIGURE 5.21 Simplified circuit schematic of the LM339 voltage comparator.

- The 2nd or intermediate stage consists of the CE amplifier $Q_{7}$. Its function is to provide additional voltage gain, which we estimate as

$$
\begin{equation*}
a_{2}=-\frac{v_{b 8}}{v_{b 7}} \cong-g_{m 7} r_{\pi 8} \tag{5.47}
\end{equation*}
$$

- The 3rd or output stage consists of the so-called open collector CE transistor $Q_{8}$. The reason for leaving the collector uncommitted is so that the user can configure it externally for the desired logic levels at the output. The simplest form is to use a pull-up resistor $R_{P U}$, in which case the circuit yields $V_{O L}=V_{C E 8(\text { sat) }} \cong 0.2 \mathrm{~V}$ when $Q_{8}$ is driven in saturation, and $V_{O H}=V_{C C}$ when $Q_{8}$ is driven in cutoff. With $V_{C C}=5 \mathrm{~V}$ the circuit yields TTL/CMOS logic levels of about 0 V and 5 V . The gain of this stage is estimated as

$$
\begin{equation*}
a_{3}=-\frac{v_{o}}{v_{b 8}} \cong-g_{m 8} R_{P U} \tag{5.48}
\end{equation*}
$$

- The dc biasing circuit, shown in Fig. 5.22, consists of the multiple-output current mirror $Q_{9}$ through $Q_{12}$, along with the stabilized current reference $I_{R E F}$, which in turn is shared among all four comparators on the chip. The current $I_{R E F}$ is replicated by $Q_{10}$ to bias the $Q_{2}-Q_{3}$ pair, and by $Q_{11}$ to actively load $Q_{7}$. Moreover, $Q_{12}$ forms a Widlar current source synthesizing a $7-\mu \mathrm{A}$ current that subsequently divides between the two collectors to provide the $3.5-\mu \mathrm{A}$ bias currents for the $Q_{1}$ and $Q_{4}$ buffers.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-004.jpg?height=464&width=947&top_left_y=214&top_left_x=452)

FIGURE 5.22 The dc biasing circuitry of the 339 voltage comparator.

EXAMPLE 5.5 (a) Assuming $\beta_{p}=150, \beta_{n}=200, V_{C C}=5 \mathrm{~V}$, and $R_{P U}=2.4 \mathrm{k} \Omega$, estimate the 339 comparator's gain for $v_{O}$ half way between $V_{O H}$ and $V_{O L}$.
(b) Estimate the input bias current as well as the difference $V_{I H}-V_{I L}$.
(c) Check with PSpice and comment on your findings.

### Solution

(a) For $v_{O}=1 / 2\left(V_{O H}+V_{O L}\right)=1 / 2(5+0.2)=2.6 \mathrm{~V}$ we have $I_{C 8}=(5-2.6) / 2.4=$ 1 mA . Using Eqs. (5.46) through (5.48),

$$
\begin{aligned}
& a_{1} \cong \frac{0.05}{26} \beta_{7} \frac{26}{0.1}=\frac{\beta_{7}}{2}=100 \mathrm{~V} / \mathrm{V} \\
& a_{2} \cong-\frac{0.1}{26} \beta_{8} \frac{26}{1}=-\frac{\beta_{8}}{10}=-20 \mathrm{~V} / \mathrm{V} \\
& a_{3} \cong-\frac{R_{P U}}{26 \Omega}=-92.3 \mathrm{~V} / \mathrm{V}
\end{aligned}
$$

The overall gain is $a=a_{1} \times a_{2} \times a_{3}=100 \times 20 \times 92.3 \cong 185 \mathrm{~V} / \mathrm{mV}$.
(b) $I_{B}=I_{B 1}=I_{E 1} /\left(\beta_{1}+1\right)=\left(3.5 \mu \mathrm{~A}+I_{B 2}\right) /\left(\beta_{1}+1\right)=[3.5 \mu \mathrm{~A}+(50 \mu \mathrm{~A}) /$ $\left.\left(\beta_{2}+1\right)\right] /\left(\beta_{1}+1\right)=25.4 \mathrm{nA}$. By Eq. (5.44), $V_{I H}-V_{I L}=\left(V_{O H}-V_{O L}\right) / a=$ $(5-0.2) /\left(185 \times 10^{3}\right) \cong 26 \mu \mathrm{~V}$.
(c) The circuit of Fig. 5.23a utilizes a 339 macro-model to display the VTC (see Appendix 5A).
From Fig. $5.23 b$ we find $V_{I L} \cong 23 \mu \mathrm{~V}, V_{I H} \cong 52 \mu \mathrm{~V}, V_{O L} \cong 0.25 \mathrm{~V}$, and $V_{O H}=5 \mathrm{~V}$. By Eq. (5.44), the gain is $a \cong(5-0.25) /\left[(52-23) 10^{-6}\right] \cong 183 \mathrm{~V} / \mathrm{mV}$. We also observe that the simulated VTC is shifted toward the right by about $37 \mu \mathrm{~V}$. This represents the input offset voltage $V_{O S}$ of the 339 macro-model for the given value of $R_{P U}$. Due primarily to mismatches between the two halves of its input stage, an actual 339 is likely to exhibit a much higher $V_{\text {os }}$. You can easily search the Web for the LM339 data sheets, which list the following typical values at room temperature: $a=200 \mathrm{~V} / \mathrm{mV}, V_{O S}=2 \mathrm{mV}, I_{B}=25 \mathrm{nA}$, and $I_{O S}=5 \mathrm{nA}$. The above calculations indicate that $I_{B}$ strongly depends on $\beta_{p}, a_{1}$ on $\beta_{n}$, and $a_{2}$ on $R_{P U}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-005.jpg?height=416&width=515&top_left_y=318&top_left_x=240)
(a)
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-005.jpg?height=499&width=691&top_left_y=220&top_left_x=826)
(b)

FIGURE 5.23 (a) PSpice circuit to display (b) the VTC of the 339 voltage comparator.

### A CMOS Voltage Comparator

The circuit of Fig. 5.24 is the complementary version of the CMOS amplifier of Fig. 5.13, but without the compensation network $R_{c}-C_{c}$, which is unnecessary in voltage comparison. The circuit is also equipped with an output inverter to boost the gain as well as to provide a rail-to-rail output swing, or $V_{O L}=V_{S S}$ and $V_{O H}=V_{D D}$. If necessary, the channel widths $W_{9}$ and $W_{10}$ can be made suitably large to boost the output current-drive capabilities.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-005.jpg?height=661&width=968&top_left_y=1407&top_left_x=204)

FIGURE 5.24 CMOS voltage comparator.

### Comparators with Hysteresis

High gain and high speed, generally desirable in voltage comparators, may be counterproductive in the case of noisy inputs. To illustrate, consider the circuit of Fig. $5.25 a$, which uses a comparator to count the zero crossings of a slow varying signal $v_{I}$ afflicted by noise. This noise will cause the comparator to make multiple transitions when $v_{I}$ is in the vicinity of 0 V , thus leading to false counts. (You may find the amount of noise exaggerated, but keep in mind that with very high gain it may take only a few tens of micro-volts of noise to span the range from $V_{I L}$ to $V_{I H}$ and vice versa, so the rendition of the figure has been exaggerated only to facilitate its visualization.)

Also referred to as chatter, the unwanted output transitions can be eliminated if we incorporate hysteresis as depicted in Fig. 5.25b. Here, the comparator exhibits two VTCs, depending on the output state: when $v_{O}=V_{O L}$ the comparator trips when $v_{I}$ raises to $V_{T H}$, and when $v_{O}=V_{O H}$ it trips when $v_{I}$ drops to $V_{T L}$. If the voltage difference $V_{T H}-V_{T L}$, aptly called the hysteresis width, exceeds the maximum peak-topeak amplitude of the input noise, then chatter will be eliminated, as exemplified in Fig. 5.25b. Hysteresis is introduced via positive feedback, either externally by the user $^{7}$ or internally by the IC designer. Here we are interested in the latter.

Figure 5.26 shows a popular CMOS realization of the comparator-withhysteresis concept. Ignoring $M_{5}$ and $M_{6}$ for a moment, we observe that the $M_{4}-M_{7}$ mirror steers $i_{D 2}$ toward the output node $v_{0}$, whereas the $M_{3}-M_{8}$ and $M_{9}-M_{10}$ mirrors steer $i_{D 1}$ away from node $v_{O}$. Consequently, the circuit acts as a differential amplifier with small-signal gain $a=v_{o} /\left(v_{p}-v_{n}\right)=g_{m 1}\left(r_{o 7} / / r_{o 10}\right)$ and a VTC of the type of Fig. 5.20c (see also Fig. 4.66).
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-006.jpg?height=792&width=1506&top_left_y=1295&top_left_x=135)

FIGURE 5.25 Illustrating (a) comparator chatter, and (b) its elimination via hysteresis.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-007.jpg?height=657&width=1114&top_left_y=207&top_left_x=185)

FIGURE 5.26 CMOS comparator with hysteresis.

Consider now the effect of having $M_{5}$ and $M_{6}$ present. Viewed as two cross-coupled inverters, these transistors introduce a flip-flop action that keeps the loads seen by $M_{1}$ and $M_{2}$ unbalanced. It is precisely this imbalance that causes hysteresis. To see how, refer to the reduced renditions of Fig. 5.27, where the cross-coupled FETs $M_{5}$ and $M_{6}$ are assumed to have $W / L$ ratios that are $m(m>1)$ times as large as those of the diode-connected FETs $M_{3}$ and $M_{4}$. We make the following observations:

- For $v_{I}$ sufficiently negative as in Fig. 5.27a, $M_{1}$ is off, so $M_{3}$ and $M_{5}$ are also off. All of $I_{S S}$ flows though $M_{2}$, causing $v_{O 2}$ to be low. This forces $M_{5}$ in the ohmic region, thus pulling $v_{O 1}$ to $V_{D D}$. With $v_{S G 6}=0, M_{6}$ is also off, resulting in $i_{D 4}=i_{D 2}=I_{S S}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-007.jpg?height=611&width=1384&top_left_y=1472&top_left_x=191)

FIGURE 5.27 The central part of the circuit of Fig. 5.26 for the cases (a) $v_{l} \ll 0$ and (b) $v_{l} \gg 0$.

- Raising $v_{I}$ will gradually turn on $M_{1}$ at the expense of $M_{2}$ becoming less conductive. Since $M_{1}$ sees the (small) ohmic resistance of $M_{5}$ as load, $v_{O 1}$ will drop some.
- For $v_{I}=0, I_{S S}$ splits equally between $M_{1}$ and $M_{2}$. However, since $k_{5}=m k_{4}$, $m>1$, it follows that $v_{O 1}$ is higher than $v_{O 2}$. In other words, the circuit is unbalanced because $M_{5}$ is still in the triode region whereas $M_{4}$ is saturated.
- To make the circuit trip we need to raise $v_{I}$ to the value $V_{I H}\left(V_{I H}>0\right)$ that will pull $M_{5}$ out of the triode region and into saturation. This value is found via KVL and the familiar FET formula as

$$
\begin{aligned}
V_{I H} & =V_{G S 1}-V_{G S 2}=V_{O V 1}-V_{O V 2} \cong \sqrt{2 I_{D 1} / k_{1}}-\sqrt{2 I_{D 2} / k_{2}} \\
& =\sqrt{2 / k_{1}}\left(\sqrt{I_{D 1}}-\sqrt{I_{D 2}}\right)
\end{aligned}
$$

(For simplicity all FETs are assumed to have $\lambda=0$.) Substituting $I_{D 1}=I_{D 5}=$ $m I_{D 4}=m I_{D 2}$, along with $I_{D 1}+I_{D 2}=I_{S S}$, we finally get, after suitable manipulation,

$$
\begin{equation*}
V_{I H} \cong \sqrt{\frac{2 I_{S S}}{(m+1) k_{1}}}(\sqrt{m}-1) \tag{5.49}
\end{equation*}
$$

- For $v_{I}$ sufficiently positive as in Fig. $5.27 b$ the roles of the various FET pairs are interchanged, so we exploit the symmetry of the circuit to state that in order to make it trip in the opposite direction we now need to lower $v_{I}$ to the value $V_{I L}\left(V_{I L}<0\right)$ such that

$$
\begin{equation*}
V_{I L}=-V_{I H} \tag{5.50}
\end{equation*}
$$

EXAMPLE 5.6 (a) Assuming $k_{n}^{\prime}=2.5 k_{p}^{\prime}=100 \mu \mathrm{~A} / \mathrm{V}^{2}$ and $L=1 \mu \mathrm{~m}$ for all FETs in the circuits of Fig. 5.27, estimate $V_{I H}$ and $V_{I L}$ if $I_{S S}=25 \mu \mathrm{~A}$ and all FETs have $W=10 \mu \mathrm{~m}$, except for $M_{3}$ and $M_{4}$, which have $W_{3}=W_{4}=6 \mu \mathrm{~m}$. What are the values of $I_{D 1}$ and $I_{D 2}$ for $v_{I}=V_{I H}$ ? For $v_{I}=V_{I L}$ ?
(b) Verify the circuits of Fig. 5.27 via PSpice. Assume $\pm 2.5-\mathrm{V}$ power supplies, along with $V_{t n}=-V_{t p}=0.75 \mathrm{~V}$ and $\lambda_{n}^{\prime}=\lambda_{p}^{\prime}=0.05 \mu \mathrm{~m} / \mathrm{V}$. Compare with the calculated values, and comment.

### Solution

(a) Applying Eqs. (5.49) and (5.50) with $m=10 / 6$ we get

$$
V_{I H} \cong \sqrt{\frac{2 \times 25}{(10 / 6+1)(10 / 1) 100}}(\sqrt{10 / 6}-1) \cong 40 \mathrm{mV}=-V_{I L}
$$

Imposing $I_{D 1}=(10 / 6) I_{D 2}$ and $I_{D 1}+I_{D 2}=25 \mu \mathrm{~A}$ we readily get, for $v_{I}=$ $V_{I H}, I_{D 1} \cong 15.6 \mu \mathrm{~A}$ and $I_{D 2} \cong 9.4 \mu \mathrm{~A}$. For $v_{I}=V_{I L}$ the roles are reversed, so $I_{D 1} \cong 9.4 \mu \mathrm{~A}$ and $I_{D 2} \cong 15.6 \mu \mathrm{~A}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-009.jpg?height=609&width=783&top_left_y=217&top_left_x=196)

FIGURE 5.28 PSpice circuit to investigate the hysteresis of the comparator of Example 5.6.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-009.jpg?height=586&width=1497&top_left_y=989&top_left_x=233)

FIGURE 5.29 Transfer characteristics of the comparator of Fig. 5.28: (a) hysteresis and (b) detail.
(b) Using the PSpice circuit of Fig. 5.28 we readily obtain the plots of Fig. 5.29, from which we find $V_{I H}=-V_{I L}=35.7 \mathrm{mV}$. This value differs from 40 mV because our hand calculations are based on $\lambda=0$. Figure $5.29 b$ provides an expanded view of the snapping action taking place as $v_{I}$ is raised to $V_{I H}$. Once $M_{1}$ pulls $M_{5}$ out of the triode region, $v_{O 1}$ drops more rapidly until $M_{6}$ turns on. At this point $M_{6}$ pulls $v_{O 2}$ toward $V_{D D}$ as fast as it can. This, in turn, shuts off $M_{5}$, causing a final and more rapid drop in $v_{O I}$. It is apparent that because of the flip-flop action provided by $M_{5}$ and $M_{6}, v_{O 1}$ and $v_{O 2}$ coexist only in complementary form (one is high whereas the other is low, and vice versa).

### Solution

(a) Assuming $V_{B E}=0.7 \mathrm{~V}$, use Ohm's law to calculate $R=(5-0.7) / 0.25=$ $17.2 \mathrm{k} \Omega$.
(b) With $V_{C C}=6 \mathrm{~V}$ we get $I_{R E F}=I_{B I A S} \cong(6-0.7) / 17.2=0.308 \mathrm{~mA}$, indicating a percentage increase of $100(0.308-0.25) / 0.25 \cong 23 \%$, quite a change!
(a) Let the FETs of Fig. $5.30 b$ have $V_{t}=0.75 \mathrm{~V}$ and $k^{\prime}=125 \mu \mathrm{~A} / \mathrm{V}^{2}$. Assuming $V_{D D}=5 \mathrm{~V}$, specify $R$ and $W / L$ so that both FETS draw $100 \mu \mathrm{~A}$ with $V_{O V}=0.25 \mathrm{~V}$.
(b) Estimate the percentage change in $I_{R E F}$ if $V_{D D}$ is raised from 5 V to 6 V .
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-011.jpg?height=525&width=1225&top_left_y=207&top_left_x=181)

FIGURE 5.30 Power-supply-based current references: (a) bipolar, and (b) MOS. (c) All MOS version.

### Solution

(a) Since $V_{G S}=0.75+0.25=1 \mathrm{~V}$, Ohm's law gives $R=(5-1) / 0.1=40 \mathrm{k} \Omega$. Moreover, imposing $0.1=(0.125 / 2) \times(W / L) \times 0.25^{2}$ gives $W / L=25.6$.
(b) From part (a) we have $k=k^{\prime}(W / L)=0.125 \times 25.6=3.2 \mathrm{~mA} / \mathrm{V}^{2}$. Imposing

$$
I_{B I A S}=\frac{6-0.75-\sqrt{2 I_{B I A S} /\left(3.2 \times 10^{-3}\right)}}{40 \times 10^{3}}
$$

and solving by iteration gives $I_{R E F}=I_{B I A S} \cong 124 \mu \mathrm{~A}$, indicating a $24 \%$ increase, quite a change!

The above examples indicate a fairly strong dependence of $I_{R E F}$ upon the supply voltage. As an example, the biasing scheme of the 741 op amp of Fig. 5.4 gives, for $\pm 15-\mathrm{V}$ supplies, $I_{R E F}=(30-1.4) / 39=733 \mu \mathrm{~A}$. However, should the user opt for a pair of $\pm 9-\mathrm{V}$ supply batteries, $I_{R E F}$ would drop to $(18-1.4) / 39=426 \mu \mathrm{~A}$, causing appreciable changes in most small-signal parameters. In the following we shall explore ways to reduce the dependence of $I_{R E F}$ on the power supply.

### Solution

(a) We have $V_{B E}=0.026 \ln \left(125 \times 10^{-6} / 10^{-15}\right)=0.664 \mathrm{~V}$ so $R=0.664 / 0.25=$ $2.66 \mathrm{k} \Omega$. By the $18-\mathrm{mV}$ rule of thumb, $V_{B E 2}=V_{B E}+18 \mathrm{mV}=0.682 \mathrm{~V}$. So, $R_{B I A S}=(5-0.682-0.664] /(0.25 / 2)=29.2 \mathrm{k} \Omega$. With $V_{C C}=6 \mathrm{~V}$ we get $\left.I_{B A S} \cong[6-2 \times 0.67)\right] / 29.2=159 \mu \mathrm{~A}, V_{B E}=0.026 \ln \left(159 \times 10^{-6} / 10^{-15}\right)=$ 0.670 V , and $I_{R E F}=0.670 / 2.66=252.5 \mu \mathrm{~A}$. This represents an increase in $I_{R E F}$ of $100(252.5-250) / 250 \cong 1 \%$, quite an improvement over the $23 \%$ increase of Example 5.7!
(b) From Example 5.8 we have $V_{G S}=0.75+0.25=1 \mathrm{~V}$, so $R=1 / 0.1=10 \mathrm{k} \Omega$ and $\left.R_{B I A S}=[5-1-1)\right] /(0.1)=30 \mathrm{k} \Omega$. As we raise $V_{D D}$ from 5 V to 6 V we expect the change in $V_{G S 2}$ to be negligible compared to the change in $V_{D D}$, so we write $I_{B A A S} \cong\left[6-0.75-\left(2 I_{B A A S} / 3.2\right)^{1 / 2}-1\right] / 30$. Solving by iterations gives $I_{B I A S}=0.132 \mathrm{~mA}$. Consequently, $V_{G S}=0.75+(2 \times 0.132 / 3.2)^{1 / 2}=$ 1.037 V and $I_{R E F}=1.037 / 10=103.7 \mu \mathrm{~A}$, indicating a $3.7 \%$ increase in $I_{R E F}$, an appreciable improvement over $24 \%$ of Example 5.8!

### EXAMPLE 5.10

(a) Assuming $m_{p}=2$ in the circuit of Fig. 5.32a, specify $m_{n}$ and $R$ for the roomtemperature values $\Delta V_{B E}=75 \mathrm{mV}$ and $I_{R E F}=0.25 \mathrm{~mA}$.
(b) Assuming $m_{p}=1$ and $k_{1}=1.25 \mathrm{~mA} / \mathrm{V}^{2}$ in the circuit of Fig. $5.32 b$, specify $m_{n}$ and $R$ for $\Delta V_{G S}=0.3 \mathrm{~V}$ and $I_{R E F}=0.1 \mathrm{~mA}$.

### Solution

(a) Use Eq. (5.53) to impose $75=26 \ln \left(2 m_{n}\right)$. This gives $m_{n} \cong 9$. Moreover, $R=75 / 0.25=300 \Omega$.
(b) Use Eq. (5.55) to impose $0.3=\sqrt{2 \times 0.1 / 1.25}\left(1-1 / \sqrt{m_{n}}\right)$. Then, $m_{n}=16$ and $R=0.3 / 0.1=3 \mathrm{k} \Omega$.

Equations (5.54) and (5.56) imply a supply-independent $I_{R E F}$. In practice, because of base-width modulation in the BJTs and channel-length modulation in the FETs, $I_{\text {REF }}$ will depend on the supply voltage somewhat. To get an idea, refer to the small-signal equivalent of Fig. 5.33, and use the test method to find the change $i$
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-015.jpg?height=447&width=743&top_left_y=183&top_left_x=204)

FIGURE 5.33 Small-signal model to find the power-supply dependence of a mismatch-based reference current.
experienced by $I_{R E F}$ due to a change $v$ in the power supply. Here, the diode-connected transistors $Q_{1} / M_{1}$ and $Q_{4} / M_{4}$ are modeled by their (small) ac resistances $r_{1} \cong 1 / g_{m 1}$ and $r_{4} \cong 1 / g_{m 4}$, the mirror transistor $Q_{3} / M_{3}$ is modeled by a dependent source $m_{p} i$ with parallel resistance $r_{03}$, and the degeneration resistance $R$ has been absorbed into the model for transistor $Q_{2} / M_{2}$ by letting

$$
G_{m 2} \cong g_{m 2} /\left(1+g_{m 2} R\right) \quad R_{o 2} \cong r_{o 2}\left(1+g_{m 2} R\right)
$$

(for simplicity we are ignoring $M_{2}$ 's body effect). Using nodal analysis along with KVL we get

$$
\frac{v-v_{1}}{r_{o 3}}+m_{p} i=\frac{v_{1}}{r_{1}} \quad i=G_{m 2} v_{1}+\frac{v-r_{4} i}{R_{o 2}}
$$

Typically $r_{o 3} \gg r_{1}$ and $r_{4} / R_{o 2} \ll 1$, so the above expressions simplify as

$$
\frac{v}{r_{o 3}}+m_{p} i \cong \frac{v_{1}}{r_{1}} \cong g_{m 1} v_{1} \quad i \cong G_{m 2} v_{1}+\frac{v}{R_{o 2}}
$$

Eliminating $v_{1}$, collecting, and simplifying, we get

$$
\begin{equation*}
\frac{i}{v}=\frac{1+\left(g_{m 2} / g_{m 1}\right) \times\left(r_{o 2} / r_{o 3}\right)}{R_{o 2}\left(1-m_{p} G_{m 2} / g_{m 1}\right)} \tag{5.57}
\end{equation*}
$$

It is apparent that the larger $R_{o 2}$ the less dependent the current from the supply voltage. If desired, we can reduce this dependence further by cascoding $Q_{2}$ and $M_{2}$.

### Exercise 5.2

Derive Eq. (5.57). Hence, show that in the bipolar case Eq. (5.57) can be expressed as

$$
\frac{i}{v}=\frac{\left(1+V_{A n} / V_{A p}\right) \times\left[1+1 /\left(g_{m 2} R\right)\right]}{R_{o 2}}
$$

where $V_{A n}$ and $V_{A p}$ are the Early voltages of the $n p n$ and the $p n p$ BJTs, respectively.
(a) If all BJTs of Example 5.10a have $V_{A}=50 \mathrm{~V}$, estimate the percentage change in $I_{R E F}$ brought about by a 1-V change in $V_{C C}$.
(b) If all FETs of Example $5.10 b$ have $\lambda=1 /(20 \mathrm{~V})$, estimate the percentage change in $I_{R E F}$ brought about by a 1-V change in $V_{D D}$.

### Solution

(a) We have $g_{m 2}=I_{R E F} / V_{T}=0.25 / 26=1 /(104 \Omega), r_{o 2}=V_{A} / I_{R E F}=50 / 0.25=$ $200 \mathrm{k} \Omega$, and $R_{o 2}=200(1+300 / 104)=777 \mathrm{k} \Omega$. Using the expression of Exercise 5.2,

$$
\frac{i}{v}=\frac{(1+50 / 50) \times[1+1 /(300 / 104)]}{777}=\frac{1}{288 \mathrm{k} \Omega}
$$

Letting $\Delta I_{R E F}=(1 \mathrm{~V}) /(288 \mathrm{k} \Omega)=3.47 \mu \mathrm{~A}$ indicates a per-volt change of $100(3.47 / 250) \cong 1.4 \%$.
(b) We have $g_{m 1}=(2 \times 1.25 \times 0.1)^{1 / 2}=0.5 \mathrm{~mA} / \mathrm{V}, g_{m 2}=(2 \times 16 \times 1.25 \times$ $0.1)^{1 / 2}=2 \mathrm{~mA} / \mathrm{V}=4 g_{m 1}, r_{o 2}=r_{o 3}=20 / 0.1=200 \mathrm{k} \Omega, G_{m 2}=2 /(1+2 \times 3)=$ $1 /(3.5 \mathrm{k} \Omega)$, and $R_{o 2}=200(1+2 \times 3)=1.4 \mathrm{M} \Omega$. By Eq. (5.57),

$$
\frac{i}{v}=\frac{1+(4) \times(1)}{1400[1-1 \times(1 / 3.5) / 0.5)]}=\frac{1}{120 \mathrm{k} \Omega}
$$

Letting $\Delta I_{R E F}=(1 \mathrm{~V}) /(120 \mathrm{k} \Omega)=8.3 \mu \mathrm{~A}$ indicates a per-volt change of $8.3 \%$.

### Startup Circuits

The circuits of Fig. 5.32 are said to be self-biased or bootstrapped because each mirror biases and is in turn biased by the other. In particular, if one of the mirrors fails to turn on, so will the other and the circuit will remain in this unwanted state indefinitely. We therefore need a mechanism that, once the circuit receives power, will turn on at least one of the mirrors, forcing the circuit to evolve toward the desired state and remain there. Aptly referred to as startup circuit, in its simplest form it consists of a large resistance $R_{\text {startup }}$ to inject a small startup current into one of the mirrors. This is shown in Fig. 5.34a for the bipolar case. (It goes without saying that such a current must be much smaller than $I_{R E F}$ in order to avoid introducing an intolerable error.)

A more elegant approach is a startup circuit that intervenes only when the reference is in the unwanted state, but goes dormant once the reference has reached the desired state. In the CMOS example of Fig. $5.34 b$ the diode-connected transistors $M_{7}$ and $M_{8}$ form a voltage divider to provide a suitable gate bias for $M_{9}$. Should $M_{1}$ be off, $V_{G S 9}$ is designed to be high enough to turn on $M_{9}$ and thus force both mirrors out of the cutoff state. Once $M_{1}$ turns fully on, $V_{G S 9}$ is designed to drop below $V_{t 9}$ so as to turn $M_{9}$ off, leaving the rest of the circuit undisturbed.

Since the current $I_{R E F}$ is used internally, provision must be made for its replication to the outside. In Fig. 5.34 this function is provided by $Q_{5} / M_{5}$ when the stabilized current is to be sourced to an external load, and by $Q_{6} / M_{6}$ when it is to be sunk from an external load.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-017.jpg?height=771&width=1436&top_left_y=204&top_left_x=198)

FIGURE 5.34 Mismatch-based current references with start-up circuit examples: (a) bipolar and (b) CMOS.

A final caveat is in order, namely, the circuits of Fig. 5.34 incorporate positive feedback, a situa-tion that may lead to instability if the loop gain exceeds unity (more on this in Chapter 7). With reference to Fig. 5.33 we observe that the current $i$ is first amplified to $m_{p} i$ by $Q_{3}$, then it is converted to $v_{1} \cong r_{1} m_{p} i \cong m_{p} i / g_{m 1}$ by $Q_{1}$, and finally it is returned by $Q_{2}$ as $G_{m 2} v_{1} \cong\left(m_{p} G_{m 2} / g_{m 1}\right) i$, so the overall amplification experienced by $i$ around the loop, aptly called the loop gain $T$, is $T=m_{p} G_{m 2} / g_{m 1}$. To avert instability we must ensure that $T<1$ (indeed, Example $5.11 a$ has $T=0.257 \mathrm{~A} / \mathrm{A}$, and Example $5.11 b$ has $T=0.571 \mathrm{~A} / \mathrm{A}$.)

### Solution

We have $\Delta V_{B E}=V_{T} \ln \left(m_{p} \times m_{n}\right)=26 \ln (1 \times 8)=54 \mathrm{mV}, R_{1}=\Delta V_{B E} / I_{E 2} \cong$ $54 / 0.1=0.54 \mathrm{k} \Omega$, and $R=1 / 0.1=10 \mathrm{k} \Omega$. We also have $V_{B E 1}=V_{T} \ln \left[\left(0.1 \times 10^{-3}\right) /\right.$ $\left.\left(2 \times 10^{-15}\right)\right]=640.5 \mathrm{mV}$. Use Eq. (5.60) to impose

$$
(1+1) \frac{R_{2}}{0.54} \ln (1 \times 8)=\frac{1,205-640.5}{26}+4-1.5
$$

and get $R_{2}=3.14 \mathrm{k} \Omega$. By Eq. (5.61) we have $V_{B G}=1.205+(4-1.5) 0.026=$ 1.27 V . Finally, use Eq. (5.62) to impose $5.0=\left(1+R_{3} / R_{4}\right) 1.27$ and get $R_{3} / R_{4}=$ 2.94. Use $R_{4}=10 \mathrm{k} \Omega$ and $R_{3}=29.4 \mathrm{k} \Omega$.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-020.jpg?height=351&width=692&top_left_y=207&top_left_x=450)

FIGURE 5.36 Thermal variation of a bandgap reference.

One last observation is in order. Equation (5.60) provides the value of $K$ necessary to achieve $\mathrm{TC}\left(V_{B G}\right)=0$ at a specific temperature $T_{0}$, typically ambient temperature. Since $K$ depends on $V_{B E 1}$ and $V_{T}$, themselves functions of temperature, $\operatorname{TC}\left(V_{B G}\right)$ will depart from zero at temperatures other than $T_{0}$. As depicted in Fig. 5.36, the plot of $V_{B G}$ as a function of $T$ exhibits a curvature ${ }^{1}$ typical of this class of references. (The student is encouraged to look up the literature ${ }^{1-3}$ for clever curvature-correction techniques designed to compensate for this higher-order effect.)

### Solution

We have $\Delta V_{E B}=26 \ln (10 \times 1)=59.9 \mathrm{mV}, R_{1}=\Delta V_{E B} / I_{E 2}=\Delta V_{E B} /\left(I_{E 1} / 10\right)=$ $\left(59.9 \times 10^{-3}\right) /\left(10 \times 10^{-6}\right)=5.99 \mathrm{k} \Omega$, and $V_{E B 1}=V_{T} \times \ln \left[\left(100 \times 10^{-6}\right) / 10^{-15}\right]=$ 658.5 mV . The calculation of $K$ yields

$$
(10+1) \frac{R_{2}}{5.99} \ln (10 \times 1)=\frac{1,205-658.5}{26}+4-1.5
$$

This gives $R_{2}=5.56 \mathrm{k} \Omega$ and $m_{p} R_{2}=55.6 \mathrm{k} \Omega$.

## 5.6 CURRENT-MODE INTEGRATED CIRCUITS

The voltages and currents in a linear circuit are mathematically equivalent because the laws governing voltages admit counterpart laws governing currents, and vice versa (familiar examples of this equivalence, known as duality, are Kirchhoff's voltage/ current laws, the node/loop methods, and the Thévenin/Norton theorems). However, transistors, the basic ingredients of today's electronics, are nonlinear devices that process voltage and current differently. Specifically, the exponential characteristics of BJTs and the quadratic characteristics of FETs indicate inherently wider dynamic ranges for currents than for voltages: for instance, a 10 -to-1 ( 20 dB ) change in the overdrive voltage of a FET results a $100-$ to-1 $(40 \mathrm{~dB})$ change in the channel current. It also turns out that the manipulation of currents in a physical circuit is inherently faster than the manipulation of voltages: this is so because stray inductances, which
oppose rapid changes in mesh currents, are of far lesser consequence than stray capacitances, which oppose rapid changes in node voltages (these aspects will be investigated in great detail in Chapter 6). These advantages in both range and speed provide a strong motivation for current-mode circuits, that is, circuits emphasizing the manipulation of currents over voltages. (Interestingly, the engineering community has traditionally favored the voltage viewpoint, as signified by the fact that voltage-mode circuits have reached commercial maturity and popularity well ahead of current-mode circuits, a classic example being the op amp, a voltage-in/voltage-out block. The development of current-mode analog ICs has been delayed also by technological reasons, such as the ability to fabricate monolithic pnp BJTs of comparable quality to their $n p n$ counterparts.) In this section we investigate current-mode circuits such as transconductors, current conveyors (CCs), operational transconductance amplifiers (OTAs), current feedback amplifiers (CFAs), and Gilbert Cells.

### Transconductors

A transconductor is a voltage-in/current-out circuit. To prevent loading, a transconductor should exhibit sufficiently high (ideally infinite) resistances both at the input and at the output terminals. The simplest transconductor is the transistor itself. However, transistors operate over only one quadrant of their $i_{C}-v_{B E}$ or $i_{D}-v_{G S}$ characteristics. To cope with this drawback, we bias the transistor at a specified operating point in the active region, and we then achieve four-quadrant operation by effecting variations, both positive and negative, about this point. But we need to keep these variations suitably small in order to ensure approximately linear circuit operation, this being the basis of small-signal models.

We can achieve much more versatility and flexibility if we manage to (a) establish the operating point right at the origin of the $i-v$ characteristic, and (b) lift the small-signal constraint altogether. A circuit meeting meets both demands is shown in Fig. 5.38 (though the version shown is bipolar, a CMOS version is readily obtained by replacing each BJT with a MOSFET of the corresponding type). We make the following observations:

- In order to handle emitter currents of either polarity, the class AB pair $Q_{1}-Q_{2}$ is used, with $Q_{1}$ sourcing current to and $Q_{2}$ sinking current from the circuitry external to node $E$ (this is similar to the push-pull output stages of Chapter 4).
- The emitter followers $Q_{3}-Q_{4}$ generate the pair of junction voltage drops needed to bias the $Q_{1}-Q_{2}$ pair for class AB operation. They also provide a Darlington function to raise the input resistance as well as lower the input bias current of node $B$. It is apparent that $Q_{1}$ through $Q_{4}$ form a voltage buffer with approximately unity gain, as depicted in the simplified equivalent circuit at the right. Assuming matched voltage drops $V_{E B 3}=V_{B E 1}$ and $V_{B E 4}=V_{E B 2}$, we thus have

$$
\begin{equation*}
v_{E}=v_{B} \tag{5.63}
\end{equation*}
$$

- The Wilson current mirrors $Q_{5}-Q_{6}-Q_{7}$ and $Q_{10}-Q_{9}-Q_{8}$ replicate the collector currents of $Q_{1}$ and $Q_{2}$, respectively, and convey them to the output node $C$, where they are subtracted from each other to give the output current $i_{C}=i_{7}-i_{8}=i_{1}-i_{2}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-023.jpg?height=973&width=1329&top_left_y=211&top_left_x=204)

FIGURE 5.38 Bipolar transcoductor, simplified circuit representation, and circuit symbol used sometimes.

But, applying KCL at the voltage-buffer supernode we have, assuming negligible base currents, $i_{1}=i_{2}+i_{E}$, or $i_{1}-i_{2}=i_{E}$. Eliminating the difference $i_{1}-i_{2}$ gives

$$
\begin{equation*}
i_{C}=i_{E} \tag{5.64}
\end{equation*}
$$

Finally, the output resistance at node $C$ is the parallel combination of the Wilsonmirror resistances $R_{c 7} \cong\left(\beta_{o 7} / 2\right) r_{o 7}$ and $R_{c 8} \cong\left(\beta_{o 8} / 2\right) r_{o 8}$. Using subscripts $n$ and $p$ as usual, we write

$$
\begin{equation*}
R_{c} \cong\left(\frac{\beta_{o n}}{2} r_{o n}\right) / /\left(\frac{\beta_{o p}}{2} r_{o p}\right) \tag{5.65}
\end{equation*}
$$

It is apparent that the transconductor can be regarded as a form of idealized transistor having (a) zero B-E voltage drop, (b) much higher input and output resistances than an ordinary transistor (this, thanks to the Darlington circuitry at the input and the Wilson circuitry at the output), and (c) full four-quadrant operation (for instance, if we terminate node $E$ on a resistive load to ground, $i_{E}$ and $i_{C}$ will flow out of the transconductor for $v_{B}>0$, but into the transconductor for $v_{B}<0$ ). Also called macro transistor, diamond transistor, and Current Conveyor II +, the transconductor shown can be used in its own right in the basic configurations of CC, CB , and CE , or as a building block for other current-mode ICs.

### Current-Feedback Amplifiers (CFAs)

Feeding node $C$ of the transconductor of Fig. 5.38 to another voltage buffer as in Fig. 5.39 turns it into a voltage-output circuit. Called current-feedback amplifier (CFA), the circuit replaces the conventional op amp in certain high-speed applications. To investigate this circuit, refer to the simplified equivalent of Fig. 5.40a, explicitly showing the net equivalent resistance $R_{e q}$ of node $C$ toward ground. With an eye on Fig. 5.39, we use inspection to find this resistance as

$$
\begin{equation*}
R_{e q}=R_{c 7} / / R_{c 8} / / / R_{b 13} / / R_{b 14} \tag{5.66}
\end{equation*}
$$

where $R_{c}$ and $R_{b}$ denote resistances seen looking into collectors and bases. Also by inspection we have

$$
\begin{equation*}
v_{O}=R_{e q} i_{N} \tag{5.67}
\end{equation*}
$$

Turning next to the typical feedback interconnection of Fig. 5.40b, we sum currents into node $v_{N}$ to get

$$
i_{N}+\frac{0-v_{N}}{R_{1}}+\frac{v_{O}-v_{N}}{R_{2}}=0
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-024.jpg?height=968&width=858&top_left_y=1101&top_left_x=440)

FIGURE 5.39 Current-feedback amplifier.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-025.jpg?height=671&width=661&top_left_y=214&top_left_x=205)
(a)
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-025.jpg?height=565&width=605&top_left_y=316&top_left_x=916)
(b)

FIGURE 5.40 (a) Simplified circuit equivalent of the CFA. (b) CFA symbol and interconnection for operation as a noninverting amplifier.

Letting $v_{N}=v_{P}=v_{I}$, solving for $i_{N}$, and inserting into Eq. (5.67) gives the closed-loop voltage gain

$$
\begin{equation*}
A=\frac{v_{O}}{v_{I}}=\left(1+\frac{R_{2}}{R_{1}}\right) \frac{1}{1+R_{2} / R_{e q}} \tag{5.68}
\end{equation*}
$$

In a well-designed circuit $R_{2}$ is on the order of $10^{3} \Omega$ whereas $R_{e q}$ is on the order of $10^{5} \sim 10^{6} \Omega$, so $R_{2} \ll R_{e q}$. Under this condition, $A$ tends to the expression already familiar from op amps,

$$
\begin{equation*}
A \cong 1+\frac{R_{2}}{R_{1}} \tag{5.69}
\end{equation*}
$$

The unique advantages of CFAs compared to ordinary op amps (also called voltagefeedback amplifiers or VFAs) are fast dynamics. These advantages, not immediately obvious from the present discussion but stemming from current-mode operation, will be addressed in Chapter 6.

### CFA-Derived Voltage-Feedback Amplifiers

Another important application of the transconductor of Fig. 5.38 is as a building block for high-speed voltage-feedback amplifiers (VFAs). The VFA of Fig. 5.41 is obtained from the CFA of Fig. 5.39 by using a third voltage buffer $\left(Q_{15}{ }^{-} Q_{16^{-}} Q_{17}{ }^{-} Q_{18}\right)$ to turn node $v_{N}$ into a high resistance input, and by inserting a resistance $R$ between the outputs of the first buffer and this new buffer to generate the control current previously denoted as $i_{N}$. This current (assumed to flow from left to right) is now
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-026.jpg?height=933&width=1323&top_left_y=210&top_left_x=311)

FIGURE 5.41 CFA-derived VFA.
$\left(v_{P}-v_{N}\right) / R$, and is conveyed to node $C$, where it produces the voltage $R_{e q}\left(v_{P}-v_{N}\right) / R$. This voltage is then buffered to the output node to give $v_{o}$, so the open-loop voltage gain of the resulting op amp is

$$
\begin{equation*}
a=\frac{v_{O}}{v_{P}-v_{N}}=\frac{R_{e q}}{R} \tag{5.70}
\end{equation*}
$$

Again, a well-designed circuit has $a \gg 1$. Owing to its inherently fast current-mode operation, this op amp type is especially suited to high-speed applications.

### Differential-Input Transconductors

The transconductor's versatility can be enhanced appreciably if we configure it to respond to differential-type inputs. In the popular rendition of Fig. 5.42, called operational transconductance amplifier (OTA), this feature is achieved by means of the differential pair $Q_{1}-Q_{2}$. To ensure high CMRR, the pair is biased via the high output-resistance Wilson mirror $Q_{3}-Q_{4}-Q_{5}$. $Q_{2}$ 's current is replicated and conveyed to the output node by the Wilson mirror $Q_{9}-Q_{10}{ }^{-} Q_{11} ; Q_{1}$ 's current is first replicated by the mirror $Q_{6}-Q_{7}-Q_{8}$, and then conveyed to the output node by the mirror $Q_{12^{2}}-Q_{13}-Q_{14}$, where it gets subtracted from that conveyed by $Q_{9}-Q_{10}{ }^{-} Q_{11}$. Ignoring the diodes $D_{1}$ and $D_{2}$ for the time being, we adapt Eq. (4.73) to write

$$
\begin{equation*}
i_{o}=i_{C 11}-i_{C 12}=i_{C 2}-i_{C 1}=I \times \tanh \left(\frac{v_{P}-v_{N}}{2 V_{T}}\right) \tag{5.71}
\end{equation*}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-027.jpg?height=1083&width=827&top_left_y=217&top_left_x=204)

FIGURE 5.42 Operational transconductance amplifer (OTA).
where $I$ is the current supplied by the user to bias the $Q_{1}-Q_{2}$ pair. The plot of $i_{0}$ versus the difference $v_{P}-v_{N}$ is the familiar $s$-shaped curve of Fig. 4.44. This curve is nonlinear, but if we restrict the input voltage within the range $\left|v_{P}-v_{N}\right| \ll 4 V_{T}$ ( $\cong 100 \mathrm{mV}$ ), then the small-signal approximation allows us to retain only the first term in the series expansion $\tanh x=x-x^{3} / 3+\cdots$ and write

$$
\begin{equation*}
i_{o}=\frac{I}{2 V_{T}}\left(v_{p}-v_{n}\right) \tag{5.72}
\end{equation*}
$$

We make some important observations:

- In small-signal operation, the transconductance gain

$$
\begin{equation*}
G_{m}=\frac{i_{o}}{v_{p}-v_{n}}=\frac{I}{2 V_{T}} \tag{5.73}
\end{equation*}
$$

is linearly proportional to the bias current $I$, so it can be programmed externally by the user. In fact, BJTs easily allow for current ranges in excess of five decades ( $>100 \mathrm{~dB}$ ), making OTAs particularly suited to a variety of programmable circuits ${ }^{7,8}$ such as programmable amplifiers, programmable oscillators, and programmable filters, especially in wide-dynamic range applications like audio and electronic music.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-028.jpg?height=722&width=1539&top_left_y=203&top_left_x=104)

FIGURE 5.43 PSpice circuits to investigate distortion in a differential pair configured for a $\pm 10-\mathrm{V}$ triangular input: (a) without and (b) with the predistorting input diode network.

- The small-signal constraint may be a drawback in certain applications. The effect of exceeding this constraint is depicted via the PSpice circuit of Fig. 5.43a, which uses input voltage dividers to scale a $\pm 10-\mathrm{V}$ triangular signal to an input difference $v_{B 1}-v_{B 2}$ of about $\pm 44-\mathrm{mV}$. Since 44 mV is not much smaller than $4 V_{T}(\cong 100 \mathrm{mV})$, the resulting current difference $i_{C 1}-i_{C 2}$ is a noticeably distorted triangle. (The shaded waveforms of Fig. 5.44 show the undistorted input voltage as well as the distorted output current.)
- If we wish an undistorted current waveform, the input voltage must be predistorted according to the inverse of the hyperbolic tangent function. An approximation to this function is achieved by means of the diode-connected BJT pair $D_{1}-D_{2}$ of Fig. 5.43b. Its effect, depicted in Fig. 5.44 via the solid traces, is
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-028.jpg?height=478&width=1295&top_left_y=1569&top_left_x=348)

FIGURE 5.44 Waveforms for the PSpice circuits of Fig. 5.43 (the shaded traces pertain to the circuit of Fig. 5.43a, the solid traces to that of Fig. 5.43b.)
to stretch in approximately inverse hyperbolic-tangent fashion the input peaks from about $\pm 44 \mathrm{mV}$ to about $\pm 60 \mathrm{mV}$, the values required for an undistorted current waveform.

### Variable Transconductance Multipliers

The OTA of Fig. 5.42 is said to be an analog multiplier because, according to Eq. (5.72), $i_{o}$ is proportional to the product $I \times\left(v_{p}-v_{n}\right)$. While the difference $v_{p}-v_{n}$ can assume either polarity, the current $I$ must always flow out of the differential pair $(I \geq 0)$, so the OTA is said to be a two-quadrant multiplier. Applications such as communications require full four-quadrant analog multiplication. This function is implemented using the current-mode circuit of Fig. 5.45. Popularly known as the Gilbert Cell for its inventor Barrie Gilbert, ${ }^{8}$ this most elegant current-mode circuit consists of (a) two emitter-coupled (EC) differential pairs $Q_{1}-Q_{2}$ and $Q_{3}{ }^{-} Q_{4}$ driven by the same voltage $v_{X}$ but in phase opposition to each other, so their output currents subtract pair-wise, and $(b)$ a third EC pair $\left(Q_{5}-Q_{6}\right)$ designed to steer the bias current $I$ to the two differential pairs in ratios controlled by the voltage $v_{Y}$. Depending on the polarity of $v_{Y}$, the output of one pair will prevail over that of the other, allowing the output current difference $i_{O 1}-i_{O 2}$ to attain either polarity and thus provide four-quadrant operation.

To obtain a relationship between the output currents and the input voltages we use KCL to write

$$
i_{O 1}-i_{O 2}=\left(i_{C 1}+i_{C 3}\right)-\left(i_{C 2}+i_{C 4}\right)=\left(i_{C 1}-i_{C 2}\right)-\left(i_{C 4}-i_{C 3}\right)
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-029.jpg?height=813&width=720&top_left_y=1256&top_left_x=201)

FIGURE 5.45 The Gilbert Cell.

Assuming negligible base currents, we adapt Eq. (5.71) and write

$$
i_{O 1}-i_{O 2}=i_{C 5} \tanh \left(\frac{v_{X}}{2 V_{T}}\right)-i_{C 6} \tanh \left(\frac{v_{X}}{2 V_{T}}\right)=\left(i_{C 5}-i_{C 6}\right) \tanh \left(\frac{V_{X}}{2 V_{T}}\right)
$$

that is,

$$
\begin{equation*}
i_{O 1}-i_{O 2}=I \tanh \left(\frac{V_{Y}}{2 V_{T}}\right) \tanh \left(\frac{V_{X}}{2 V_{T}}\right) \tag{5.74}
\end{equation*}
$$

We identify three classes of applications for the cell:

- Both inputs are of the small-signal type, that is, $\left|v_{x}\right| \ll 4 V_{T}$ and $\left|v_{y}\right| \ll 4 V_{T}$, so we approximate $\tanh x \cong x$ and write

$$
\begin{equation*}
i_{o 1}-i_{o 2} \cong I \times \frac{v_{x}}{2 V_{T}} \times \frac{v_{y}}{2 V_{T}} \tag{5.75}
\end{equation*}
$$

Clearly, in this mode the cell operates as a true four-quadrant multiplier.

- One of the inputs $\left(v_{x}\right)$ is a small-signal continuous wave such as a sine wave, while the other input $\left(v_{Y}\right)$ is a square wave of sufficient magnitude to overdrive the $Q_{5}-Q_{6}$ pair so as to turn one of its BJTs off. Then, for $v_{Y}>0, Q_{6}$ is off and $Q_{5}$ steers all of $I$ to the $Q_{1}-Q_{2}$ pair to give $i_{o 1}-i_{o 2}=+I v_{x} /\left(2 V_{T}\right)=+g_{m} v_{x}$. Conversely, for $v_{Y}<0, Q_{5}$ is off and $Q_{6}$ steers all of $I$ to the $Q_{3}-Q_{4}$ pair to give $i_{o 1}-i_{o 2}=-I v_{x} /\left(2 V_{T}\right)=-g_{m} v_{x}$, the negative sign stemming from the anti-phase connection at the input. In this capacity the cell finds application in communications as modulator/detector.
- Both inputs are of the large-signal type. Then, when $v_{X}$ and $v_{Y}$ have the same polarity the cell gives $i_{O 1}-i_{O 2}=I-0=I$, whereas when $v_{X}$ and $v_{Y}$ have opposite polarities it gives $i_{O 1}-i_{O 2}=0-I=-I$. This function is similar to the exclusive-or function of digital circuits. In this capacity the cell finds application as phase detector in phase-locked loop systems.

As in the case of OTAs, the small-signal constraint can be a serious limitation in certain multiplier applications, so provisions must be made to accommodate larger input magnitudes while still assuring accurate multiplication. Shown in Fig. 5.46 is a popular Gilbert Cell application meeting the above requirements. We make the following observations:

- The $Q_{5}-Q_{6}$ pair exploits emitter degeneration via $R_{Y}$ to expand its input signal range by the desired amount. Again ignoring base currents, we apply KCL, Ohm's law, and KVL to write

$$
\begin{aligned}
i_{C 5}-i_{C 6} & =\left(I_{Y}+\frac{v_{E 5}-v_{E 6}}{R_{Y}}\right)-\left(I_{Y}+\frac{v_{E 6}-v_{E 5}}{R_{Y}}\right)=2 \frac{v_{E 5}-v_{E 6}}{R_{Y}} \\
& =\frac{\left(v_{Y 1}-v_{B E 5}\right)-\left(v_{Y 2}-v_{B E 6}\right)}{0.5 R_{Y}}
\end{aligned}
$$

Regrouping and using $v_{B E}=V_{T} \ln \left(i_{C} / I_{s}\right)$ we get

$$
i_{C 5}-i_{C 6}=\frac{\left(v_{Y 1}-v_{Y 2}\right)-\left(v_{B E 5}-v_{B E 6}\right)}{0.5 R_{Y}}=\frac{\left(v_{Y 1}-v_{Y 2}\right)-V_{T} \ln \left(i_{C 5} / i_{C 6}\right)}{0.5 R_{Y}}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-031.jpg?height=877&width=898&top_left_y=214&top_left_x=201)

FIGURE 5.46 Four-quadrant analog multiplier.

In a well-designed circuit the last numerator term is negligible (see Problem 5.39), so we approximate

$$
\begin{equation*}
i_{C 5}-i_{C 6}=\frac{v_{Y 1}-v_{Y 2}}{0.5 R_{Y}} \tag{5.76}
\end{equation*}
$$

indicating that the emitter-degenerated $Q_{5}-Q_{6}$ pair acts as a linear voltage-to-current (V-I) converter.

- Likewise, the $Q_{7}-Q_{8}$ pair is a V-I converter giving $i_{C 7}-i_{C 8}=\left(v_{X 1}-v_{X 2}\right) /\left(0.5 R_{X}\right)$ and driving the diode-connected pair $Q_{9}{ }^{-} Q_{10}$. Using KVL and $v_{B E}=V_{T} \ln \left(i_{C} / I_{s}\right)$ we have

$$
\begin{aligned}
v_{X} & =v_{E 10}-v_{E 9}=\left(V_{A}-v_{B E 10}\right)-\left(V_{A}-v_{B E 9}\right)=v_{B E 9}-v_{B E 10} \\
& =V_{T} \ln \frac{i_{C 9}}{i_{C 10}}=V_{T} \ln \frac{i_{C 7}}{i_{C 8}}
\end{aligned}
$$

But, KCL gives $i_{C 7}=I_{X}+\left(v_{X 1}-v_{X 2}\right) / R_{X}$ and $i_{C 8}=I_{X}-\left(v_{X 1}-v_{X 2}\right) / R_{X}$, so

$$
v_{X}=V_{T} \ln \frac{I_{X}+\left(v_{X 1}-v_{X 2}\right) / R_{X}}{I_{X}-\left(v_{X 1}-v_{X 2}\right) / R_{X}}=V_{T} \ln \frac{1+\left(v_{X 1}-v_{X 2}\right) /\left(R_{X} I_{X}\right)}{1-\left(v_{X 1}-v_{X 2}\right) /\left(R_{X} I_{X}\right)}
$$

Using the identity $\ln [(1+x) /(1-x)]=2 \tan ^{-1} x$, which holds for $|x|<1$, we have

$$
\begin{equation*}
v_{X}=2 V_{T} \tan ^{-1} \frac{v_{X 1}-v_{X 2}}{R_{X} I_{X}} \tag{5.77}
\end{equation*}
$$

- Substituting Eqs. (5.76) and (5.77) into Eq. (5.74) we get

$$
i_{O 1}-i_{O 2}=\left(i_{C 5}-i_{C 6}\right) \tanh \frac{v_{X}}{2 V_{T}}=\frac{v_{Y 1}-v_{Y 2}}{0.5 R_{Y}} \tanh \frac{2 V_{T} \tan ^{-1}\left[\left(v_{X 1}-v_{X 2}\right) /\left(R_{X} I_{X}\right)\right]}{2 V_{T}}
$$

that is,

$$
\begin{equation*}
i_{O 1}-i_{O 2}=\frac{v_{Y 1}-v_{Y 2}}{0.5 R_{Y}} \times \frac{v_{X 1}-v_{X 2}}{R_{X} I_{X}} \tag{5.78}
\end{equation*}
$$

It is apparent that the tanh function and its inverse $\tanh ^{-1}$ cancel each other out to leave only the argument $\left(v_{X 1}-v_{X 2}\right) /\left(2 R_{X}\right)$. In words, the $X$-input is first processed by the $Q_{9}-Q_{10}$ diodes in $\tanh ^{-1}$ fashion to generate a predistorted signal $v_{x}$; the $Q_{1}-Q_{2}$ and $Q_{3}{ }^{-} Q_{2}$ pairs then process $v_{X}$ in tanh fashion to generate an overall undistorted output. The output is, in turn, modulated by the $Y$-input.

- In actual application the output current difference $i_{O 1}-i_{O 2}$ is converted to a voltage. In the rendition of Fig. 5.46 this I-V conversion is achieved by terminating the cell's outputs on a pair of matched resistances $R$ to give the double-ended output voltage

$$
\begin{equation*}
v_{O}=v_{O 2}-v_{O 1}=R\left(i_{O 1}-i_{O 2}\right)=\frac{R}{0.5 R_{X} R_{Y} I_{X}} \times\left(v_{X 1}-v_{X 2}\right) \times\left(v_{Y 1}-v_{Y 2}\right) \tag{5.79}
\end{equation*}
$$

If a single-ended voltage-type output is desired, then the I-V conversion can be implemented via an op amp configured as a differential amplifier. ${ }^{7}$ Alternatively, if a single-ended current output is desired, then we can use three Wilson current mirrors in the manner of the OTA of Fig. 5.42.

## 5.7 FULLY DIFFERENTIAL OPERATIONAL AMPLIFIERS

A common way of encoding analog information electronically is via single-ended voltages such as ground-referenced potentials. A classic example is the inverting amplifier of Fig. 5.47a, whose input $v_{I}$ and output $v_{O}$ are both referenced to ground potential. For large $a$, they are related as $v_{O}=\left(-R_{2} / R_{1}\right) v_{I}$. In actual application the circuit is likely to be part of a larger system, where it may be subject to various
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-032.jpg?height=457&width=1330&top_left_y=1589&top_left_x=319)

FIGURE 5.47 Basic op amp circuit: (a) idealized situation, and (b) in actual application, showing the stray elements of its interconnections.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-033.jpg?height=464&width=1384&top_left_y=200&top_left_x=191)

FIGURE 5.48 (a) Interference noise model for the inverting amplifier of Fig. 5.47. (b) Interconnecting the op amp as a difference amplifier to reject $v_{1}$, and using balanced input lines to cancel out the $v_{2}$ noise sources.
forms of interference noise that might obfuscate its useful signals. To begin with, the ground interconnection, far from being a perfect conductor, exhibits distributed resistance, inductance, and capacitance, and is shared with other subcircuits in the system. As the currents of the other circuits flow back and forth on the ground line, as illustrated via the lumped model of Fig. 5.47b, they produce undesirable voltage drops along the distributed line impedance. Also shown are stray mutual inductances and stray internode capacitances, which provide additional paths through which the surrounding circuits can inject interference noise into the line. We model the cumulative effect of all noise sources with a single ground noise source $v_{1}$ as in Fig. 5.48a. Interference noise pickup from neighboring circuits affects also the signal line connecting the source to the amplifier, so we model this via the line noise source $v_{2}$.

Given the noise drops along the ground line, the very concept of reference node becomes blurred. For the sake of discussion let us arbitrarily pick node $v_{P}$ as our ground reference, as depicted in Fig. 5.48a. Then, using KVL we find $v_{O}=\left(-R_{2} / R_{1}\right) \times\left(v_{1}+v_{I}+v_{2}\right)$, indicating that both noise sources get amplified by the same amount as the useful signal $v_{I}$. This is unacceptable especially in high-gain applications, where the input signal strength may be comparable to that of noise. The best way to dispose of ground noise is to treat $v_{1}$ as a commonmode signal and use a differential amplifier with a high common-mode rejection ratio (CMRR) to reject it. As depicted in Fig. 5.48b, this requires lifting node $v_{P}$ off ground and driving it by means of an additional dedicated line as well as an additional $R_{1}-R_{2}$ pair, as shown. This second line will of course pick up noise just like the preexisting line, but if the two lines are identical and are laid out in close proximity to each other so as to form what is aptly referred to as balanced lines, then noise pickup will be identical on the two lines and the circuit will give $^{7} v_{O}=\left(R_{2} / R_{1}\right)\left[\left(v_{1}+v_{2}\right)-\left(v_{1}+v_{I}+v_{2}\right)\right]=\left(-R_{2} / R_{1}\right) v_{I}$. Summarizing, $v_{1}$ is rejected thanks to the amplifier's CMRR, and the $v_{2}$ sources simply cancel each other out thanks to line balance.

### Fully Differential Amplifier Concepts

The classic differential amplifier of Fig. $5.48 b$ processes the input differentially but still yields a single-ended output. In today's mixed-mode ICs, where analog circuits are fabricated alongside inherently noisy digital circuits and are powered at low supply voltages, the combination of low signal amplitudes and high interference noise makes double-ended signal transmission mandatory both at the input and at the output ports. The workhorse of this class of circuits is the fully differential op amp shown symbolically in Fig. 5.49a. Also called fully balanced op amp, it responds to a differential input just like an ordinary op amp, to give $v_{O P}=a\left(v_{P}-v_{N}\right)$. However, unlike the common op amp, it has also a second, balanced output, $v_{O N}=a\left(v_{N}-v_{P}\right)=$ $-v_{O P}$, Additionally, it comes with a control input for the user to specify the commonmode output voltage $V_{O C(\mathrm{set})}$, as we shall see shortly.

Beside the noise-immunity advantages of balanced transmission, the fully differential op amp offers also (a) wider output signal swing and (b) reduced second-harmonic distortion. To see how, rewrite the outputs in more general forms accounting for inherent circuit nonlinearities, namely, $v_{O P}=a\left(v_{P}-v_{N}\right)+b\left(v_{P}-v_{N}\right)^{2}+c\left(v_{P}-v_{N}\right)^{3} \ldots$ and $v_{O N}=a\left(v_{N}-v_{P}\right)+b\left(v_{N}-v_{P}\right)^{2}+c\left(v_{N}-v_{P}\right)^{3} \ldots$ Then, the differential output reduces, after simplification, to $v_{O P}-v_{O N}=2 a\left(v_{P}-v_{N}\right)+2 c\left(v_{P}-v_{N}\right)^{3} \ldots$, indicating a differential output signal swing twice as large as that of the individual single-ended outputs, as well as a cancellation of the second-harmonic components.

The fully differential op amp is configured for negative-feedback operation with two identical networks as depicted in Fig. 5.49b for the resistive case. (Both networks are of the negative-feedback type as each connects from one of the outputs to the input of the opposite polarity.) For the purpose of illustration, the external inputs $v_{I P}$ and $v_{I N}$ have been decomposed in terms of their differential-mode and commonmode components

$$
\begin{equation*}
v_{I D}=v_{I P}-v_{I N} \quad v_{I C}=\frac{v_{I P}+v_{I N}}{2} \tag{5.80a}
\end{equation*}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-034.jpg?height=579&width=1208&top_left_y=1462&top_left_x=439)

FIGURE 5.49 Fully differential op amp: (a) symbol and labels, and (b) interconnection for operation as a fully balanced amplifier.

Likewise, the differential-mode and common-mode components at the output are

$$
\begin{equation*}
v_{O D}=v_{O P}-v_{O N} \quad v_{O C}=\frac{v_{O P}+v_{O N}}{2} \tag{5.80b}
\end{equation*}
$$

If the open-loop gain $a$ is sufficiently large, the differential-mode components are related as

$$
\begin{equation*}
v_{O D}=\frac{R_{2}}{R_{1}} v_{I D} \tag{5.81}
\end{equation*}
$$

(Note that since the single-ended output signals have opposite phases, as shown, the differential output swing $v_{O D}$ is twice as wide.) We also observe that whereas $v_{I C}$ is established by the input sources, $v_{O C}$ is unspecified and as such it needs to be set externally by the user.

### Fully Differential Bipolar Op Amp

Figure 5.50 shows how the folded-cascode bipolar structure of Fig. $4.71 a$ can be turned into a fully differential op amp. The first important change is in $Q_{5}$, formerly diode connected but now operated as a current-sink active load, just like $Q_{6}$. This
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-035.jpg?height=1020&width=1086&top_left_y=1047&top_left_x=204)

FIGURE 5.50 Simplified fully differential bipolar op amp.
results in a perfectly symmetric structure. (To avoid cluttering, the details of the biasing network have been omitted, so only the base-bias voltages $V_{B 78}$ and $V_{B 34}$ are shown (also, in actual implementation, $Q_{5}$ and $Q_{6}$ are likely to be cascoded to raise the gain, but here we are focusing only on the basics.) The high-resistance collector nodes of the $Q_{3}-Q_{5}$ and $Q_{4}-Q_{6}$ pairs are buffered via unity-gain push-pull stages to give $v_{O P}$ and $v_{O N}$. The other important feature is the matched $R-R$ pair and the error amplifier EA, forming what is referred to as the common-mode feedback network (CMFN). Its function is to properly center $v_{O P}$ and $v_{O N}$ up or down the permissible output voltage range (OVR), usually halfway in order to maximize the output voltage swing. Specifically, the resistance pair synthesizes the voltage $\left(v_{O P}+v_{O N}\right) / 2$, which the EA then compares against the externally supplied voltage $V_{O C(s e t)}$, and adjusts its output $v_{E A}$ to force $\left(v_{O P}+v_{O N}\right) / 2$ to approach $V_{O C(\text { set })}$. To see how, recall that $v_{O P}$ and $v_{O N}$ are the voltages at which the pull-up actions by $Q_{3}$ and $Q_{4}$ balance, respectively, the pull-down actions by $Q_{5}$ and $Q_{6}$. So, raising/lowering $v_{E A}$ makes pull-down stronger/ weaker than pull-up, shifting $v_{O P}$ and $v_{O N}$ down/up the OVR. In control-theory parlance, the negative-feedback loop comprising the $R-R$ pair, the $E A$, the $Q_{5}-Q_{6}$ pair, and the buffers is said to form a servo loop.

### Fully Differential CMOS Op Amps

Figure 5.51 shows how the folded-cascode CMOS op amp of Fig. 5.17 can be turned into a fully differential type (again, the details of the biasing network have been omitted, so only the gate-bias voltages $V_{G 78}$ and $V_{G 56}$ are shown). To ensure balanced outputs, $M_{5}$ and $M_{7}$, formerly diode connected, are now operated as current sources.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-036.jpg?height=835&width=1267&top_left_y=1231&top_left_x=367)

FIGURE 5.51 Fully-differential CMOS op amp of the folded-cascode type.

Moreover, the CMFN is the all-transistor network made up of $M_{12}$ through $M_{16}$. To see how it functions, consider the following:

- Start out assuming $v_{P}=v_{N}$, so $v_{O P}=v_{O N}$. Also, assume $v_{O P}=v_{O N}=V_{O C(\mathrm{set})}$, so the two $I$ sources split equally between the SC pairs to give $I_{D 12}=I_{D 13}=0.5 I$ and $I_{D 14}=I_{D 15}=0.5 I$. The diode-connected FET $M_{16}$ draws $I_{D 16}=I_{D 13}+I_{D 14}=I$, which $M_{9}$ and $M_{10}$ then mirror to provide, respectively, the bias currents for $M_{3}$ and $M_{4}$ (refer also to Fig. 5.16). As we know, $v_{O P}$ and $v_{O N}$ represent the voltages at which the pull-up actions by $M_{5}$ and $M_{6}$ balance, respectively, the pull-down actions by $M_{3}$ and $M_{4}$.
- Suppose now that for some reason $v_{O P}$ and $v_{O N}$ try to rise above $V_{O C(\text { set })}$. Then, $M_{12}$ and $M_{15}$ will become less conductive, while $M_{13}$ and $M_{14}$ will conduct more, thus raising $I_{D 16}$. By mirror action this will raise $I_{D 9}$ and $I_{D 10}$ and thus boost the pulldown action by $M_{3}$ and $M_{4}$, with the result of forcing $v_{O P}$ and $v_{O N}$ to drop back to $V_{O C(\mathrm{set})}$. By symmetric reasoning, if $v_{O P}$ and $v_{O N}$ try to drop below $V_{O C(\mathrm{set})}, M_{13}$ and $M_{14}$ will conduct less, decreasing $I_{D 16}$ and thus reducing the pull-down action by $M_{3}$ and $M_{4}$. The pull-up action by $M_{5}$ and $M_{6}$ will now prevail, forcing $v_{O P}$ and $v_{O N}$ to rise back to $V_{O C(\text { set })}$.
- Let us now apply an ac signal across the inputs so as to generate the symmetric swings $v_{O P}=V_{O C(\mathrm{set})}+v_{O D} / 2$ and $v_{O N}=V_{O C(\mathrm{set})}-v_{O D} / 2$. These swings will imbalance the differential pairs to give $i_{D 15}=0.5 I-i$ and $i_{D 14}=0.5 I+i$, and $i_{D 12}=0.5 I+i$ and $i_{D 13}=0.5 I-i$, for some current change $i$. However, $M_{16}$ still draws

$$
i_{D 16}=i_{D 13}+i_{D 14}=0.5 I-i+0.5 I+i=I
$$

indicating that the servo loop provided by the CMFN keeps the value of $\left(v_{O P}+v_{O N}\right) / 2$ near $V_{O C(\mathrm{set})}$ regardless of the ac signals present. Of course this holds true so long as none of the transistors is forced out of its active region.

Find the small-signal gain $v_{o d} / v_{i d}$ of the op amp of Fig. 5.51, assuming the parameters of Example 5.4. Compare with the example and comment.

### Solution

The circuit of Fig. 5.51 is perfectly symmetric about the vertical axis running down from node $V_{G 78}$, so we work with the half-circuit ac equivalent of Fig. 5.52. By inspection, $R_{o}=R_{d 5} / / R_{d 3}$, where $R_{d 5}$ and $R_{d 3}$ are the ac resistances seen looking into the drains of $M_{5}$ and $M_{3}$. Using again inspection we write

$$
R_{o}=\left[r_{o 5}+r_{o 7}+\left(g_{m 5}+g_{m b 5}\right) r_{o 5} r_{o 7}\right] / /\left[r_{o 3}+\left(r_{o 9} / / r_{o 1}\right)+\left(g_{m 3}+g_{m b 3}\right) r_{o 3}\left(r_{o 9} / / r_{o 1}\right)\right]
$$

This is formally identical to Eq. (5.39), so we recycle Example 5.4 to write $R_{o} \cong$ $5.22 \mathrm{M} \Omega$. We also have $i_{1}=g_{m 1}\left(v_{i d} / 2\right)=(0.4 \mathrm{~mA} / \mathrm{V}) \times\left(v_{i d} / 2\right)$. Following the line of reasoning of Example 5.4 we can state that most of $i_{1}$ flows out of $M_{3}$, so

$$
-\frac{v_{o d}}{2} \cong-R_{o} i_{1}=-g_{m 1} R \frac{v_{o d}}{2}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-038.jpg?height=572&width=513&top_left_y=179&top_left_x=446)

FIGURE 5.52 Half-circuit equivalent of the op amp of Fig. 5.51.

Consequently, $v_{o d} / v_{i d}=g_{m 1} R_{o} \cong 0.4 \times 5,220=2,088 \mathrm{~V} / \mathrm{V}$. The single-ended signal $v_{o}$ of Example 5.4 now splits between the two opposite halves $v_{o p}$ and $v_{o n}$, so the gain is unchanged.

Figure 5.53 shows how the two-stage CMOS op amp of Fig. 5.13 can be turned into a fully differential type (again, the biasing details have been omitted for simplicity). In this rendition the CMFN is now the complementary of that of Fig. 5.51 because it is designed to adjust the current of a $p$ MOSFET, namely, the tail current supplied by $M_{9}$ (evidently there are various different ways of designing a CMFN).
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-038.jpg?height=776&width=1396&top_left_y=1291&top_left_x=241)

FIGURE 5.53 Fully-differential CMOS op amp of the two-stage type.

### Expanding the Input Voltage Range

If we specify $V_{G 34}$ in the folded-cascode op amp of Fig. 5.51 so as to bias the $M_{9}-M_{10}$ pair right at the edge of saturation $\left(V_{D S 9}=V_{O V 9}\right.$ and $\left.V_{D S 10}=V_{O V 10}\right)$, then, the input voltage range (IVR) is specified by Eq. (5.41). For instance, suppose we have a singlesupply system with $V_{S S}=0$ and $V_{D D}=3 \mathrm{~V}$, and let $\left|V_{t 1}\right|=0.75 \mathrm{~V}$ and $V_{O V}=0.25 \mathrm{~V}$ throughout. Then, the common-mode input voltage $v_{I C}=1 / 2\left(v_{P}+v_{N}\right)$ is such that

$$
\begin{aligned}
& v_{I C(\min )}=V_{S S}+V_{O V 9}-\left|V_{t \mid}\right|=0+0.25-0.75=-0.5 \mathrm{~V} \\
& v_{I C(\max )}=V_{D D}-V_{O V 11}-V_{O V 1}-\left|V_{t 1}\right|=3-0.25-0.25-0.75=1.75 \mathrm{~V}
\end{aligned}
$$

While the lower limit is quite desirable because it allows us to lower the inputs all the way down to the ground rail, and even $0.5-\mathrm{V}$ below, without causing any malfunction, the upper limit is generally too restrictive, especially in a low-supply situation such as the $3-\mathrm{V}$ case considered here. Ideally we want the IVR to extend from rail to rail and possibly beyond by, say, a $0.5-\mathrm{V}$ margin (from -0.5 V to 3.5 V in our example). Were we to use the dual op amp realization by interchanging $p$ MOSFETs and $n$ MOSFETs as well as interchanging the power supplies (see Fig. P5.21), then the $n$-type input pair would exhibit the dual constraints $v_{I C(\min )}=1.25 \mathrm{~V}$ and $v_{I C(\max )}=$ 3.5 V . In other words, while a $p$-type input stage works well near $V_{S S}$ but goes off near $V_{D D}$, an $n$-type works well near $V_{D D}$ but goes off near $V_{S S}$, just the opposite.

The above considerations provide the basis for the ingenious solution of Fig. 5.54, which uses both input-stage types to get the best of both. (The CMFN, not shown to
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-039.jpg?height=846&width=896&top_left_y=1183&top_left_x=205)

FIGURE 5.54 Using two complementary input stages $\left(M_{1 n}-M_{2 n}\right.$ and $M_{1 \rho}-M_{2 p}$ ) to achieve a rail-to-rail IVR (CMFN not shown).
avoid cluttering the schematic, can be made to adjust either $V_{G 78}$ or $V_{G 910}$, or both.) Assuming again $V_{t n}=-V_{t p}=0.75 \mathrm{~V}$ and $V_{O V}=0.25 \mathrm{~V}$ throughout, we note the following:

- For $v_{I C}<V_{S S}+V_{O V 11 n}+V_{t n}\left(=1 \mathrm{~V}\right.$ for $\left.V_{S S}=0\right)$ the $M_{1 n}-M_{2 n}$ pair is off whereas the $M_{1 p}-M_{2 p}$ pair is fully operational, so we rewrite Eq. (5.38) as $G_{m}=g_{m 1 p}$.
- Raising $v_{I C}$ above 1 V will gradually turn on the $M_{1 n}-M_{2 n}$ pair until both pairs are fully operational once we pass the $1.25-\mathrm{V}$ mark. For $1.25 \mathrm{~V} \leq v_{I C} \leq 1.75 \mathrm{~V}$ the two pairs work in tandem, giving $G_{m}=g_{m 1 p}+g_{m 1 n}$.
- Raising $v_{I C}$ above 1.75 V will gradually turn off the $M_{1 p}-M_{2 p}$ pair while the $M_{1 n}-M_{2 n}$ pair continues to be fully operational.
- For $v_{I C}>V_{D D}-V_{O V 11 p}-\left|V_{t p}\right|\left(=2 \mathrm{~V}\right.$ for $\left.V_{D D}=3 \mathrm{~V}\right)$ the $M_{1 p}-M_{2 p}$ pair is totally off, so the circuit gives $G_{m}=g_{m 1 n}$.
- So long as the $M_{7}-M_{8}$ and the $M_{9}-M_{19}$ pairs are biased at the edge of saturation, the output voltage swing (OVS) will extend to within two $V_{O V}$ of either supply rail. If a true rail-to-rail OVS is desired, then an ad-hoc output stage is required, such as the CS push-pull output stage of Section 4.11.

Shown in Fig. 5.55 is the bipolar version of Fig. 5.54. To maximize the IVR, $V_{B 34}$ is set to bias the $Q_{9}-Q_{10}$ pair slightly above the edge of saturation, say at $V_{C E 9}=V_{C E 10} \cong$ 0.25 V . Likewise, $V_{B 56}$ is set so that $V_{E C 7}=V_{E C 8} \cong 0.25 \mathrm{~V}$. Then, assuming B-E voltage drops of 0.65 V , we have $v_{I C(\min )}=V_{E E}+2 \times 0.25-0.65=V_{E E}-0.15 \mathrm{~V}$
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-040.jpg?height=964&width=919&top_left_y=1103&top_left_x=447)

FIGURE 5.55 Bipolar op amp of with a rail-to-rail IVR (CMFN not shown).
and $v_{I C(\max )}=V_{D D}+0.15 \mathrm{~V}$. In some embodiments the $Q_{7}-Q_{8}$ and $Q_{9}-Q_{10}$ pairs are replaced by resistor pairs ${ }^{1}$ to develop the voltage drops of about 0.25 V that are required to prevent the input pairs from saturating in the vicinity of the supply rails.

A notorious issue with the op amps of Figs. 5.54 and 5.55 is that near the lower end of the IVR the input offset voltage of the $p$-type pair dominates, whereas near the upper end that of the $n$-type pair dominates. So, as $v_{I C}$ changes from one end to the other of the IVR, the net input offset voltage will generally change in magnitude and possibly in polarity, depending on the magnitudes and directions of the individual mismatches. In the bipolar case also the input bias current may pose problems: at the lower end it coincides with the base current of the $p$-type pair, flowing out of the op amp, but at the higher end it coincides with that of the $n$-type pair, flowing into the op amp. At intermediate IVR values both pairs are on and the base currents of the $p$-type pair tend to cancel those of the $n$-type pair. Consequently, input bias-current magnitude and direction are strong functions of $v_{I C}$.

## 5.8 SWITCHED-CAPACITOR CIRCUITS

Traditionally, electronic systems have been designed using off-the-shelf analog and digital ICs, along with passive components such as resistors and capacitors, all mounted on a common medium such as a printed-circuit board (PCB). Nowadays, for reasons of cost, miniaturization, power consumption, and reliability, the trend is to integrate both analog and digital functions on the same silicon chip to create circuits aptly called mixed-signal ICs. Given that digital electronics is dominated by CMOS technology, analog functions must be implemented using exclusively the components most easily available in this technology, namely, MOSFETs and capacitors (to keep die size within reason, capacitances must be limited to a few tens of picofarads or less). Resistors and larger capacitors must therefore be avoided altogether. Figure 5.56 shows the conceptual structure of these two basic components (the shaded capacitances represent parasitics that will be discussed later). The type of capacitor shown is referred to as double-polysilicon capacitor because it is made up of two polysilicon layers, the same material type as the gate (being of the $n^{+}$type, these layers can for all purposes be regarded as metal plates).

The most common applications of the MOSFET are amplification and switching. We have already investigated switching in the design of the logic gates of Chapter 3, and amplification in the design of CMOS op amps such as the cascode op amp of Fig. 5.17. A unique advantage of CMOS op amps is that they exhibit the virtually infinite input resistances presented by the gate terminals of the input FETs. This makes it possible to drive the op amp with voltages stored in on-chip capacitors with very small leakage. Also, the reason for cascoding is to raise the resistance levels in order to achieve high dc gain. If we were to apply resistive feedback around such an op amp, output loading by the external resistances would be so severe as to invalidate the high-gain advantages accrued via cascoding. Mercifully, capacitive feedback (as opposed to resistive feedback) loads down the op amp only during transients. Once steady state is achieved, capacitors act as open circuits, thus preserving high dc gains. Another important advantage of cascode op amps, not immediately obvious at this
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-042.jpg?height=886&width=1346&top_left_y=205&top_left_x=290)

FIGURE 5.56 Conceptual structure of an $n$ MOSFET and a double-poly capacitor, showing the parasitic overlap capacitances $C_{o V}$ and parasitic top-plate/bottom-plate capacitances $C_{\text {top }}$ and $C_{b t m}$.
juncture but to be investigated in great detail in Chapter 7, is that capacitive loading reinforces their ability to stave off the possibility of oscillation, a feature not available in most other op amp types. In summary, the on-chip components available to the mixed-signal IC designer are (a) CMOS op amps, especially cascode types, (b) small capacitors (on the order of picofarads or less), and (c) MOSFET switches. Let us now address the switched-capacitor concept.

### The Switched Capacitor

Figure 5.57 shows a basic switched-capacitor arrangement, along with the gate drive for the two FETs. We make the following observations:

- When $\phi$ is high, $M_{1}$ is on while $M_{2}$ is off because $\bar{\phi}$ is low. $M_{1}$ charges $C$ toward $v_{1}$, and when $v_{C}$ comes within $v_{O V 1}$ of $v_{1}, M_{1}$ enters the triode region, where it approximates a resistance $r_{D S 1}$ as in Fig. 5.58a. If $\phi$ is kept high for a duration sufficiently longer than the time constant $\tau_{1}=r_{D S 1} C$, we can say that by the time $\phi$ returns low we practically have $v_{C}=v_{1}$.
- When $\bar{\phi}$ is high the situation reverses as in Fig. $5.58 b$, so now $M_{2}$ charges $C$ toward $v_{2}$. Assuming $\bar{\phi}$ is kept high long enough compared to $\tau_{2}=r_{D S 2} C$ to fully
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-043.jpg?height=400&width=1079&top_left_y=213&top_left_x=199)
(b)

FIGURE 5.57 (a) Basic switched capacitor and (b) non-overlapping clock drive.
charge $C$ to $v_{2}$, we can say that by the time $\bar{\phi}$ returns low there has been a charge transfer $\Delta Q$ from $v_{1}$ to $v_{2}$ such that

$$
\begin{equation*}
\Delta Q=C\left(v_{1}-v_{2}\right) \tag{5.82}
\end{equation*}
$$

(This, assuming $v_{1}>v_{2}$. If $v_{1}<v_{2}$, then charge transfer is from $v_{2}$ to $v_{1}$.)

- If the process is repeated at a rate of $f_{S}\left(=1 / T_{S}\right)$ cycles/sec, then the charge transferred in one second is $f_{S} \Delta Q=f_{S} C\left(v_{1}-v_{2}\right)$. But, charge/second represents average current, $i_{\mathrm{avg}}=f_{S} C\left(v_{1}-v_{2}\right)$, suggesting that the switched-capacitor block acts like an equivalent resistance $R_{e q}=\left(v_{1}-v_{2}\right) / i_{\text {avg }}$, or

$$
\begin{equation*}
R_{e q}=\frac{1}{C f_{S}} \tag{5.83}
\end{equation*}
$$

This equivalence is depicted in Fig. 5.59, where the MOSFET pair of Fig. 5.57a is shown as a break-before-make switch of the single-pole double-throw (SPDT) type. We must prevent the MOSFETs from being on simultaneously as this would short the $v_{1}$ and $v_{2}$ sources together and invalidate Eq. (5.82). Hence, the need for non-overlapping gate drives in the manner of Fig. 5.57b.

A popular application of the simulated resistor of Eq. (5.82) is in the synthesis of filters, of which the integrator to be investigated next is the most basic building block.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-043.jpg?height=362&width=917&top_left_y=1674&top_left_x=201)

FIGURE 5.58 Circuit equivalent of the switched capacitor of Fig. $5.57 a$ when (a) $\phi$ is high and (b) $\bar{\phi}$ is high.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-044.jpg?height=267&width=699&top_left_y=186&top_left_x=449)

FIGURE 5.59 A capacitance $C$ switched at a frequency of $f_{s}$ draws on average the same current as a resistance of value $1 /\left(C f_{s}\right)$.

### Switched-Capacitor Integrator

The classic integrator of Fig. 5.60a is also called RC integrator because we use the external $R$-C network to configure the op amp for integration. Applying KCL we get $\left(V_{i}-0\right) / R_{1}=\left(0-V_{o}\right) /\left[1 /\left(s C_{2}\right)\right]$. Letting $s \rightarrow j 2 \pi f$ and simplifying gives the inverting-type integrator transfer function

$$
\begin{equation*}
H_{R C}(j f)=\frac{V_{o}}{V_{i}}=-\frac{1}{j f / f_{0}} \tag{5.84}
\end{equation*}
$$

where

$$
\begin{equation*}
f_{0}=\frac{1}{2 \pi R_{1} C_{2}} \tag{5.85}
\end{equation*}
$$

is called the unity-gain frequency because $\left|H_{R C}\left(j f_{0}\right)\right|=1$. We now wish to rephrase the circuit of Fig. $5.60 a$ in switched-capacitor (SC) form so we can fabricate it entirely on chip. To achieve this we replace $R_{1}$ with a simulated resistor as in Fig. 5.60b, and we scale $C_{2}$ to a small enough value so we can realistically fabricate it on chip. Using Eq. (5.83) to write $R_{1}=1 /\left(C_{1} f_{S}\right)$ and substituting into Eq. (5.85) we get

$$
\begin{equation*}
f_{0}=\frac{1}{2 \pi} \frac{C_{1}}{C_{2}} f_{S} \tag{5.86}
\end{equation*}
$$

We make the following important observations:

- The SC integrator uses no resistors, a definite advantage because accurate and stable resistors are difficult to fabricate on chip. The SC integrator uses MOSFETs and capacitors instead.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-044.jpg?height=346&width=1152&top_left_y=1736&top_left_x=443)

FIGURE 5.60 (a) The $R C$ integrator, and (b) its switched-capacitor (SC) implementation.

- The unity-gain frequency $f_{0}$ is established by the product $R_{1} C_{2}$ in the $R C$ integrator, but by the ratio $C_{2} / C_{1}$ in the $S C$ integrator. Compared to products, ratios are much easier to control during fabrication and to maintain with temperature and time. Capacitance matching within $0.5 \%$ is easily achievable in MOS technology. ${ }^{2}$ This is another important advantage of $S C$ integrators.
- The unity-gain frequency $f_{0}$ of the $S C$ integrator is directly proportional to the switching frequency $f_{S}$, so, if desired, we can program $f_{0}$ automatically over a wide range of values by suitably varying $f_{S}$.
(a) Specify component values for $f_{0}=10 \mathrm{kHz}$ in the integrator of Fig. 5.60a, and comment.
(b) Repeat, but for the circuit of Fig. $5.60 b$ if $f_{S}=1 \mathrm{MHz}$. Do not exceed a total capacitance of 10 pF .

### Solution

(a) Arbitrarily choose $C_{2}=1 \mathrm{nF}$. Then Eq. (5.85) gives,

$$
R_{1}=\frac{1}{2 \pi C_{2} f_{0}}=\frac{1}{2 \pi 10^{-9} \times 10^{4}}=15.9 \mathrm{k} \Omega
$$

Both values are easily available off the shelf, but $C_{2}$ could hardly be fabricated on chip. Moreover, because of component tolerances, $f_{0}$ may require tuning (via $R_{1}$ ), and will drift with temperature because so do $R_{1}$ and $C_{2}$.
(b) By Eq. (5.86) we have

$$
\frac{C_{2}}{C_{1}}=\frac{f_{S}}{2 \pi f_{0}}=\frac{10^{6}}{2 \pi 10^{4}}=15.9
$$

Arbitrarily pick $C_{1}=0.5 \mathrm{pF}$, so $C_{2}=7.958 \mathrm{pF}$, for a total capacitance of less than 10 pF , which we can readily fabricate on chip.

### Discrete-Time Considerations

The SC integrator is a discrete-time circuit because the current between the input source and the op amp flows in the form of charge packets. (Conversely, the $R C$ integrator is a continuous-time circuit because so is the current flowing via $R_{1}$.) We now wish to investigate how charge discretization affects the transfer function of the SC integrator compared to its $R C$ counterpart. To this end we use the PSpice circuit of Fig. 5.61 and turn our attention to the waveforms of Fig. 5.62. As shown, $C_{1}$ switches back and forth between $v_{I}$ and the op amp's virtual ground $(0 \mathrm{~V})$ at a frequency of $f_{S}=10 \mathrm{MHz}$, so we divide the time axis into intervals of $T_{S}=1 / f_{S}=1 / 10^{7}=100 \mathrm{~ns}$ each. For $v_{I}>0, C_{1}$ 's charge is dumped into $C_{2}$, causing a negative-going step in $v_{0}$. Conversely, for $v_{I}<0$, charge is pulled out of $C_{2}$, yielding a positive-going step in $v_{O}$. Of particular significance are the falling edges of the $v_{G 1}$ pulse train because these are the instants at which $C_{1}$, after having been fully charged to $v_{l}$, is ready to be discharged into $C_{2}$. Labeling these instants sequentially as $\ldots n-1, n, n+1 \ldots$
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-046.jpg?height=395&width=849&top_left_y=218&top_left_x=444)

FIGURE 5.61 PSpice circuit to investigate the SC integrator in the time domain.
we can say that the change experienced by $v_{O}$ from the instant $n-1$ to the instant $n$ is set by the charge $C_{1} v_{I}(n-1)$ accumulated in $C_{1}$ at the instant $n-1$ according to

$$
\begin{equation*}
v_{O}(n)-v_{O}(n-1)=\frac{-C_{1} v_{l}(n-1)}{C_{2}} \tag{5.87}
\end{equation*}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-046.jpg?height=1110&width=1529&top_left_y=969&top_left_x=109)

FIGURE 5.62 Waveforms of the PSpice circuit of Fig. 5.61.

This discrete-time sequence is best investigated via the Fourier transforms $V_{i}(j \omega)$ and $V_{o}(j \omega)$. A well-known property of these transforms states that delaying a signal by one clock period $T_{S}$ is equivalent to multiplying its Fourier transform by $\exp \left(-j \omega T_{S}\right)$. This means that Eq. (5.87) transforms into

$$
V_{o}(j \omega)-V_{o}(j \omega) e^{-j \omega T_{s}}=-\frac{C_{1}}{C_{2}} V_{i}(j \omega) e^{-j \omega T_{s}}
$$

Collecting and simplifying we get

$$
V_{o}(j \omega)=-\frac{C_{1}}{C_{2}} V_{i}(j \omega) \frac{e^{-j \omega T_{s}}}{1-e^{-j \omega T_{s}}}=-\frac{C_{1}}{C_{2}} V_{i}(j \omega) \frac{e^{-j \omega T_{s} / 2}}{e^{j \omega T_{s} / 2}-e^{-j \omega T_{s} / 2}}
$$

Letting $\omega=2 \pi f, T_{S}=1 / f_{S}$, and using the identity $\sin x=\left(e^{x}-e^{-x}\right) / 2 j$ we get, after some algebra,

$$
\begin{equation*}
H_{S C}(j f)=\frac{V_{o}(j f)}{V_{i}(j f)}=-\frac{1}{j f / f_{0}} \times \frac{\pi f / f_{S}}{\sin \left(\pi f / f_{S}\right)} \times e^{-j \pi f / f_{s}} \tag{5.88}
\end{equation*}
$$

where again

$$
\begin{equation*}
f_{0}=\frac{1}{2 \pi} \frac{C_{1}}{C_{2}} f_{S} \tag{5.89}
\end{equation*}
$$

We observe that in the limit $f \ll f_{S}$ we have $H_{S C}(j f) \rightarrow H_{R C}(j f)$, that is, the $S C$ integrator approximates the $R C$ integrator. Physically this makes sense because for $f_{S} \gg f$ charge transfer can be regarded as a continuous process. Otherwise, $H_{S C}(j f)$ will deviate from $H_{R C}(j f)$ by the magnitude and phase errors

$$
\begin{equation*}
\varepsilon_{m}(f)=\frac{\pi f / f_{S}}{\sin \left(\pi f / f_{S}\right)}-1 \quad \varepsilon_{\phi}(f)=-180^{\circ}\left(f / f_{S}\right) \tag{5.90}
\end{equation*}
$$

Figure 5.63 compares the transfer function magnitudes for the case $f_{S}=10 f_{0}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-047.jpg?height=456&width=650&top_left_y=1573&top_left_x=201)

FIGURE 5.63 Comparing the transfer functions of the $R C$ and $S C$ integrators.

EXAMPLE 5.16 (a) Calculate the deviation of $H_{S C}(j f)$ from $H_{R C}(j f)$ in Fig. 5.63 at $f=f_{0}$ and at $f=2 f_{0}$. Compare and comment.
(b) Repeat, but for the circuit of Fig. 5.61. Compare with (a) and comment.

### Solution

(a) In Fig. 5.63 we have $f_{0} / f_{S}=1 / 10$, so Eq. (5.90) gives $\varepsilon_{m}\left(f_{0}\right)=(\pi / 10) /$ $\sin (\pi / 10)-1=1.0166-1=1.66 \%$ and $\varepsilon_{\phi}\left(f_{0}\right)=-180 / 10=-18^{\circ}$. Similarly, $\varepsilon_{m}\left(2 f_{0}\right)=6.9 \%$ and $\varepsilon_{\phi}\left(2 f_{0}\right)=-36^{\circ}$, indicating a doubling in $\varepsilon_{\phi}$ but a much greater increase in $\varepsilon_{m}$.
(b) By Eq. (5.89) the circuit of Fig. 5.61 has $f_{0} / f_{S}=\left(C_{1} / C_{2}\right) /(2 \pi)=(10 / 100) /$ $(2 \pi)=1 / 62.83$, so we now get $\varepsilon_{m}\left(f_{0}\right)=0.0417 \%$ and $\varepsilon_{\phi}\left(f_{0}\right)=-2.86^{\circ}$. Also, $\varepsilon_{m}\left(2 f_{0}\right)=0.167 \%$ and $\varepsilon_{\phi}\left(2 f_{0}\right)=-5.73^{\circ}$. The deviations are now appreciably smaller because the ratio $f_{0} / f_{S}$ is $2 \pi$ times as small.

### Autozeroing Techniques

Because of component mismatches stemming from fabrication process variations, a differential amplifier such as an op amp or a voltage comparator exhibit some input offset voltage $V_{O S}$. As shown in Fig. 5.64a, we can visualize a real-life amplifier as consisting of an ideal, offsetless amplifier but equipped with an internal voltage source $V_{O S}$ in series with one of its inputs to account for the internal imbalances (it doesn't matter which input, as $V_{O S}$ is unpredictable both in magnitude and polarity). The presence of $V_{O S}$ is likely to be a serious drawback in precision applications, so it is desirable to automatically compensate for its presence, a task referred to as autozeroing. CMOS circuits utilize a capacitor $C$ as in Fig. 5.64b to store a voltage of equal magnitude but opposite polarity as $V_{O S}$. Being in series, the two voltages cancel each other out, giving the appearance of offset-free behavior. The amplifier alternates between two modes of operation known as the autozeroing and the sampling mode:

- During the autozero phase depicted in Fig. 5.65a, switches $S_{1}$ and $S_{2}$ disconnect the amplifier from nodes $v_{P}$ and $v_{N}$ while $S_{4}$ configures it as a unity-gain voltage follower. The circuit now buffers its own internal offset voltage $V_{O S}$ to $C$ via $S_{3}$, so with $S_{5}$ closed $C$ will charge to whatever value of $V_{O S}$ the amplifier exhibits at that moment. (For this scheme to work, the amplifier must be unity-gain stable.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-048.jpg?height=309&width=905&top_left_y=1696&top_left_x=440)

FIGURE 5.64 (a) Modeling the input offset voltage $V_{\text {os }}$ of a differential amplifier, and (b) nulling the effect of $V_{\text {OS }}$ by using a capacitor to store a corrective voltage of equal magnitude but opposite polarity as $V_{O S}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-049.jpg?height=572&width=1496&top_left_y=207&top_left_x=196)

FIGURE 5.65 Switch positions during the (a) autozeroing mode and (b) during the sampling mode.

If necessary, a suitable frequency-compensation network must be switched into the amplifier during this phase.)

- Once we have stored $V_{O S}$ in the capacitor, we open switches $S_{3}$ through $S_{5}$ as in Fig. $5.65 b$ to place the capacitor voltage in series with the internal offset voltage so the two cancel each other out. At the same time, we close $S_{1}$ and $S_{2}$ to reconnect the amplifier to nodes $v_{P}$ and $v_{N}$ for normal operation, such as negativefeedback op amp operation or voltage comparison. The scheme shown is popular especially with voltage comparators, where the circuit is autozeroed before each comparison instance. Should $V_{O S}$ drift with temperature or should $C$ experience leakage between consecutive comparisons, autozeroing is renewed each time.

### Transmission Gates

The $n$ MOSFET switches of Fig. 5.57 will close convincingly only as long as the voltages at the source and drain terminals are sufficiently lower than $V_{H}$. As $v_{1}$ and $v_{2}$ increase, the overdrive voltages are reduced, thus increasing the channel resistances. If $v_{1}$ or $v_{2}$ rise above $V_{H}-V_{t n}$, the FET won't even turn on and the switch will therefore fail to close. If we were to use $p$ MOSFET switches instead, they would work well for $v_{1}$ and $v_{2}$ sufficiently high, but fail to turn on if $v_{1}$ or $v_{2}$ drop below $V_{L}+\left|V_{t p}\right|$, just the opposite of $n$ MOSFETs. The circuit of Fig. 5.66, popularly known as transmission gate, combines the best of both by using a pair of complementary FETs connected in parallel and driven in anti-phase.

When the switch-enable control $E$ is low $\left(E=V_{S S}\right.$ ) and its complement $\bar{E}$ is therefore high $\left(\bar{E}=V_{D D}\right)$, both FETs are off. Driving $E$ high and thus $\bar{E}$ low will tend to turn on both FETs. In fact, so long as $V_{S S}+\left|V_{t p}\right|<v<V_{D D}-V_{t n}$, both FETs are indeed on, ensuring a net transmission-gate resistance $r_{T G}$ that, for the case of matched devices with $k_{n}=k_{p}=k$ and $V_{t n}=-V_{t p}=V_{t}$, is such that

$$
r_{T G}=r_{D S n} / / r_{S D_{p}}=\frac{1}{k v_{O V n}} / / \frac{1}{k v_{O V_{p}}}=\frac{1}{k\left(V_{D D}-v-V_{t}\right)} / / \frac{1}{k\left(v-V_{S S}-V_{t}\right)}
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-050.jpg?height=572&width=1339&top_left_y=198&top_left_x=312)

FIGURE 5.66 (a) Transmission gate and (b) its zero-current resistance $r_{\text {TG }}$, along with the individual channel resistances $r_{D S n}$ and $r_{\text {SDP }}$.

Expanding and simplifying gives

$$
\begin{equation*}
r_{T G}=\frac{1}{k\left(V_{D D}-V_{S S}-2 V_{t}\right)} \tag{5.91}
\end{equation*}
$$

Under the assumption of matched FETs, $r_{T G}$ is independent of $v$ over the given interval (see Fig. 5.66b). If $v$ is driven outside the above interval, one of the FETs will go off but the other will become even more conductive, thus ensuring a low overall resistance over the entire range $V_{S S}<v<V_{D D}$.

### Stray Capacitances and Charge Injection

Returning to Fig. 5.56, we observe the presence of a number of stray or parasitic capacitances:

- The top and bottom plates of $C$ form themselves stray capacitances with the substrate, here denoted as $C_{t o p}$ and $C_{b t m}$. While $C_{b t m}$ is typically $10 \%-20 \%$ of $C$, $C_{\text {top }}$ is considerably smaller.
- The sides of the gate of the MOSFET switch form the overlap capacitances $C_{O V}$ with the source and drain regions, and these regions form in turn the diffusion capacitances $C_{j}$ with the substrate.
- Additionally, we observe that in order to turn on/off the $n$ MOSFET we need to build up or remove the electron charge $Q_{n}$ in the channel (see Example 3.3). $Q_{n}$ enters/exits the channel through the source and drain regions.

Depending on circuit topology, the stray capacitances may interfere with the intended charge transfer and cause errors. In the switch/capacitor example of Fig. 5.67 the bottom-plate capacitance $C_{b t m}$ plays no role because shorted to ground. Moreover, the overlap and junction capacitances associated with the source region, relabeled as $C_{g s}$ and $C_{s b}$, affect the input source $v_{1}$ but have no impact on the useful capacitance $C$. However, the remaining parasitics do play a role. Specifically, $C_{t o p}$ and $C_{d b}$ are in parallel with $C$, thus yielding a total capacitance $C_{t o t}=C_{d b}+C_{t o p}+C$. Moreover,
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-051.jpg?height=490&width=1084&top_left_y=220&top_left_x=200)

FIGURE 5.67 Showing the capacitive parasitics of a simple switch-capacitor pair (the capacitances shown in shaded form have no effect in this particular circuit).
$C_{g d}$ couples the clock signal $v_{G}$ to $C_{\text {tot }}$, a phenomenon referred to as clock feedthrough. Additionally, turning the switch off/on causes a fraction $\alpha(0<\alpha<1)$ of the total electron charge $Q_{n}$ in the channel to flow to/from $C_{\text {tot }}$, a phenomenon referred to as charge injection.

We are particularly interested in the trailing edge of $v_{G}$ because at this instant, denoted as $t_{O F F}$, we witness (a) the removal of the charge $Q_{g d}$ from $C_{t o t}$ and (b) the injection of the charge $\alpha Q_{n}$ into $C_{\text {tot }}$ (see Fig. 5.68a). Since the electron charge $Q_{n}$ is negative, the effect is equivalent to removing the positive charge $\alpha\left|Q_{n}\right|$ from $C_{t o t}$, so the two undesired charge transfers reinforce each other. As a result, $v_{O}$ will be affected by an error of $\Delta v_{O} \cong-\left(Q_{g d}+\alpha\left|Q_{n}\right|\right) / C_{\text {tot }}$, where $C_{g d} \ll C_{\text {tot }}$ has been assumed.

One way to reduce the above error is to deliberately introduce an opposing clock feedthrough and charge injection via a dummy transistor $M_{2}$ driven in anti-phase with respect to $M_{1}$ (see Fig. 5.68b). With proper selection of $M_{2}$ 's channel width $W_{2}, M_{2}$ 's feedthrough and injection will approximately cancel out those of $M_{1}$, resulting in a much smaller error in $v_{o}$ (see Problem 5.50). Alternatively, we can implement the switch with a transmission gate and adjust the $W / L$ ratios of the $n$ FET and $p$ FET so as to make their undesirable charge transfers approximately cancel each other out.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-051.jpg?height=410&width=1321&top_left_y=1594&top_left_x=199)

FIGURE 5.68 (a) Charge transfer $\left(Q_{g d}\right)$ and charge injection $\left(Q_{n}\right)$ at the instant $t_{\text {OFF }}$ in which the $M_{1}$ switch is turned off. (b) Compensation via a second dummy transistor $M_{2}$ driven in anti-phase with respect to $M_{1}$.

### Stray-Insensitive Integrators

With clever design techniques it is often possible to stave off errors due to parasitic capacitances. Figure $5.69 a$ shows a popular modification to the $S C$ integrator of Fig. 5.60 b to render it stray insensitive. Flipping the switches down completely discharges $C_{1}$, while flipping the switches up charges $C_{1}$ to $V_{i}$, so for $V_{i}>0$ charge transfers into the summing junction of the op amp, while for $V_{i}<0$ charge transfers out of the summing node. The situation is similar to that of Fig. 5.60b, so the circuit is an inverting-type SC integrator.

Turning next to Fig. $5.69 b$, we observe that with the switches in the position shown, $C_{1}$ charges to $V_{i}$, and that commutating the switches transfers charge out of the summing junction if $V_{i}>0$, and into the summing junction if $V_{i}<0$, just the opposite of Fig. 5.69a. So, the circuit is a noninverting-type SC integrator, obtained from that of Fig. 5.69a by a mere clock-phase change for the second SPDT switch.
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-052.jpg?height=295&width=579&top_left_y=867&top_left_x=450)
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-052.jpg?height=259&width=565&top_left_y=866&top_left_x=1068)
(b)

FIGURE 5.69 Stray-insensitive SC integrators: (a) inverting type and (b) noninverting type.

To appreciate the stray insensitivity of the above integrators, consider Fig. 5.70, where the total stray capacitances (top/bottom parasitics plus FET parasitics) associated of the two plates of $C_{1}$ have been denoted as $C_{X}$ and $C_{Y}$. Since $C_{X}$ is switched between ground and the op amp's virtual-ground input, it remains permanently discharged, so the circuit is insensitive to $C_{X} . C_{Y}$ does intervene in the transfer of charge between $V_{i}$ and ground, but without interfering with $C_{1}$, so the circuit is insensitive also to $C_{Y}$. The price for stray insensitivity is a more complex switch system (four FETs instead of two), but this price is certainly worthwhile!
![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-052.jpg?height=391&width=968&top_left_y=1742&top_left_x=448)

## APPENDIX 5A

SPICE Macro-Models

Used judiciously, computer simulators such as SPICE can be very powerful aids both to the designer and the user of analog ICs. The IC designer will simulate the product under development at the transistor level, using device parameters derived from direct measurements of the fabrication process, usually proprietary. The IC user, on the other hand, is more interested in a behavioral simulation of the IC, without having to worry about too many internal details. Besides, the transistor-level simulations of complex system comprising a multitude of individual ICs may be excessively time consuming, not to mention the fact that the numerical calculations may fail to converge.

To alleviate the user's task, IC manufacturers provide SPICE macro-models that can be downloaded directly from their websites for immediate use. PSpice's library contains the macro-models of a number of popular ICs such as the 741 op amp . Its netlist is as follows:

```
* connections:
*
*
*
* | | | | output
* | | | | |
.subckt uA741 1 2 3 4 5
*
```

| c1 | 11 | 12 | 8.661E-12 |  |
| :---: | :---: | :---: | :---: | :---: |
| c2 | 6 | 7 | 30.00E-12 |  |
| dc | 5 | 53 | $d x$ |  |
| de | 54 | 5 | $d x$ |  |
| dlp | 90 | 91 | $d x$ |  |
| dln | 92 | 90 | $d x$ |  |
| dp | 4 | 3 | $d x$ |  |
| egnd | 99 | 0 | poly(2) $(3,0)(4,0) 0.5$. 5 |  |
| fb | 7 | 99 | poly(5) vb vc ve vlp vln 0 10.61E6 | -10E6 10E6 |
| + |  |  | 10E6 -10E6 |  |
| ga | 6 | 0 | 1112 188.5E-6 |  |
| gcm | 0 | 6 | 1099 5.961E-9 |  |
| iee | 10 | 4 | dc 15.16E-6 |  |
| hlim | 90 | 0 | vlim 1K |  |
| q1 | 11 | 2 | 13 qx |  |
| q2 | 12 | 1 | 14 qx |  |
| r2 | 6 | 9 | 100.0E3 |  |
| rc1 | 3 | 11 | 5.305 E 3 |  |
| rc2 | 3 | 12 | 5.305 E 3 |  |
| re1 | 13 | 10 | 1.836E3 |  |
| re2 | 14 | 10 | 1.836E3 |  |

![](https://cdn.mathpix.com/cropped/2024_11_07_10da0ce153b00c68dc1dg-054.jpg?height=544&width=701&top_left_y=207&top_left_x=450)

Far from including all the 24 BJTs of Fig. 5.1, the macro-model uses only two BJTs (q1 and q2) to emulate the input-stage front end, and a number of other simpler components (resistors, capacitors, diodes, and dependent/independent sources) to mimic op amp behavior at a macroscopic level (gain, output saturation, and dynamic characteristics such as input/output impedances, frequency response, and slew-rate limiting, to be covered in Chapter 6). Compared to the transistor-level simulation by the IC designer, the macro-model-level simulation by the user is generally much faster. However, both the designer and the user need to be aware that all models come with inherent limitations, so the results of any simulation need to be properly evaluated and eventually verified in the lab. (For instance, a notorious limitation of many op amp macro-models is their failure to mimic the input noise characteristics correctly.)
