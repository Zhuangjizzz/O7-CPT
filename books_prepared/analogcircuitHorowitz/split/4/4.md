# CHAPTER4 OPERATIONAL AMPLIFIERS

## 4.1 Introduction to op-amps - the "perfect component"

In the previous three chapters we learned about circuit design with "discrete components," both active and passive. Our basic building blocks were transistors, both bipolar (BJT) and field-effect (FET), along with the resistors, capacitors, and other components that are needed to set bias, couple and block signals, create load impedances, and so on.

With those tools we have gone quite far. We've learned how to design simple power supplies, signal amplifiers and followers, current sources, dc and differential amplifiers, analog switches, power drivers and regulators, and even some rudimentary digital logic.

But we've also learned to struggle with imperfections. Voltage amplifiers suffer from nonlinearity (a groundedemitter amplifier with a 1 mV input signal has $\sim 1 \%$ distortion), which you can trade off against voltage gain (by adding emitter degeneration); differential amplifiers have input unbalance, typically tens of millivolts (with bipolar transistors), ten times more with discrete junction-FETs (JFETs); in bipolar design you have to worry about input current (often substantial), and the ever-present $V_{\mathrm{BE}}$ and its variation with temperature; in FET design you trade absence of input current for unpredictability of $V_{G S}$; and so on.

We've seen hints that things can be better, in particular the remarkable linearizing effects of negative feedback (\$2.5.3), and its ability to make overall circuit performance less dependent on component imperfections. It is negative feedback that gives the emitter-degenerated amplifier its linearity advantage over the grounded-emitter amplifier (at the cost of voltage gain). And in the high-loop-gain limit, negative feedback promises circuit performance largely independent of transistor imperfections.

Promised, but not yet delivered: the high-gain amplifier blocks we need to get high loop gain in a feedback arrangement still involve substantial design efforts - the hallmark of complex circuits implemented with discrete (as opposed to integrated) components.

With this chapter we enter the promised land! The opamp is, essentially, a "perfect part": a complete integrated amplifier gain block, best thought of as a dc-coupled differential amplifier with single-ended output, and with extraordinarily high gain. It also excels in precise input symmetry and nearly zero input current. Op-amps are designed as "gain engines" for negative feedback, with such high gain that the circuit performance is set almost entirely by the feedback circuitry. Op-amps are small and inexpensive, and they should be the starting point for nearly every analog circuit you design. In most op-amp circuit designs we're in the regime where they are essentially perfect: with them we will learn to build nearly perfect amplifiers, current sources, integrators, filters, regulators, current-tovoltage converters, and a host of other modules.

Op-amps are our first example of integrated circuits many individual circuit elements, such as transistors and resistors, fabricated and interconnected on a single "chip" of silicon. ${ }^{1}$ Figure 4.1 shows some IC op-amp packaging schemes.

### 4.1.1 Feedback and op-amps

We first met negative feedback in Chapter 2, where we saw that the process of coupling the output back, in such a way as to cancel some of the input signal, improved characteristics such as linearity, flatness of response, and predictability. As we saw quantitatively, the more negative feedback that is used, the less the resultant amplifier characteristics depend on the characteristics of the open-loop (no-feedback) amplifier, ultimately depending only on the properties of the feedback network itself. Operational amplifiers are typically used in this high-loop-gain limit, with open-loop voltage gain (no feedback) of a million or so.

A feedback network can be frequency-dependent, to produce an equalization amplifier (for example the

[^16]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-024.jpg?height=603&width=795&top_left_y=206&top_left_x=123)

Figure 4.1. Op-amps (and other linear ICs) come in a bewildering variety of "packages," most of which are represented in this photograph. Top row, left to right: 14-pin plastic dual in-line package (DIP), 8-pin plastic DIP ("mini-DIP"). Middle row: 14-pin thin-shrink small-outline package (TSSOP), 8-pin small-outline package (SO8), 8-pin TSSOP (" $\mu \mathrm{MAX}$ "). Bottom row: 5 -pin small-outline transistor package (SOT23), 6-ball chip-scale package (CSP - top and bottom views), 5 -pin SC-70. The 14-pin packages hold quad opamps (i.e., four independent op-amps), the 8 -pin packages hold duals, and the rest are singles. (TSSOP and smaller packages courtesy of Travis Eichhorn, Maxim Semiconductor.)
treble and bass "tone control" stage of amplification that you find in most audio systems); or it can be amplitudedependent, producing a nonlinear amplifier (a popular example is a logarithmic amplifier, built with feedback that exploits the logarithmic $V_{\mathrm{BE}}$ versus $I_{\mathrm{C}}$ of a diode or transistor). It can be arranged to produce a current source (nearinfinite output impedance) or a voltage source (near-zero output impedance), and it can be connected to generate very high or very low input impedance. Speaking in general terms, the property that is sampled to produce feedback is the property that is improved. Thus, if you feed back a signal proportional to the output current, you will generate a good current source.

As we remarked in $\S 2.5 .1$, feedback can be arranged intentionally to be positive, for example to make an oscillator, or, as we'll see later, to make a Schmitt trigger circuit. That's the good kind of positive feedback. The bad kind occurs, uninvited (and unwelcome), when a negativefeedback circuit is burdened with sufficient accumulated phase shifts at some frequency to produce overall positive feedback, and oscillations. This can occur for a variety of reasons. We'll discuss this important subject, and see how to prevent unwanted oscillations by frequency compensation, the topic of $\S 4.9$ at the end of the chapter.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-024.jpg?height=116&width=216&top_left_y=223&top_left_x=1267)

Figure 4.2. Op-amp symbol.

Having made these general comments, we now look at a few feedback examples with op-amps.

### 4.1.2 Operational amplifiers

The operational amplifier is a very high-gain dc-coupled differential amplifier with a single-ended output. You can think of the classic long-tailed pair (§2.3.8) with its two inputs and single output as a prototype, although real opamps have much higher gain (typically $10^{5}$ to $10^{6}$ ) and lower output impedance, and they allow the output to swing through most or all of the supply range (you often use a split supply, for example $\pm 5 \mathrm{~V}$ ). Operational amplifiers are available in literally thousands of types, with the universal symbol shown in Figure 4.2, where the $(+)$ and $(-)$ inputs do as expected: the output goes positive when the noninverting input $(+)$ goes more positive than the inverting input $(-)$, and vice versa. The $(+)$ and $(-)$ symbols don't mean that you have to keep one positive with respect to the other, or anything like that; they just tell you the relative phase of the output (which is important to keep negative feedback negative). Using the words "noninverting" and "inverting," rather than "plus" and "minus" helps avoid confusion. Power-supply connections are frequently not displayed, and there is no ground terminal. Operational amplifiers have enormous voltage gain, and they are never (well, hardly ever) used without feedback. Think of an opamp as fodder for feedback. The open-loop gain is so high that, for any reasonable closed-loop gain, the characteristics depend on only the feedback network. Of course, at some level of scrutiny this generalization must fail. We will start with a naïve view of op-amp behavior and fill in some of the finer points later, when we need to.

There are literally thousands of different op-amps available, offering various performance tradeoffs that we will explain later (look ahead to Tables 4.2a,b, 5.5, or 8.3 if you want to see a small sample of what's available). A very good all-around performer is the popular LF411 ("411" for short), originally introduced by National Semiconductor. Like many op-amps, it is a wee beastie packaged in the so-called mini-DIP (dual in-line package) or SOIC (smalloutline IC), and it looks as shown in Figure 4.3. It is inexpensive (less than \$1) and easy to use; it comes in an improved grade (LF411A) and also in a version containing
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-025.jpg?height=410&width=818&top_left_y=221&top_left_x=204)

Figure 4.3. Mini-DIP and SOIC packages.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-025.jpg?height=432&width=682&top_left_y=748&top_left_x=276)

Figure 4.4. Pin connections for LF411 op-amp in 8-pin DIP.
two independent op-amps (LF412, called a "dual" opamp). We will adopt the LF411/LF412 throughout this chapter as our "standard" op-amp, and we recommend it (or perhaps the versatile LMC6482) as a good starting point for your circuit designs.

Inside the 411 is a piece of silicon containing 24 transistors (21 BJTs, 3 FETs), 11 resistors, and 1 capacitor. (You can look ahead to Figure 4.43 on page 243 to see a simplified circuit diagram of its innards.) The pin connections are shown in Figure 4.4. The dot in the upper-lefthand corner, or notch at the end of the package, identifies the end from which to begin counting the pin numbers. As with most electronic packages, you count pins counterclockwise, viewing from the top. The "offset null" terminals (also known as "balance" or "trim") have to do with correcting (externally) the small asymmetries that are unavoidable when making the op-amp. More about this later in the chapter.

### 4.1.3 The golden rules

Here are the simple rules for working out op-amp behavior with external negative feedback. They're good enough for almost everything you'll ever do.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-025.jpg?height=284&width=427&top_left_y=220&top_left_x=1261)

Figure 4.5. Inverting amplifier.
First, the op-amp voltage gain is so high that a fraction of a millivolt between the input terminals will swing the output over its full range, so we ignore that small voltage and state golden rule I.
I. The output attempts to do whatever is necessary to make the voltage difference between the inputs zero.

Second, op-amps draw very little input current (about 50 pA for the inexpensive JFET-input LF411, and often less than a picoamp for MOSFET-input types); we round this off, stating golden rule II.
II. The inputs draw no current.

One important note of explanation: golden rule I doesn't mean that the op-amp actually changes the voltage at its inputs. It can't do that. (How could it, and be consistent with golden rule II?) What it does is "look" at its input terminals and swing its output terminal around so that the external feedback-network brings the input differential to zero (if possible).

These two rules get you quite far. We illustrate with some basic and important op-amp circuits, and these will prompt a few cautions listed in §4.2.7.

## 4.2 Basic op-amp circuits

### 4.2.1 Inverting amplifier

Let's begin with the circuit shown in Figure 4.5. The analysis is simple, if you remember your golden rules.

1. Point $B$ is at ground, so rule I implies that point $A$ is also.
2. This means that (a) the voltage across $R_{2}$ is $V_{\text {out }}$ and (b) the voltage across $R_{1}$ is $V_{\text {in }}$.
3. So, using rule II, we have $V_{\text {out }} / R_{2}=-V_{\text {in }} / R_{1}$.

In other words, the voltage gain ( $G_{V} \equiv V_{\text {out }} / V_{\text {in }}$ ) is

$$
\begin{equation*}
G_{V}=-R_{2} / R_{1} \tag{4.1}
\end{equation*}
$$

Later you will see that it's sometimes better not to ground $B$ directly, but through a resistor - but don't worry about that now.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-026.jpg?height=297&width=460&top_left_y=219&top_left_x=298)

Figure 4.6. Noninverting amplifier.

Our analysis seems almost too easy! In some ways it obscures what is actually happening. To understand how feedback works, just imagine some input level, say +1 volt. For concreteness, imagine that $R_{1}$ is 10 k and $R_{2}$ is 100 k . Now, suppose the output decides to be uncooperative, and sits at zero volts. What happens? $R_{1}$ and $R_{2}$ form a voltage divider, holding the inverting input at +0.91 volts. The op-amp sees an enormous input unbalance, forcing the output to go negative. This action continues until the output is at the required -10.0 volts, at which point both opamp inputs are at the same voltage, namely ground. Similarly, any tendency for the output to go more negative than -10.0 volts will pull the inverting input below ground, forcing the output voltage to rise.

What is the input impedance? Simple. Point $A$ is always at zero volts (it's called a virtual ground). So $Z_{\text {in }}=R_{1}$. At this point you don't yet know how to figure the output impedance; for this circuit, it's a fraction of an ohm.

Note that this analysis is true even for dc - it's a dc amplifier. So if you have a signal source that has a dc offset from ground (collector of a previous stage, for instance), you may want to use a coupling capacitor (sometimes called a blocking capacitor, since it blocks dc but couples the signal). For reasons you will see later (having to do with departures of op-amp behavior from the ideal), it is usually a good idea to use a blocking capacitor if you're interested only in ac signals anyway.

This circuit is known as an inverting amplifier. Its one undesirable feature is the low input impedance, particularly for amplifiers with large (closed-loop) voltage gain, where $R_{1}$ tends to be rather small. That is remedied in the next circuit (Figure 4.6).

### 4.2.2 Noninverting amplifier

Consider Figure 4.6. Again, the analysis is simplicity itself:

$$
V_{A}=V_{\mathrm{in}}
$$

But $V_{A}$ comes from a voltage divider: $V_{A}=V_{\text {out }} R_{1} /\left(R_{1}+\right.$ $R_{2}$ ). Set $V_{A}=V_{\text {in }}$, and you get a voltage gain of

$$
\begin{equation*}
G_{V}=1+R_{2} / R_{1} \tag{4.2}
\end{equation*}
$$

This is a noninverting amplifier. In the approximation we are using, the input impedance is infinite (with the JFETinput 411 it would be $10^{12} \Omega$ or more; a BJT-input op-amp will typically exceed $10^{8} \Omega$ ). The output impedance is still a fraction of an ohm. As with the inverting amplifier, a detailed look at the voltages at the inputs will convince you that it works as advertised.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-026.jpg?height=774&width=595&top_left_y=628&top_left_x=1080)

Figure 4.7. Amplifiers for ac signals: A. ac-coupled noninverting amplifier, B. blocking capacitor rolls off the gain to unity at dc.

#### A. An ac amplifier

The basic noninverting amplifier, like the inverting amplifier earlier, is a dc amplifier. If the signal source is accoupled, you must provide a return to ground for the (very small) input current, as in Figure 4.7A. The component values shown give a voltage gain of 10 and a low-frequency 3 dB point of 16 Hz .

If only ac signals are being amplified, it is often a good idea to "roll off" the gain to unity at dc, especially if the amplifier has large voltage gain, to reduce the effects of finite "input offset voltage" (§4.4.1A). The circuit in Figure 4.7 B has a low-frequency 3 dB point of 17 Hz , the frequency at which the impedance of the capacitor $C_{1}$ equals $R_{1}$, or 2.0 k . Note the large capacitor value required. For noninverting amplifiers with high gain, the capacitor in this ac amplifier configuration may be undesirably large. In that
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-027.jpg?height=226&width=424&top_left_y=221&top_left_x=408)

Figure 4.8. Op-amp follower.
case it may be preferable to omit the capacitor and trim the offset voltage to zero, as we will discuss later. An alternative is to raise $R_{1}$ and $R_{2}$, perhaps using a $T$ network for the latter (Figure 4.66 on page 259).

In spite of its desirable high input impedance, the noninverting amplifier configuration is not necessarily to be preferred over the inverting amplifier configuration in all circumstances. As we will see later, the inverting amplifier puts less demand on the op-amp, and therefore gives somewhat better performance. In addition, its virtual ground provides a handy way to combine several signals without interaction. Finally, if the circuit in question is driven from the (stiff) output of another op-amp, it makes no difference whether the input impedance is 10 k (say) or infinity, because the previous stage has no trouble driving it in either case.

### 4.2.3 Follower

Figure 4.8 shows the op-amp version of an emitter follower. It is simply a noninverting amplifier with $R_{1}$ infinite and $R_{2}$ zero (gain $=1$ ). An amplifier of unity gain is sometimes called a buffer because of its isolating properties (high input impedance, low output impedance).

### 4.2.4 Difference amplifier

The circuit in Figure 4.9A is a difference amplifier (sometimes called a differential amplifier) with gain $R_{2} / R_{1}$. This circuit requires precise resistor matching to achieve high common-mode rejection ratios (CMRR). You may be lucky and find a batch of $100 \mathrm{k} 0.01 \%$ resistors at an electronics flea market or surplus outlet; otherwise you can buy precision resistor arrays, with close matching of ratios and temperature coefficients. ${ }^{2}$ All your difference amplifiers

[^17]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-027.jpg?height=650&width=659&top_left_y=218&top_left_x=1141)

Figure 4.9. Classic difference amplifier: A. Op-amp with matched resistor ratios. B. Integrated version, with uncommitted "sense" and "reference" pins. In the best grade (INA105A) the resistor ratio is matched to better than $0.01 \%$, with a temperature coefficient better than $5 \mathrm{ppm} /{ }^{\circ} \mathrm{C}$.
will have unity gain, but that's easily remedied with further (single-ended) stages of gain. If you can't find good resistors (or even if you can!), you should know that you can buy this circuit as a convenient packaged difference amplifier, with well-matched resistors; examples are the INA105 or AMP03 $(G=1)$, INA106 ( $G=10$ or 0.1 ), and INA117 or AD629 ( $G=1$ with input dividers; input signals to $\pm 200 \mathrm{~V}$ ) from TI/Burr-Brown and Analog Devices (many more are listed in Table 5.7 on page 353). The unitygain INA105 configuration is shown in Figure 4.9B, with its uncommitted "sense" and "reference" pins. You get the classic difference amplifier by connecting sense to the output and ref to ground. But the additional flexibility lets you make all sorts of nifty circuits, such as a precision unitygain inverter, noninverting gain-of-2 amplifier, and noninverting gain-of-0.5 amplifier. We treat difference amplifiers in greater detail in $\S 5.14$.

Exercise 4.1. Show how to make these three circuits with an INA105.

There are, in addition, more sophisticated differential amplifier configurations, known officially as "instrumentation amplifiers"; they are discussed in detail in $\S \S 5.15$ and 5.16, along with a listing in Table 5.8 on page 363.
formance: their best resistor arrays specify worst-case ratio tracking to $0.001 \%$, and tracking temperature coefficient (tempco) to $\pm 0.1 \mathrm{ppm} /{ }^{\circ} \mathrm{C}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-028.jpg?height=348&width=412&top_left_y=219&top_left_x=299)

Figure 4.10. Basic op-amp current source (floating load). $V_{\text {in }}$ might come from a voltage divider, or it could be a signal that varies with time.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-028.jpg?height=619&width=719&top_left_y=719&top_left_x=166)

Figure 4.11. Current source with grounded load and floating power supply.

### 4.2.5 Current sources

The circuit in Figure 4.10 approximates an ideal current source, without the $V_{\mathrm{BE}}$ offset of a transistor current source. Negative feedback results in $V_{\text {in }}$ at the inverting input, producing a current $I=V_{\text {in }} / R$ through the load. The major disadvantage of this circuit is the "floating" load (neither side grounded). You couldn't generate a usable sawtooth wave with respect to ground with this current source, for example. One solution is to float the whole circuit (power supplies and all) so that you can ground one side of the load (Figure 4.11). The circuit in the box is the previous current source, with its power supplies shown explicitly. $R_{1}$ and $R_{2}$ form a voltage divider to set the current. If this circuit seems confusing, it may help to remind yourself that "ground" is a relative concept. Any one point in a circuit could be called ground. This circuit is useful for generating currents into a load that is returned to ground, but it has the disadvantage that the control input is now floating, so you cannot program the output current with an in-
put voltage referenced to ground. In addition, you've got to make sure that the floating power supply is truly floating - for example, you'd have trouble making a microamp dc current source this way if you tried to use a standard wall-plug-powered dc power supply, because capacitance between windings in its transformer would introduce reactive currents, at the 60 Hz line frequency, that might well exceed the desired microamp output current; one possible solution would be to use batteries. Some other approaches to this problem are presented in Chapter 9 (§9.3.14) in the discussion of constant-current power supplies. ${ }^{3}$

#### A. Current sources for loads returned to ground

With an op-amp and external transistor it is possible to make a simple high-quality current source for a load returned to ground; a little additional circuitry makes it possible to use a programming input referenced to ground (Figure 4.12). In the first circuit, feedback forces a voltage $V_{\mathrm{CC}}-V_{\mathrm{in}}$ across $R$, giving an emitter current (and therefore an output current) $I_{E}=\left(V_{\mathrm{CC}}-V_{\mathrm{in}}\right) / R$. There are no $V_{\mathrm{BE}}$ offsets, or their variations with temperature, with $I_{\mathrm{C}}$, with $V_{\mathrm{CE}}$, etc., to worry about. The current source is imperfect (ignoring op-amp errors: $I_{\mathrm{B}}, V_{\mathrm{OS}}$ ) only insofar as the small base current may vary somewhat with $V_{\mathrm{CE}}$ (assuming the op-amp draws no input current), not too high a price to pay for the convenience of a grounded load; a Darlington for $Q_{1}$ would reduce this error considerably. This error comes about, of course, because the op-amp stabilizes the emitter current, whereas the load sees the collector current. A variation of this circuit, using a MOSFET instead of a bipolar transistor, avoids this problem altogether, since FETs draw no dc gate current (but large power MOSFETs have plenty of input capacitance, which can cause problems; see the comment at the end of this subsection).

With this circuit the output current is proportional to the voltage drop below $V_{\mathrm{CC}}$ applied to the op-amp's noninverting input; in other words, the programming voltage is referenced to $V_{\mathrm{CC}}$, which is fine if $V_{\text {in }}$ is a fixed voltage generated by a voltage divider, but an awkward situation if an external input is to be used. This is remedied in the second circuit, in which a similar current source with an npn transistor is used to convert an input voltage (referenced to ground) to a $V_{\mathrm{CC}}$-referenced input to the final current

[^18]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-029.jpg?height=1184&width=792&top_left_y=168&top_left_x=198)

Figure 4.12. Current sources for grounded loads that don't require a floating power supply. The op-amps may need to have rail-to-rail input and output capability (RRIO); see text.
source; for the latter we've used a $p$-channel MOSFET for variety (and to eliminate the small base-current error you get with bipolar transistors). Op-amps and transistors are inexpensive. Don't hesitate to use a few extra components to improve performance or convenience in circuit design.

One important note about these circuits: at low output currents the voltage across the emitter (or source) resistors may be quite small, which means that the op-amps must be able to operate with their inputs near or at the positive supply voltage. For example, in the circuit of Figure 4.12B $\mathrm{IC}_{2}$ needs to operate with its inputs close to the positive supply rail. Don't assume that a given op-amp will do this, without explicit permission from the datasheet! The LF411's datasheet waffles a bit on this, but grudgingly admits that it will work, albeit with degraded performance, with the inputs at the positive rail. (It will not, however, work down to the negative rail; but with $\mathrm{IC}_{1}$ powered from split supply voltages there's no problem there.) By contrast, opamps like the LMC7101 or LMC6482 guarantee proper
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-029.jpg?height=552&width=799&top_left_y=178&top_left_x=1075)

Figure 4.13. FET-bipolar current source suitable for high currents.
operation all the way to (and a bit beyond) the positive rail (see the "Swing to supplies?" column in Table 4.2a on page 271). Alternatively, the op-amp could be powered from a separate $V_{+}$voltage higher than $V_{\mathrm{CC}}$.
Exercise 4.2. What is the output current in the last circuit for a given input voltage $V_{\text {in }}$ ? (Did we get it right in the figure?)

Figure 4.13 shows an interesting variation on the op-amp-transistor current source. Although you can get plenty of current with a simple power MOSFET, the high interelectrode capacitances of high-current FETs may cause problems. When a relatively low-current MOSFET ${ }^{4}$ is combined with a high-current $n p n$ power transistor, this circuit has the advantage of zero base current error (which you get with FETs) along with much smaller input capacitance. In this circuit, which is analogous to the "complementary Darlington" (or Sziklai circuit; see §2.4.2A), bipolar transistor $Q_{2}$ kicks in when the output current exceeds about 20 mA .

Lest we leave the wrong impression, we emphasize that the simpler MOSFET-only circuit (in the manner of Figure 4.12B) is a preferable configuration, given the major drawback of power BJTs, namely their susceptibility to "second breakdown" and consequent limit on safe operating area (as we saw in $\S 3.5 .1 \mathrm{~B}$, see particularly Figure 3.95). Big power MOSFETs have large input capacitance, so in such a circuit you should use a network like Figure 4.13's $R_{3} C_{1}$ to prevent oscillation.

#### B. Howland current source

Figure 4.14 shows a nice "textbook" current source. If the resistors are chosen so that $R_{3} / R_{2}=R_{4} / R_{1}$, then it can be shown that $I_{\text {load }}=-V_{\text {in }} / R_{2}$.

Exercise 4.3. Show that the preceding result is correct.

[^19]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-030.jpg?height=389&width=699&top_left_y=221&top_left_x=176)

Figure 4.14. Howland current source.

This sounds great, but there's a hitch: the resistor ratios must be matched exactly; otherwise it isn't a perfect current source. Even so, its performance is limited by the op-amp's common-mode rejection ratio (CMRR, §2.3.8). For large output currents the resistors must be small, and the compliance is limited. Also, at high frequencies (where the loop gain is low, as we'll learn shortly) the output impedance can drop from the desired value of infinity to as little as a few hundred ohms (the op-amp's open-loop output impedance). These drawbacks limit the applicability of this clever circuit.

You can convert this circuit into a noninverting current source by grounding $R_{1}$ (where $V_{\text {in }}$ is shown) and applying the control input voltage $V_{\text {in }}$ instead to $R_{2}$.

Figure 4.15 is a nice improvement on the Howland circuit, because the output current is sourced through a sense resistor $R_{\mathrm{S}}$ whose value you can choose independently of the matched resistor array (with resistor pairs $R_{1}$ and $R_{2}$ ). The best way to understand this circuit is to think of $\mathrm{IC}_{1}$ as a difference amplifier whose output sense and reference connections sample the drop across $R_{\mathrm{S}}$ (i.e., the current); the latter is buffered by follower $\mathrm{IC}_{2}$ so there is no current error.

For this configuration you can exploit the internal precision matched resistors in an integrated difference amplifier: use something like an INA106 for $R_{1}, R_{2}$, and $\mathrm{IC}_{1}$, wired "backwards" (for $G=0.1$ ) to reduce the drop across the sense resistor. See $\S 5.14$ and Table 5.7 on page 353.

### 4.2.6 Integrators

Op-amps allow you to make nearly perfect integrators, without the restriction that $V_{\text {out }} \ll V_{\text {in }}$. Figure 4.16 shows how it's done. Input current $V_{\text {in }} / R$ flows through $C$. Because the inverting input is a virtual ground, the output voltage is given by

$$
V_{\mathrm{in}} / R=-C\left(d V_{\text {out }} / d t\right)
$$

![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-030.jpg?height=384&width=616&top_left_y=221&top_left_x=1080)

GND.
Figure 4.15. Bipolarity current source-sink.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-030.jpg?height=243&width=422&top_left_y=710&top_left_x=1156)

Figure 4.16. Integrator.
or

$$
\begin{equation*}
V_{\text {out }}(t)=-\frac{1}{R C} \int V_{\text {in }}(t) d t+\text { const. } \tag{4.3}
\end{equation*}
$$

The input can, of course, be a current, in which case $R$ is omitted.

As an example, if we choose $R=1 \mathrm{M}$ and $C=0.1 \mu \mathrm{~F}$ in this circuit, then a constant dc input of +1 V produces $1 \mu \mathrm{~A}$ of current into the summing junction, hence an output voltage that is ramping downward at $d V_{\text {out }} / d t=-V_{\text {in }} / R C=$ $-10 \mathrm{~V} / \mathrm{s}$. To say it algebraically, for a constant $V_{\text {in }}$ or con$\operatorname{stant} I_{\text {in }}$,

$$
\Delta V_{\mathrm{out}}=-\frac{V_{\mathrm{in}}}{R C} \Delta t=-\frac{I_{\mathrm{in}}}{C} \Delta t
$$

We rigged up the integrator of Figure 4.16, with $R=1 \mathrm{M} \Omega$ and $C=1 \mathrm{nF}$, and drove it with the simple test waveform shown in Figure 4.17. Without having taken a math class, the thing knows calculus!

Sharp-eyed readers may have noticed that this circuit doesn't have any feedback at dc, and so there's no way for it to have a stable quiescent point: for any nonzero input voltage $V_{\text {in }}$, the output is going somewhere! As we'll see shortly, even with $V_{\text {in }}$ exactly at zero volts, the output tends to wander off, owing to op-amp imperfections (non-zero input current, and "offset voltage"). These latter problems can be minimized by careful choice of op-amp and circuit values; but even so you usually have to provide some way to reset the integrator. Figure 4.18 shows how this is commonly done, either with a reset switch (both discrete JFET and integrated CMOS analog switch examples are shown)
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-031.jpg?height=411&width=771&top_left_y=223&top_left_x=229)

Figure 4.17. Integrator waveforms. The output can go anywhere it wants to, unlike our simple $R C$ "integrator" of §1.4.4. Horizontal: $10 \mathrm{~ms} / \mathrm{div}$.
or with a large-value feedback resistor across the integrating capacitor. Closing a reset switch ${ }^{5}$ (Figures 4.18A,B) zeroes the integrator by rapidly discharging the capacitor, while allowing perfect integration when open. The use of a feedback resistor (Figure 4.18D) produces stable biasing by restoring feedback at dc (where the circuit behaves like a high-gain inverting amplifier), but the effect is to roll off the integrator action at very low frequencies, $f<1 / R_{f} C$. An additional series analog switch at the input (Figure 4.18C) lets you control the intervals during which the integrator is active; when that switch is open the integrator output is frozen at its last value.

You don't have to worry about zeroing the integrator, of course, if it's part of a larger circuit that does the right thing. We'll see a beautiful example shortly (§4.3.3), namely an elegant triangle-wave generator, in which an untamed integrator is just what you want.

This first look at the op-amp integrator assumes that the op-amp is perfect, in particular that (a) the inputs draw no current, and (b) the amplifier is balanced with both inputs at precisely the same voltage. When our op-amp honeymoon is over we'll see that real op-amps do have some input current (called "bias current," $I_{\mathrm{B}}$ ), and that they exhibit some voltage imbalance (called "offset voltage," $V_{\mathrm{OS}}$ ). These imperfections are not large - bias currents of picoamps are routine, as are offset voltages of less than a millivolt - but they can cause problems with circuits like integrators, in which the effect of a small error grows with time. We'll deal with these essential topics later in the chapter (§4.4), after you're comfortable with the basics.

[^20]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-031.jpg?height=1350&width=652&top_left_y=218&top_left_x=1141)

Figure 4.18. Op-amp integrators with reset switches.

### 4.2.7 Basic cautions for op-amp circuits

- In all op-amp circuits, golden rules I and II (§4.1.3) are obeyed only if the op-amp is in the active region, i.e., inputs and outputs are not saturated at one of the supply voltages.

For instance, overdriving one of the amplifier configurations will cause output clipping at output swings near $V_{\mathrm{CC}}$ or $V_{\mathrm{EE}}$. During clipping, the inputs will no longer be maintained at the same voltage. The op-amp output cannot swing beyond the supply voltages (typically it can swing only to within 2 V of the supplies, though certain op-amps are designed to swing all the way to one supply or the other, or to both; the latter are known as "rail-torail output" op-amps). Likewise, the output compliance of an op-amp current source is set by the same limitation.

The current source with floating load (Figure 4.10), for instance, can put a maximum of $V_{\mathrm{CC}}-V_{\text {in }}$ across the load in the "normal" direction (current in the same direction as applied voltage) and $V_{\text {in }}-V_{\mathrm{EE}}$ in the reverse direction. ${ }^{6}$

- The feedback must be arranged so that it is negative. This means (among other things) that you must not mix up the inverting and noninverting inputs. We'll learn later that you can get yourself into similar problems if you rig up a feedback network that has lots of phase shift at some frequency.
- There must always be feedback at dc in an op-amp circuit. Otherwise the op-amp is guaranteed to go into saturation.

For instance, we were able to put a capacitor from the feedback network to ground in the noninverting amplifier (to reduce gain to 1 at dc, Figure 4.7B), but we could not similarly put a capacitor in series between the output and the inverting input. Likewise, an integrator will ultimately saturate without some additional circuitry such as a reset switch.

- Some op-amps have a relatively small maximum differential-input voltage limit. The maximum voltage difference between the inverting and noninverting inputs may be limited to as little as 5 volts in either polarity. Breaking this rule will cause large input currents to flow, with degradation or destruction of the op-amp.
- Op-amps are high-gain devices, often having plenty of gain even at radiofrequencies, where the inductances in the power-rail wiring can lead to instabilities in the amplifiers. We solve this issue with mandatory (we mean it!) bypass capacitors on the op-amp supply rails. ${ }^{7}$ Note: The figures in this chapter and elsewhere (and generally in the real world) do not show bypass capacitors, for simplicity. You have been warned.

We take up some more issues of this type in $\S 4.4$, and again in Chapter 5 in connection with precision circuit design.
${ }^{6}$ The load could be rather strange, e.g., it might contain batteries, requiring the reverse sense of voltage to get a forward current; the same thing might happen with an inductive load driven by changing currents.
${ }^{7}$ When we were young we were taught that each op-amp needed its own set of bypass capacitors. But with experience we've come to realize that one pair of capacitors can work to stabilize nearby op-amps. Furthermore, local wiring inductance with multiple sets of bypass capacitors can lead to resonances, which allow one op-amp to interfere with another. For example, if $L=25 \mathrm{nH}$ and $C=0.01 \mu \mathrm{~F}$, then $f_{\mathrm{LC}}=10 \mathrm{MHz}$, and $X_{\mathrm{LC}}=1.6 \Omega$. The impedance peak at resonance will be $Q$ times higher. You can solve this problem by adding an additional parallel lossy bypass capacitor, such as a small electrolytic. Its equivalent series resistance, of order $0.5 \Omega$ or more, acts to damp the resonant $Q$.

## 4.3 An op-amp smorgasbord

In the following examples we skip the detailed analysis, leaving that fun for the reader.

### 4.3.1 Linear circuits

#### A. Optional inverter

The circuits in Figure 4.19 let you invert, or amplify without inversion, by flipping a switch. The voltage gain is either +1 or -1 , depending on the switch position. The "switches" can be CMOS analog switches ${ }^{8}$, which let you control the sense of inversion with a (digital) signal. The clever variation of Figure 4.20 lets you vary the gain continuously from follower to inverter. And when the pot $R_{1}$ is at mid-position, the circuit does nothing at all!

Exercise 4.4. Show that the circuits in Figure 4.19 work as advertised.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-032.jpg?height=687&width=483&top_left_y=973&top_left_x=1131)

Figure 4.19. Optional inverters; $G= \pm 1.0$
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-032.jpg?height=267&width=450&top_left_y=1767&top_left_x=1147)

Figure 4.20. Follower-to-inverter: continuously adjustable gain from $G=+1$ to $G=-1$.

[^21]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-033.jpg?height=350&width=537&top_left_y=218&top_left_x=323)

Figure 4.21. Op-amp follower with bootstrap.

#### B. Follower with bootstrap

As with transistor amplifiers, the bias path can compromise the high input impedance you would otherwise get with an op-amp, particularly with ac-coupled inputs, for which a resistor to ground is mandatory. If that is a problem, the bootstrap circuit shown in Figure 4.21 is a possible solution. As in the transistor bootstrap circuit (\$2.4.3), the $0.1 \mu \mathrm{~F}$ capacitor makes the upper 1 M resistor look like a high-impedance current source to input signals. The lowfrequency rolloff for this circuit will begin at about 10 Hz , dropping at 12 dB per octave for frequencies somewhat below this. ${ }^{9}$ This circuit may exhibit some frequency peaking, analogous to the Sallen-and-Key circuit of §4.3.6; this can be tamed by adding a resistor of $1-10 \mathrm{k}$ in series with the feedback capacitor.

The very low input current (and therefore high input impedance) of FET-input op-amps generally make bootstrapping unnecessary; you can use 10 M or larger resistors for the input bias path in ac-coupled amplifiers.

#### C. Ideal current-to-voltage converter

Remember that the humble resistor is the simplest $I$-to- $V$ converter. However, it has the disadvantage of presenting a nonzero impedance to the source of input current; this can be fatal if the device providing the input current has very little compliance or does not produce a constant current as the output voltage changes. A good example is a photovoltaic cell, a diode junction that has been optimized as a light detector. Even the garden-variety signal diodes you use in circuits have a small photovoltaic effect (there are amusing stories of bizarre circuit behavior finally traced to this effect). Figure 4.22 shows the good way to convert current to voltage while holding the input strictly at ground. The inverting input is a virtual ground; this is fortunate, because a photovoltaic diode can generate only a few tenths

[^22]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-033.jpg?height=312&width=511&top_left_y=219&top_left_x=1219)

Figure 4.22. Photodiode amplifier.
of a volt. This particular circuit has an output of 1 volt per microamp of input current. (With BJT-input op-amps you sometimes see a resistor connected between the noninverting input and ground; its function will be explained shortly in connection with op-amp shortcomings.)

Of course, this transresistance configuration can be used equally well for devices that source their current from some positive excitation voltage, such as $V_{\mathrm{CC}}$. Photodiodes and phototransistors (both devices that source current from a positive supply when exposed to light) are often used this way (Figure 4.23). The photodiode has lower photocurrent, but excels in linearity and speed; very fast photodiodes can operate at gigahertz speeds. By contrast, the phototransistor has a considerably higher photocurrent (owing to transistor beta, which boosts the native collector-to-base photocurrent), with poorer linearity and speed. You can even get photo-Darlingtons, which extend this trend.

In real-world applications it is usually necessary to include a small capacitor across the feedback resistor, to ensure stability (i.e., prevent oscillation or ringing). This is because the capacitance of the detector, in combination with the feedback resistor, forms a lowpass filter; the resulting lagging phase shift at high frequencies, combined with the op-amp's own lagging phase shift (see §4.9.3), can add up to $180^{\circ}$, thus producing overall positive feedback, and thus oscillation. We treat this interesting problem in some detail in Chapter $4 x$ ("Transresistance amplifiers"); be sure to read that section carefully if you are building amplifiers for photodiodes. (And analogous stability problems occur, for similar reasons, when you drive capacitive loads with op-amps; see §4.6.1B).

Exercise 4.5. Use a 411 and a 1 mA (full scale) meter to construct a "perfect" current meter (i.e., one with zero input impedance) with 5 mA full scale. Design the circuit so that the meter will never be driven more than $\pm 150 \%$ full scale. Assume that the 411 output can swing to $\pm 13$ volts ( $\pm 15 \mathrm{~V}$ supplies) and that the meter has $500 \Omega$ internal resistance.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-034.jpg?height=1325&width=535&top_left_y=205&top_left_x=258)

Figure 4.23. Photodiode amplifiers with reverse bias: A. Phototransistor; note base terminal is not used. B. Photodiode. C. Phototransistor used as photodiode; for variety we show it current sinking. D. Phototransistor with load resistor driving voltage follower.

#### D. Summing amplifier

The circuit shown in Figure 4.24 is just a variation of the inverting amplifier. Point $X$ is a virtual ground, so the input current is $V_{1} / R_{1}+V_{2} / R_{2}+V_{3} / R_{3}$. With equal resistor values you get $V_{\text {out }}=-\left(V_{1}+V_{2}+V_{3}\right)$. Note that the inputs can be positive or negative. Also, the input resistors need not be equal; if they're unequal, you get a weighted sum. For instance, you could have four inputs, each of which is +1 volt or zero, representing binary values $1,2,4$, and 8 . By using input resistors of $10 \mathrm{k}, 5 \mathrm{k}, 2.5 \mathrm{k}$, and 1.25 k , you will get a negative output in volts equal to the binary count input. This scheme can be easily expanded to several dig-
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-034.jpg?height=259&width=527&top_left_y=210&top_left_x=1104)

Figure 4.24. Summing amplifier.
its. It is the basis of digital-to-analog conversion, although a different input circuit (an $R-2 R$ ladder) is usually used.

Exercise 4.6. Show how to make a two-digit digital-to-analog converter (DAC) by appropriately scaling the input resistors in a summing amplifier. The digital input represents two digits, each consisting of four lines that represent the values $1,2,4$, and 8 for the respective digits. An input line is either at +1 volt or at ground, i.e., the eight input lines represent $1,2,4,8,10,20,40$, and 80 . With $\pm 15 \mathrm{~V}$ supplies, the op-amp's outputs generally cannot swing beyond $\pm 13$ volts; you will have to settle for an output in volts equal to one-tenth the value of the input number.

#### E. Power booster

For high output current, a power transistor follower can be hung on an op-amp output (Figure 4.25). In this case a noninverting amplifier has been drawn, though a follower can be added to any op-amp configuration. Notice that feedback is taken from the emitter; thus feedback enforces the desired output voltage in spite of the $V_{\mathrm{BE}}$ drop. This circuit has the usual problem that the follower output can only source current. As with transistor circuits, the remedy is a push-pull booster (Figure 4.26). We'll see later that the limited speed with which the op-amp can move its output (slew rate) seriously limits the speed of this booster in the crossover region, creating distortion. For slow-speed applications you don't need to bias the push-pull pair into quiescent conduction, because feedback will take care of most of the crossover distortion. Complete power booster ICs are available, e.g. the LT1010 and BUF633/4. These
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-034.jpg?height=368&width=504&top_left_y=1857&top_left_x=1100)

Figure 4.25. Single-ended emitter follower boosts op-amp output current (sourcing only).
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-035.jpg?height=356&width=635&top_left_y=217&top_left_x=264)

Figure 4.26. Push-pull follower boosts op-amp output current, both sourcing and sinking. You commonly see a small resistor ( $\sim 100 \Omega$ ) connected between the bases and emitters to reduce crossover nonlinearity by maintaining feedback throughout the signal swing. See Figure 2.71 for improved output-stage biasing.
are unity-gain push-pull amplifiers capable of 200 mA of output current, and operation to $20-100 \mathrm{MHz}$ (see $\S 5.8 .4$, and also the discussion (and table) of unity-gain buffers in Chapter $4 x$.); they are carefully biased for low open-loop crossover distortion, and include on-chip protection (current limit, and often thermal shutdown as well). As long as you ensure that the op-amp driving them has significantly less bandwidth, you can include them inside the feedback loop without any worries. ${ }^{10}$

#### Feedback and the push-pull booster

The push-pull booster circuit illustrates nicely the linearizing effect of negative feedback. We hooked up an LF411 op-amp as a noninverting unity-gain follower, driving a BJT push-pull output stage, and we loaded the output with a $10 \Omega$ resistor to ground. Figure 4.27 shows the output signals at the op-amp and at the load, with an input sinewave of 1 V amplitude at 125 Hz . For the upper pair of traces we (foolishly) took the feedback from the op-amp's output, which produced a fine replica of the input signal; but the load sees severe crossover distortion (from the $2 V_{\mathrm{BE}}$ dead zone). With the feedback coming from the push-pull output (where the load is connected) we get what we want, as seen in the lower pair of traces. The op-amp cleverly creates an exaggerated waveform to drive the push-pull follower, with precisely the right shape to compensate for the crossover.

Figure 4.28 shows what these waveforms look like when we try driving an actual loudspeaker, a load that is more complicated than a resistor (because it's both a "motor" and a "generator," it exhibits resonances and other nasty properties; it's also got a reactive crossover network, and

[^23]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-035.jpg?height=470&width=779&top_left_y=219&top_left_x=1080)

Figure 4.27. Feedback cures crossover distortion in the push-pull follower. Vertical: $1 \mathrm{~V} / \mathrm{div}$; horizontal: $2 \mathrm{~ms} /$ div.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-035.jpg?height=481&width=802&top_left_y=831&top_left_x=1068)

Figure 4.28. Same as Figure 4.27, but loaded with a loudspeaker of $6 \Omega$ nominal impedance.
an inductive coil to propel the cone). Once again, the magic of feedback does the job, this time with an op-amp output that is charmingly unsymmetrical. ${ }^{11}$

#### F. Power supply

An op-amp can provide the gain for a feedback voltage regulator (Figure 4.29). The op-amp compares a sample of the output with the zener reference, changing the drive to the Darlington "pass transistor" as needed. This circuit supplies a stable 10 volt output ("regulated"), at up to 1 amp load current. Some notes about this circuit:

[^24]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-036.jpg?height=632&width=751&top_left_y=207&top_left_x=142)

Figure 4.29. Voltage regulator.

- The voltage divider that samples the output could be a potentiometer, for adjustable output voltage.
- For reduced ripple at the zener, the 10 k resistor should be replaced with a current source. Another approach is to bias the zener from the output; that way you take advantage of the regulator you have built. Caution: when using this trick, you must analyze the circuit carefully to be sure it will start up when power is first applied.
- We used a rail-to-rail op-amp, which can swing its output to the positive rail, ${ }^{12}$ so that the input voltage can go as low as +12 V without putting the Darlington pass transistor into saturation. With a 411, by contrast, you would have to allow another $1.5-2 \mathrm{~V}$ of margin, because the opamp's output cannot get closer than that to the positive supply rail.
- The circuit as drawn could be damaged by a temporary short circuit across the output, because the op-amp would attempt to drive the Darlington pair into heavy conduction. Regulated power supplies should always have circuitry to limit "fault" current (see §9.1.1C for more details).
- Without the "compensation capacitor" $C_{\mathrm{C}}$ the circuit would likely oscillate when the dc output is bypassed (as it would be when powering a circuit) because of the additional lagging phase shift. Capacitor $C_{\mathrm{C}}$ ensures stability into a capacitive load, a subject we'll visit in $\S \S 4.6 .1 \mathrm{~B}$, 4.6.2, and 9.1.1C.
- Integrated circuit voltage regulators are available in tremendous variety, from the time-honored 723 to the

12 Our suggested LT1637 is a 44-volt "over-the-top" op-amp that exhibits strikingly higher input-bias currents when its input is near the positive rail (as much as $I_{\mathrm{B}}=20 \mu \mathrm{~A}$, about 100 times its normal bias current). The LT1677, with $I_{\mathrm{B}}=0.2 \mu \mathrm{~A}$, might be a better choice.
convenient 3-terminal adjustable regulators with internal current limit and thermal shutdown (see §9.3). These devices, complete with temperature-compensated internal voltage reference and pass transistor, are so easy to use that you will almost never use a general-purpose op-amp as a regulator. The exception might be to generate a stable voltage within a circuit that already has a stable powersupply voltage available.

In Chapter 9 we discuss voltage regulators and power supplies in detail, including special ICs intended for use as voltage regulators.

### 4.3.2 Nonlinear circuits

#### A. Comparator - an introduction

It is quite common to want to know which of two signals is larger, or to know when a given input signal exceeds a predetermined voltage. For instance, the usual method of generating triangle waves is to supply positive or negative currents into a capacitor, reversing the polarity of the current when the amplitude reaches a preset peak value. Another example is a digital voltmeter. In order to convert a voltage to a number, the unknown voltage is applied to one input of a comparator, with a linear ramp (capacitor + current source) applied to the other. A digital counter counts cycles of an oscillator during the time that the ramp is less than the unknown voltage and displays the result when equality of amplitudes is reached. The resultant count is proportional to the input voltage. This is called single-slope integration; in most sophisticated instruments a dual-slope integration is used (Chapter 13).

The simplest form of comparator is a high-gain differential amplifier, made either with transistors or with an opamp (Figure 4.30). In this circuit there's no feedback - the op-amp goes into positive or negative saturation according to the difference of the input voltages. Because of the enormous voltage gain of op-amps (typically $10^{5}-10^{6}$ ), the inputs will have to be equal to within a fraction of a millivolt in order for the output not to be saturated. Although an ordinary op-amp can be used as a comparator (and frequently is), there are special ICs intended for use as comparators. They let you set the output voltage levels independently of the voltages used to power the comparator (e.g., you can have output levels of 0 V and +5 V from a comparator powered from $\pm 15 \mathrm{~V}$ ); and they are generally much faster, because they are not trying to be op-amps, i.e., linear amplifiers intended for use with negative feedback. We'll talk about them in detail in Chapter 12 (§§12.1.7 and 12.3, and Table 12.2).).
<img class="imgSvg" id = "m36zccy2suo9ell10gh" src="data:image/svg+xml;base64,PHN2ZyBpZD0ic21pbGVzLW0zNnpjY3kyc3VvOWVsbDEwZ2giIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDIwMSAxMjcuMTc3MTU2MDM4NTc0OTkiIHN0eWxlPSJ3aWR0aDogMjAxLjM1NjcwNDkyOTUyNTk2cHg7IGhlaWdodDogMTI3LjE3NzE1NjAzODU3NDk5cHg7IG92ZXJmbG93OiB2aXNpYmxlOyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJsaW5lLW0zNnpjY3kyc3VvOWVsbDEwZ2gtMSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxMjguNDMxMTc4NDYxOTQ5NTciIHkxPSI0Mi41ODcwNDE3NjQ2Njk2NjQiIHgyPSIxNTkuMzU2NzA0OTI5NTI1OTYiIHkyPSIzNi41OTg1Njg0NDQ3NjMyIj48c3RvcCBzdG9wLWNvbG9yPSJjdXJyZW50Q29sb3IiIG9mZnNldD0iMjAlIj48L3N0b3A+PHN0b3Agc3RvcC1jb2xvcj0iY3VycmVudENvbG9yIiBvZmZzZXQ9IjEwMCUiPjwvc3RvcD48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTMiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iOTEuMTU2NTE2NDMyNzc3ODkiIHkxPSI2MC4wNTU0MzgzNzQzNzk2MDUiIHgyPSIxMjguNDMxMTc4NDYxOTQ5NTciIHkyPSI0Mi41ODcwNDE3NjQ2Njk2NjQiPjxzdG9wIHN0b3AtY29sb3I9ImN1cnJlbnRDb2xvciIgb2Zmc2V0PSIyMCUiPjwvc3RvcD48c3RvcCBzdG9wLWNvbG9yPSJjdXJyZW50Q29sb3IiIG9mZnNldD0iMTAwJSI+PC9zdG9wPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJsaW5lLW0zNnpjY3kyc3VvOWVsbDEwZ2gtNSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxMDIuNjE5NDUwMzY1ODkyMTYiIHkxPSIzNy4zMzQ4MDQ2NjAyODc0OSIgeDI9IjEyOC40MzExNzg0NjE5NDk1NyIgeTI9IjQyLjU4NzA0MTc2NDY2OTY2NCI+PHN0b3Agc3RvcC1jb2xvcj0iY3VycmVudENvbG9yIiBvZmZzZXQ9IjIwJSI+PC9zdG9wPjxzdG9wIHN0b3AtY29sb3I9ImN1cnJlbnRDb2xvciIgb2Zmc2V0PSIxMDAlIj48L3N0b3A+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImxpbmUtbTM2emNjeTJzdW85ZWxsMTBnaC03IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjcwLjEyMjgwMDIwNTc4MTk0IiB5MT0iMzUuMTkwMDcwNzc0NTEyMzgiIHgyPSI5MS4xNTY1MTY0MzI3Nzc4OSIgeTI9IjYwLjA1NTQzODM3NDM3OTYwNSI+PHN0b3Agc3RvcC1jb2xvcj0iY3VycmVudENvbG9yIiBvZmZzZXQ9IjIwJSI+PC9zdG9wPjxzdG9wIHN0b3AtY29sb3I9ImN1cnJlbnRDb2xvciIgb2Zmc2V0PSIxMDAlIj48L3N0b3A+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImxpbmUtbTM2emNjeTJzdW85ZWxsMTBnaC05IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjkxLjE1NjUxNjQzMjc3Nzg5IiB5MT0iNjAuMDU1NDM4Mzc0Mzc5NjA1IiB4Mj0iMTEwLjY4MjYzMTM3ODAzOTU2IiB5Mj0iNzcuNzI1ODM2MjYxNjA3MSI+PHN0b3Agc3RvcC1jb2xvcj0iY3VycmVudENvbG9yIiBvZmZzZXQ9IjIwJSI+PC9zdG9wPjxzdG9wIHN0b3AtY29sb3I9ImN1cnJlbnRDb2xvciIgb2Zmc2V0PSIxMDAlIj48L3N0b3A+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImxpbmUtbTM2emNjeTJzdW85ZWxsMTBnaC0xMSIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSI3MC4xMjI4MDAyMDU3ODE5NCIgeTE9IjM1LjE5MDA3MDc3NDUxMjM4IiB4Mj0iMTAyLjYxOTQ1MDM2NTg5MjE2IiB5Mj0iMzcuMzM0ODA0NjYwMjg3NDkiPjxzdG9wIHN0b3AtY29sb3I9ImN1cnJlbnRDb2xvciIgb2Zmc2V0PSIyMCUiPjwvc3RvcD48c3RvcCBzdG9wLWNvbG9yPSJjdXJyZW50Q29sb3IiIG9mZnNldD0iMTAwJSI+PC9zdG9wPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50IGlkPSJsaW5lLW0zNnpjY3kyc3VvOWVsbDEwZ2gtMTMiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTAyLjYxOTQ1MDM2NTg5MjE2IiB5MT0iMzcuMzM0ODA0NjYwMjg3NDkiIHgyPSIxMTAuNjgyNjMxMzc4MDM5NTYiIHkyPSI3Ny43MjU4MzYyNjE2MDcxIj48c3RvcCBzdG9wLWNvbG9yPSJjdXJyZW50Q29sb3IiIG9mZnNldD0iMjAlIj48L3N0b3A+PHN0b3Agc3RvcC1jb2xvcj0iY3VycmVudENvbG9yIiBvZmZzZXQ9IjEwMCUiPjwvc3RvcD48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTE1IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjQyIiB5MT0iMjEiIHgyPSI3MC4xMjI4MDAyMDU3ODE5NCIgeTI9IjM1LjE5MDA3MDc3NDUxMjM4Ij48c3RvcCBzdG9wLWNvbG9yPSJjdXJyZW50Q29sb3IiIG9mZnNldD0iMjAlIj48L3N0b3A+PHN0b3Agc3RvcC1jb2xvcj0iY3VycmVudENvbG9yIiBvZmZzZXQ9IjEwMCUiPjwvc3RvcD48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0ibGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTE3IiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjExMC42ODI2MzEzNzgwMzk1NiIgeTE9Ijc3LjcyNTgzNjI2MTYwNzEiIHgyPSIxMjQuMjAxOTY1NzkwMjMyOTIiIHkyPSIxMDYuMTc3MTU2MDM4NTc0OTkiPjxzdG9wIHN0b3AtY29sb3I9ImN1cnJlbnRDb2xvciIgb2Zmc2V0PSIyMCUiPjwvc3RvcD48c3RvcCBzdG9wLWNvbG9yPSJjdXJyZW50Q29sb3IiIG9mZnNldD0iMTAwJSI+PC9zdG9wPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxtYXNrIGlkPSJ0ZXh0LW1hc2stbTM2emNjeTJzdW85ZWxsMTBnaCI+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0id2hpdGUiPjwvcmVjdD48Y2lyY2xlIGN4PSIxNTkuMzU2NzA0OTI5NTI1OTYiIGN5PSIzNi41OTg1Njg0NDQ3NjMyIiByPSI3Ljg3NSIgZmlsbD0iYmxhY2siPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjQyIiBjeT0iMjEiIHI9IjcuODc1IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTI0LjIwMTk2NTc5MDIzMjkyIiBjeT0iMTA2LjE3NzE1NjAzODU3NDk5IiByPSI4LjUzMTI1IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+PC9tYXNrPjxzdHlsZT4KICAgICAgICAgICAgICAgIC5lbGVtZW50LW0zNnpjY3kyc3VvOWVsbDEwZ2ggewogICAgICAgICAgICAgICAgICAgIGZvbnQ6IDE0cHggSGVsdmV0aWNhLCBBcmlhbCwgc2Fucy1zZXJpZjsKICAgICAgICAgICAgICAgICAgICBhbGlnbm1lbnQtYmFzZWxpbmU6ICdtaWRkbGUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLnN1Yi1tMzZ6Y2N5MnN1bzllbGwxMGdoIHsKICAgICAgICAgICAgICAgICAgICBmb250OiA4LjRweCBIZWx2ZXRpY2EsIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICA8L3N0eWxlPjxnIG1hc2s9InVybCgjdGV4dC1tYXNrLW0zNnpjY3kyc3VvOWVsbDEwZ2gpIj48bGluZSB4MT0iMTI4LjQzMTE3ODQ2MTk0OTU3IiB5MT0iNDIuNTg3MDQxNzY0NjY5NjY0IiB4Mj0iMTU5LjM1NjcwNDkyOTUyNTk2IiB5Mj0iMzYuNTk4NTY4NDQ0NzYzMiIgc3R5bGU9InN0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1kYXNoYXJyYXk6bm9uZTtzdHJva2Utd2lkdGg6MS4yNiIgc3Ryb2tlPSJ1cmwoJyNsaW5lLW0zNnpjY3kyc3VvOWVsbDEwZ2gtMScpIj48L2xpbmU+PGxpbmUgeDE9IjkxLjE1NjUxNjQzMjc3Nzg5IiB5MT0iNjAuMDU1NDM4Mzc0Mzc5NjA1IiB4Mj0iMTI4LjQzMTE3ODQ2MTk0OTU3IiB5Mj0iNDIuNTg3MDQxNzY0NjY5NjY0IiBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS13aWR0aDoxLjI2IiBzdHJva2U9InVybCgnI2xpbmUtbTM2emNjeTJzdW85ZWxsMTBnaC0zJykiPjwvbGluZT48bGluZSB4MT0iMTAyLjYxOTQ1MDM2NTg5MjE2IiB5MT0iMzcuMzM0ODA0NjYwMjg3NDkiIHgyPSIxMjguNDMxMTc4NDYxOTQ5NTciIHkyPSI0Mi41ODcwNDE3NjQ2Njk2NjQiIHN0eWxlPSJzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLXdpZHRoOjEuMjYiIHN0cm9rZT0idXJsKCcjbGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTUnKSI+PC9saW5lPjxsaW5lIHgxPSI3MC4xMjI4MDAyMDU3ODE5NCIgeTE9IjM1LjE5MDA3MDc3NDUxMjM4IiB4Mj0iOTEuMTU2NTE2NDMyNzc3ODkiIHkyPSI2MC4wNTU0MzgzNzQzNzk2MDUiIHN0eWxlPSJzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLXdpZHRoOjEuMjYiIHN0cm9rZT0idXJsKCcjbGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTcnKSI+PC9saW5lPjxsaW5lIHgxPSI5MS4xNTY1MTY0MzI3Nzc4OSIgeTE9IjYwLjA1NTQzODM3NDM3OTYwNSIgeDI9IjExMC42ODI2MzEzNzgwMzk1NiIgeTI9Ijc3LjcyNTgzNjI2MTYwNzEiIHN0eWxlPSJzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLXdpZHRoOjEuMjYiIHN0cm9rZT0idXJsKCcjbGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTknKSI+PC9saW5lPjxsaW5lIHgxPSI3MC4xMjI4MDAyMDU3ODE5NCIgeTE9IjM1LjE5MDA3MDc3NDUxMjM4IiB4Mj0iMTAyLjYxOTQ1MDM2NTg5MjE2IiB5Mj0iMzcuMzM0ODA0NjYwMjg3NDkiIHN0eWxlPSJzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLXdpZHRoOjEuMjYiIHN0cm9rZT0idXJsKCcjbGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTExJykiPjwvbGluZT48bGluZSB4MT0iMTAyLjYxOTQ1MDM2NTg5MjE2IiB5MT0iMzcuMzM0ODA0NjYwMjg3NDkiIHgyPSIxMTAuNjgyNjMxMzc4MDM5NTYiIHkyPSI3Ny43MjU4MzYyNjE2MDcxIiBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS13aWR0aDoxLjI2IiBzdHJva2U9InVybCgnI2xpbmUtbTM2emNjeTJzdW85ZWxsMTBnaC0xMycpIj48L2xpbmU+PGxpbmUgeDE9IjQyIiB5MT0iMjEiIHgyPSI3MC4xMjI4MDAyMDU3ODE5NCIgeTI9IjM1LjE5MDA3MDc3NDUxMjM4IiBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS13aWR0aDoxLjI2IiBzdHJva2U9InVybCgnI2xpbmUtbTM2emNjeTJzdW85ZWxsMTBnaC0xNScpIj48L2xpbmU+PGxpbmUgeDE9IjExMC42ODI2MzEzNzgwMzk1NiIgeTE9Ijc3LjcyNTgzNjI2MTYwNzEiIHgyPSIxMjQuMjAxOTY1NzkwMjMyOTIiIHkyPSIxMDYuMTc3MTU2MDM4NTc0OTkiIHN0eWxlPSJzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLXdpZHRoOjEuMjYiIHN0cm9rZT0idXJsKCcjbGluZS1tMzZ6Y2N5MnN1bzllbGwxMGdoLTE3JykiPjwvbGluZT48L2c+PGc+PHRleHQgeD0iMTU1LjQxOTIwNDkyOTUyNTk2IiB5PSI0MS44NDg1Njg0NDQ3NjMyIiBjbGFzcz0iZWxlbWVudC1tMzZ6Y2N5MnN1bzllbGwxMGdoIiBmaWxsPSJjdXJyZW50Q29sb3IiIHN0eWxlPSIKICAgICAgICAgICAgICAgIHRleHQtYW5jaG9yOiBzdGFydDsKICAgICAgICAgICAgICAgIHdyaXRpbmctbW9kZTogaG9yaXpvbnRhbC10YjsKICAgICAgICAgICAgICAgIHRleHQtb3JpZW50YXRpb246IG1peGVkOwogICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IG5vcm1hbDsKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogbHRyOwogICAgICAgICAgICAiPjx0c3BhbiBzdHlsZT0iCiAgICAgICAgICAgICAgICB1bmljb2RlLWJpZGk6IHBsYWludGV4dDsKICAgICAgICAgICAgICAgIHdyaXRpbmctbW9kZTogbHItdGI7CiAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogbm9ybWFsOwogICAgICAgICAgICAgICAgdGV4dC1hbmNob3I6IHN0YXJ0OwogICAgICAgICAgICAiPlkxOTwvdHNwYW4+PC90ZXh0Pjx0ZXh0IHg9IjE1OS4zNTY3MDQ5Mjk1MjU5NiIgeT0iMzYuNTk4NTY4NDQ0NzYzMiIgY2xhc3M9ImRlYnVnIiBmaWxsPSIjZmYwMDAwIiBzdHlsZT0iCiAgICAgICAgICAgICAgICBmb250OiA1cHggRHJvaWQgU2Fucywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgIj48L3RleHQ+PHRleHQgeD0iMTI4LjQzMTE3ODQ2MTk0OTU3IiB5PSI0Mi41ODcwNDE3NjQ2Njk2NjQiIGNsYXNzPSJkZWJ1ZyIgZmlsbD0iI2ZmMDAwMCIgc3R5bGU9IgogICAgICAgICAgICAgICAgZm9udDogNXB4IERyb2lkIFNhbnMsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICI+PC90ZXh0Pjx0ZXh0IHg9IjkxLjE1NjUxNjQzMjc3Nzg5IiB5PSI2MC4wNTU0MzgzNzQzNzk2MDUiIGNsYXNzPSJkZWJ1ZyIgZmlsbD0iI2ZmMDAwMCIgc3R5bGU9IgogICAgICAgICAgICAgICAgZm9udDogNXB4IERyb2lkIFNhbnMsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICI+PC90ZXh0Pjx0ZXh0IHg9IjcwLjEyMjgwMDIwNTc4MTk0IiB5PSIzNS4xOTAwNzA3NzQ1MTIzOCIgY2xhc3M9ImRlYnVnIiBmaWxsPSIjZmYwMDAwIiBzdHlsZT0iCiAgICAgICAgICAgICAgICBmb250OiA1cHggRHJvaWQgU2Fucywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgIj48L3RleHQ+PHRleHQgeD0iNDcuMjUiIHk9IjI2LjI1IiBjbGFzcz0iZWxlbWVudC1tMzZ6Y2N5MnN1bzllbGwxMGdoIiBmaWxsPSJjdXJyZW50Q29sb3IiIHN0eWxlPSIKICAgICAgICAgICAgICAgIHRleHQtYW5jaG9yOiBzdGFydDsKICAgICAgICAgICAgICAgIHdyaXRpbmctbW9kZTogaG9yaXpvbnRhbC10YjsKICAgICAgICAgICAgICAgIHRleHQtb3JpZW50YXRpb246IG1peGVkOwogICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IG5vcm1hbDsKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogcnRsOyB1bmljb2RlLWJpZGk6IGJpZGktb3ZlcnJpZGU7CiAgICAgICAgICAgICI+PHRzcGFuIHN0eWxlPSIKICAgICAgICAgICAgICAgIHVuaWNvZGUtYmlkaTogcGxhaW50ZXh0OwogICAgICAgICAgICAgICAgd3JpdGluZy1tb2RlOiBsci10YjsKICAgICAgICAgICAgICAgIGxldHRlci1zcGFjaW5nOiBub3JtYWw7CiAgICAgICAgICAgICAgICB0ZXh0LWFuY2hvcjogc3RhcnQ7CiAgICAgICAgICAgICI+WTE5PC90c3Bhbj48L3RleHQ+PHRleHQgeD0iNDIiIHk9IjIxIiBjbGFzcz0iZGVidWciIGZpbGw9IiNmZjAwMDAiIHN0eWxlPSIKICAgICAgICAgICAgICAgIGZvbnQ6IDVweCBEcm9pZCBTYW5zLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAiPjwvdGV4dD48dGV4dCB4PSIxMDIuNjE5NDUwMzY1ODkyMTYiIHk9IjM3LjMzNDgwNDY2MDI4NzQ5IiBjbGFzcz0iZGVidWciIGZpbGw9IiNmZjAwMDAiIHN0eWxlPSIKICAgICAgICAgICAgICAgIGZvbnQ6IDVweCBEcm9pZCBTYW5zLCBzYW5zLXNlcmlmOwogICAgICAgICAgICAiPjwvdGV4dD48dGV4dCB4PSIxMTAuNjgyNjMxMzc4MDM5NTYiIHk9Ijc3LjcyNTgzNjI2MTYwNzEiIGNsYXNzPSJkZWJ1ZyIgZmlsbD0iI2ZmMDAwMCIgc3R5bGU9IgogICAgICAgICAgICAgICAgZm9udDogNXB4IERyb2lkIFNhbnMsIHNhbnMtc2VyaWY7CiAgICAgICAgICAgICI+PC90ZXh0Pjx0ZXh0IHg9IjEyNC4yMDE5NjU3OTAyMzI5MiIgeT0iMTExLjQyNzE1NjAzODU3NDk5IiBjbGFzcz0iZWxlbWVudC1tMzZ6Y2N5MnN1bzllbGwxMGdoIiBmaWxsPSJjdXJyZW50Q29sb3IiIHN0eWxlPSIKICAgICAgICAgICAgICAgIHRleHQtYW5jaG9yOiBzdGFydDsKICAgICAgICAgICAgICAgIHdyaXRpbmctbW9kZTogaG9yaXpvbnRhbC10YjsKICAgICAgICAgICAgICAgIHRleHQtb3JpZW50YXRpb246IG1peGVkOwogICAgICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IG5vcm1hbDsKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogbHRyOwogICAgICAgICAgICAiPjx0c3BhbiBzdHlsZT0iCiAgICAgICAgICAgICAgICB1bmljb2RlLWJpZGk6IHBsYWludGV4dDsKICAgICAgICAgICAgICAgIHdyaXRpbmctbW9kZTogbHItdGI7CiAgICAgICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogbm9ybWFsOwogICAgICAgICAgICAgICAgdGV4dC1hbmNob3I6IG1pZGRsZTsKICAgICAgICAgICAgIj5BbDwvdHNwYW4+PHRzcGFuIHN0eWxlPSJ1bmljb2RlLWJpZGk6IHBsYWludGV4dDsiPkg8dHNwYW4gYmFzZWxpbmUtc2hpZnQ9InN1YiIgY2xhc3M9InN1Yi1tMzZ6Y2N5MnN1bzllbGwxMGdoIj4yPC90c3Bhbj48L3RzcGFuPjwvdGV4dD48dGV4dCB4PSIxMjQuMjAxOTY1NzkwMjMyOTIiIHk9IjEwNi4xNzcxNTYwMzg1NzQ5OSIgY2xhc3M9ImRlYnVnIiBmaWxsPSIjZmYwMDAwIiBzdHlsZT0iCiAgICAgICAgICAgICAgICBmb250OiA1cHggRHJvaWQgU2Fucywgc2Fucy1zZXJpZjsKICAgICAgICAgICAgIj48L3RleHQ+PC9nPjwvc3ZnPg=="/>

Figure 4.30. Comparator: an op-amp without feedback.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-037.jpg?height=282&width=726&top_left_y=448&top_left_x=257)

Figure 4.31. Comparator without hysteresis produces multiple transitions from noisy input signal.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-037.jpg?height=445&width=809&top_left_y=877&top_left_x=218)

Figure 4.32. Positive feedback prevents multiple comparator transitions. A. Comparator without feedback. B. Schmitt trigger configuration uses positive feedback to prevent multiple output transitions. Special comparator ICs are generally preferable, and are drawn with the same symbol.

#### B. Schmitt trigger

The simple comparator circuit in Figure 4.30 has two disadvantages. For a very slowly varying input, the output swing can be rather slow. Worse still, if the input is noisy, the output may make several transitions as the input passes through the trigger point (Figure 4.31). Both these problems can be remedied by use of positive feedback (Figure 4.32). The effect of $R_{3}$ is to make the circuit have two thresholds, depending on the output state. In the example shown, the threshold when the output is at ground (input high) is 4.76 volts, whereas the threshold with the output at +5 volts is 5.0 volts. A noisy input is less likely to produce multiple triggering (Figure 4.33). Furthermore, the positive feedback ensures a rapid output transition, regardless of the speed of the input waveform. (A small "speed-up" capacitor of $10-100 \mathrm{pF}$ is often connected across $R_{3}$ to enhance switching speed still further.) This configuration is known
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-037.jpg?height=228&width=739&top_left_y=218&top_left_x=1100)

Figure 4.33. Hysteresis tames noise-prone comparator.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-037.jpg?height=269&width=549&top_left_y=570&top_left_x=1200)

Figure 4.34. Output versus input ("transfer function") for Schmitt trigger.
as a Schmitt trigger, a function that we saw earlier in a discrete transistor implementation (Figure 2.13).

The output depends both on the input voltage and on its recent history, an effect called hysteresis. This can be illustrated with a diagram of output versus input, as in Figure 4.34. The design procedure is easy for Schmitt triggers that have a small amount of hysteresis. Use the circuit of Figure 4.32B. First choose a resistive divider ( $R_{1}$, $R_{2}$ ) to put the threshold at approximately the right voltage; if you want the threshold near ground, just use a single resistor from noninverting input to ground. Next, choose the (positive) feedback resistor $R_{3}$ to produce the required hysteresis, noting that the hysteresis equals the output swing, attenuated by a resistive divider formed by $R_{3}$ and $R_{1} \| R_{2}$. Finally, if you are using a comparator with "open-collector" output, you must add an output pullup resistor small enough to ensure a nearly full supply swing, taking account of the loading by $R_{3}$ (read about comparator outputs in $\S 12.3$, and see Table 12.2). For the case in which you want thresholds symmetrical about ground, connect an offsetting resistor of appropriate value from the noninverting input to the negative supply. You may wish to scale all resistor values to keep the output current and impedance levels within a reasonable range.

#### C. Power-switching driver

The output of a comparator or Schmitt trigger switches abruptly between high and low voltages; it's not a continuous (or "linear") signal. You might want to use its output to turn a substantial load on or off. Examples might be a relay, laser, or motor.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-038.jpg?height=777&width=889&top_left_y=206&top_left_x=25)

Figure 4.35. Power switching with an op-amp; A. With bipolar npn; note base current limit and reverse protection, B. With power MOSFET; note simplified drive circuit.

For loads that are either on or off, a switching transistor can be driven from a comparator or op-amp. Figure 4.35A shows how. Note the diode to prevent reverse base-emitter breakdown (op-amps powered from dual supply rails easily swing more than the -6 V base-emitter breakdown voltage); it would be omitted if the op-amp's negative supply were no more than -5 V . The TIP3055 is a jellybean classic power transistor for noncritical high-current applications, though you'll find plenty of variety of available types with improved maximum voltage, current, power dissipation, and speed (see the listing in Table 2.2 on page 106). A Darlington can be used if currents greater than about 1 amp need to be driven.

In general, however, you're better off using an $n$-channel power MOSFET, in which case you can dispense with the resistor and diode altogether (Figure 4.35B). The IRF520 ${ }^{13}$ is a near-classic - but the variety of readily available power MOSFETs is overwhelming (see Table 3.4); in general you trade off high breakdown voltage against low ONresistance.

When switching external loads, don't forget to include a reverse diode if the load is inductive (§1.6.7).

[^25]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-038.jpg?height=315&width=654&top_left_y=220&top_left_x=1015)

Figure 4.36. Simple active half-wave rectifier.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-038.jpg?height=343&width=715&top_left_y=647&top_left_x=1015)

Figure 4.37. Effect of finite slew rate on the simple active rectifier.

#### D. Active rectifier

Rectification of signals smaller than a diode drop cannot be done with a simple diode-resistor combination. As usual, op-amps come to the rescue, in this case by putting a diode in the feedback loop (Figure 4.36). For $V_{\text {in }}$ positive, the diode provides negative feedback; the circuit's output follows the input, coupled by the diode, but without a $V_{\mathrm{BE}}$ drop. For $V_{\text {in }}$ negative, the op-amp goes into negative saturation and $V_{\text {out }}$ is at ground. $R$ could be chosen smaller for lower output impedance, with the tradeoff of higher opamp output current. A better solution is to use an op-amp follower at the output, as shown, to produce very low output impedance regardless of the resistor value.

There is a problem with this circuit that becomes serious with high-speed signals. Because an op-amp cannot swing its output infinitely fast, the recovery from negative saturation (as the input waveform passes through zero from below) takes some time, during which the output is incorrect. It looks something like the curve shown in Figure 4.37. The output (heavy trace) is an accurate rectified version of the input (light trace), except for a short time interval after the input rises through zero volts. During that interval the op-amp output is racing up from saturation near $-V_{E E}$, so the circuit's output is still at ground. A general-purpose opamp like the 411 has a slew rate (maximum rate at which the output can change) of $15 \mathrm{~V} / \mu \mathrm{s}$; recovery from negative saturation therefore takes about $1 \mu \mathrm{~s}$ (when operating from $\pm 15 \mathrm{~V}$ supplies), which may introduce significant output
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-039.jpg?height=307&width=713&top_left_y=219&top_left_x=261)

Figure 4.38. Improved active half-wave rectifier.
error for fast signals. A circuit modification improves the situation considerably (Figure 4.38).
$D_{1}$ makes the circuit a unity-gain inverter for negative input signals. $D_{2}$ clamps the op-amp's output at one diode drop below ground for positive inputs, and since $D_{1}$ is then back-biased, $V_{\text {out }}$ sits at ground. The improvement comes because the op-amp's output swings only two diode drops as the input signal passes through zero. Because the opamp output has to slew only about 1.2 volts instead of $V_{\mathrm{EE}}$ volts, the "glitch" at zero crossings is reduced more than 10 -fold. This rectifier is inverting, incidentally. If you require a noninverted output, attach a unity-gain inverter to the output.

The performance of these circuits is improved if you choose an op-amp with a high slew rate. Slew rate also influences the performance of the other op-amp applications we've discussed, for instance the simple voltage amplifier circuits. Shortly we'll take a closer look at the ways in which real op-amps depart from the ideal - input current, offset voltage, bandwidth and slew rate, and so on - because you need to know about those limitations if you want to design good circuits. With that knowledge we'll also look at some active full-wave rectifier circuits to complement these half-wave rectifiers. ${ }^{14}$ First, though, we'd like to demonstrate some of the fun of designing with op-amps by showing a few real-world circuit examples.

### 4.3.3 Op-amp application: triangle-wave oscillator

These op-amp circuit fragments that we've been exploring - amplifiers, integrators, Schmitt triggers, etc. - are interesting enough; but the real excitement in circuit design comes when you creatively put pieces together to make a complete "something." A nice example that we can handle now is a triangle-wave oscillator. Unlike any other circuits so far, this one has no input signal; instead it creates an output signal, in this case a symmetrical triangle wave of

[^26]1 volt amplitude. As a by-product you also get a square wave, for free. (We'll see many more examples of oscillators in Chapter 7).

The idea is first to use an integrator (with a constantdc input voltage) to generate a ramp; we need to turn the ramp around when it reaches its $\pm 1 \mathrm{~V}$ limits, so we let the integrator output (the ramp) drive a Schmitt trigger, with thresholds at $\pm 1 \mathrm{~V}$. The output of the Schmitt, then, is what ought to determine the direction of the ramp. Aha! Just use its output (which switches between the supply rail voltages) as the input to the integrator.

Figure 4.39 shows a circuit implementation. It's easiest to start with $\mathrm{IC}_{2}$, which is wired as a noninverting Schmitt trigger (it looks like an inverting amplifier, but it's not note that feedback goes to the non-inverting input), for a reason we'll see soon. This configuration is used less frequently than the conventional inverting circuit of Figure 4.32B, because of its lower input impedance (and substantial input current reversal at threshold). Importantly, the LMC6482 has rail-to-rail output swing, so with $\pm 5 \mathrm{~V}$ power supplies its thresholds are at $\pm 1 \mathrm{~V}$, set by a 5:1 ratio of $R_{3}$ to $R_{2}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-039.jpg?height=483&width=805&top_left_y=1172&top_left_x=1072)

Figure 4.39. Triangle-wave oscillator.

The Schmitt's $\pm 5 \mathrm{~V}$ output is the input to the integrator $\mathrm{IC}_{1}$. We chose $C_{1}$ to be a convenient value of $0.01 \mu \mathrm{~F}$, then calculated $R_{1}$ to ramp through 2 V in a half period $(0.5 \mathrm{~ms})$, using $5 \mathrm{~V} / R_{1}=I_{\mathrm{in}}=C_{1}[d V / d t]_{\mathrm{ramp}}$. The calculated resistor value of $125 \mathrm{k} \Omega$ (in the figure we show the nearest standard 1\% "E96" resistor value; see Appendix C) came out reasonable, given real-world op-amp characteristics, as we'll learn later in the chapter. If it hadn't, we would have changed $C_{1}$; this is typically how you get to your final circuit component values.

Exercise 4.7. Confirm that value of $R_{1}$ is correct, and that the Schmitt trigger thresholds are at $\pm 1 \mathrm{~V}$.

Now the reason for connecting $\mathrm{IC}_{2}$ as a noninverting Schmitt trigger becomes clear: if $\mathrm{IC}_{2}$ 's output is at -5 V , say, then the triangle wave is ramping upward toward the Schmitt's +1 V threshold, at which point the Schmitt's output will switch to +5 V , reversing the cycle. If we had instead used the more conventional inverting Schmitt configuration, the oscillator would not oscillate; in that case it would "latch up" at one limit, as you can verify by walking through one cycle of operation.

The expressions for output frequency and amplitude are shown in the figure. It's interesting to note that the frequency is independent of supply voltage; but if you alter the resistor ratio $R_{2} / R_{3}$ to change the output amplitude, you will also change the frequency. Sometimes it is good to develop algebraic expressions for circuit operation, to see such dependencies. Here's how it goes in this case:

$$
\begin{align*}
& \frac{d V}{d t}=\frac{I}{C}=\frac{V_{\mathrm{S}} / R_{1}}{C_{1}}, \\
& \text { so } \quad \Delta t=C_{1} \frac{R_{1}}{V_{\mathrm{S}}} \Delta V, \\
& \text { but } \Delta V=2 \frac{R_{2}}{R_{3}} V_{S} \text {, } \\
& \text { so } \quad \Delta t=2 C_{1} R_{1} \frac{R_{2}}{R_{3}}, \\
& \text { and so, finally, } \quad f=\frac{1}{2 \Delta t}=\frac{1}{4 R_{1} C_{1}} \frac{R_{3}}{R_{2}} \text {. } \tag{4.4}
\end{align*}
$$

Note how $V_{\mathrm{s}}$ cancelled in the fourth step, leading to an output frequency independent of supply voltage.

A warning: it's easy to be dazzled by the apparent power of mathematics and quickly to fall in love with "algebraic circuit design." Our stern advice in this matter (and you can quote us on it) is:

Resist the temptation to take refuge in equations as a substitute for understanding how a circuit really works.

### 4.3.4 Op-amp application: pinch-off voltage tester

Here's another nice application of op-amps: suppose you want to measure a batch of JFETs in order to put them into groups that are matched in pinch-off voltage $V_{\mathrm{GS}}$ (off) (sometimes called $V_{P}$, see $\S 3.1 .3$ ). This is useful because the large spread of specified $V_{\mathrm{P}}$ sometimes makes it difficult to design a good amplifier. ${ }^{15}$ We'll assume that you want to find the gate-source back-bias that results in a drain

[^27]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-040.jpg?height=475&width=792&top_left_y=219&top_left_x=941)

Figure 4.40. Simple pinch-off voltage tester.
current of $1 \mu \mathrm{~A}$ with the drain at +10 V and the source grounded.

If you didn't know about op-amps, you could imagine (a) grounding the source, (b) hooking up a sensitive current meter from the drain to $\mathrm{a}+10 \mathrm{~V}$ supply, and then (c) adjusting the gate voltage with a variable negative supply to a value that produces $1 \mu \mathrm{~A}$ of measured drain current.

Figure 4.40 shows a better way. The device under test (you'll often see the acronym DUT) has its drain tied to +10 V ; but the source lead, instead of being grounded, is tied to the inverting input (virtual ground) of an op-amp whose noninverting input is grounded. The op-amp controls the gate voltage, thus holding the source at ground. Because the source is pulled down to -10 V through a 10 M resistor, the source current (and therefore the drain current) is $1 \mu \mathrm{~A}$. The op-amp's output is the same as the gate voltage, so the output of this circuit is the pinch-off voltage you wanted to know.

A few details:

- We chose power supply voltages of $\pm 10 \mathrm{~V}$ for the op-amp to make the rest of the circuit simpler, since we wanted to measure $V_{\mathrm{P}}$ with +10 V on the drain. That's OK , because most op-amps work well over a range of supply voltages (in fact, the trend is toward lower operating voltages, driven by the market for battery-powered consumer devices). But if you have only $\pm 15 \mathrm{~V}$ available, you would have to generate +10 V within your circuit, either with a voltage divider, a zener, or a 3-terminal voltage regulator (see Chapter 9).
- We put a 100 k resistor $\left(R_{1}\right)$ as protection in series with the gate to prevent any significant gate current from flowing during plug-in transients, etc. This can introduce a lagging phase shift around the loop at high frequencies (as can the rather large pull-down resistor $R_{2}$ ), so we added a small feedback capacitor $C_{1}$ to maintain stability.

We talk about this business of stability toward the end of the chapter, in §4.9.

- For this circuit to work properly, it's important that the op-amp's inverting input not load the source terminal, for example by drawing anything approaching a microamp of current. As we'll learn shortly, this is not always the case. For this example our general-purpose 411 op-amp, with its JFET input transistors, is fine (with input currents in the picoamperes); but an op-amp that uses bipolar transistors for its input stage would generally have input currents in the 10's to 100's of nanoamps, and should be avoided for a low-current application like this.
- The drain current at which pinch-off voltage is specified is not always $1 \mu \mathrm{~A}$. You'll see $V_{\mathrm{GS}(\text { off })}$ specified at values of drain current ranging from 1 nA to tens of microamps, depending on the size of the JFET, and the whim of the manufacturer. (In an informal survey of datasheets we found 1 nA to be the most popular, followed by $1 \mu \mathrm{~A}$, 10 nA , and 0.5 nA , with five other values used occasionally.) It would be easy to modify the circuit to accommodate higher test currents; but to go to 10 nA , say, you would need a $1 \mathrm{G} \Omega$ resistor for $R_{2}$ ! In that case a better solution is to return the pull-down resistor to a lower voltage, say -0.1 V , which you could generate with a voltage divider from the -10 V negative supply. You'd have to worry again about op-amp input currents with such a small test current.
Exercise 4.8. Show how to make the pinch-off tester operate from $\pm 15 \mathrm{~V}$ supplies, with the measurement still made at $V_{\mathrm{D}}=+10 \mathrm{~V}$; assume that the largest resistor value available is $10 \mathrm{M} \Omega$.

Exercise 4.9. Modify the pinch-off tester circuit of Figure 4.40 so that you can measure $V_{\mathrm{GS}}$ at three values of drain current, namely $1 \mu \mathrm{~A}, 10 \mu \mathrm{~A}$, and $100 \mu \mathrm{~A}$, by setting a 3-position switch. Assume that the largest resistor value you can conveniently get is $10 \mathrm{M} \Omega$.

Exercise 4.10. Now change the circuit so that it measures $V_{\mathrm{GS}(\mathrm{off})}$ at $I_{\mathrm{D}}=1 \mathrm{nA}$. Assume you can get $100 \mathrm{M} \Omega 5 \%$ resistors.

### 4.3.5 Programmable pulse-width generator

When triggered by a short input pulse, the circuit in Figure 4.41 generates an output pulse ${ }^{16}$ whose width is set by 10-turn pot $R_{1}$. Here's how it works.
$\mathrm{IC}_{1}, \mathrm{IC}_{2}$, and $Q_{1}$ form a current source that charges timing capacitor $C$, as we'll detail below. $\mathrm{IC}_{3}$ is a versatile timer IC, whose many exploits we will enjoy in Chapter 7. It holds $C$ discharged (through a saturated MOSFET

[^28]switch whose drain drives the DIS pin to ground) and simultaneously holds the output at ground, until it receives a negative-going trigger pulse at its TRIG input pin; at that point it releases DIS and switches its output to $V_{+}$, in this case +5 V .

The current source now charges $C$ with a positive-going ramp, according to $I=C d V / d t$. This continues until the capacitor voltage, which also drives $\mathrm{IC}_{3}$ 's TH input, reaches a voltage equal to $2 / 3$ of the supply voltage, $V_{\mathrm{TH}}=\frac{2}{3} V_{+}$; at this point $\mathrm{IC}_{3}$ abruptly pulls DIS back to ground, simultaneously switching its output to ground. This completes the cycle.

The current source is an elegant circuit. We want to source a current into the capacitor, with compliance from ground to at least $+3.3 \mathrm{~V}(2 / 3$ of $+5 \mathrm{~V})$, with linear control by a pot that returns to ground. For reasons we'll see presently, we want the programmed current proportional to the supply voltage $V_{+}$. In this circuit $Q_{1}$ is the current source, with $\mathrm{IC}_{2}$ controlling its base to hold its emitter at $+5 \mathrm{~V} . \mathrm{IC}_{1}$ is an inverting amplifier referenced to +5 V ; it pivots its output to a voltage that exceeds +5 V by an amount proportional to the current flowing through $R_{1}$ and $R_{2}$. That excess voltage appears across $R$, generating the output current. You'll know you understand how it works by doing the following problem.

Exercise 4.11. Calculate the current sourced by $Q_{1}$ by calculating the output voltage of IC ${ }_{1}$ as a function of $R_{\mathrm{X}}$ (the sum of $R_{1}$ and $R_{2}$ ), $R_{3}$, and $V_{+}$. Now use it to calculate the output pulse width, knowing that $\mathrm{IC}_{3}$ switches when the voltage at TH reaches $\frac{2}{3} V_{+}$.

This circuit is an illustration of the use of ratiometric techniques: for a given setting of $R_{1}$, both the capacitor charging current $I$ and the timer IC threshold voltage $V_{\mathrm{TH}}$ individually depend on supply voltage $V_{+}$; but their variation is such that the final pulse width $T$ does not depend on $V_{+}$. That is why the current source was designed with $I \propto V_{+}$. The use of ratiometric techniques is an elegant way to design circuits with excellent performance, often without requiring precise control of power-supply voltages.

### 4.3.6 Active lowpass filter

The simple $R C$ filters we saw back in Chapter 1 have a soft rolloff; that is, their response versus frequency does not progress sharply from a passband to a stopband. Perhaps surprisingly, this behavior cannot be remedied by simply cascading multiple stages, as we'll see in detail in Chapter 6 (and particularly in connection with active filters, §6.3). Much better filter performance can be achieved if
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-042.jpg?height=639&width=1131&top_left_y=216&top_left_x=381)

Figure 4.41. Pulse generator with programmable width.
you include both inductors and capacitors, or, equivalently, if you "activate" the filter design by using op-amps.

Figure 4.42 shows an example of a simple and even partly intuitive filter. This configuration is known as a Sallen-and-Key filter, after its inventors. The unity-gain amplifier can be an op-amp connected as a follower, or a unity-gain buffer IC, or just an emitter follower. This particular filter is a second-order lowpass filter. Note that it would be simply a pair of cascaded passive $R C$ lowpass filters, except for the fact that the bottom of the first capacitor is bootstrapped by the output. It is easy to see that at high frequencies (well beyond $f=1 / 2 \pi R C$ ) it falls off just like a cascaded $R C$, i.e., at $-12 \mathrm{~dB} /$ octave, because the output is essentially zero (and therefore the first capacitor's lower end is effectively grounded). As we lower the frequency and approach the passband, however, the bootstrap action tends to reduce the attenuation, thus giving a sharper "knee" to the curve of response versus frequency. We've plotted the response versus frequency, with three "tunings" of the $R$ and $C$ values. ${ }^{17}$

Of course, such hand-waving cannot substitute for honest analysis, which luckily has been done for a prodigious variety of nice filters. And contemporary generalpurpose SPICE-based analog simulation tools, or special filter analysis software, let you design and view filter response curves with relative ease.

[^29]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-042.jpg?height=914&width=820&top_left_y=956&top_left_x=957)

Figure 4.42. Sallen-and-Key active lowpass filter: A. Schematic; B. frequency response, compared with a cascade of two passive $R C$ sections.

## 4.4 A detailed look at op-amp behavior

We've hinted that op-amps aren't perfect, and that the performance of circuits such as active rectifiers and Schmitt triggers is limited by op-amp speed, or "slew rate." For those applications a high-speed op-amp is often required.

But slew rate is just one of a half-dozen important parameters of op-amps, which include input offset voltage, input bias current, input common-mode range, noise, bandwidth, output swing, and supply voltage and current. To state the situation fairly, op-amps are remarkable devices, with nearideal performance for most applications you are likely to encounter. To put it quantitatively, think of the difficulty of designing, with discrete transistors and other components, a high-gain dc differential amplifier that has an input current less than a picoamp, an offset from perfect balance less than a millivolt, a bandwidth of several megahertz, and that operates with its inputs anywhere between the two supply voltages. You can get such an op-amp for a dollar; it comes in a tiny package measuring $1.5 \mathrm{~mm} \times 3 \mathrm{~mm}$, and it draws less than a milliamp.

But op-amps do have performance limitations - that's why there are literally thousands of available types - and in general you're faced with a tradeoff: you can get much lower bias current (for example), at the expense of offset voltage. A good understanding of op-amp limitations and their influence on circuit design and performance will help you choose your op-amps wisely and design with them effectively.

To motivate the subject, imagine that you've been asked to design a dc amplifier, so that small voltages $(0-10 \mathrm{mV})$ can be seen on a handsome analog meter scale. And it should have at least $10 \mathrm{M} \Omega$ input resistance, and be accurate to $1 \%$ or so. No problem, you say...I'll just use the non-inverting amplifier configuration (to get high input resistance), with lots of gain ( $\times 1000$, say, so 10 mV is amplified to 10 V ). Speed is not an issue, so you don't worry about slew rate. With supreme confidence you draw up the circuit (with an LF411 op-amp), your technician builds it, and $\ldots$ your boss fires you! The thing was a disaster: it read $20 \%$ of full-scale with no input attached, and it drifted like crazy when carried outside. It does work OK - as a paperweight. ${ }^{18}$

To get started, look at Figure 4.43, a simplified schematic of the LF411. Its circuit is relatively straightforward, in terms of the kinds of transistor circuits we discussed in the last two chapters. It has a JFET differential input stage, with current-mirror active load, buffered with an npn follower (to prevent loading of the high-gain input stage) driving a grounded-emitter npn stage (with currentsource active load). This drives the push-pull emitter follower output stage ( $Q_{7} Q_{8}$ ), with current-limiting circuitry

[^30]( $R_{5} Q_{9}$ and $R_{6} Q_{10}$ ) to protect against output short-circuit. ${ }^{19}$ The curious feedback capacitor $C_{\mathrm{C}}$ ensures stability; we'll learn about it later. This circuit displays the internal circuitry characteristic of the typical op-amp, and from it we can see how and why op-amp performance departs from ideal.

Exercise 4.12. Explain how the current-limiting circuitry in Figure 4.43 works. What is the maximum output current?

Exercise 4.13. Explain the function of the two diodes in the output stage.

Let's look at these problems, what the consequences are for circuit design, and what to do about it.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-043.jpg?height=810&width=799&top_left_y=794&top_left_x=1070)

Figure 4.43. Simplified schematic of the LF411 op-amp.

### 4.4.1 Departure from ideal op-amp performance

The ideal op-amp has these characteristics:

- Input current $=0$ (input impedance $=\infty$ ).
- $V_{\text {out }}=0$ when both inputs are at precisely the same voltage (zero "offset voltage").
- Output impedance $($ open loop $)=0$.
- Voltage gain $=\infty$.
- Common-mode voltage gain $=0$.

19 The LF411's detailed schematic reveals a more elaborate negative current-limit configuration; check it out on the datasheet, to see if you can understand how it works.

- Output can change instantaneously (infinite slew rate).
$\cdot$ Absence of added "noise."
All of these characteristics should be independent of temperature and supply voltage changes.

In the following paragraphs we describe how real opamps depart from these ideals. As you struggle through the fact-filled sections, you may want to refer to Table 4.1 to maintain perspective. Tables $4.2 \mathrm{a}, \mathrm{b}, 5.5$, and 8.3 may be helpful also, for seeing some actual numbers. And we'll revisit these in more detail in Chapter 5 ( $\S 5.7$ and 5.8) in connection with the design of precision circuits.

#### A. Input offset voltage

Op-amps don't have perfectly balanced input stages, owing to manufacturing variations. The problem is worse with FETs, with their poorer matching of input thresholds. If you connect the two op-amp inputs together to create exactly zero differential input signal, the output will usually saturate at either $V_{+}$or $V_{-}$(you can't predict which). The difference in input voltages necessary to bring the output to zero is called the input offset voltage, $V_{\mathrm{OS}}$ (it's as if there were a battery of that voltage in series with one of the inputs). Typical offset voltages are around 1 mV , but "precision" op-amps can have offset voltages as small as $10 \mu \mathrm{~V}$. Some op-amps make provision for trimming the input offset voltage to zero. For a 411 you attach a 10k pot between pins 1 and 5 ("offset trim" in Figure 4.43), with the wiper connected to $V_{\mathrm{EE}}$, and adjust for zero offset; the effect is to unbalance deliberately the current mirror to compensate for the offset.

#### B. Offset voltage drift

Of greater importance for precision applications is the drift of the input offset voltage with temperature and time, since any initial offset could be manually trimmed to zero. A 411 has a typical offset voltage of 0.8 mV ( 2 mV maximum), with a tempco of $\Delta V_{\mathrm{OS}} / \Delta T=7 \mu \mathrm{~V} /{ }^{\circ} \mathrm{C}$ and unspecified coefficient of offset drift with time. The OP177A, a precision op-amp, is laser-trimmed for a maximum offset of 10 mi crovolts, with a temperature coefficient of $0.1 \mu \mathrm{~V} /{ }^{\circ} \mathrm{C}(\max )$ and long-term drift of $0.2 \mu \mathrm{~V} /$ month (typical) - roughly a hundred times better in both offset and tempco.

#### C. Input current

The input terminals sink (or source, depending on the opamp type) a small current called the input bias current, $I_{\mathrm{B}}$, which is defined as half the sum of the input currents with the inputs tied together (the two input currents are approximately equal and are simply the base or gate currents of
the input transistors). For the JFET-input 411 the bias current is typically $50 \mathrm{pA}(200 \mathrm{pA} \max )$ at room temperature (but as much as 4 nA at $70^{\circ} \mathrm{C}$ ), while a typical BJT-input op-amp like the OP27 has a bias current of 15 nA , varying little with temperature. As a rough guide, BJT-input opamps have bias currents in the tens of nanoamps, whereas JFET-input op-amps have input currents in the tens of picoamps (i.e., 1000 times lower), and MOSFET-input opamps have input currents of typically a picoamp or less. Generally speaking, you can ignore input current with FET op-amps, but not with bipolar-input op-amps. ${ }^{20}$

The significance of input bias current is that it causes a voltage drop across the resistors of the feedback network, bias network, or source impedance. How small a resistor this restricts you to depends on the dc gain of your circuit and how much output variation you can tolerate. For example, an LF412's maximum input current of 200 pA means that you can tolerate resistances (seen from the input terminals) up to $\sim 5 \mathrm{M} \Omega$ before you have to worry about it at the 1 mV level.

We will see more about how this works later. If your circuit is an integrator, bias current produces a slow ramp even when there is no external input current to the integrator.

Op-amps are available with input bias currents down to a nanoamp or less for bipolar-transistor-input circuit types, or down to a fraction of a picoamp $\left(10^{-6} \mu \mathrm{~A}\right)$ for MOSFET-input circuit types. The very lowest bias currents are typified by the BJT-input LT1012, with a typical input current of 25 pA , the JFET-input OPA129, with an input current of 0.03 pA , and the MOSFET LMC6041, with an input current of 0.002 pA . At the other end, very fast BJT op-amps like the THS4011/21 ( $\sim 300 \mathrm{MHz}$ ) have input currents of $3 \mu \mathrm{~A}$. In general, BJT op-amps intended for highspeed operation have higher bias currents.

#### D. Input offset current

Input offset current is a fancy name for the difference of the input currents between the two inputs. Unlike input bias current, the offset current, $I_{\mathrm{OS}}$, is a result of manufacturing variations, since an op-amp's symmetrical input circuit would otherwise result in identical bias currents at the two inputs. The significance is that, even when it is driven by identical source impedances, the op-amp will see unequal voltage drops and hence a difference voltage between its inputs. You will see shortly how this influences design.

Typically, the offset current is somewhere between one-

[^31]Table 4.1 Op-amp Parameters ${ }^{a}$

| Parameter | bipolar (BJT) |  | JFET-input |  | cMOS |  | Units |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|  | jellybean | premium | jellybean | premium | jellybean | premium |  |
| $V_{\text {os }}$ (max) | 3 | 0.025 | 2 | 0.1 | 2 | 0.1 | mV |
| TCV ${ }_{\text {os }}$ (max) | 5 | 0.1 | 20 | 1 | 10 | 3 | $\mu \mathrm{V} /{ }^{\circ} \mathrm{C}$ |
| ![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-045.jpg?height=50&width=99&top_left_y=510&top_left_x=451) | 50nA | 25pA | 50pA | 40fA | 1pA | 2fA | @ $25^{\circ} \mathrm{C}$ |
| en (typ) | 10 | 1 | 20 | 3 | 30 | 7 | nV/VHz @ 1kHz |
| $f_{\text {T }}$ (typ) | 2 | 2000 | 5 | 400 | 2 | 10 | MHz |
| SR (typ) | 2 | 4000 | 15 | 300 | 5 | 10 | V/us |
| $V_{\text {S }}(\mathrm{min})^{\mathrm{b}}$ | 5 | 1.5 | 10 | 5 | 2 | 1 | V |
| $V_{\text {s }}(\max )^{\text {b }}$ | 36 | 44 | 36 | 36 | 15 | 15 | V |

Notes: (a) typical and "best" values of important op-amp performance parameters. (b) total supply: $V_{+}-V_{-}$.
Typical and "best" values of important op-amp performance parameters. In this chart we list values for run-of-the-mill ("jellybean") parts, and for the best op-amp you can get for each individual parameter. That is, you cannot get a single op-amp that has the combination of excellent performance shown in any of the "premium" columns. In this chart you can clearly see that bipolar op-amps excel in precision, stability, speed, wide supply voltage range, and noise, at the expense of bias current; JFET-input types are intermediate, with CMOS op-amps displaying the lowest bias current.
half and one-tenth the bias current. For the 411, $I_{\text {offset }}=$ 25 pA , typical. However, for bias-compensated op-amps (like the OPA177), the specified offset current and bias current are comparable, for reasons we'll see in the advanced Chapter 5.

#### E. Input impedance

Input impedance refers to the small-signal ${ }^{21}$ differential input resistance (impedance looking into one input, with the other input grounded), which is usually much less than the common-mode resistance (a typical input stage looks like a long-tailed pair with current source). For the FET-input 411 it is about $10^{12} \Omega$, whereas for BJT-input op-amps like the LT1013 it is about $300 \mathrm{M} \Omega$. Because of the input bootstrapping effect of negative feedback (it attempts to keep both inputs at the same voltage, thus eliminating most of the differential-input signal), $Z_{\text {in }}$ in practice is raised to very high values and usually is not as important a parameter as input bias current.

#### F. Common-mode input range

The inputs to an op-amp must stay within a certain voltage range, typically less than the full supply range, for proper operation. If the inputs go beyond this range, the gain of the op-amp may change drastically, even reversing sign! For a 411 operating from $\pm 15$ volt supplies, the guaranteed common-mode input range is $\pm 11$ volts minimum.

[^32]However, the manufacturer claims that the 411 will operate with common-mode inputs all the way to the positive supply, though performance may be degraded. Bringing either input down to the negative supply voltage causes the amplifier to go berserk, with symptoms like phase reversal ${ }^{22}$ and output saturation to the positive supply. From the circuit in Figure 4.43 you can see why the LF411 cannot possibly operate with input voltages to the negative rail, because that would put the source terminals of the input JFET pair below the negative rail, taking them out of the active region. This is discussed further in Chapter $4 x$, along with some good war stories.

There are many op-amps available with common-mode input ranges down to the negative supply, e.g., the bipolar LT1013 and the CMOS TLC2272 and LMC6082; these are often referred to as "single-supply op-amps" or "groundsensing op-amps" (see §4.6.3). There are also some opamps whose common-mode input range includes the positive supply, e.g., the JFET LF356. With the trend toward lower supply voltages for battery-powered equipment, opamp designers have come up with varieties that accommodate input signals over the full range between supply voltages; these are called rail-to-rail, because supply voltages

[^33]are often called supply rails. ${ }^{23}$ Examples are the CMOS LMC6482 and TLV2400 series, and the bipolar LM6132, LT1630, and LT6220 series. These have the additional nice feature of being able to swing their outputs all the way to the rails (see the subsection on output swing below). These would seem to be ideal op-amps; however, as we discuss in $\S \S 5.7,5.9$, and 5.10 , rail-to-rail op-amps typically make compromises that affect other characteristics, notably offset voltage, output impedance, and supply current. There are, in addition, a few (very few) op-amps that operate properly for input voltages above the positive rail (for example, the "over-the-top" LT1637, listed in Table 4.2a on page 271).

In addition to the operating common-mode range, there are maximum allowable input voltages beyond which damage will result. For the 411 they are $\pm 15$ volts (but not to exceed the negative supply voltage, if it is less).

#### G. Differential input range

Some bipolar op-amps allow only a limited voltage between the inputs, sometimes as small as $\pm 0.5$ volt, although most are more forgiving, permitting differential inputs nearly as large as the supply voltages. Exceeding the specified maximum can degrade or destroy the op-amp.

#### H. Output swing versus load resistance

The LF411, typical of many op-amps, cannot swing its output closer than a volt or two from either supply rail, even when lightly loaded ( $R_{L}>5 \mathrm{k}$, say). That's because the output stage is a push-pull emitter follower, so even a full rail-to-rail drive to its bases would leave the output a diode drop short of both rails; the drive circuitry has its own difficulties getting close to the rails as well, and the currentlimit sense resistors $R_{5}$ and $R_{6}$ impose an additional voltage drop, which accounts for the shortfall.

For low values of load resistance, the internal currentlimit circuit will set the maximum swing. For example, the 411 can swing its output to within about 2 volts of $V_{\mathrm{CC}}$ and $V_{\text {EE }}$ into load resistances greater than about 1 k . Load resistances significantly less than that will permit only a small swing. This is frequently shown on datasheets as a graph of peak-to-peak output voltage swing $V_{\mathrm{om}}$ as a function of

[^34]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-046.jpg?height=506&width=618&top_left_y=206&top_left_x=1061)

Figure 4.44. Maximum peak-to-peak output swing versus load (LF411).
load resistance, or sometimes just a few values for typical load resistances. Figure 4.44 shows the datasheet's graph for the LF411. Many op-amps have asymmetrical output drive capability, with the ability to sink more current than they can source (or vice versa). For that reason you often see maximum output swing plotted, versus load current, as separate curves for output sourcing and sinking current into a load. Figure 4.45 shows such graphs for the LF411.

Some op-amps can produce output swings all the way down to the negative supply (e.g., the bipolar LT1013 and CMOS TLC2272), a particularly useful feature for circuits operated from a single positive supply, because output swings all the way to ground are then possible. Finally, opamps with CMOS transistor outputs in a common-source amplifier configuration ${ }^{24}$ (e.g., the LMC6xxx series) can swing all the way to both rails. For such op-amps a much more useful graph plots how close the output can get to each power-supply rail as a function of load current (both sourcing and sinking). An example is shown in Figure 4.46 for the CMOS rail-to-rail LMC6041. Note the effective use of log-log axes, so you can read off accurately the fact that this op-amp can swing to within 1 mV of the rails when supplying $10 \mu \mathrm{~A}$ of output current, and that its output resistance is approximately $80 \Omega$ (sinking) and $100 \Omega$ (sourcing). You can find bipolar op-amps that share this property, without the limited supply voltage range of the CMOS opamps (usually $\pm 8 \mathrm{~V}$ max), for example, the LM6132/42/52 family and the LT1636/7.

#### I. Output Impedance

Output impedance $R_{\mathrm{o}}$ means the op-amp's intrinsic output impedance without feedback (see Figure 2.90). For the 411 it is about $40 \Omega$, but with some low-power op-amps it can

[^35]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-047.jpg?height=491&width=683&top_left_y=219&top_left_x=281)

Figure 4.45. Maximum output voltage (both sourcing and sinking) versus load current (LF411). The maximum output current capability decreases by $\sim 25 \%$ at $T_{\mathrm{J}}=125^{\circ} \mathrm{C}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-047.jpg?height=616&width=680&top_left_y=896&top_left_x=280)

Figure 4.46. Maximum swing (as $\Delta \mathrm{V}$ from the respective rails) versus load current for a CMOS rail-to-rail output op-amp. The solid curves are measured values; you can't always trust datasheets in this case the datasheet's sourcing curve (dashed curve) is evidently in error.
be as high as several thousand ohms, a characteristic shared by some op-amps with rail-to-rail outputs. Feedback lowers the output impedance into insignificance (or raises it, for a current source), by a factor of the loop gain $A B$ (see $\S 2.5 .3 \mathrm{C}$ ); so what usually matters more is the maximum output current, with typical values of $\pm 20 \mathrm{~mA}$ or so (but much higher for the rarified group of "high current" opamps, see Table 4.2 b on page 272).

#### J. Voltage gain, bandwidth, and phase shift

Typically the voltage gain $A_{\mathrm{vo}}$ (sometimes called $A_{\mathrm{VOL}}, A_{\mathrm{V}}$, $G_{\mathrm{V}}$, or $G_{\mathrm{VOL}}$ ) at dc is 100,000 to $1,000,000$ (often specified
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-047.jpg?height=685&width=797&top_left_y=206&top_left_x=1073)

Figure 4.47. LF411 gain versus frequency ("Bode plot").
in decibels, thus 100 dB to 120 dB ), dropping to unity gain at a frequency (called $f_{\mathrm{T}}$, or sometimes gain-bandwidth product, GBW), most often in the range of 0.1 MHz to 10 MHz . This is usually given as a graph of open-loop voltage gain as a function of frequency, on which the $f_{\mathrm{T}}$ value is clearly seen; see, for example, Figure 4.47, which shows the curve for our favorite LF411.

For internally compensated op-amps this graph is simply a 6 dB /octave rolloff beginning at some fairly low frequency (for the 411 it begins at about 10 Hz ), an intentional characteristic necessary for stability, as we'll see in §4.9. This rolloff (the same as a simple $R C$ lowpass filter) results in a constant $90^{\circ}$ lagging phase shift from input to output (open-loop) at all frequencies above the beginning of the rolloff, increasing to $120^{\circ}$ to $160^{\circ}$ as the open-loop gain approaches unity. Because a $180^{\circ}$ phase shift at a frequency where the voltage gain equals 1 will result in positive feedback (oscillations), the term "phase margin" is used to specify the difference between the phase shift at $f_{\mathrm{T}}$ and $180^{\circ}$.

There's a price to pay for greater bandwidth $f_{\mathrm{T}}$, namely, higher transistor operating currents, and therefore higher op-amp supply currents. You can get op-amps with supply currents of less than $1 \mu \mathrm{~A}$, but they have $f_{\mathrm{T}}$ 's down around 10 kHz ! In addition to high supply currents, very fast opamps can have relatively high input bias currents, often more than a microamp, owing to their bipolar input stages operating at high collector current. Don't use fast op-amps if you don't need them - in addition to the drawbacks just mentioned, their high gain at high frequency makes it easier for your circuit to oscillate.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-048.jpg?height=406&width=795&top_left_y=205&top_left_x=123)

Figure 4.48. The maximum slew rate of a sinewave, $\mathrm{SR}=2 \pi A f$, occurs at the zero crossings.

#### K. Slew rate

The op-amp "compensation" capacitance (discussed further in §4.9.2) and small internal drive currents act together to limit the rate at which the output can change, even when a large input unbalance occurs. This limiting speed is usually specified as slew rate or slewing rate (SR). For the 411 it is $15 \mathrm{~V} / \mu \mathrm{s}$; low-power op-amps typically have slew rates less than $1 \mathrm{~V} / \mu \mathrm{s}$, whereas a high-speed op-amp might slew at hundreds of volts per microsecond. The slew rate limits the amplitude of an undistorted sine-wave output swing above some critical frequency (the frequency at which the full supply swing requires the maximum slew rate of the op-amp), thus the "output voltage swing as a function of frequency" graph (seen in datasheets; see for example Figure 4.54). A sine wave of frequency $f$ hertz and amplitude $A$ volts requires a minimum SR of $2 \pi A f$ volts per second, with the peak slewing occurring at the zero crossings (Figure 4.48). Figure 4.49 shows a 'scope trace illustrating realworld "slew-rate distortion."

For externally compensated op-amps, the slew rate depends on the compensation network used. In general, it will be lowest for "unity-gain compensation," increasing to perhaps 30 times faster for $\times 100$ gain compensation. This is discussed further in $\S 4.9 .2 \mathrm{~B}$ and in Chapter $4 x .{ }^{25}$ As with gain-bandwidth product $f_{\mathrm{T}}$, higher SR op-amps run at higher supply currents.

An important note: slew rate is ordinarily specified for a unity-gain configuration (i.e., a follower) with a full-swing step input. So there's is a large differential drive at the opamp's input, which really gets the currents flowing in there. The slew rate will be considerably less for a small input, say 10 mV .

[^36]LT1013

Figure 4.49. Slew-rate-induced distortion. This scope trace of an LT1013 op-amp follower, for which the datasheet specifies a typical SR of $0.4 \mathrm{~V} / \mu \mathrm{s}$, shows the input and output waveforms for a sinewave whose peak SR is $0.6 \mathrm{~V} / \mu \mathrm{s}(A=6.0 \mathrm{~V}, f=15.4 \mathrm{kHz})$; also shown is a slower sinewave, which overlays its (identical) output $(A=6.0 \mathrm{~V}, f=11 \mathrm{kHz}$ : $\mathrm{SR}=0.4 \mathrm{~V} / \mu \mathrm{s})$. Scales: $2 \mathrm{~V} / \mathrm{div}, 10 \mu \mathrm{~s} / \mathrm{div}$.

#### L. Temperature dependence

Most of these parameters have some temperature dependence. However, this usually doesn't make any difference, since small variations in gain, for example, are almost entirely compensated by feedback. Furthermore, the variations of these parameters with temperature are typically small compared with the variations from unit to unit.

The exceptions are input offset voltage and input offset current; these input errors will matter, particularly if you've trimmed the offsets approximately to zero, and will cause drifts in the output. When high precision is important, a low-drift "instrumentation" op-amp should be used, with external loads kept above 10k to minimize the horrendous effects on input-stage performance caused by temperature gradients. We will have much more to say about this subject in Chapter 5.

#### M. Supply voltage and current

Traditionally, most op-amps were designed for $\pm 15 \mathrm{~V}$ power supplies, with a smattering of "single-supply" opamps that operated on single supplies (i.e., $+V$ and ground), typically from +5 V to +15 V . The traditional split-supply op-amps were somewhat flexible; for example, the third-generation LF411 accepts supplies from $\pm 5 \mathrm{~V}$ to $\pm 18 \mathrm{~V}$. Most of these early op-amps ran at supply currents of a few milliamps.

There has been an important trend to lower-current and especially lower-voltage operation to accommodate battery-powered equipment. So, for example, it is now common to see op-amps that operate with total supply voltages (the span from $V_{+}$to $V_{-}$) of 5 V , or even 3 V , and run on supply currents of $10 \mu \mathrm{~A}$ to $100 \mu \mathrm{~A}$. These are usually
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-049.jpg?height=394&width=506&top_left_y=219&top_left_x=367)

Figure 4.50. Inverting amplifier.
built with $100 \%$ CMOS circuitry, but there are some bipolar designs as well. These are usually rail-to-rail output stages - obviously such op-amps cannot afford the luxury of the "no-closer-than-2-volts-from-either-rail" mantra!

When considering these op-amps, watch out for unusually low maximum supply voltage restrictions. Many such op-amps are limited to as little as 10 V total supply (i.e., $\pm 5 \mathrm{~V}$ ), and an increasing number are limited to 5 volts or less. Also, note that an op-amp with microamp quiescent current will necessarily draw plenty of current if you ask it to supply that amount of current to an attached load; output current doesn't come out of thin air.

#### N. Miscellany: CMRR, PSRR, $e_{\mathrm{n}}, i_{\mathrm{n}}$

For completeness, we should mention here that op-amps are also limited in common-mode rejection ratio (CMRR) and power-supply rejection ratio (PSRR), i.e., their incomplete rejection of common-mode input variations and power-supply fluctuations. This becomes more important at high frequencies, where the loop gain is decreasing and where the compensation capacitor $C_{\mathrm{C}}$ couples negative-rail fluctuations into the signal chain.

In addition, op-amps are not noiseless - they introduce both voltage noise $\left(e_{\mathrm{n}}\right)$ and current noise $\left(i_{\mathrm{n}}\right)$ at their input. These become significant limitations primarily in connection with precision circuits and low-noise amplifiers, and they will be treated in Chapters 5 and 8.

### 4.4.2 Effects of op-amp limitations on circuit behavior

Let's go back and look at the inverting amplifier with these limitations in mind. We'll see how they affect performance, and we'll learn how to design effectively in spite of them. With the understanding we'll get from this example, you should be able to handle other op-amp circuits. Figure 4.50 shows the circuit again.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-049.jpg?height=325&width=429&top_left_y=220&top_left_x=1260)

Figure 4.51. Op-amp noninverting amplifier with finite open-loop gain.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-049.jpg?height=681&width=607&top_left_y=687&top_left_x=1172)
$\begin{array}{rr}\text { GMD } & Z_{\text {out }}=\frac{Z \text { (open-loop) }}{1+A B} \\ \text { B. } \quad\left(B=\frac{R_{1}}{R_{1}+R_{2}}\right)\end{array}$
Figure 4.52. Input and output impedances: A. transresistance amplifier, B. inverting voltage amplifier.

#### A. Open-loop gain

Finite open-loop gain affects bandwidth, input and output impedances, and linearity. We saw this earlier, in the context of discrete transistor amplifiers, when we introduced negative feedback in Chapter 2 (§2.5.3). That material forms an essential background to what follows here; be sure to review it if you are foggy on this stuff.

#### Bandwidth

Because of finite open-loop gain, the voltage gain of the amplifier with feedback (closed-loop gain) will begin dropping at a frequency where the open-loop gain approaches $R_{2} / R_{1}$ (Figure 4.47). For garden-variety op-amps like the 411, this means that you're dealing with a relatively lowfrequency amplifier; the open-loop gain is down to 100 at

40 kHz , and $f_{\mathrm{T}}$ is 4 MHz . Note that the closed-loop gain is always less than the open-loop gain, so the overall amplifier will exhibit a noticeable falloff of gain at a fraction of $f_{\mathrm{T}}$. Recall from Chapter 2 that the closed-loop gain of the noninverting amplifier in Figure 4.51 is given by

$$
G=\frac{A}{1+A B}
$$

where $B$ is the fraction of the output fed back, in this case $B=R_{1} /\left(R_{1}+R_{2}\right)$. The output will therefore be down 3 dB at the frequency where the magnitude of the loop gain $A B$ is unity (i.e., where the magnitude of the open-loop gain $A$ equals the desired closed-loop gain $1 / B$ ), approximately 40 kHz for the LF411. ${ }^{26}$

Back in $\S 4.2 .5$ we remarked that op-amp current sources rely on the op-amp's voltage gain (thus loop gain) to raise its inherently low output resistance $R_{\mathrm{o}}$ (of order $\sim 100 \Omega$, see Figure 5.20), and that the decrease of open-loop gain with increasing frequency degrades the current-source's output impedance. This can be made quantitative: $Z_{\text {out }}$ at increasing frequencies is of the form $R_{\mathrm{O}} \cdot f_{\mathrm{T}} / f$.

#### Output impedance

Finite loop gain also affects the input and output impedances of a closed-loop op-amp circuit. Feedback can extract a sample of the output voltage (e.g., the noninverting voltage amplifiers we've been considering) or the output current (e.g., an op-amp current source). For voltage feedback the op-amp's open-loop output impedance is lowered by a factor of $1+A B$, bringing typical open-loop output impedances of tens to hundreds of ohms down to milliohms (for large loop gain), but rising back up to openloop values as the loop gain falls to unity at higher frequencies.

This linear rise in closed-loop output impedance is nicely illustrated in Figure 4.53, adapted from the LT1055 datasheet. You can see how greater loop gain (feedback configured for lower closed-loop gain) produces correspondingly lower output impedance; and you can see the linear rise up to the op-amp's native $R_{\text {out }}$ (sometimes designated $r_{\mathrm{o}}$ ), here about $60 \Omega$. Note also that an impedance that rises linearly with frequency is like an inductor. And, in fact, that's just what the output looks like for signals in this frequency range. This can have important conse-

[^37]quences, for example, creating a series $L C$ resonant circuit when the op-amp's load is capacitive.

The effect of the lowered loop gain (at high frequencies) is to degrade the beneficial effects of negative feedback. So a voltage amplifier suffers from increased output impedance, as we've seen. And the reverse is true for an amplifier with feedback that senses output current: here feedback normally acts to raise the native output impedance by a factor of loop gain (that's good: you want high output impedance in a current source), which then drops back to its open-loop values as the loop gain falls. Some op-amps (most notably those with rail-to-rail outputs) use an output stage with intrinsically high output impedance; for these op-amps a high loop gain is essential to achieve low output impedance.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-050.jpg?height=550&width=598&top_left_y=878&top_left_x=1073)

Figure 4.53. An op-amp's closed-loop output impedance rises approximately linearly with frequency over a large portion of its bandwidth, thus behaving like an inductance $L_{\text {out }} \approx r_{0} G_{\mathrm{CL}} / 2 \pi f_{\mathrm{T}}$. After the loop gain drops to unity, $Z_{\text {out }}$ looks like the op-amp's open-loop output resistance $r_{0}$. These curves were adapted from the LT1055 datasheet.

#### Input impedance

The input impedance of a noninverting amplifier is raised by a factor of $1+A B$ from its open-loop value, a matter usually of little consequence because of the high native input impedances of op-amps.

The inverting amplifier circuit is different from the noninverting circuit and has to be analyzed separately. It's best to think of it as a combination of an input resistor driving a shunt feedback stage (Figure 4.52). The shunt stage alone has its input at the "summing junction" (the inverting input of the amplifier), where the currents from feedback and input signals are combined (this amplifier connection is really a "transresistance" configuration; it converts a current
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-051.jpg?height=493&width=609&top_left_y=218&top_left_x=318)

Figure 4.54. Peak-to-peak output swing versus frequency (LF411).
input to a voltage output). Feedback reduces the impedance looking into the summing junction, $R_{2}$, by a factor of $1+A$ (see if you can prove this). In cases of very high loop gain, the input impedance is reduced to a fraction of an ohm, a good characteristic for a current-input amplifier.

The classic op-amp inverting amplifier connection is a combination of a shunt feedback transresistance amplifier and a series input resistor, as in the figure. As a result, the input impedance equals the sum of $R_{1}$ and the impedance looking into the summing junction. For high loop gain, $R_{\text {in }}$ approximately equals $R_{1}$.

It is a straightforward exercise to derive an expression for the closed-loop voltage gain of the inverting amplifier with finite loop gain. The answer is

$$
\begin{equation*}
G=-A(1-B) /(1+A B) \tag{4.5}
\end{equation*}
$$

where $B$ is defined as before, $B=R_{1} /\left(R_{1}+R_{2}\right)$. In the limit of large open-loop gain $A, G=-1 / B+1$ (i.e., $G=$ $-R_{2} / R_{1}$ ).

Exercise 4.14. Derive the foregoing expressions for input impedance and gain of the inverting amplifier.

#### Linearity

In the limit of infinite loop gain, a feedback circuit's behavior depends on only the feedback network; the native nonlinearities of the op-amp (e.g., voltage dependence of gain, crossover distortion, and so on) are compensated by feedback. These defects reappear as loop gain is reduced, for example at higher frequencies. It is for this reason that you have to choose your op-amps with care, for example if you want to design low-distortion audio amplifier circuits. Op-amps intended for this sort of application have carefully designed output stages, and often they specify distor-
tion as a function of frequency and gain. An example is the excellent AD797, which specifies a maximum distortion of $0.0003 \%$ at 20 kHz and 3 V (rms) output.

#### B. Slew rate

Because of limited slew rate, the maximum undistorted sinewave output swing drops above a certain frequency. Figure 4.54 shows the curve for a 411 , with its $15 \mathrm{~V} / \mu \mathrm{s}$ slew rate. For slew rate $S$, the output amplitude is limited to $A(\mathrm{pp}) \leq S / \pi f$ for a sinewave of frequency $f$, thus explaining the $1 / f$ dropoff of the curve. The flat portion of the curve reflects the power-supply limits of output voltage swing. An easy formula to remember is ${ }^{27}$

$$
\begin{equation*}
S_{\min }=\omega A=2 \pi f A \tag{4.6}
\end{equation*}
$$

where $S_{\min }$ is the minimum required SR for a sinewave of amplitude $A$ (that's half the peak-to-peak amplitude: $A_{\mathrm{PP}}=$ $2 A$ ) and angular frequency $\omega$; recall that $\omega=2 \pi f$. As an aside, the slew-rate limitation of op-amps can be usefully exploited to filter sharp noise spikes from a desired signal, with a technique known as nonlinear lowpass filtering: if the slew rate is deliberately limited, the fast spikes can be dramatically reduced with little distortion of the underlying signal.

#### C. Output current

Because of limited output-current capability, an op-amp's output swing is reduced for small load resistances, as we saw in Figure 4.44. For precision applications it is a good idea to avoid large output currents in order to prevent onchip thermal gradients produced by excessive power dissipation in the output stage.

#### D. Offset voltage

Because of input offset voltage, a zero input produces an output ${ }^{28}$ of $V_{\text {out }}=G_{\mathrm{dc}} V_{\mathrm{OS}}=\left(1+R_{2} / R_{1}\right) V_{\mathrm{OS}}$. For an inverting amplifier with a voltage gain of 100 built with a 411, the output could be as large as $\pm 0.2$ volt when the input

[^38]is grounded ( $V_{\mathrm{OS}}=2 \mathrm{mV}$ max). Solutions: (a) If you don't need gain at dc, use a capacitor to drop the gain to unity at dc, as in Figure 4.7B. In this case you could do that by capacitively coupling the input signal. (b) Trim the voltage offset to zero with the manufacturer's recommended trimming network. (c) Use an op-amp with smaller $V_{\text {OS }}$. (d) Trim the voltage offset to zero with an external trimming network, as for example in §4.8.3 (see Figure 4.91).

#### E. Input bias current

Even with a perfectly trimmed op-amp (i.e., $V_{\mathrm{OS}}=0$ ), our inverting amplifier circuit will produce a nonzero output voltage when its input terminal is connected to ground. That is because the finite input bias current, $I_{\mathrm{B}}$, produces a voltage drop across the resistors, which is then amplified by the circuit's voltage gain. In this circuit the inverting input sees a driving impedance of $R_{1} \| R_{2}$, so the bias current produces a voltage $V_{\text {in }}=I_{\mathrm{B}}\left(R_{1} \| R_{2}\right)$, which is then amplified by the gain at dc, $1+R_{2} / R_{1}$ (see footnote 28); the result is an output error voltage of $V_{\text {out }}=I_{\mathrm{B}} R_{2}$.

With FET-input op-amps the effect is usually negligible, but the substantial input current of bipolar op-amps (and also current-feedback op-amps; see Chapter $4 x$ ) can cause real problems. For example, consider an inverting amplifier with $R_{1}=10 \mathrm{k}$ and $R_{2}=1 \mathrm{M}$; these are reasonable values for an audiofrequency inverting stage, where we might like to keep $Z_{\text {in }}$ at least 10 k . If we chose the low-noise bipolar NE5534 ( $I_{\mathrm{B}}=2 \mu \mathrm{~A}$, max), the output (for grounded input) could be as large as $100 \times 2 \mu \mathrm{~A} \times 9.9 \mathrm{k}$, or 1.98 volt $\left(G_{\mathrm{dc}} I_{\mathrm{B}} R_{\text {unbalance }}\right)$, which is unacceptable. By comparison, for our jellybean LF411 (JFET-input) op-amp, the corresponding worst-case output (for grounded input) is 0.2 mV ; for most applications this is negligible, and in any case is dwarfed by the $V_{\text {OS }}$-produced output error ( 200 mV , worstcase untrimmed, for the LF411).

There are several solutions to the problem of biascurrent errors. If you must use an op-amp with large bias current, it is a good idea to ensure that both inputs see the same dc driving resistance, as in Figure 4.55. In this case, 91 k is chosen as the parallel resistance of 100 k and 1 M . In addition, it is best to keep the resistance of the feedback network small enough so that bias current doesn't produce large offsets; typical values for the resistance seen from the op-amp inputs are 1 k to 100 k or so. A third cure involves reducing the gain to unity at dc, as in Figure 4.7B.

In most cases, though, the simplest solution is to use opamps with negligible input current. Op-amps with JFETor MOSFET-input stages generally have input currents in the picoamp range (watch out for its rapid rise versus temperature, though, roughly doubling every $10^{\circ} \mathrm{C}$ ),
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-052.jpg?height=309&width=521&top_left_y=218&top_left_x=1066)

Figure 4.55. With bipolar op-amps, use a compensation resistor to reduce errors caused by input bias current.
and many modern bipolar designs use superbeta transistors or bias-cancellation schemes to achieve bias currents nearly as low and decreasing slightly with temperature. With these op-amps, you can have the advantages of bipolar op-amps (precision, low noise) without the annoying problems caused by input current. For example, the precision low-noise bipolar OP177 has $I_{\mathrm{B}}<2 \mathrm{nA}$, and the bias-compensated bipolar LT1012 has $I_{\mathrm{B}}= \pm 25 \mathrm{pA}$ (typ). Among inexpensive FET op-amps, the JFET LF411 has $I_{\mathrm{B}}=50 \mathrm{pA}($ typ $)$, and the MOSFET TLC270 series, priced under a dollar, has $I_{\mathrm{B}}=1 \mathrm{pA}(\mathrm{typ})$.

#### F. Input offset current

As we just described, it is usually best to design circuits so that circuit impedances, combined with op-amp bias current, produce negligible errors. However, occasionally it may be necessary to use an op-amp with high bias current, or to deal with signals of extraordinarily high Thévenin impedances. Examples of high-bias-current amplifiers are current-feedback op-amps (e.g., the AD844), low-noise $\left(e_{n}\right)$ op-amps (e.g., the AD797), and wideband op-amps (e.g., the LM7171), each with input currents of several microamps.

In these cases the best you can do is to balance the dc driving resistances seen by the op-amp at its input terminals. There will still be some error at the output ( $G_{\mathrm{dc}} I_{\mathrm{offset}} R_{\mathrm{source}}$ ) that is due to unavoidable asymmetry in the op-amp input currents. In general, $I_{\text {offset }}$ is smaller than $I_{\text {bias }}$ by a factor of 2 to 20 (with bipolar op-amps generally showing better matching than FET op-amps).

#### G. Limitations imply tradeoffs

In the preceding paragraphs we discussed the effects of op-amp limitations, taking the example of the simple inverting voltage amplifier circuit. Thus, for example, opamp input current caused a voltage error at the output. In a different op-amp application you may get a different effect; for example, in an op-amp integrator circuit, a finite input current produces an output ramp (rather than a
constant) with zero applied input. As you become familiar with op-amp circuits you will be able to predict the effects of op-amp limitations in a given circuit and therefore choose which op-amp to use in a given application. In general, there is no "best" op-amp (even when price is no object): for example, op-amps with the very lowest input currents (MOSFET types) generally have larger voltage offsets and greater noise, and vice versa. Good circuit designers choose their components with the right tradeoffs to optimize performance, without going overboard on unnecessary "gold-plated" parts.

To help put this discussion of "op-amp realities" into perspective, you may want to look again at Table 4.1 on page 245 , where we've summarized the kinds of performance you can expect from op-amps that might be described as average, or "jellybean" (for example, the LF412 is a jellybean JFET op-amp), and from those that are among the best available ("premium") for each given parameter. Sadly, you can't get an op-amp that combines all the characteristics in a "premium" column; engineering is the art of compromise.

The limitations of op-amp performance we have talked about will have an influence on component values in nearly all circuits. For instance, the feedback resistors must be large enough so that they don't load the output significantly, but they must not be so large that input bias current produces sizable offsets. High impedances in the feedback network cause both loading effects, and destabilizing phase shifts, from stray capacitances; they also increase susceptibility to capacitive pickup of interfering signals. These tradeoffs typically dictate resistor values of 2 k to 100 k with general-purpose op-amps.

Similar sorts of tradeoffs are involved in almost all electronic design, including the simplest circuits constructed with transistors. For example, the choice of quiescent current in a transistor amplifier is limited at the high end by device dissipation, increased input current, excessive supply current, and reduced current gain, whereas the lower limit of operating current is limited by leakage current, reduced current gain, and reduced speed (from stray capacitance in combination with the high resistance values). For these reasons you typically wind up with collector currents in the range of a few tens of microamps to a few tens of milliamps (higher for power circuits, sometimes a bit lower in "micropower" applications), as mentioned in Chapter 2.

In later chapters we look more carefully at some of these problems in order to convey a good understanding of the tradeoffs involved.

Exercise 4.15. Draw a dc-coupled inverting amplifier with a gain
of 100 and $Z_{\text {in }}=10 \mathrm{k}$. Include compensation for input bias current and show offset voltage trimming network ( 10 k pot between pins 1 and 5 , wiper tied to $V_{-}$). Now add circuitry so that $Z_{\text {in }} \geq$ $10^{8} \Omega$.

### 4.4.3 Example: sensitive millivoltmeter

To put flesh on these bones, let's look at a very simple design example - a dc amplifier with lots of gain, high input impedance, and (for variety in today's too-digital world) an analog zero-center panel meter readout. We'll aim for $\pm 10 \mathrm{mV}$ full-scale sensitivity, and 10 megohms input impedance.

Figure 4.56 shows the initial design, where we assume we've got $\pm 5 \mathrm{~V}$ supplies available (more on this later), and we use a noninverting gain of 100 to produce a $\pm 1 \mathrm{~V}$ opamp output at fullscale. That drives a $100-0-100 \mu \mathrm{~A}$ zerocenter meter movement, which we decorate with a relabeled scale that reads " $-10 \mathrm{mV} \cdots 0 \cdots 10 \mathrm{mV}$."
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-053.jpg?height=419&width=828&top_left_y=1053&top_left_x=1058)

Figure 4.56. Sensitive millivoltmeter with analog readout; see text for choice of $I_{1}$.

It looks simple, and it is. But it won't work well if we're not careful. Imagine we choose our default LF411 for IC $\mathrm{C}_{1}$, figuring that the low bias current of a JFET-input op-amp is just what we need. We short the input leads together and find to our horror that the meter reads way off center, as much as $\pm 2 \mathrm{mV}$. That's because the 411 has $V_{\mathrm{OS}}=2 \mathrm{mV}$ (max). Ideally we'd like the thing to read zero with the input leads shorted or open, where "zero" might realistically mean no more than $1 \%$ of the full-scale reading.

OK, we add an offset trimmer and adjust it until the output reads zero with shorted input. We leave it on the bench, go to lunch, then come back and find it now reads -0.2 mV with shorted input. That's because it sat in the sun, warmed up by $10^{\circ} \mathrm{C}$, and therefore drifted by $200 \mu \mathrm{~V}$ (the LF411 has a temperature coefficient of offset voltage $\mathrm{TCV}_{\mathrm{OS}}=20 \mu \mathrm{~V} /{ }^{\circ} \mathrm{C}$, max). Well, we won't use it in the sun!

So, we wait for it to cool down, and note with satisfaction that it reads zero again.

Now we go to test it on a voltage divider, but we find that when we remove the short (test leads open circuited) the meter reads +2 mV ! This time the problem is bias current, specified as 200 pA (max) at room temperature. That's not much current, but it develops $2000 \mu \mathrm{~V}$ across the 10 M input resistor, which the meter dutifully reports as an input.

We could solve the $V_{\mathrm{OS}}$ problem with a precision bipolar op-amp, but we'd be in worse trouble with $I_{\mathrm{B}}$. We need an op-amp with $V_{\mathrm{OS}}<100 \mu \mathrm{~V}$ and $I_{\mathrm{B}}<10 \mathrm{pA}$. The solution is a precision FET-input op-amp, for example, the OPA336 ( $125 \mu \mathrm{~V}$ untrimmed, and 10 pA ), which is just about good enough without trimming, and certainly fine if we're willing to trim the initial offset.

A better solution here is to use a "chopper" op-amp like the LTC1050C or AD8638 (see Table 5.6). These are sometimes called "zero-drift," or "auto-zeroing" amplifiers. We'll learn about them shortly, and in more detail in the next chapter; for now all you need to know is that they offer specifications like $V_{\mathrm{OS}}<5 \mu \mathrm{~V}$, $\mathrm{TC} V_{\mathrm{OS}}<0.05 \mu \mathrm{~V} /{ }^{\circ} \mathrm{C}$, and $I_{\mathrm{B}}<50 \mathrm{pA}$ (those are, in fact, the worst-case specs for the LTC1050 in its inexpensive C-suffix grade).

A final thought: having a calibration adjustment is OK if you're building just a few of these things. But in production it would be nice to avoid manual calibration steps. An elegant circuit solution that circumvents calibration is to use a current-sensing resistor on the low side of the meter. We include this feature when we revisit this example early in Chapter 5 (§5.2), in a more rigorous approach to precision design.

### 4.4.4 Bandwidth and the op-amp current source

Back in $\S 4.2 .5$ we remarked that op-amp current sources rely on the op-amp's voltage gain (thus loop gain) to raise its inherently low output resistance $R_{\mathrm{o}}$ (of order $\sim 100 \Omega$, see Figure 5.20), and that the decrease of open-loop gain with increasing frequency degrades the current-source's output impedance. Put another way, the op-amp current source is a peculiar circuit, because an op-amp virtue (inherently low output impedance, i.e., a voltage source) becomes a vice, which must be punished with the cudgel of plentiful loop gain. This can be made quantitative: because of finite bandwidth $f_{\mathrm{T}}$, the output impedance of an opamp current source at increasing frequencies is of the form $R_{0} \cdot f_{\mathrm{T}} / f$, dropping ultimately to the op-amp's native output resistance $R_{\mathrm{O}}$ at the unity-gain frequency $f_{\mathrm{T}}$.

Likewise, finite slew rate affects the current-source's output impedance, making it look like a shunt capacitance.

Here's how to think about it: an ideal current source with a real capacitive load slews at a rate $S=d V / d t=I / C$; so a current source that is afflicted with a maximum slew rate $S$ looks like an ideal current source burdened with an effective shunt capacitance $C_{\text {eff }}=I_{\text {out }} / S$. For example, a 10 mA current source made with an op-amp of slew rate $1 \mathrm{~V} / \mu \mathrm{s}$ has an effective capacitive load of 10 nF ; this is rather large, compared even with a large MOSFET.

## 4.5 A detailed look at selected op-amp circuits

The performance of the next few circuits is affected significantly by the limitations of op-amps; we will go into a bit more detail in their description.

### 4.5.1 Active peak detector

There are numerous applications in which it is necessary to determine the peak value of some input waveform. The simplest method is a diode and capacitor (Figure 4.57). The highest point of the input waveform charges up $C$, which holds that value while the diode is back-biased.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-054.jpg?height=166&width=351&top_left_y=1167&top_left_x=1197)

Figure 4.57. Passive peak detector.
This method has some serious problems. The input impedance is variable and is very low during peaks of the input waveform. Also, the diode drop makes the circuit insensitive to peaks less than about 0.6 volt, and inaccurate (by one diode drop) for larger peak voltages. Furthermore, since the diode drop depends on temperature and current, the circuit's inaccuracies depend on the ambient temperature and on the rate of change of output; recall that $I=C(d V / d t)$. An input emitter follower would improve the first problem only.

Figure 4.58A shows a better circuit, which exhibits the benefits of feedback. By taking feedback from the voltage at the capacitor, the diode drop doesn't cause any problems. The sort of output waveform you might get is shown in Figure 4.59.

Op-amp limitations affect this circuit in three ways.
(a) A finite op-amp slew rate causes a problem, even with relatively slow input waveforms. To understand this, note that the op-amp's output goes into negative saturation when the input is less positive than the output
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-055.jpg?height=677&width=753&top_left_y=220&top_left_x=205)

Figure 4.58. A. Op-amp peak detector (more accurately, a "peak tracker"). B. Improved peak tracker responds to short peaks, because the input op-amp does not have to slew from negative saturation.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-055.jpg?height=353&width=718&top_left_y=1142&top_left_x=261)

Figure 4.59. Peak detector output waveform.
(try sketching the op-amp voltage on the graph; don't forget about diode forward drop). So the op-amp's output has to race back up to the output voltage (plus a diode drop) when the input waveform next exceeds the output. At slew rate $S$, this takes roughly $\left(V_{\text {out }}-V_{-}\right) / S$, where $V_{-}$is the negative supply voltage. Improved circuit 4.58B solves this problem.
(b) Input bias current causes a slow discharge (or charge, depending on the sign of the bias current) of the capacitor. This is sometimes called "droop," and it is best avoided by using op-amps with very low bias current. For the same reason, the diode must be a low-leakage type (e.g., the FJH1100, with less than 1 pA reverse current at 20 V , an "FET diode" such as the PAD5, or a diode-connected JFET such as the 2N4417; see the diode discussion in Chapter $1 x$ ), and the follow-
ing stage must also present high impedance (ideally it should also be an FET or FET-input op-amp).
(c) The maximum op-amp output current limits the rate of change of voltage across the capacitor, i.e., the rate at which the output can follow a rising input. Thus the choice of capacitor value is a compromise between low droop and high output slew rate.

For instance, a $1 \mu \mathrm{~F}$ capacitor used in this circuit with the common LM358 (which would be a poor choice because of its high bias current) would droop at $d V / d t=I_{\mathrm{B}} / C=$ $0.04 \mathrm{~V} / \mathrm{s}$ (using the "typical" value $I_{\mathrm{B}}=40 \mathrm{nA}$; the worstcase value of $I_{\mathrm{B}}=500 \mathrm{nA}$ produces a droop of $0.5 \mathrm{~V} / \mathrm{s}$ ) and would follow input changes only up to $d V / d t=I_{\text {output }} / C=$ $0.02 \mathrm{~V} / \mu \mathrm{s}$. This maximum follow rate is much less than the op-amp's slew rate of $0.5 \mathrm{~V} / \mu \mathrm{s}$, being limited by the maximum output current of 20 mA driving $1 \mu \mathrm{~F}$. By decreasing $C$ you could achieve greater output slewing rate, at the expense of greater droop. A more realistic choice of components would be the popular TLC2272 MOSFET-input opamp as driver and output follower (1 pA typical bias current) and a value of $C=0.01 \mu \mathrm{~F}$. With this combination you would get a droop of only $0.0001 \mathrm{~V} / \mathrm{s}$ and an overall circuit slew rate of $2 \mathrm{~V} / \mu \mathrm{s}$. For even better performance, use a MOSFET op-amp like the LMC660 or LMC6041, with a typical input current of 2 femtoamps. Capacitor leakage (or diode leakage or both) may then limit performance even if unusually good capacitors are used, e.g., polystyrene or polypropylene (see Chapter $1 x$ ). ${ }^{29}$

#### A. Resetting a peak detector

In practice it is usually desirable to reset the output of a peak detector in some way. One possibility is to put a resistor across the peak-hold capacitor so that the circuit's output decays with a time constant $R C$. In this way it holds only the most recent peak values. A better method is to put a transistor switch across $C$; a short pulse to the base then zeros the output. An FET switch is often used instead. For example, in Figure 4.58 you could connect an $n$-channel MOSFET such as a 2N7000 across $C$; bringing the gate

[^39]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-056.jpg?height=1386&width=846&top_left_y=209&top_left_x=82)
B. LF398 (integrated circuit S/H)

GND
Figure 4.60. Sample-and-hold: A. Standard configuration, with exaggerated waveform; B. LF398 single-chip S/H.
momentarily positive then zeros the capacitor voltage. An integrated CMOS analog switch (such as the MAX318, with a small series resistor to limit the current) can be used instead of a discrete nMOS (n-type metal-oxide semiconductor) transistor.

### 4.5.2 Sample-and-hold

Closely related to the peak detector is the "sample-andhold" (S/H) circuit (sometimes called "follow-and-hold"). These are especially popular in digital systems in which you want to convert one or more analog voltages to num-
bers so that a computer can digest them: the favorite method is to grab and hold the voltage(s), then do the digital conversion at your leisure. The basic ingredients of an S/H circuit are an op-amp and an FET switch; Figure 4.60 A shows the idea. $\mathrm{IC}_{1}$ is a follower to provide a low-impedance replica of the input. CMOS analog switch $S_{1}$ passes the signal through during "sample" and disconnects it during "hold." Whatever signal was present when $S_{1}$ was turned OFF is held on capacitor $C . \mathrm{IC}_{2}$ is a high-input-impedance follower (FET inputs), so that capacitor current during "hold" is minimized. The value of $C$ is a compromise: leakage currents in $S_{1}$ and the follower cause $C$ 's voltage to"droop" during the hold interval according to $d V / d t=I_{\text {leakage }} / C$. Thus $C$ should be large to minimize droop. But $S_{1}$ 's ON-resistance forms a lowpass filter in combination with $C$, so $C$ should be small if high-speed signals are to be followed accurately. $\mathrm{IC}_{1}$ must be able to supply $C$ 's charging current ( $I=C d V / d t$ ) and must have sufficient slew rate to follow the input signal. In practice, the slew rate of the whole circuit will usually be limited by IC ${ }_{1}$ 's output current and $S_{1}$ 's ON-resistance.

Exercise 4.16. Suppose $\mathrm{IC}_{1}$ can supply 10 mA of output current and $C=0.01 \mu \mathrm{~F}$. What is the maximum input slew rate the circuit can accurately follow? If $S_{1}$ has $50 \Omega$ oN resistance, what will be the output error for an input signal slewing at $0.1 \mathrm{~V} / \mu \mathrm{s}$ ? If the combined leakage of $S_{1}$ and $\mathrm{IC}_{2}$ is 1 nA , what is the droop rate during the "hold" state?

For both the S/H circuit and the peak detector, an opamp drives a capacitive load. When designing such circuits, make sure you choose an op-amp that is stable at unity gain when loaded by the capacitor $C$. Some op-amps, (e.g., the LT1457, a member of Linear Technology's "CLOAD" ${ }^{\mathrm{TM}}$ stable" op-amps) are specifically designed to drive large $(0.01 \mu \mathrm{~F})$ capacitive loads directly. Some other tricks you can use are discussed in §4.6.1B and in Chapter $4 x$.

You don't have to design S/H circuits from scratch, because there are nice monolithic ICs that contain all the parts you need. National's LF398 is a popular part, containing the FET switch and two op-amps in an inexpensive (\$1.25) 8-pin package. Figure 4.60B shows how to use it. Note how feedback closes the loop around both op-amps. There are plenty of fancy S/H chips available, if you need better performance than the LF398 offers. For example, the AD783 from Analog Devices includes an internal capacitor and guarantees a maximum acquisition time of $0.4 \mu \mathrm{~s}$ for $0.01 \%$ accuracy following a 5 volt step.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-057.jpg?height=366&width=527&top_left_y=220&top_left_x=369)

Figure 4.61. Active clamp.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-057.jpg?height=294&width=731&top_left_y=690&top_left_x=252)

Figure 4.62. Finite slew-rate causes clamp output "glitches".

### 4.5.3 Active clamp

Figure 4.61 shows a circuit that is an active version of the clamp function we discussed in Chapter 1. For the values shown, $V_{\text {in }}<+10$ volts puts the op-amp output at positive saturation, and $V_{\text {out }}=V_{\text {in }}$. When $V_{\text {in }}$ exceeds +10 volts the diode closes the feedback loop, clamping the output at 10 volts. In this circuit, op-amp slew-rate limitations allow small glitches as the input reaches the clamp voltage from below (Figure 4.62).

Exercise 4.17. The active clamp in Figure 4.61 suffers from a slew-rate speed limitation similar to that of the peak tracker of Figure 4.58A. Figure out an improvement to the clamp circuit, analogous to the trick used in Figure 4.58B.

### 4.5.4 Absolute-value circuit

The circuit shown in Figure 4.63 gives a positive output equal to the magnitude of the input signal; it is a full-wave rectifier. As usual, the use of op-amps and feedback eliminates the diode drops of a passive full-wave rectifier.

You can imagine situations in which you want an output proportional to the logarithm of the absolute value. A simple circuit change might be to substitute a diode (or transistor with base tied to collector) for the feedback resistor of the second op-amp, exploiting the Ebers-Moll relation between diode voltage and summing-junction current. As we will see in Chapter $4 x$, this is the basis of the logarithmic amplifier; the circuit needs a few
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-057.jpg?height=422&width=799&top_left_y=207&top_left_x=1075)

Figure 4.63. Active full-wave rectifier.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-057.jpg?height=488&width=529&top_left_y=713&top_left_x=1210)

Figure 4.64. Another full-wave rectifier; note that ground is the negative supply voltage for $\mathrm{IC}_{2}$.
additional components, however, to compensate for the temperature coefficient of $V_{\mathrm{BE}}$.

Exercise 4.18. Figure out how the circuit in Figure 4.63 works. Hint: apply first a positive input voltage and see what happens; then do negative.

Figure 4.64 shows another absolute-value circuit. It is readily understandable as a simple combination of an optional inverter $\left(\mathrm{IC}_{1}\right)$ and an active clamp $\left(\mathrm{IC}_{2}\right)$. For negative input levels the clamp holds point $X$ at ground, making $\mathrm{IC}_{1}$ a unity-gain inverter; for positive input levels, the clamp is out of the circuit, with its output at negative saturation, making $\mathrm{IC}_{1}$ a follower. Thus the output is equal to the absolute value of the input voltage. By running $\mathrm{IC}_{2}$ from a single positive supply, you avoid problems of slew-rate limitations in the clamp, since its output moves over only one diode drop. Note that no great accuracy is required of $R_{3}$.

### 4.5.5 A closer look at the integrator

We introduced the op-amp integrator in $\S 4.2 .6$, before dealing with input bias current and offset voltage. One problem with that circuit (Figure 4.16) is that the output tends
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-058.jpg?height=820&width=667&top_left_y=202&top_left_x=187)

Figure 4.65. Integrator errors: bias current and offset voltage.
to wander off, even with the input grounded, because of op-amp offsets and bias current (there's no feedback at dc, which violates the third item in §4.2.7). This problem can be minimized by using a FET op-amp for low input current and offset, trimming the op-amp input offset voltage, and using large $R$ and $C$ values. Furthermore, in applications in which the integrator is zeroed periodically by closing a switch placed across the capacitor (Figures 4.18A-C), only the drift over short time scales matters.

It's worth looking at this in a bit more detail. Look at the integrator in Figure 4.65, shown with a choice of voltage input $V_{\text {in }}$ (which, in the absence of op-amp errors, produces a current into the summing junction of $I=V_{\text {in }} / R$ ), or a current input $I_{\text {in }}$ (in which case you omit the input resistor $R$ ). The ideal integrator produces an output

$$
V_{\text {out }}(t)=-\frac{1}{C} \int I_{\text {in }}(t) d t=-\frac{1}{R C} \int V_{\text {in }}(t) d t
$$

It's easy enough to figure out the effect of the op-amp's input errors $I_{\mathrm{B}}$ and $V_{\mathrm{OS}}$. Let's first take the case of an integrator circuit with current input. ${ }^{30}$ The op-amp's bias current $I_{\mathrm{B}}$ adds (or subtracts) from the true input current $I_{\mathrm{in}}$; in the absence of any external input current the integrator's output would ramp at a rate $d V_{\text {out }} / d t=I_{\mathrm{B}} / C$. The effect of op-amp input offset voltage, on the other hand, is simply

[^40]to offset the output voltage by $V_{\mathrm{OS}}$, without ramping; ${ }^{31}$ so, when you reset the integrator by shorting the feedback capacitor $C$, the output goes to a voltage equal to $V_{\mathrm{OS}}$ rather than zero.

Let's look at some actual values. In Figure 4.65 we've chosen, rather arbitrarily, values of $0.1 \mu \mathrm{~F}$ for $C$ and (for voltage input) $1 \mathrm{M} \Omega$ for $R$. So a positive input current of $1 \mu \mathrm{~A}$ produces an output ramp of $-10 \mathrm{~V} / \mathrm{s}$. If we were to choose the precision bipolar OP27E, its relatively high input current of $\pm 40 \mathrm{nA}$ (max) would cause an output ramp of as much as $d V_{\text {out }} / d t=I_{B} / C= \pm 0.4 \mathrm{~V} / \mathrm{s}$.

This isn't good, particularly if you want to integrate for a few seconds or more. So let's fix things by choosing an op-amp that excels in low bias current, for example the CMOS LMC6041A (the suffixes denote the particular grade; we've chosen the best in all cases). It has a specified maximum bias current of 4 pA over its temperature range (but an astounding 32 "typical" value of 2 fA , or $2 \times 10^{-15} \mathrm{~A}$ ). Now the worst-case output ramp, in the absence of any input signal current, is reduced to $d V_{\text {out }} / d t=I_{\mathrm{B}} / C= \pm 40 \mu \mathrm{~V} / \mathrm{s}$. The "typical" ramping rate is 2000 times smaller, if the specs can be believed; that's a mere $0.02 \mu \mathrm{~V} / \mathrm{s}$.

At this point, the lesson seems to be that the best opamp for any integrator is the one with the smallest bias current $I_{\mathrm{B}}$. But, alas, life is more complicated. In particular, if the integrator is wired for voltage input, with a series input resistor $R$, then the op-amp's offset voltage $V_{\mathrm{OS}}$ now produces a ramp when the input to the circuit is held at ground. Imagine the input is grounded ( $V_{\mathrm{in}}=0$ ), and think about it this way: the op-amp strives to align its inputs with a voltage $V_{\text {OS }}$ between them; that small voltage then produces a current $I=V_{\mathrm{OS}} / R$ through the input resistor. That current has to come through the feedback capacitor, that is, the output must ramp to produce the current needed to satisfy the op-amp's twisted belief that its inputs should differ by $V_{\mathrm{OS}}$. Another way to say it is that the current acts just like an input current of $I=-V_{\mathrm{OS}} / R$.

Now the choice of op-amp is not so clear! Look at Figure 4.65 again. The CMOS op-amp with its very low bias current has a pretty large offset voltage, $V_{\mathrm{OS}}=3 \mathrm{mV}$ (max). So in this circuit it can produce an equivalent input current of $3 \mathrm{nA}(3 \mathrm{mV}$ across $1 \mathrm{M} \Omega)$; that's nearly a thousand times

[^41]larger than the worst-case contribution of its bias current, and it's getting into the same ballpark as the input current of the OP27E bipolar op-amp we considered first.

If minimum drift is needed with these particular circuit values, the solution is to choose an op-amp with the best compromise of low bias current and low offset voltage; to be precise, it should have the minimum value of the total worst-case error current $I_{\mathrm{E}}=I_{\mathrm{B}}+V_{\mathrm{OS}} / R$. A good choice would be the bipolar OP97E, a precision (low-offset) opamp with internal bias-cancellation circuitry. It sports maximum values of $I_{\mathrm{B}}=0.1 \mathrm{nA}$ and $V_{\mathrm{OS}}=25 \mu \mathrm{~V}$; the corresponding worst-case current error is $I_{\mathrm{E}}=0.125 \mathrm{nA}$, which is 25 times better than that of the LMC6041A and 320 times better than that of the OP27.

Note that the relative contribution of $V_{\mathrm{OS}}$ and $I_{\mathrm{B}}$ to integrator error is scaled by the value of $R$. So you can simply choose a larger resistor value if you have an op-amp with excellent $I_{\mathrm{B}}$ but only modest $V_{\mathrm{OS}}$.

If the residual drift of an integrator circuit is still too large for a given application, or if long-term accuracy is unimportant, one solution is to put a large resistor $R_{2}$ across $C$ to provide dc feedback for stable biasing, as shown in Figure 4.18D. The effect is to roll off the integrator action at very low frequencies, $f<1 / R_{2} C$. The feedback resistor may become rather large in this sort of application. Figure 4.66 shows a trick for producing the effect of a large feedback resistor using smaller values in any op-amp circuit. In this case - an inverting amplifier circuit - the feedback network behaves like a single $10 \mathrm{M} \Omega$ resistor, thus producing a voltage gain of -100 . This technique has the advantage of using resistors of convenient values without the problems of stray capacitance, etc., that occur with very large resistor values. Note that this "T-network" trick may increase the effective input offset voltage if used in a transresistance configuration (§4.3.1C). For example, the circuit of Figure 4.66, driven from a high-impedance source (e.g., the current from a photodiode, with the input resistor omitted), has an output offset of 100 times $V_{\text {OS }}$, whereas the same circuit with a $10 \mathrm{M} \Omega$ feedback resistor has an output equal to $V_{\mathrm{OS}}$ (assuming the offset that is due to input current is negligible).

### 4.5.6 A circuit cure for FET leakage

Sometimes a circuit technique is so elegant and fascinating that we feel compelled to tell others about it. That's the case for the circuit in this section, brought over and updated from our 2nd edition. Read it and delight in its cleverness; but then check our remarks in the concluding paragraph.

In the integrator with a FET reset switch (Figure 4.18),
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-059.jpg?height=366&width=530&top_left_y=220&top_left_x=1184)

Figure 4.66. "T-network" simulates large-value resistor (here $10 \mathrm{M} \Omega$ ).
drain-source leakage sources a small current into the summing junction even when the FET is OFF. With an ultra-low-input-current op-amp and low-leakage capacitor, this can be the dominant error in the integrator. For example, the excellent LMC6001A JFET-input "electrometer" op-amp has a maximum input current of 0.025 pA , and a high-quality $0.1 \mu \mathrm{~F}$ metallized Teflon or polystyrene capacitor specifies leakage resistance as $10^{7}$ megohms, minimum. Thus the integrator, exclusive of reset circuit, keeps stray currents at the summing junction below 1 pA (for a worst-case 10 V full-scale output), corresponding to an output $d V / d t$ of less than $0.01 \mathrm{mV} / \mathrm{s}$. Compare this with the leakage contribution of a MOSFET such as the SD210 (enhancement mode), which specifies a maximum leakage current of 10 nA at $V_{\mathrm{DS}}=10 \mathrm{~V}$ and $V_{\mathrm{GS}}=-5 \mathrm{~V}$ ! In other words, the reset FET can contribute up to 10,000 times as much leakage as everything else combined.

Figure 4.67 shows a clever circuit solution. Although both $n$-channel MOSFETs are switched together, $Q_{1}$ is switched with gate voltages of 0 and +15 volts so that gate leakage (as well as drain-source leakage) is entirely eliminated during the OFF state (zero gate voltage). In the ON state the capacitor is discharged as before, but with twice $R_{\mathrm{ON}}$. In the OFF state, $Q_{2}$ 's small leakage passes to ground through $R_{2}$ with negligible drop. There is no leakage current at the summing junction because $Q_{1}$ 's source, drain, and substrate are all at the same voltage. (Sharpeyed readers may have noticed that the virtual ground at the op-amp's inverting input is imperfect to the extent of its offset voltage $V_{\mathrm{OS}} .{ }^{33}$ This can be trimmed to eliminate completely any leakage current from $Q_{1}$.)

The ultimate limit to capacitor "droop" in this circuit, once FET switch leakage has been eliminated, is set by the op-amp's input current and by the capacitor's selfdischarge. The capacitor shown has a specified ${ }^{34}$ leakage

[^42]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-060.jpg?height=526&width=615&top_left_y=209&top_left_x=218)

Figure 4.67. MOSFET leakage defeated by clever circuit.
resistance of $10^{7} \mathrm{M} \Omega$, i.e., $10^{13} \Omega$. The resulting leakage currents, of order $10^{-16} \mathrm{~A}$ (following reset), are entirely negligible compared with op-amp bias currents. For the opamp shown, the specified bias current is 25 fA maximum (10 fA typ) at $25^{\circ} \mathrm{C}$; that bias current produces a maximum droop of $0.25 \mu \mathrm{~V} / \mathrm{s}$. There are no op-amps with lower specified maximum bias current currently available; but you can find op-amps whose "typical" bias current is lower for example, the LMC6041, an inexpensive op-amp whose datasheet proclaims $I_{\mathrm{B}}=2 \mathrm{fA}$ (typ) at $25^{\circ} \mathrm{C}$ (no maximum is given at room temperature; $I_{\mathrm{B}}=4 \mathrm{pA}$ max over the full temperature range). What is one to make of an op-amp whose typical input current is 2000 times smaller than the guaranteed maximum? Just that the manufacturer knows that it's very good, but it's too painful to test in production. You'd do well to use these inexpensive units in such a circuit if you're willing to screen the op-amps yourself; otherwise pay the bounty for a unit that has a guaranteed limit (but note that the LMC6001A, such a unit, has a typi$\mathrm{cal} I_{\mathrm{B}}$ that is five times higher than that of the less expensive LMC6041).

When designing circuits where low input current is needed, watch out for temperature effects: all FET opamps (both JFET and CMOS types) exhibit dramatic increases in input current with rising temperature, typically doubling each $10^{\circ} \mathrm{C}$; the LMC6001A's guaranteed maximum bias current jumps from 25 fA at $25^{\circ} \mathrm{C}$ to 2000 fA at $85^{\circ} \mathrm{C}$. At high temperatures, the input (leakage) currents

[^43]of FET op-amps may often be higher than the input (bias) currents of low- $I_{\mathrm{B}}$ bipolar types; that is because leakage currents rise exponentially with temperature, whereas transistor bias currents remain roughly constant (or decrease slightly). Look back at Figure 3.48 for a good illustration; see also Figures 5.6 and 5.38.

It may be difficult to find discrete low-capacitance MOSFETs with substrate pins; currently the SD210 family (with SST-prefix SMT versions) is available from Linear Systems (Fremont, CA). The two-switch T-configuration is sound, though it may be challenging to find suitable switch components without substrate-diode conduction, etc. These MOSFETs work well, but if they become "unobtanium" we suggest you modify the circuit to use JFETs, in the manner of Figure 5.5.

### 4.5.7 Differentiators

Differentiators are similar to integrators, but with $R$ and $C$ reversed (Figure 4.68). Because the inverting input is at ground, the rate of change of input voltage produces a current $I=C\left(d V_{\text {in }} / d t\right)$ and hence an output voltage

$$
\begin{equation*}
V_{\mathrm{out}}=-R C \frac{d V_{\mathrm{in}}}{d t} \tag{4.7}
\end{equation*}
$$

Differentiators are bias stable, but they generally have problems with noise and instabilities at high frequencies because of the op-amp's high gain and internal phase shifts. For this reason it is necessary to roll off the differentiator action at some maximum frequency. The usual method is shown in Figure 4.69. The choice of the rolloff components $R_{1}$ and $C_{2}$ depends on the noise level of the signal and the bandwidth of the op-amp, with larger values providing greater stability and less noise, at the expense of differentiator bandwidth. A minimum recommended value for $R_{1}$ is given by $R_{1}=0.5 \sqrt{R_{2} / C_{1} f_{\mathrm{T}}} ; C_{2}$ can be added for further noise reduction, with a starting value of $C_{2} \approx C_{1} R_{1} / R_{2}$. At high frequencies $\left(f \gg 1 / 2 \pi R_{1} C_{1}\right)$ this circuit becomes an integrator because of $R_{1}$ and $C_{2}$. We'll explain what's going on here in more detail in §4.9.3.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-060.jpg?height=215&width=320&top_left_y=2015&top_left_x=1215)

Figure 4.68. Op-amp differentiator (noisy, probably unstable!).
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-061.jpg?height=302&width=568&top_left_y=221&top_left_x=346)

Figure 4.69. Adding $R_{1}$ and $C_{2}$ stabilizes the basic op-amp differentiator (consisting of $C_{1}, R_{2}$, and the op-amp); they also reduce high-frequency noise.

## 4.6 Op-amp operation with a single power supply

Op-amps don't require $\pm 15$ volt regulated supplies. They can be operated from split supplies of lower voltages ${ }^{35}$ or from unsymmetrical supply voltages (e.g, +12 and -3 ), as long as the total supply voltage $\left(V_{+}-V_{-}\right)$is within specifications (see Table 4.1 on page 245 for generic values, and Tables 4.2a,b on pages 271-272 for specific parts). Unregulated supply voltages are often adequate because of the high "power-supply rejection ratio" you get from negative feedback (for the 411 it's 90 dB typ). But there are many occasions when it would be nice to operate an op-amp from a single supply, say +9 volts. This can be done with ordinary op-amps by generating a "reference" voltage above ground, if you are careful about minimum supply voltages, output-swing limitations, and maximum common-mode input range.

In many cases, however, you can simplify these circuits by taking advantage of a class of op-amps designed for single supply operation. With characteristic directness, engineers call these "single-supply op-amps." Their common feature is that both their input common-mode range and their output swing extends to the negative supply rail (i.e., ground, when run from a single positive supply). A subclass of these can swing their outputs to both supplies ("rail-to-rail outputs"), and some of those even permit input swings to both rails ("rail-to-rail I/O"). Keep in mind, though, that operation with symmetrical split supplies should be considered the normal op-amp technique for most applications.

[^44]
### 4.6.1 Biasing single-supply ac amplifiers

For a general-purpose op-amp like the 411, the inputs and output can typically swing to within about 1.5 volts of either supply. With $V_{-}$connected to ground, you can't have either of the inputs or the output at ground; that is, it won't work properly if you drive the inputs to ground, and it simply cannot swing its output to ground.

Thus one reason why the circuit in Figure 4.70 won't work is that the ac-coupled low-level signal from the microphone is centered on ground, where the op-amp will not work. But even if the op-amp's input common-mode range included the negative rail (ground, here), we'd still be in trouble, because in this circuit the amplified output would also be centered on ground (so that it would have to swing both above and below ground). It is important to understand that this problem with the output cannot be solved in this manner - an op-amp simply cannot swing beyond its supply rails. Even an op-amp with rail-to-rail inputs and outputs would not work.

Exercise 4.19. Draw a sketch of the output waveform from the circuit of Figure 4.70, when driven with a 10 mV input sinewave, assuming that the op-amp is of the special class with rail-to-rail inputs and outputs.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-061.jpg?height=345&width=552&top_left_y=1241&top_left_x=1221)

Figure 4.70. Defective single-supply microphone amplifier.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-061.jpg?height=498&width=631&top_left_y=1705&top_left_x=1159)

Figure 4.71. A reference voltage at $\frac{1}{2} V_{+}$(created by divider $R_{1} R_{2}$ ) allows single-supply operation with an ordinary op-amp.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-062.jpg?height=751&width=1208&top_left_y=204&top_left_x=345)

Figure 4.72. Biasing schemes for single-supply operation A. Common reference (also known, confusingly, as a "virtual ground") for multiple stages; note bypass capacitor. B. Follower generates low-impedance reference. C. The reference can serve as the return path for feedback, with significant signal currents. D. Zener-type fixed voltage reference.

#### A. Reference voltage

One solution is to generate a reference voltage somewhere between ground and the positive supply (e.g. at half of $V_{+}$) to bias the op-amp for successful operation (Figure 4.71). This circuit is an audio amplifier with 40 dB gain. Choosing $V_{+}=12 \mathrm{~V}$ and $V_{\text {ref }}=0.5 \mathrm{~V}_{+}$gives an output swing of about 9 volts pp before the onset of clipping. Capacitive coupling is used at the input and output to block the dc level, which equals $V_{\text {ref }}$. The optional resistors should be used if this circuit connects to the outside world; they ensure that there is no dc voltage at the input and output, which prevents loud clicks and pops when external stuff is connected.

The reference voltage can be generated at the op-amp input with a simple resistive divider, as shown. If the circuit requires several op-amp stages, it is simpler to generate a common reference, with a single bias resistor to each stage, as in Figure 4.72A. Be sure to bypass the reference, to prevent signal coupling. You can also buffer the reference with a follower (Figure 4.72B), which is particularly useful if any significant dc or signal currents flow through that path, as in Figure 4.72C. Note that the follower can be any ordinary op-amp, because it is operating with a midsupply signal. In this circuit the reference voltage doesn't have to be half of the supply voltage; it may be best to split the supply unsymmetrically, to allow maximum signal swing. In some instances it may be preferable to put it at a fixed voltage from one rail, using an IC zener-like fixed
reference, as in Figure 4.72D; that rail is then a regulated supply with respect to the common reference.

Contemporary circuit design is moving to lower supply voltages, often in the form of a single positive supply. For operation with a single +5 V supply, for example, a conventional op-amp like the 411 simply will not do: Not only can its outputs not swing typically closer than 1.5 V to the supply rails; in fact, it is not even specified for operation from a total supply voltage of less than 10 V . So for such circuits you should use op-amps designed for low-voltage operation. These are often called "single-supply" op-amps and come in several forms, some of which include specified operation of both inputs and outputs down to the negative rail; others feature output swings to both rails, of which a subset permits both inputs and outputs to go to both rails. We'll deal with these shortly, in §4.6.3.

#### B. Supply splitter

The circuit in Figure 4.72C suggests a different approach to operation with a battery. Instead of piping a line called $V_{\text {ref }}$ around as a signal common, with the negative battery terminal called ground, why not ground the "reference" output, effectively splitting the single supply into a positivenegative pair? This is a common technique in battery operated equipment, and is shown in Figure 4.73. The battery voltage is split by the resistive divider, which feeds a follower to generate a low-impedance common voltage. To
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-063.jpg?height=348&width=626&top_left_y=201&top_left_x=325)

Figure 4.73. Op-amp split-supply generator. A follower generates a low-impedance mid-battery output voltage, which becomes circuit ground.
the outside world that common voltage is "ground," with both ends of the battery floating.

The output should be bypassed, as always, to maintain low-impedance supply rails, relative to ground, at signal frequencies. That is necessary because ground is usually the common return for filters, biasing networks, loads, etc. Look at almost any normal split-supply circuit and you'll find dc and signal currents flowing into and out of ground.

This raises an interesting problem, which we discuss in detail in Chapter $4 x$ and in 89.1 .1 C , namely that the op-amp's output resistance, in combination with the bypass capacitor, creates a lagging phase shift at high frequencies that can cause the feedback loop to go into oscillation. Some op-amps are designed to circumvent this problem, for example the LT1097 shown in the figure (whose datasheet states that it is stable with any capacitive load). Even so, this circuit exhibits a peak in its output impedance versus frequency (Figure 4.74), and a related effect, namely, a ringing transient with that same characteristic frequency (Figure 4.75); you can think of these effects as the not-quite-banished ghost of an oscillation. As the figures show, a small series damping resistor at the opamp's output (Figure 4.76A) effectively stops this resonant behavior, at the expense of an increase in dc output impedance.

If increased output impedance is undesirable (which often it is not), another approach is to take "slow" feedback downstream of the damping resistor (which preserves accurate dc performance, i.e., low dc output impedance), with a parallel "fast" feedback path from the upstream side (Figure 4.76B) to prevent ringing. You can see the result in Figure 4.75 , where we used $R_{1}=2.7 \Omega, R_{2}=10 \mathrm{k}$, and $C=2.7 \mathrm{nF}$ : the initial transient looks just like that with a $2.7 \Omega$ damping resistor, but then returns to the correct dc level because dc feedback is taken from the point of load. A third possibility is to "overcompensate" the op-amp, for which the LT1097 provides hospitality in the form of a convenient "overcomp" pin; adding a capacitor to ground from this
pin increases the phase margin by shifting the dominant pole downward in frequency (§4.9).

There's a nice integrated solution from Texas Instruments, the TLE2425 and TLE2426 "rail-splitter" ICs. These come in a convenient 3-terminal TO-92 (small transistor) package, draw less than 0.2 mA quiescent current, are stable into any capacitive load greater than $0.33 \mu \mathrm{~F}$, and can source or sink an unbalanced current of 20 mA (Figure 4.77). The TLE2426 splits the rails $50 \%$ with an internal resistive divider, whereas the TLE2425 uses an internal voltage reference to put the output common 2.50 V above the negative rail.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-063.jpg?height=468&width=721&top_left_y=817&top_left_x=1109)

Figure 4.74. One effect of the capacitive load is a bump in the output impedance, which is greatly reduced with a $5 \Omega$ damping resistor; see text.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-063.jpg?height=527&width=777&top_left_y=1517&top_left_x=1081)

Figure 4.75. Measured output voltage transient of the rail-splitter circuit of Figure 4.76 A caused by a 4.5 mA load current step, with several values of series damping resistor. The latter eliminates ringing, at the expense of dc output impedance. An alternative is the "split-feedback" scheme of Figure 4.76B. Scales: $5 \mathrm{~mA} / \mathrm{div}$ and $10 \mathrm{mV} / \mathrm{div}$; $40 \mu \mathrm{~s} / \mathrm{div}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-064.jpg?height=555&width=632&top_left_y=207&top_left_x=184)

Figure 4.76. Stabilizing the split-supply generator: A. Decoupling resistor, B. Decoupling resistor with fast and slow feedback paths.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-064.jpg?height=309&width=815&top_left_y=922&top_left_x=118)

Figure 4.77. Integrated 3-terminal rail splitter.

### 4.6.2 Capacitive loads

This particular example of a supply-splitter illuminates a more general problem, namely, the effect of capacitive loading at the output of any op-amp circuit. Although we'll deal with this further in the advanced Chapter $4 x$, it's important to appreciate now the causes, and cures, because it can cause mischief in even the simplest of op-amp circuits.

Let's say you build a little box, with some op-amps inside and the output(s) brought out through the ever-popular BNC panel connectors. It's easy to forget that something like a length of shielded cable - say a 2 m BNC cable going from an output connector to some other instrument has plenty of capacitance: the standard RG-58 shielded cable patch cords have 100 pF per meter (see Appendix H). So an innocuous connecting cable alone loads the op-amp's output with 200 pF . That's sometimes enough to make an op-amp follower oscillate (we rig up just such a demonstration in our circuit design class, where an LF411 follower screams loudly when asked to drive 8 ft of cable). And even if it doesn't break into oscillation, it will likely exhibit response peaks at high frequencies, evident as overshoot and ringing.

The causes are the same as with the supply splitter: the capacitive load creates a lagging phase shift, and it's within the feedback loop. ${ }^{36}$

And the possible cures are the same (Figure 4.78); taking the figure's circuits in order (A-E):

- You can add a small series resistor (perhaps $25-100 \Omega$ ) at the op-amp's output, outside the feedback loop. (It's quite common to see a $50 \Omega$ output resistor, which forms a matched source to " $50 \Omega$ cable"; see Appendix H.) This is OK , and easy; but it does mean that feedback does not act on the actual output signal, which may be significant with nasty loads, or at high frequencies, etc.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-064.jpg?height=1245&width=552&top_left_y=755&top_left_x=1099)

Figure 4.78. Driving capacitive loads.

[^45]- You can split the feedback loop, as shown, so that feedback comes directly from the op-amp's output at high frequencies, where instability lurks. And at lower frequencies the feedback accurately controls the signal seen by the load. This is not really a compromise, because those high frequencies are exactly where the thing would oscillate anyway if you were to allow feedback from the load.
- You can reduce the loop gain, for example by increasing the closed-loop gain, to regain stability.
- You can seek an op-amp that guarantees stability into the range of load capacitances you expect. Many op-amps provide good data in the form of plots of "Stability versus Capacitive Load." Figure 4.79 shows an example, taken from the datasheet for the LMC6482.
- You can add a unity-gain buffer, with its low native output impedance, either within or outside the feedback loop. If you add it inside the loop, you need to worry about phase shifts introduced by the buffer; it should have significantly higher $f_{\mathrm{T}}$ than the op-amp, and it's often a good idea to include a $50-100 \Omega$ series resistor at the buffer's input (not shown). You may need to rolloff the op-amp's response with a small capacitor, as in Figure 4.87 on page 274.

### 4.6.3 "Single-supply" op-amps

As we just remarked, some op-amps are designed specifically to allow inputs and outputs to go to the negative rail. These are called "single-supply" (or "ground-sensing") opamps, the idea being that their negative rail is actually tied to ground. The input range actually extends slightly below ground, typically to -0.3 V . In some cases the outputs can swing also to the positive rail ("rail-to-rail output"), and a subset of these permits input swings to (and slightly be-
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-065.jpg?height=483&width=718&top_left_y=1713&top_left_x=258)

Figure 4.79. Stability versus capacitive load for a LMC6482 opamp follower with $R_{\text {load }}=2 \mathrm{k}$ and $\pm 7.5 \mathrm{~V}$ supplies.
yond) both rails ("rail-to-rail input"). Linear Technology has introduced an exotic new twist - op-amps that permit input swings well beyond the positive rail (they call them "Over-The-Top ${ }^{\mathrm{TM}}$ " amplifiers).

These amplifiers can simplify single-supply circuits because you don't need a midsupply reference, rail splitter, etc. But you have to remember that the output cannot go below ground - so you can't build an audio amplifier like Figure 4.70, whose output would need to swing both sides of ground. Before looking at the characteristics of these op-amps in more detail, let's look at a design example.

#### A. Example: single-supply photometer

Figure 4.80 shows a typical example of a circuit for which single-supply operation is convenient. We discussed a similar circuit earlier under the heading of current-to-voltage converters (and we will go further in Chapter $4 x$ ). Because a photocell circuit might well be used in a portable lightmeasuring instrument, and because the output is known to be positive only, this is a good candidate for a batteryoperated single-supply circuit. $R_{1}$ sets the full-scale output at 5 volts for an input photocurrent of $0.5 \mu \mathrm{~A}$. The small feedback capacitor is added to ensure stability, as we'll explain in §4.9.3. No offset voltage trim is needed in this circuit, since the worst-case untrimmed offset of 10 mV corresponds to a negligible $0.2 \%$ of full-scale meter indication. The TLC27L1 is an inexpensive micropower ( $10 \mu \mathrm{~A}$ supply current) CMOS op-amp with input and output swings to the negative rail. Its low input current ( 0.6 pA , typ, at room temperature ${ }^{37}$ ) makes it good for low-current applications like this. If you choose a bipolar op-amp for this kind of low signal-current circuit, better performance at
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-065.jpg?height=427&width=680&top_left_y=1577&top_left_x=1137)

Figure 4.80. Single-supply photometer.

[^46]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-066.jpg?height=350&width=422&top_left_y=218&top_left_x=325)

Figure 4.81. Photodiode amplifier with simple bias current cancellation.
low light levels results if the photodiode is connected as in the circuit shown in Figure 4.81.

It's worth noting that the "current budget" of this circuit is dominated by the output current that drives the meter, which can go as high as $500 \mu \mathrm{~A}$. It's easy to overlook a point like that, blithely assuming that the battery need provide only the op-amp's $10 \mu \mathrm{~A}$ quiescent current. At $10 \mu \mathrm{~A}$ a standard 9 V battery lasts 40,000 hours ( 5 years), whereas with continuous operation at $500 \mu \mathrm{~A}$ it would last a month.

#### B. Single-supply op-amp innards

It's helpful to look at the circuitry of a typical single-supply op-amp, both to understand how these types achieve operation to one or both rails, and also to appreciate some of the subtleties and pitfalls of designing them into your circuits. Figure 4.82 is a simplified schematic of the very popular TLC270 series of CMOS single-supply op-amps. The input stage is a $p$-channel MOSFET differential amplifier with current-mirror active load. The use of enhancementmode $p$-channel input transistors lets the inputs go to the negative rail (and a bit beyond, until the omnipresent input protection diodes begin to conduct), but prevents input operation to the positive rail (because there would be no forward gate-source voltage).

Unlike the classic conventional op-amp with its pushpull follower output stage (Figure 4.43), this output stage is unsymmetrical: an $n$-channel follower $Q_{6}$ for the pullup and another $n$-channel common-source amplifier $Q_{7}$ for the pull-down. That's done because a follower at $Q_{7}$ (which would have to be p-channel) could not pull all the way down, given that its lowest gate drive voltage is ground. This unsymmetrical output requires the common-source driver $Q_{5}$ for $Q_{6}$ 's gate, with matching threshold voltages for $Q_{5}$ and $Q_{7}$ to set the output-stage quiescent current. The feedback capacitor $C_{\text {comp }}$ is for frequency compensation (see §4.9.2). This output stage can saturate at ground, with an impedance of $Q_{7}$ 's $R_{\mathrm{ON}}$; but it can't reach $V_{+}$, because $Q_{6}$ is an $n$-channel MOSFET follower.

Exercise 4.20. What sets the source voltage of $Q_{1}$ and $Q_{2}$ when the inputs are approximately at ground? And what determines the high end of the input range? Why is the latter always below $V_{+}$?

Exercise 4.21. What sets the maximum positive voltage to which $Q_{6}$ can pull the output, assuming the op-amp is lightly loaded?

This same output-stage structure - follower pullup with amplifier pull-down - can be built with bipolar transistors; an example is the popular LT1013/LT1014 singlesupply dual-quad op-amps, improved variants of the classic LM358/LM324 op-amps. A note of caution: don't make the mistake of assuming that you can make any op-amp's output work down to the negative rail simply by providing an external current sink. In most cases the circuitry driving the output stage does not permit that. Look for explicit permission in the datasheet!

One way to achieve rail-to-rail outputs - i.e., operation to both supply rails - is to replace the $n$-channel follower pullup $Q_{6}$ in Figure 4.82 with a $p$-channel common-source amplifier; then each transistor can saturate to its respective rail. This requires some driver circuitry changes, of course. An analogous circuit can be built with bipolar transistors common emitter pnp pullup and npn pull-down. Contemporary examples include the CMOS TLC2270, LMC6000, and MAX406 series, and the bipolar LM6132, LT1881, and MAX4120 series. As we'll see in Chapter $4 x$, there are other ways to make single-supply and rail-to-rail outputs. These amplifiers differ in important ways, and you must watch out for misleading statements about output swing to the negative rail (ground).

These output stages are pretty straightforward, and not surprising. But they don't generalize to the input stage. How, indeed, can you possibly achieve rail-to-rail input capability? To complete the picture without going into any
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-066.jpg?height=534&width=809&top_left_y=1664&top_left_x=968)

Figure 4.82. Simplified schematic of the TLC271-series singlesupply op-amp.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-067.jpg?height=575&width=1165&top_left_y=218&top_left_x=466)

Figure 4.83. Precision voltage-controlled waveform generator.
detail, the trick is to design an amplifier with two independent input stages, one $p$-channel (or $p n p$ ) and the other $n$-channel (or npn). We talk about them, and some other nifty tricks (such as putting on-chip voltage generators to create bias supplies beyond the rails, in combination with a conventional op-amp like Figure 4.43), in Chapter $4 x$. Single-supply op-amps are indispensable in batteryoperated equipment.

### 4.6.4 Example: voltage-controlled oscillator

Figure 4.83 shows a clever circuit, borrowed from the application notes of several manufacturers. $\mathrm{IC}_{1}$ is an integrator, rigged up so that the capacitor current ( $V_{\text {in }} / 15 \mathrm{k}$ ) changes sign, but not magnitude, when $Q_{1}$ conducts. $\mathrm{IC}_{2}$ is connected as a Schmitt trigger, with thresholds at one-third and two-thirds of $V_{\text {ref }}$. The $n$-channel MOSFET $Q_{1}$ is here used as a switch, pulling the bottom side of $R_{4}$ to ground when $\mathrm{IC}_{2}$ 's output is HIGH and leaving it open-circuited when the output is LOW.

A nice feature of this circuit is its operation from a single positive supply. The TLV3501 is a CMOS comparator with rail-to-rail output swing, which means that the output of the Schmitt goes all the way from $V_{\text {ref }}$ to ground; this ensures that the thresholds of the Schmitt don't drift, as they would with an op-amp of conventional output-stage design, with its ill-defined limits of output swing. In this case the result is stable frequency and amplitude of the triangle wave. Note that the frequency depends on only the ratio $V_{\text {in }} / V_{\text {ref }}$; this means that if $V_{\text {in }}$ is generated from $V_{\text {ref }}$ by a resistive divider (made from some sort of resistive transducer, say), the output frequency won't vary with $V_{\text {ref }}$, only with changes in resistance. This is another example
of ratiometric techniques; circuit designers like to use this trick to minimize dependence on power-supply voltages.

Some additional points.

- Both the frequency conversion coefficient and the output swing amplitude are set by the reference voltage that powers $\mathrm{IC}_{2}\left(V_{\text {ref }}\right)$, in this case a precise and stable +5.00 V provided by the 3 -terminal voltage reference $\mathrm{IC}_{3}$. This voltage could be left unregulated if the control voltage is arranged to be proportional to it, as described above. The output amplitude would, however, still be dependent on that supply rail. The solution just shown is preferable.
- The integrator op-amp, $\mathrm{IC}_{1}$, is a "precision" op-amp, with a maximum offset voltage of $60 \mu \mathrm{~V}$. It was chosen to provide accurately proportional frequency down near zero volts input. You can think of this instead in terms of dynamic range of the frequency control: input offset voltage in the integrator op-amp produces an error in frequency equivalent to a value of $V_{\text {in }}$ of twice that offset voltage (because of the divider $R_{2} R_{3}$ ); to say it another way, at an input voltage $V_{\text {in }} \approx 2 V_{\mathrm{OS}}$, the output frequency will be in error by $100 \%$ (it could be as large as twice the programmed frequency and as low as zero). So the ratio of maximum to minimum frequency is roughly equal to $V_{\mathrm{ref}} / V_{\mathrm{OS}}$. The LT1077C shown in the figure provides a dynamic range of nearly 100,000:1 (the ratio $V_{\text {ref }} / V_{\text {OS }}=5 \mathrm{~V} / 60 \mu \mathrm{~V}$ ).
- The integrator op-amp must operate down to zero volts input; i.e., it must be a "single-supply" (or "groundsensing") op-amp, of which the LT1077C is an example.
- Input current $I_{\mathrm{B}}$ of the integrator op-amp also causes an error, most serious when the control voltage $V_{\text {in }}$ is near zero volts. The LT1077C has well-matched inputs with $I_{\mathrm{B}}(\max )=11 \mathrm{nA}$, which causes a worst-case error
equivalent to about $30 \mu \mathrm{~V}$ of unbalance when it flows through the network of unequal input resistors. This is smaller than the error contribution that is due to worstcase $V_{\mathrm{OS}}$; the combination results in a worst-case equivalent error of $90 \mu \mathrm{~V}$, or a dynamic range (untrimmed) of 50,000:1. The fact that offset voltage effects dominate over bias current effects is no accident: that is why the resistor values $R_{1}-R_{4}$ were chosen as small as they are (and the capacitor value $C_{1}$ was then chosen to produce the desired frequency range).
- The LT1077C could be trimmed to extend the dynamic range; ultimately it is drift in $V_{\mathrm{OS}}$ and $I_{\mathrm{B}}$ (over time and temperature) that set the circuit's overall stability near zero frequency.
- The TLV3501 is an unusually fast ( 4.5 ns ) comparator with rail-to-rail output swing. However, its supply voltage is limited to +5.5 V maximum. If you wanted to run that portion of the circuit at a higher voltage, you could substitute a fast rail-to-rail op-amp like the CA3130. The latter part has been around a long time and is nearing extinction; ${ }^{38}$ but it excels in speed for a low-power op-amp because it is uncompensated (see $\S 4.9 .2 \mathrm{~B}$ ). It would not be suitable for the input op-amp, however, because it is not stable as an integrator, for reasons we will see shortly. It also has large input offset voltage.
- Another possibility is to replace the Schmitt trigger circuit with a CMOS 555-type timer IC, for example, an ICL7555. These have stable input thresholds at one-third and two-thirds of the supply rail, and rail-to-rail fast output swing.
- Switch alternatives: IC switches like the SD210 or 74HC4066 (the latter belongs to the 74HC family of digital logic) could replace the discrete MOSFET $Q_{1}$; their lower capacitance would improve operation at high frequencies.
- Another possibility, if power consumption matters more than maximum frequency or dynamic range, is to use low-power CMOS rail-to-rail op-amps for both ICs, for example, a TLC2252 dual op-amp ( $35 \mu \mathrm{~A}$ per channel). In this case scale up the resistor values, particularly in the input stage, because CMOS op-amps have negligible input current for this application.
- If the use of a dual op-amp in a single package seems particularly appealing, then a good overall choice is the bipolar LM6132, with rail-to-rail inputs and outputs and a slew rate of $14 \mathrm{~V} / \mu \mathrm{s}$; in the same family you can get faster op-amps (LM6142, LM6152), at the cost of higher input and supply currents.

[^47]- An elegant single-IC solution is the use of a combination op-amp-comparator-reference IC like the MAX951. We looked around for a way to use such a chip here, but, alas, we couldn't squeeze the excellent performance of Figure 4.83 out of any of the combination chips currently available, nor from special-purpose timers like the LTC699x-series (§7.1.4B). This illustrates the circuit performance advantage you get if you can combine the best available ICs for the given task, rather than having to accept a pre-assembled combination.

Exercise 4.22. Derive the expression for output frequency shown in Figure 4.83. Along the way, verify that the Schmitt thresholds and integrator currents are as advertised.

### 4.6.5 VCO implementation: through-hole versus surface-mount

Traditionally, electronic components were made with wire leads sticking out the ends (e.g., "axial-lead" resistors and capacitors), or rows of pins sticking down (e.g., ICs with DIP - "dual in-line" - packaging). Contemporary practice has shifted strongly toward "surface-mount" components, in which the connections are made directly to contacts on a ceramic or plastic package. See, for example, the photographs of resistors in Chapter 1 (Figure 1.2), of op-amps earlier in this chapter (Figure 4.1), or of small logic (Figure 10.23) in Chapter 10.

The good news is that surface-mount technology (SMT) lets you make smaller gadgets; and it is better electrically as well, because of reduced inductances in the smaller packages.

The bad news is that SMT makes it difficult to wire up a circuit on the spur of the moment on a prototype "breadboard" (of either the solder-in or plug-in style), an exercise that is fast and easy with through-hole components. The problem is compounded by the fact that many new highperformance components (e.g., op-amps) are available only in surface-mount packages.

In a nutshell, your choices boil down to (a) sticking with through-hole components (if you can get the parts you need) and enjoying the easy prototyping and ability to build a one-off gadget quickly; (b) going with the flow, and using mostly SMT components, laying out a printed circuit board for each circuit you want to build; or (c) trying to retain the best of both worlds by prototyping with through-hole components, where available, and using SMT adapters (or "carriers") for the SMT components that you cannot get in through-hole packages. The latter are tiny circuit boards on which you solder an SMT component, whose leads connect
to a row of pins, producing a faux through-hole component. We've struggled with this whole business and have concluded that this last option, though attractive in principle, is fast fading away, because of the decreasing availability of through-hole components.

To give a glimpse of the tradeoffs, we laid out the voltage-controlled oscillator (VCO) circuit of Figure 4.83 on printed-circuit boards, exploring the alternatives of (a) through-hole components, (b) relatively large SMT components, and (c) small SMT components. Figure 4.84 shows them at actual size; we've shown only the component outlines and "pads" (metal foil patterns that make the connections to the components). For the through-hole board we used standard DIP op-amp and comparator and axial-lead $1 / 4$-watt resistors; for the large SMT we used SOIC-8 opamp and comparator and 0805 SMT resistors; and for the small SMT we used SOT-23 op-amp and comparator and the smaller 0603 resistors. ${ }^{39}$ The latter is 4.5 times smaller than the through-hole board. And there is no penalty in performance; in fact, smaller components generally deliver somewhat better performance owing to smaller parasitic inductances.

### 4.6.6 Zero-crossing detector

This example illustrates the use of a single-supply comparator, a close kin to the single-supply op-amp. Like the latter, it will operate with input signals all the way to the lower supply rail, which often is ground. The circuit, shown in Figure 4.85, generates an output square wave for use with 5 V "TTL" logic ( 0 to +5 V range) from an input wave of any amplitude up to 150 volts rms. The LM393 is a comparator IC (like the TLV3501 we used in the last example), specialized for this sort of application; it cannot be used as an amplifier, in the manner of an op-amp, because its internal phase shifts are not tailored ("compensated," see §4.9) to permit feedback without oscillation. It also has an "open-collector" output, which you must pull up externally to a supply rail, as shown. Its internal circuit is shown in Figure 4.86; note the overall similarity to an op-amp (Figure 4.43), with the important omission of the compensation capacitor $C_{\mathrm{C}}$, and the lack of a "pullup" transistor at the output. We treat comparators in more detail in §12.3.

[^48]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-069.jpg?height=675&width=552&top_left_y=220&top_left_x=1196)

Figure 4.84. Printed-circuit layouts for the VCO of Figure 4.83. The use of small surface-mount components reduces the board area to $22 \%$ of the analogous board using through-hole components. Additional benefits are a greater selection of available parts, and better electrical performance.

Resistor $R_{1}$, combined with $D_{1}$ and $D_{2}$, limits the input swing to -0.6 volt to +5.6 volts, approximately; its power rating is set by the maximum rms input voltage. Resistive divider $R_{2} R_{3}$ is necessary to limit negative swing to less than 0.3 volt, the limit for a 393 comparator. $R_{5}$ and $R_{6}$ provide hysteresis for this Schmitt trigger circuit, with $R_{4}$ setting the trigger points symmetrically about ground. The input impedance is nearly constant because of the large $R_{1}$ value relative to the other resistors in the input attenuator. A 393 is used because its inputs can go all the way to ground, making single-supply operation simple.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-069.jpg?height=529&width=802&top_left_y=1730&top_left_x=1068)

Figure 4.85. Zero-crossing level detector with input protection.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-070.jpg?height=588&width=807&top_left_y=165&top_left_x=114)

Figure 4.86. Schematic of the LM393 single-supply comparator.

Exercise 4.23. Verify that the trigger points are at $\pm 100 \mathrm{mV}$ at the input signal.

Some additional points.

- The vintage LM393 severely limits the allowable swing below ground, because the output will switch polarity if the input goes below -0.3 V , a pathology tactfully called phase reversal in the datasheet. That is prevented here by diode $D_{1}$ and divider $R_{2} R_{3}$; alternatively the low side of $D_{1}$ could be biased a diode drop above ground, as in Figure 5.81. Resistor $R_{3}$ could be omitted if a modern comparator like the LT1671 were used; the latter also has internal active pullup to +5 V , so you would omit pull-up resistor $R_{7}$ as well.
- We intentionally set the Schmitt thresholds symmetrically around ground, but that may not be the best choice. For example, you might want output transitions accurately synchronized with the exact zero crossings of the input waveform. Omitting $R_{4}$ would set the negativegoing input threshold exactly at 0 V ; alternatively, you could set the positive-going threshold to 0 V with a properly-chosen value for $R_{4}$ (test your understanding with Exercise 4.24).
- By using capacitive feedback only (omitting $R_{5}$ ), you can have both thresholds at 0 V with some of the benefits of hysteresis. In this case, the hysteresis is transient, with a time constant $\tau=C_{1} R_{6}$, by which time you are assuming the input waveform will have left the threshold region. So, for example, if you were using this circuit to sense zero crossings of a 60 Hz sinewave, you might choose $C_{1}=0.1 \mu \mathrm{~F}$ for a 0.5 ms time constant (but see next item). The drawback is that you're making assumptions about the input's minimum slew rate and maximum zero-crossing frequency. You could imagine a more elaborate scheme, with additional comparators, such that the input threshold is restored to 0 V after the input wave-
form passes a second higher threshold. This design challenge would yield a precise zero-crossing circuit (for both waveform slopes) with no restrictions on input speed, etc.
- Be careful if you decide to increase the value of the speed-up capacitor $C_{1}$ - this capacitor causes a negativegoing transient at the inverting input of the comparator, and if the capacitor is much larger than a few picofarads you may cause phase reversal at the comparator's output (a pathology of many comparators, including the LM393). In that case it's best to use a modern comparator whose datasheet specifically brags that it is free of phase reversal; an example is the MAX989.

Exercise 4.24. What value of $R_{4}$ in Figure 4.85 puts the positivegoing input threshold at 0 V ?

Exercise 4.25. Try designing a hysteretic circuit, with several comparators, such that both thresholds are precisely at 0 V , under the assumption that the input waveform always travels a minimum of 50 mV beyond ground before coming back.

### 4.6.7 An op-amp table

We've collected in Table 4.2a on the facing page a representative selection of useful op-amps, including many of our favorites. You can get an idea of the price and performance of parts that are in wide use. Better yet, use this table as a starting point in your next design! More comprehensive op-amp tables are located in the chapter on precision design (Table 5.4, High-speed op-amps; Table 5.5, Precision op-amps; Table 5.6, Auto-zero op-amps), and in the chapter on noise (Table 8.3, Low-noise op-amps).

## 4.7 Other amplifiers and op-amp types

In this first op-amp chapter we've met the "standard" splitsupply op-amp, implemented variously with bipolar transistors, JFETs and MOSFETs. We've also seen examples of single-supply op-amps, some with rail-to-rail outputs (and even rail-to-rail inputs).

There are other choices, some of which we'll look at in Chapters $4 x$ and 5. It's worth listing them here, because one or more of them may be the best solution to a design problem that looks initially like it needs an op-amp.

#### Current-feedback op-amps

These look a lot like ordinary ("voltage-feedback") opamps, but differ by having a low-impedance inverting input terminal that is a current summing junction. They excel in wideband circuits with moderate to high voltage gain; see the discussion in Chapter $4 x$.
Table 4.2a Representative Operational Amplifiers (see also Tables 5.2-5.6 and 8.3)

| Part \# ${ }^{\text {a }}$ | Package |  |  | Total Supply |  | $I_{Q}$ <br> typb <br> (mA) | $\begin{gathered} f_{\mathrm{T}} \\ \text { typ } \\ (\mathrm{MHz}) \end{gathered}$ | ![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-071.jpg?height=94&width=111&top_left_y=1211&top_left_x=364) | $V_{\text {os }}$ max $(\mu \mathrm{V})$ | $I_{\text {bias }}$ typ (nA) | ![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-071.jpg?height=104&width=107&top_left_y=916&top_left_x=366) | Swing to supplies?$\frac{\mathrm{IN}}{+-} \frac{\mathrm{OUT}}{+-}$ | Comments |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|  | \#/pkg | 응 | qty 25 <br> (\$US) | min <br> (V) | max <br> (V) |  |  |  |  |  |  |  |  |
| LM358, 324 | 2,4 | $\cdot$ $\cdot$ - | 0.16 | 3 | 32 | 1 | 1 | 0.5 | 7000 | 45 | 40 | - $\cdot$ - $\cdot$ | single-supply jellybean |
| LT1013, 1014 | 2,4 | $\cdot$ $\cdot$ - | 1.30 | 4 | 44 | 0.7 | 0.8 | 0.4 | 40 | 12 | 22 | - $\cdot$ - $\cdot$ | precision single-supply |
| LT1077A | 1 | $\cdot$ $\cdot$ - | 4.11 | 2.2 | 44 | 0.05 | 0.23 | 0.08 | 40 | 7 | 27 | - $\cdot$ - $\cdot$ | low-power bipolar, also OP193 |
| LMC6482A, 84A | 2,4 | $\cdot$ $\cdot$ - | 1.73 | 3 | 16 | 1.3 | 1.5 | 1.3 | 750 | 20fA | 37 | $\cdot$ | CMOS jellybean, LMC7101 SOT-23 |
| TLC2272A, 74 | 2,4 | $\cdot$ $\cdot$ - | 1.57 | 4 | 16 | 2.2 | 2.2 | 3.6 | 950 | 0.001 | 9 | - $\cdot$ $\cdot$ $\cdot$ | CMOS |
| LMC6442A | 2 | $\cdot$ $\cdot$ - | 2.00 | 2.2 | 16 | 0.002 | 0.01 | 0.004 | 3000 | 5fA | 170 | $\cdot$ | micro-power! |
| LMC6041, 42, 44 | 1,2,4 | $\cdot$ $\cdot$ - | 1.48 | 4.5 | 16 | 0.02 | 0.08 | 0.015 | 3000 | 2fA | 83 | - $\cdot$ $\cdot$ $\cdot$ |  |
| LMC6081A, 82, 84 | 1,2,4 | $\cdot$ - - | 2.72 | 4 | 16 | 0.45 | 1.3 | 1.5 | 350 | 10fA | 22 | - $\cdot$ $\cdot$ $\cdot$ | for low power, LMC6061 has $I_{\mathrm{Q}}=20 \mu \mathrm{~A}$ |
| TLV2401, 02 | 1,2 | - $\cdot$ $\cdot$ | 1.42 | 2.5 | 16 | 0.0009 | 0.005 | 0.002 | 1200 | 0.1 | 500 | $\cdot$ $\cdot$ $\cdot$ | pico-power, operates to $V_{\mathrm{Cc}}+5 \mathrm{~V}$ |
| LMC7101A | 1 | - - $\cdot$ | 0.93 | 2.7 | 16 | 0.5 | 1 | 1 | 3000 | 0.001 | 37 | $\cdot$ $\cdot$ $\cdot$ $\cdot$ | similar to LMC6482 |
| LF411, 412C | 1,2 | $\cdot$ $\cdot$ - | 0.72 | 7 | 36 | 4.5 | 3 | 13 | 2000 | 0.05 | 18 | - - - - | JFET, TI, dual cheaper than single |
| LF347B | 4 | $\cdot$ $\cdot$ - | 0.58 | 7 | 36 | 8 | 3 | 13 | 5000 | 0.05 | 18 | $\cdot$ - - - | low cost JFET, 15¢ per op-amp |
| LT1057A, 1058 | 2,4 | $\cdot$ $\cdot$ - | 6.30 | 7 | 40 | 3.4 | 5 | 24 | 450 | 0.05 | 13 | - - - - | improved LF412, also see AD712 |
| OPA727, 2727 | 1,2 | - $\cdot$ - | 2.58 | 4 | 13 | 4.3 | 20 | 30 | 150 | 0.085 | 6 | - $\cdot$ $\cdot$ $\cdot$ | e-trim CMOS |
| OPA376, 2376 | 1,2 | - $\cdot$ $\cdot$ | 2.03 | 2.2 | 7 | 0.76 | 5.5 | 2 | 25 | 0.2pA | 7.5 | - $\cdot$ $\cdot$ $\cdot$ | e-trim CMOS |
| TLC272C, 274C | 2,4 | $\cdot$ $\cdot$ - | 0.69 | 3 | 16 | 1.4 | 2.2 | 5.3 | 10 mV | 0.1pA | 27 | - $\cdot$ - $\cdot$ | consider TLV27x family |
| OPA129B | 1 | $\cdot$ $\cdot$ - | 10.15 | 10 | 36 | 1.2 | 1 | 2.5 | 2000 | 30fA | 17 | - - - - | electrometer, mass spec, pH probe |
| LT1012A | 1 | $\cdot$ $\cdot$ - | 5.11 | 2.4 | 40 | 0.37 | 0.4 | 0.2 | 25 | 0.025 | 14 | - - - - | low $I_{B}$ bipolar |
| LTC1050C | 1 | $\cdot$ - - | 4.30 | 6 | 18 | 1.1 | 2.5 | 4 | 5 | 0.01 | $1.6 \mu \mathrm{~V}^{\mathrm{C}}$ | - $\cdot$ $\cdot$ | chopper |
| LT1637 | 1 | $\cdot$ - - | 2.32 | 2.7 | 44 | 0.19 | 1 | 0.35 | 350 | 20 | 27 | + $\cdot$ $\cdot$ | "over-the-top": $V_{\text {in }}$ to $V_{\text {EE }}+44 \mathrm{~V}$ |
| LT1097 | 1 | $\cdot$ $\cdot$ - | 2.33 | 2.6 | 40 | 0.35 | 0.7 | 0.2 | 50 | 0.04 | 14 | - - - - | CLOAD stable, comp pin |
| OPA177 | 1 | $\cdot$ $\cdot$ - | 2.30 | 6 | 44 | 1.5 | 0.6 | 0.3 | 60 | 0.5 | 7 | - - - - | improved OP-07 |
| OPA277, 2277, 4227 | 1,2,4 | $\cdot$ $\cdot$ - | 3.60 | 4 | 36 | 0.8 | 1 | 0.8 | 20 | 0.5 | 8 | - - - - | improved OP-07, see also OPA227 |
| LM6132A, 34 | 2,4 | $\cdot$ - - | 2.92 | 2.7 | 35 | 0.8 | 11 | 14 | 2000 | 110 | 27 | $\cdot$ | early RRIO |
| AD797A | 1 | $\cdot$ - - | 8.36 | 10 | 36 | 8.2 | 80 | 20 | 80 | 250 | 0.9 | - - - - | low distortion, low noise |
| ADA4000-1, 2, 4 | 1,2,4 | - $\cdot$ $\cdot$ | 1.46 | 8 | 36 | 1.3 | 5 | 20 | 1700 | 0.005 | 16 | $\cdot$ - - - | JFET |
| LT6220, 21, 22 | 1,2,4 | - $\cdot$ | 2.61 | 2.5 | 12.6 | 0.9 | 60 | 20 | 200 | $15^{\text {h }}$ | 10 | $\cdot$ $\cdot$ $\cdot$ $\cdot$ |  |
| OPA627A | 1 | $\cdot$ - - | 24.50 | 9 | 36 | 7 | 16 | 55 | 250 | 0.002 | 5.6 | - - - - | low-noise JFET |
| OPA657 | 1 | - $\cdot$ $\cdot$ | 12.90 | 8 | 13 | 14 | 1600 | 700 | 1800 | 0.002 | 4.8 | - - - - | fast JFET |
| OPA454 | 1 | - $\cdot$ - | 4.88 | 10 | 120 | 3.2 | 2.5 | 13 | 4000 | 0.002 | 35 | - $\cdot$ - - | high voltage, also OPA445 miniDIP |
| THS4011, 12 | 1,2 | $\cdot$ $\cdot$ - | 5.60 | 9 | 33 | 7.8 | 290 | 310 | 6000 | 2000 | 7.5 | - - - - | fast VFB ${ }^{\text {; }}$; THS4021/22 decomp, G>10 |
| LM7171A | 1 | - $\cdot$ - | 3.60 | 8 | 36 | 6.5 | 200 | 4100 | 4000 | 2700 | 14 | - - | CFB $^{\text {e }}, 100 \mathrm{~mA}$ output current |
| EL5165 | 1 | - $\cdot$ $\cdot$ | 2.32 | 5 | 12.6 | 5 | 1400 | 6000 | 5000 | 8500 | 1.7 | - | CFB ${ }^{\text {e }}$ |
| AD8011 | 1 | $\cdot$ $\cdot$ - | 3.98 | 3 | 12.6 | 1 | $570^{\text {d }}$ | 3500 | 5000 | 5000 | 2 | - - - | low-power two-stage CFB |
| Notes: (a) Italicized part numbers have corresponding number of op-amps per package. (b) quiescent current per package, for the boldface part number (that with the least number of op-amps; e.g.,1mA for the LM358). (c) peak-to-peak noise voltage. (d) GBW for $\mathrm{GV}=10$. (e) $\mathrm{VFB}=\mathrm{voltage}$ feedback, $\mathrm{CFB}=\mathrm{current}$ feedback. (h) rises to 250nA at the negative rail. |  |  |  |  |  |  |  |  |  |  |  |  |  |

Table 4.2b Monolithic Power and High-Voltage Op-Amps ${ }^{a}$

| Type | Mfg | Total supply |  |  |  |  | $\begin{gathered} f_{\mathrm{T}} \\ \text { typ } \\ (\mathrm{MHz}) \end{gathered}$ | Slew rate typ (V/ / s ) | Iout(max) typ (A) | $P_{\text {diss }}$ <br> ( $50^{\circ} \mathrm{C}$ ) <br> max <br> (W) | ![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-072.jpg?height=197&width=60&top_left_y=247&top_left_x=1260) |  | Package | Cost qty 25 (\$US) | ![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-072.jpg?height=158&width=48&top_left_y=286&top_left_x=1697) |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
|  |  |  |  | Diff'l input $^{b}$ | है잉 | ![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-072.jpg?height=79&width=60&top_left_y=291&top_left_x=1309) |  |  |  |  |  |  |  |  |
|  |  | $\begin{gathered} \hline \min ^{\prime} \\ \text { (V) } \end{gathered}$ | max <br> (V) |  | typ <br> (mA) |  |  |  |  |  |  | 岀 華 |  |  |  | ![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-072.jpg?height=70&width=60&top_left_y=369&top_left_x=1309) |
| Iow power |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| LME49726 | TI | 2.5 | 6 | 0.7 | full | $\cdot$ - | 6.8 | 3.7 | 0.35 | $1^{\text {u }}$ | - | - - | MSOP | 1.29 | A |
| OPA567 | TI | 2.7 | 7.5 | 3.4 | full | - - | 1.2 | 1.2 | 2.2 | $12.5^{\text {n }}$ | $\cdot$ | $\cdot$ $\cdot$ | QFN | 5.53 | B |
| OPA569 | TI | 2.7 | 7.5 | 3.4 | full | $\cdot$ - | 1.2 | 1.2 | 2.2 | $25^{n}$ | $\cdot$ |  | SO-20 | 7.41 | B,C |
| AD8010 | Analog | 10 | 12.6 | 16 | 1.2 | - - | 230 | 800 | 0.2 | $1.3^{\text {u }}$ | - - | - - | SO-16 | 6.69 | D |
| LM6171 | TI | 5 | 36 | 2.5 | 10 | - - | 100 | 3000 | 0.12 | 0.7 | - - | - - | DIP, SO | 4.27 | E |
| LTC2057HV | LTC | 4.8 | 65 | 0.8 | full | - - | 1.5 | 0.45 | 0.02 | low | - | - - | SO-8 | 3.32 | F |
| ADA4700 | Analog | 10 | 100 | 1.7 | full | - - | 3.5 | 20 | 0.03 | 2.5 | $\cdot$ - | - - | SO-8 | 6.00 |  |
| OPA445 | TI | 20 | 100 | 4.2 | 80 | - - |  | 10 | 0.015 | 0.6 | - | - - | DIP, SO-8 | 10.07 | G |
| OPA454 | TI | 10 | 100 | 3.2 | fullg |  | 2.5 | 13 | 0.12 | $7.5^{n}$ | $\cdot$ - | - $\cdot$ | SO-8 | 6.09 |  |
| LTC6090 | LTC | 9.5 | 140 | 2.8 | full | - - | 12 | 21 | 0.05 | $15^{n}$ | $\cdot$ - | - $\cdot$ | SO,TTSOP | 4.87 | H |
| medium power |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| L2720W | ST | 4 | 28 | 10 | full | - - | 1.2 | 2 | 1 | 5 | $\cdot$ - | - - | SO-16 | 1.02 | I |
| ISL1532A | Intersil | 10 | 30 | $3.5^{\circ}$ | full | - - | 50 | 400 | 1 | 1 | - | - $\cdot$ | SSOP-20 | $1.43^{r}$ | J |
| THS3120 | TI | 9 | 33 | 7 | 4 | - - | 130 | 900 | 0.47 | $15^{n}$ | - - | - $\cdot$ | MSOP-8 | 5.57 | K |
| LT1794 | LTC | 10 | 36 | 26 | full | - - | 200 | 600 | 0.72 | $25^{n}$ | $\cdot$ - | - $\cdot$ | SO-20 | 8.09 | J |
| LT1206 | LTC | 10 | 36 | $12^{\circ}$ | full | - $\cdot$ | 60 | 900 | 0.5 | $15^{\text {p }}$ | - | - $\cdot$ | DIP,TO-220 | 5.88 | K,L |
| LT1210 | LTC | 8 | 36 | 35 | full | $\cdot$ | 35 | 900 | 2 | $15^{p}$ | - | - $\cdot$ | TO-220-7 | 8.75 | K,M |
| L272 | FSC | 4 | 40 | 8 | full | - - | 0.35 | 1 | 1 | 5 | $\cdot$ - | - - | DIP, SO-16 | 2.08 | N |
| PA75 | Apex | 5 | 40 | 8 | full | - - | 1.4 | 1.4 | 2.5 | 19 | - | - - | TO-220-7 | 28.88 | O |
| TDA7256 | ST | 10 | 50 | 80 | full | - - | 9 | 10 | 3 | 35 | $\cdot$ | - $\cdot$ | TO-220-11 | 3.42 | P |
| LM1875 | TI | 16 | 60 | 70 | full | - - | 5.5 | 8 | 4 | 25 | - | - - | TO-220-5 | 2.75 | P |
| OPA552 | TI | 8 | 60 | 7 | full | $\cdot$ | 12 | $24{ }^{\text {d }}$ | 0.2 | $25^{p}$ | $\cdot$ | - - | DIP, DDPak | 5.70 | Q |
| LM675 | TI | 20 | 60 | 18 | full | - - | 5.5 | 8 | 3 | 40 | - | - - | TO-220-5 | 4.82 | R |
| OPA547 | TI | 8 | 60 | 10 | full | - - | 1 | 6 | 0.5 | 25 | $\cdot$ | - $\cdot$ | TO-220-7 | 9.57 | S |
| OPA548 | TI | 8 | 60 | 17 | full | - - | 1 | 10 | 3 | 30 | - | - $\cdot$ | TO-220-11 | 13.22 | S |
| OPA549 | TI | 8 | 60 | 26 | full | - - | 0.9 | 9 | 8 | 53 | $\cdot$ | - $\cdot$ | TO-220-11 | 20.65 | S |
| OPA453 | TI | 20 | 80 | 4.5 | full |  | 7.5 | $23^{\text {d }}$ | 0.05 | 25 | $\cdot$ | - - | TO-220-7 | 5.50 | T |
| OPA541 | TI | 20 | 80 | 20 | full | - - | 2 | 10 | 10 | 90 | - | - - | TO-3, SIP-11 | 19.28 |  |
| LM3886 | TI | 18 | $84^{\text {s }}$ | 50 | 60 | - - | 8 | 19 | 11.5 | 75 | - | - $\cdot$ | TO-220-11 | 5.94 | P |
| TDA7293 | ST | 24 | 120 | 30 | 30 | - - | - | 15 | 6.5 | 75 | $\cdot$ - | - $\cdot$ | TO-220-15 | 5.49 | P |
| higher voltage |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| PA340 | Apex | 20 | 350 | 2.2 | 16 | $\cdot$ | 10 | $32^{k}$ | 0.06 | 16 | $\cdot$ | - - | DDPak-7 | 21.45 | U |
| PA90 | Apex | 30 | 400 | 10 | 20 | - $\cdot$ | 100 | $300^{\text {e }}$ | 0.2 | 18 | - | - - | SIP-12 +tab | $188.00^{v}$ | U |
| PA15 | Apex | 100 | 450 | 2.0 | 25 | $\cdot$ $\cdot$ | 5.8 | 20 | 0.2 | $18^{n}$ | - | - - | SIP-10 | $185.00^{v}$ | U |
| PA98 | Apex | 30 | 450 | 21 | 25 |  | 100 | $1000^{\text {e }}$ | 0.2 | 18 | - | - - | SIP-12 +tab | $272.00^{V}$ | U |
| PA97 | Apex | 100 | 900 | 0.6 | 20 |  | 1 | $8^{\text {e }}$ | 0.01 | $3^{n}$ | - | - - | SIP-12 | $176.00^{V}$ | V |

Notes: (a) within categories, sorted by maximum voltage, then output current; the Apex parts are hybrid, and neither PCB nor instrument-box types are listed. (b) not to exceed total supply voltage. (c) $P_{\text {diss }}$ with case at $T_{\mathrm{C}}=50 \mathrm{C}$, based on $R_{\theta \mathrm{JC}}$. (d) when comp for $G>10$. (e) when comp for $G>100$. ( g ) internal JFETs limit current to 4 mA . ( h ) see notes. ( k ) for $C_{C}=4.7 \mathrm{pF}, G \geq 10$. ( n ) provided you can get the heat out of the package! (o) adjustable. (p) power package. (r) qty 1k. (s) 94 V w/o signal. (u) to ambient. (v) unit qty; see distributor prices (and your banker) for larger qty.

Comments: (A) dual, RRO. (B) RRIO. (C) with current monitor. (D) video. (E) VFB with CFB. (F) auto-zero, $4 \mu \mathrm{~V}$. (G) has $V_{\text {os }}$ trim; also in TO-99. (H) dual='6091. (I) update of L272. (J) dual, ADSL driver. (K) current-feedback, CFB. (L) can drive 10nF capacitive loads. (M) 1.1A min.
(N) Fairchild's version. ( O ) amp+buffer. (P) audio amplifier. (Q) slower OPA551 for $G=1$. (R) classic workhorse. (S) current-limit adjustment with resistor or external current. (T) slower OPA452 for $G=1$. (U) MOSFET output. (V) "inexpensive."

#### "Zero-drift" op-amps

These unusual op-amps, which include auto-zero and chopper-stabilized amplifiers, are tailored for precision (low-VOS) applications. They use internal MOS switches to measure and correct for input offset error. These are the only amplifiers with values of
untrimmed $V_{\text {OS }}$ down to $5 \mu \mathrm{~V}$ or less. See Table 5.6 on page 335.

High-voltage, high-power op-amps
You can get op-amps with maximum output currents of 25 amps or more, or with power supply voltages to 1 kV or

#### "Here Yesterday, Gone Today"

In its untiring quest for better and fancier chips, the semiconductor industry can sometimes cause you great pain. It might go something like this: you've designed and prototyped a wonderful new gadget; debugging is complete, and you're ready to go into production. When you try to order the parts, you discover that a crucial IC has been discontinued by the manufacturer! An even worse nightmare goes like this: customers have been complaining about late delivery on some instrument that you've been manufacturing for many years. When you go to the assembly area to find out what's wrong, you discover that a whole production run of boards is built, except for one IC that "hasn't come in yet." You then ask purchasing why they haven't expedited the order; turns out they have, just haven't received it. Then you learn from the distributor that the part was discontinued six months ago and that none is available!

Why does this happen, and what do you do about it? We've generally found four reasons that ICs are discontinued.

1. Obsolescence: Much better parts come along, and it doesn't make much sense to keep making the old ones. This has been particularly true with digital memory chips (e.g., small static RAMs and EPROMs, which are superseded by denser and faster versions each year), though linear ICs have not entirely escaped the purge. In these cases there is often a pin-compatible improved version that you can plug into the old socket.
2. Not selling enough: Perfectly good ICs sometimes disappear. If you are persistent enough, you may get an explanation from the manufacturer - "there wasn't enough demand," or some such story. You might characterize this as a case of "discontinued for the convenience of the manufacturer." We've been particularly inconvenienced by Harris's discontinuation of their splendid

HA4925 - a fine chip, the fastest quad comparator, now gone, with no replacement anything like it. In our first edition we reported that Harris also discontinued the HA2705 - another great chip, the world's fastest lowpower op-amp, gone without a trace! Since that time, Maxim came out with the MAX402, similarly a fast low-power op-amp. Lots of us used it; then - whammo - can't get it! Sometimes a good chip is discontinued when the wafer fabrication line changes over to a larger wafer size (e.g., from the original $3^{\prime \prime}$ diameter wafer to a $5^{\prime \prime}$ or $6^{\prime \prime}$ wafer).
3. Lost schematics: You might not believe it, but sometimes the semiconductor house loses track of the schematic diagram of some chip and can't make any more! This apparently happened with the Solid State Systems SSS-4404 CMOS 8-stage divider chip.
4. "Upgraded" production line: Sometimes a manufacturer will replace older test equipment (which may have been working just fine) with the latest and greatest new stuff. Problem is, the programs to run the new testers aren't finished yet. So, the wafer line could be making lots of chips ... but there's no way to test them. This scenario appears to have played out in the case of the magnificent OPA627, one of our all-time favorites (there was nearly a year in which you couldn't get these puppies, but, thankfully, it's back in production).
5. Manufacturer out of business: This also happened to the SSS-4404! If you're stuck with a board and no available IC, you've got several choices. You can redesign the board (and perhaps the circuit) to use something that is available. This is probably best if you're going into production with a new design or if you are running a large production of an existing board. A cheap and dirty solution is to make a little "daughterboard" that plugs into the empty IC socket and includes whatever it takes to emulate the nonexistent chip. Although this latter solution isn't terribly elegant, it gets the job done.
more! These are specialized (and expensive) devices, extremely useful for applications such as piezo drivers, servo drivers, and so on. See Table 4.2 b on the facing page for some favorites.

#### Micropower op-amps

At the other end of the spectrum, you can get op-amps with quiescent currents as low as a microamp or less. These things aren't blazingly fast - the LMC6442, with
$I_{\mathrm{Q}}=10 \mu \mathrm{~A}$ per amplifier, has an $f_{\mathrm{T}}$ of 10 kilohertz, and a slew rate ${ }^{40}$ of $0.004 \mathrm{~V} / \mu \mathrm{s}$ - but they do let you run a portable instrument just about forever on a single battery.

#### Instrumentation amplifiers

These are integrated differential amplifiers with settable voltage gain. They contain several op-amps internally and

[^49]![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-074.jpg?height=1146&width=1633&top_left_y=213&top_left_x=130)

Figure 4.87. Laboratory dc amplifier with output offset. Op-amp power supply connections and bypass capacitors are not shown explicitly, a common practice in circuit schematics.
excel in stability and common-mode rejection. Instrumentation amplifiers are discussed in §5.15.

Video and radiofrequency amplifiers
Specialized amplifiers for use with video signals, or with communications signals at frequencies from 10 MHz to 10 GHz , are widely available as fixed-gain amplifier modules. At these frequencies you generally don't use op-amps.

#### Dedicated amplifier variants

Microphone preamps, speaker amplifiers, stepping motor drivers, and the like are available as customized ICs with superior characteristics and ease of use.

## 4.8 Some typical op-amp circuits

### 4.8.1 General-purpose lab amplifier

Figure 4.87 shows a dc-coupled "decade amplifier" with settable gain, bandwidth, and wide-range dc output offset.
$\mathrm{IC}_{1}$ is a low-noise JFET-input op-amp with noninverting gain from unity $(0 \mathrm{~dB})$ to $\times 100(40 \mathrm{~dB})$ in accurately calibrated 10 dB steps; a vernier is provided for variable gain. $\mathrm{IC}_{2}$ is an inverting amplifier; it allows offsetting the output over a range of $\pm 10$ volts, accurately calibrated by the 10 turn pot $R_{16}$ by injecting current into the summing junction. $C_{3}-C_{5}$ set the high-frequency rolloff, because it is often a nuisance to have excessive bandwidth (and noise). $\mathrm{IC}_{5}$ is a power booster for driving low-impedance loads or cables; it can provide $\pm 150 \mathrm{~mA}$ output current.

Some interesting details: a $10 \mathrm{M} \Omega$ input resistor is small enough, since the bias current of the OPA627 is 10 pA (maximum, at room temperature), thus producing a 0.1 mV error with open input. $R_{2}$, in combination with clamp diodes $D_{1}$ and $D_{2}$, limits the input voltage at the op-amp to the range $V_{-}-0.6 \mathrm{~V}$ to $V_{+}+0.6 \mathrm{~V}$. With the protection components shown, the input can go to $\pm 150$ volts without damage. The JFET-input OPA627 was chosen for its combination of low input current ( $I_{\mathrm{B}}=1 \mathrm{pA}$, typ $)$, modest pre-
cision $\left(V_{\mathrm{OS}}=100 \mu \mathrm{~V}\right.$, max), low noise ( $e_{\mathrm{n}}=5 \mathrm{nV} / \sqrt{\mathrm{Hz}}$, typ), and wide bandwidth ( $f_{\mathrm{T}}=16 \mathrm{MHz}$, typ); the latter is needed to preserve some loop gain at the high-frequency end of the instrument $(100 \mathrm{kHz})$ when running at full gain $(40 \mathrm{~dB})$.

The output stage is an inverter with a unity-gain power buffer inside the feedback loop. The vintage LT1010 has plenty of slew rate, bandwidth, and muscle, with less than $10 \Omega$ open-loop output impedance (which of course is lowered by feedback; see $\S 2.5 .3 \mathrm{C}$ ). Both it and the OPA627 have enough slew rate ( $75 \mathrm{~V} / \mu$ s and $55 \mathrm{~V} / \mu \mathrm{s}$, respectively) to generate a full $\pm 15 \mathrm{~V}$ output swing at the full 100 kHz bandwidth of the instrument. A power buffer like this is good for isolating capacitive loads from the op-amp (more on this in Chapter $4 x$; see also $\S \S 4.6 .1 \mathrm{~B}$ and 4.6.2); furthermore, it takes the heat when driving a hefty load, which keeps $\mathrm{IC}_{2}$ cool, an important consideration with precision (low- $V_{\mathrm{OS}}$ ) op-amps. It takes lots of drive compared with an op-amp - up to 0.5 milliamp - but that's no problem when you're driving it with an op-amp.

The offset circuit consists of a precision LT1027 3terminal voltage reference IC. We'll learn more about these in Chapter 9; they generate a highly stable voltage output when powered from a noncritical dc rail that is at least 2 volts higher than their specified output voltage. This particular part comes in several grades, the best of which (LT1027A) has a maximum error of 1 mV , and is guaranteed to drift less than $2 \mathrm{ppm} /{ }^{\circ} \mathrm{C}$; for this application we'd save some money by choosing the inexpensive " $D$ " grade $\left(5.0 \mathrm{~V} \pm 2.5 \mathrm{mV} ; 5 \mathrm{ppm} /{ }^{\circ} \mathrm{C}\right)$. The OP177 is a highly stable precision op-amp ( $V_{\mathrm{OS}}<10 \mu \mathrm{~V}$, $\mathrm{TC} V_{\mathrm{OS}}<0.1 \mu \mathrm{~V} /{ }^{\circ} \mathrm{C}$ in its best grade) that provides a stable offsetting voltage. Capacitor $C_{6}$ bypasses noise on the reference voltage, and $C_{7}$ and $C_{8}$ reduce amplifier noise by limiting the bandwidth of the amplifiers. For a dc application like this you don't need, and don't want, lots of bandwidth. We'll talk in detail about this sort of precision design in Chapter 5.

Some additional points.

- In a circuit like this the input protection network can limit the ultimate bandwidth, because $R_{2}$ forms a lowpass filter in combination with the combined input capacitance of $\mathrm{IC}_{1}$, diode capacitance, and associated wiring capacitance. In this case the total capacitance is approximately 12 pF , which puts the 3 dB point at 300 kHz , well above the 100 kHz high-frequency limit of the instrument. To use a similar protection circuit in a wideband amplifier, you could reduce the value of $R_{2}$, put a small capacitor ( 47 pF , say) across it, or both. You could also use clamp diodes with lower capacitance, for example a 1N3595 or a PAD5 (see Chapter $1 x$ ).
- A really useful general-purpose laboratory amplifier should have true differential inputs. This is best done with an instrumentation amplifier, rather than an op-amp; see §5.15. Here we've compromised with a "pseudodifferential" configuration, in which the input common terminal (which is the return path for feedback), floating from circuit ground with a $100 \Omega$ resistor, is allowed to accommodate a small amount of signal from the input source. A better arrangement, though still not symmetrically differential, is shown in Figure 4.88, where a difference amplifier $\left(\mathrm{IC}_{7}\right)$ uses the floating input common as a reference. Note the use of a chassis-isolated BNC panel connector.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-075.jpg?height=373&width=779&top_left_y=783&top_left_x=1080)

Figure 4.88. Difference amp cancels error from signal on input common.

- In many situations it is preferable to introduce the dc offset at the input rather than at the output. Then you can change gain, without adjusting the offset, to zoom in on a portion of the input signal. This requires a much larger range of offset voltage, and other circuit changes as well. We'll see an example in Chapter 5.
- Watch out for op-amps that exhibit phase reversal when their inputs go more than 0.3 V below $V_{-}$; in such cases a restrictive input clamp must be used to prevent negative swings below that limit. This is a common defect of many op-amps, which the excellent OPA627 does not share.
- Contemporary instrumentation usually provides for remote operation, with digital control from a computer. This circuit, however, uses mechanical controls for gain, bandwidth, and offset. You could replace the mechanical switches with analog switches, and use a DAC to generate the offset, to adapt this instrument to digital control.
- The rolloff capacitors $C_{3}-C_{5}$ close the loop around the output amplifier pair $\left(\mathrm{IC}_{2}+\mathrm{IC}_{5}\right)$ at high frequencies, which is beneficial in terms of reducing noise. But it also promotes instability, owing to the combined phase shifts of the two amplifiers. This arrangement is still OK, though, as long as the bandwidth of buffer $\mathrm{IC}_{5}$ is much greater than that of amplifier $\mathrm{IC}_{2}$.

But that is not the case here: the OPA627 op-amp has a unity gain bandwidth of $f_{\mathrm{T}}=16 \mathrm{MHz}$, at which it specifies a $75^{\circ}$ phase margin. But the LT1010 buffer adds about $50^{\circ}$ of additional lagging phase shift, pushing the amplifier close to instability (see $\S 4.9$ for an explanation of phase margin and stability). The solution here is to use a small feedback capacitor around the op-amp ( $\left.4.7 \mathrm{pF}, C_{2}\right)$, which closes the high-frequency feedback path directly. This rolls off its gain to unity at about 1 MHz , at which frequency the buffer contributes less than $5^{\circ}$ additional lagging phase shift.

Exercise 4.26. Check that the gain is as advertised. How does the variable-offset circuitry work? At what frequency would the slew-rate-limited output swing drop below $\pm 15 \mathrm{~V}$ ?

### 4.8.2 Stuck-node tracer

Here's a nice example of an op-amp circuit with nonlinear feedback. A tricky troubleshooting problem is a so-called stuck node, in which there is a short somewhere on a circuit board. It may be an actual short-circuit in the wiring itself, or it may be that the output of some device (for example a digital logic gate, see Chapter 10) is held in a fixed state. It's hard to find, because anywhere you look on that line, you measure zero volts to ground.

A technique that does work, however, is to use a sensitive voltmeter to measure voltage drops along the stuck trace. A typical signal trace on a printed-circuit board might be $0.010^{\prime \prime}$ wide and $0.0013^{\prime \prime}$ thick ( 1 ounce per square foot), which has a resistance along the trace of $53 \mathrm{~m} \Omega / \mathrm{in}$. So if there's a device holding the line to ground somewhere and you inject a diagnostic current of 10 mA dc somewhere else, there will be a voltage drop of $530 \mu \mathrm{~V}$ per inch in the direction of the stuck node.

Let's design a stuck-node tracer. It should be battery powered so that it can float anywhere on the powered circuit under test. It should be sensitive enough to indicate a drop of as little as $\pm 100 \mu \mathrm{~V}$ on its zero-center meter, with larger meter deflections for larger drops. Ideally it should have a nonlinear scale, so that even for voltage drops of tens of millivolts the meter will not go off scale. And with some care it should be possible to design a circuit that draws so little battery current that we can omit the on/off switch: 9 V batteries or AA-size cells give nearly their full shelf life of several years at continuous drain currents of less than $20 \mu \mathrm{~A}$ (they have capacities of about 500 mAh and 2500 mAh , respectively).

With a floating supply provided by batteries, the simplest circuit is a high gain inverting amplifier driving a
zero-center meter (Figure 4.89). Because the input and output are both intrinsically bipolarity, it's probably best to use a pair of AA cells, running the op-amp from $\pm 1.5$ volt unregulated supplies. The back-to-back Schottky diodes reduce the gain gracefully at large output swings and prevent pegging; Figure 4.90 plots the resulting meter deflection versus $V_{\text {in }}$.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-076.jpg?height=409&width=700&top_left_y=528&top_left_x=1017)

Figure 4.89. Stuck-node tracer: high-gain floating dc amplifier with nonlinear feedback.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-076.jpg?height=465&width=684&top_left_y=1089&top_left_x=1033)

Figure 4.90. Stuck-node tracer achieves large dynamic range through nonlinear feedback.

The major difficulty in this design is in achieving an input offset of less than $100 \mu \mathrm{~V}$ while maintaining micropower current drain, all with supply voltages of just $\pm 1.5$ volts. The OP193 is specified to operate down to 2 V total supply voltage, and its output stage swings to the negative rail and to within a volt of the positive rail. In its best grade (" $E$ " suffix) its offset voltage is $75 \mu \mathrm{~V}$, maximum. Its quiescent current of just $15 \mu \mathrm{~A}$ ensures that the batteries will last their full shelf life, since that current would provide continuous operation for over 150,000 hours from a 2500 mAh battery.

Some additional points.

- One subtle problem with this circuit is that an alkaline battery at the end of its life is down to about 1.0 V
terminal voltage; so you would have insufficient headroom to provide full-scale positive output voltage $(+0.5 \mathrm{~V})$, given the all-npn output stage. A solution is to use a higher battery voltage (e.g., 3 V lithium cells, or multiple alkaline 1.5 V AA cells). But operation from a single pair of AA cells is an elegance worth preserving. In this case you would do better to use an op-amp with true rail-to-rail output, for example, the CMOS OPA336. The latter has a quiescent current of $20 \mu \mathrm{~A}$, operates down to 2.3 V total supply voltage, and has an untrimmed offset voltage of $125 \mu \mathrm{~V}$. Its input voltage range goes to the negative rail and to within 1 volt of the positive rail; the latter is fine here, because we have chosen an inverting amplifier configuration with both inputs at 0 V .
- We rather artificially constrained the circuit design by choosing a zero-center analog meter and then insisting on using just a pair of AA alkaline cells. In real life you'd probably be happier with an audio output, with the pitch increasing with input voltage drop; then you could keep your eye on the circuit as you probe around. For this job you'd probably use a simple current-controlled oscillator, built with an op-amp relaxation oscillator or a 555-type timer IC (Chapter 7); for a noncritical application you don't need the linearity and stability of the VCO we designed in Figure 4.83.
- Don't forget the "rail-splitter" techniques we discussed in $\S 4.6 .1 \mathrm{~B}$; you can always use those tricks to create a split plus and minus rail, for example, from a single 9 V battery. With $\pm 4.5 \mathrm{~V}$ rails, you have a much wider range of op-amps to choose from. We were forced to choose from a rather small selection that run on 2 V total supply, draw only tens of microamps supply current, and have "precision" low input offset voltage. Once you have 5 V total supply available (a 9 V battery is down to 6 V at the end of its life), there are literally hundreds of available op-amps, dozens of which run on micropower current drain and have precision low offsets. See, for example, Table 5.5 on page 320.

### 4.8.3 Load-current-sensing circuit

Figure 4.91 shows a hefty ( 10 kW !) power supply driving a 100 amp load; the illustrated circuit provides a voltage output proportional to load current, for use with a current regulator, metering circuit, or whatever. The output current is sensed with a current shunt, a calibrated manganinmetal 4-terminal power resistor $R_{\mathrm{S}}$, of resistance $0.0005 \Omega$, whose "Kelvin connection" of four leads ensures that the sensed voltage does not depend on a low-resistance bond to the sensing terminals (as would be the case if you tried
to do the same thing with a conventional 2-terminal resistor). The voltage drop goes from 0 to 50 mV , with probable common-mode offset caused by the effects of resistance in the ground lead (note that the power supply is connected to chassis ground at the output). For that reason the op-amp is wired as a differential amplifier, with a gain of 200 . Voltage offset is trimmed externally with $R_{8}$, as the venerable LM358A doesn't have internal trimming circuitry. A zener reference with a few percent stability is adequate for trimming, because the trimming is itself a small correction (you hope!). The supply voltage, $V_{+}$, could be unregulated, since the power-supply rejection of the op-amp is more than adequate, 85 dB (typ) in this case.

Some additional points.

- Chassis ground and circuit ground would be connected together, somewhere. But there could easily be a volt or so separating circuit ground from the sensing point along the high-current negative return, because of the very large currents flowing. For that reason we connected the negative supply lead of the op-amp to the more negative end of the current-shunt output. This ensures that the commonmode voltage appearing at the op-amp input never goes below its negative rail; it is a "single-supply" op-amp, with operating common-mode range to its negative rail.
- Low offset voltage is important in this application; for example, to achieve $1 \%$ accuracy in a current measurement made at $10 \%$ of full-scale load current (i.e., a 10 A load, producing a sense voltage of 5 mV ) requires an offset voltage no greater than $50 \mu \mathrm{~V}$ ! We chose the vintage LM358A for our initial design, because it costs only 20 cents. But its poor untrimmed offset ( 3 mV , max) necessitates external manual trimming; and its lack of external trim terminals forced us to use lots of components. The need for manual trimming might not seem important if you're just building one of these for your lab; but in production it's an extra step, requiring a test setup and procedure, as well as additional parts inventory, etc.
- So, you might choose instead the LT1006, a single opamp that lets you trim externally with a single 10k pot. However, its improved performance ( $V_{\mathrm{OS}}=80 \mu \mathrm{~V}$, max, untrimmed) in the least expensive grade -40 times better than the LM358A - means that you hardly need to trim at all. Carrying this idea further, you could choose instead the LT1077A, a single-supply op-amp with $40 \mu \mathrm{~V}$ maximum untrimmed offset; it too can be trimmed externally.
- For the utmost in accuracy you should use a chopper-stabilized ("zero-drift") op-amp, for example the LTC1050C. It has $5 \mu \mathrm{~V}$ maximum offset voltage in the cheapest grade (combined with sub-nanoamp input
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-078.jpg?height=743&width=1162&top_left_y=215&top_left_x=368)

Figure 4.91. High-power current-sensing amplifier.
bias current, which doesn't matter here). This op-amp includes on-chip capacitors for its chopper, and operates from a single-supply (with input common-mode range to the negative rail), just like the LM358. Its $5 \mu \mathrm{~V}$ offset voltage corresponds to $1 \%$ accuracy at $1 \%$ of full scale; that's a dynamic range of $10,000: 1$, not bad for a simple circuit. See Table 5.6 on page 335 for auto-zero op-amp choices.

- Finally, an interesting design alternative is to do high-side current sensing. That is, the shunt is connected instead to the out+ power terminal. This has the advantage of keeping all the circuit grounds (power supply, and load) connected together. We'll see how to do this in the advanced Chapter $9 x$.

### 4.8.4 Integrating suntan monitor

We nerds don't ordinarily go to the beach. But when we do, we like to rely on some electronics to tell us when to turn over. What we want to monitor, of course, is the integrated dose of tan-producing (UV-rich) sunlight.

There are many ways to accomplish this; in fact, we'll revisit this task when we turn to mixed-signal (analog + digital) electronics (in Chapter 13), and again when we're looking for nifty things to do with microcontrollers (in Chapter 15). Here we want to show how an op-amp integrator can be used to build a suntan monitor circuit.

The idea is to integrate (accumulate) the photocurrent from a sensor whose output is proportional to the intensity
of tanning sunlight. We'll imagine that we have a photodiode, optically filtered to pass only the UV rays of interest, with an output short-circuit current of $\sim 1 \mathrm{nA}$ (nominal) in full sunlight; we'll assume that the photocurrent might range down to a tenth of this value, or so, in hazy sun.

#### A. First try: direct integration

The circuit in Figure 4.92 is a reasonable first try. It uses a single-supply CMOS micropower op-amp ( $10 \mu \mathrm{~A}$ per amplifier), powered from a 9 V battery, to integrate the (negative) photocurrent. A nanoamp produces a positive-going ramp of $0.5 \mathrm{mV} / \mathrm{s}$ at the op-amp's output, which we connect to a Schmitt trigger comparator with settable positive threshold. The LM385-2.5Z micropower two-terminal (zener-type) voltage reference then gives us a range of 0 to 1.5 hours ( $\sim 5000 \mathrm{~s}$ ) full sunlight equivalent (let's call it "FSE"), at which point the comparator output goes to ground, driving the piezo alarm. The latter draws 15 mA , a substantial battery load, but it is very loud, so even a dozing nerd will quickly enough shut the thing off (via the "reset" button). This circuit draws about $50 \mu \mathrm{~A}$ when integrating, good for about 8000 hours of operation (a 9 V battery has a capacity of 500 mAh at low drain). 8000 hours is about a year, so that's a lot of tanning; the battery will die of old age first.

Exercise 4.27. The LM385 requires a minimum of $10 \mu \mathrm{~A}$ of current for proper operation. What does the circuit provide, at the end of battery life ( 6 V )?
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-079.jpg?height=593&width=786&top_left_y=221&top_left_x=227)

Figure 4.92. Integrating suntan monitor, first try.

Exercise 4.28. How much hysteresis does Schmitt trigger $\mathrm{IC}_{2}$ provide? How will that affect the operation?

#### B. Second try: two-step conversion

One problem with the last circuit is that the unfiltered photodiode current is at least a few microamps, in direct sunlight. Trying to cut down the light by a factor of a thousand is risky, because you get light leaks, etc., that cause large errors.

The circuit in Figure 4.93 fixes that, by first converting the photocurrent (however large its magnitude) to a voltage, then integrating that in a second stage where we can choose an input resistor to generate a current in the nanoamp range. Now, however, we've got to use split supplies. That's because whichever polarity we choose for the transresistance (current to voltage) amplifier's output (by connecting the photodiode appropriately), the subsequent integrator's output will be the opposite polarity; integrators invert. In our circuit we used a 2.5 V reference to split the 9 V battery; most of the current in the circuit is between the positive and negative rails, so the reference needs less than $20 \mu \mathrm{~A}$ of bias. ${ }^{41}$ In this circuit we've shown a two-pole power switch, wired so the integrating capacitor is held reset until power is turned on.

The integrator output triggers a Schmitt comparator, as before, driving the mighty-lunged piezo screamer. Note that its large drive current is rail-to-rail; it does not pass through our ground reference. The circuit's operating cur-

[^50]rent is about $60 \mu \mathrm{~A}$, good for nearly a year of continuous operation.

A final note: the LMC6044 is a quad, rail-to-rail output, micropower op-amp ( $10 \mu \mathrm{~A} /$ amplifier). So if a stiff ground reference were needed, the unused op-amp section could be configured as in Figure 4.73, with the stabilizing trick of Figure 4.76A.

#### C. The "Mark-III" suntan integrator

It's always fun to see how elegantly you can shrink down circuit complexity. In this case there's a nice trick you can use to eliminate the two-stage integration, namely, a "current divider." Figure 4.94 shows how it's done: the photocurrent drives a pair of resistors, bridging the same voltage (because the inverting input is a virtual ground); the current divides proportional to the relative conductance, in this case in the ratio of $1000: 1$ if pot $R_{2}$ is turned to minimum resistance. That means that a photocurrent of $1 \mu \mathrm{~A}$ would inject a current of 1 nA into the integrator. If you prefer, you can think of the circuit as a resistive load ( $R_{1}$ in series with $R_{2}$, which easily dominates $R_{3}$ ), which develops a voltage $V_{\text {in }}=I_{\text {diode }}\left(R_{1}+R_{2}\right)$; that voltage is the input to the integrator, via $R_{3}$. Because the voltage developed by the photocurrent can range up to nearly a volt, it's necessary to back-bias the detector diode, in this case with a forward-biased diode $D_{2}$, which generates a -0.4 V rail.

The integrator's positive-going output ramp drives Schmitt comparator $\mathrm{A}_{2}$, with fixed comparison voltage provided by reference $D_{1}$. Its output drives the by-now usual piezo alarm.

Now for the elegance: it turns out you can get, packaged in a single small IC, a combination op-amp, comparator, and voltage reference. The MAX951 shown is just one of several such offerings, and it fills the bill here. It is because of the internal connection of $D_{1}$ and $\mathrm{IC}_{2}$ 's inverting input that we were forced to put the suntan control at the input, rather than at the comparator.

A few additional comments.

- The accuracy of the current divider depends on the accuracy of the virtual ground. The op-amp shown has a maximum offset voltage of 3 mV , so at $10 \%$ full sunlight and with the control set to minimum resistance (maximum bake cycle), the error is about $30 \%$ ( 10 mV signal, 3 mV offset). In other words, the circuit elegance involves a compromise in performance, relative to the more straightforward (some might say heavy-handed) approach in Figure 4.93, where the error is about $3 \%$ at minimum sunlight.
- Diode $D_{2}$ will be forward biased by the IC's quiescent
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-080.jpg?height=746&width=1578&top_left_y=209&top_left_x=160)

Figure 4.93. Integrating suntan monitor, second try; FSE is "full sunlight equivalent." A. Schematic. B. Spectral response of the Hamamatsu G5842 photodiode, whose short-circuit photocurrent in sunlight is about $1 \mu \mathrm{~A}$.
current of $7 \mu \mathrm{~A}$ as long as the photocurrent is less than this value. Thus the biasing resistor $R_{6}$ can be omitted unless a maximum photocurrent of more than about $5 \mu \mathrm{~A}$ is anticipated.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-080.jpg?height=496&width=831&top_left_y=1298&top_left_x=110)

Figure 4.94. Integrating suntan monitor, third try. $\mathrm{A}_{1}, \mathrm{~A}_{2}$, and $D_{1}$ all live inside a MAX951 multifunction chip. $A_{2}$ is a comparator.

- The MAX951 has a specified operating voltage range of 2.7 V to 7 V . The low-voltage operation is a pleasant bonus; but for this particular IC it also means that we cannot run directly from a 9 V battery, unless we use a voltage regulator (see Chapter 9) to reduce the supply voltage to 7 V or less. This illustrates an important lesson, namely, that you have to watch out for low maximum supply-voltage ratings when using ICs intended for low-voltage operation. It also illustrates the trend of IC
manufacturers toward lower supply voltages for their new product designs.

## 4.9 Feedback amplifier frequency compensation

We first met feedback in Chapter 2 (§2.5), where we saw its beneficial effects on stability and predictability of amplifier gain, and the reduction of an amplifier's inherent nonlinearities. We saw, also, how it affects input and output impedances of amplifiers: for example, by sensing output voltage, and using series feedback at the input, the input impedance is raised and the output impedance is lowered, both by a factor of the loop gain. All is not rosy, though: the combination of gain with feedback creates the possibility of oscillation. Here, in the context of op-amps, we continue the treatment of negative feedback, looking at the important subject of frequency compensation - the business of preventing oscillation in amplifiers with negative feedback. The material in $\S 2.5$ is a necessary background for the sections that follow.

Let's begin by looking at a graph of open-loop voltage gain versus frequency for several op-amps: you'll typically see something like the curves in Figure 4.95. From a superficial look at such a Bode plot (a log-log plot of openloop gain and phase versus frequency) you might conclude that the OP27 is an inferior op-amp, since its open-loop gain drops off so rapidly with increasing frequency. In fact, that rolloff is built into the op-amp intentionally and is
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-081.jpg?height=552&width=751&top_left_y=221&top_left_x=244)

Figure 4.95. Open-loop gain versus frequency for three similar opamps.
recognizable as the same $-6 \mathrm{~dB} /$ octave curve characteristic of an $R C$ lowpass filter. The OP37, by comparison, is identical to the OP27 except that it is decompensated (and similarly for the discontinued ${ }^{42}$ HA-5147). Op-amps are most often internally compensated, with decompensated and uncompensated varieties sometimes available. Let's take a look at this business of frequency compensation.

### 4.9.1 Gain and phase shift versus frequency

An op-amp (or, in general, any multistage amplifier) will begin to roll off at some frequency because of the lowpass filters formed by signals of finite source impedance driving capacitive loads within the amplifier stages. For instance, it is common to have an input stage consisting of a differential amplifier, perhaps with current-mirror load (see the LF411 schematic in Figure 4.43), driving a commonemitter second stage. For now, imagine that the capacitor labeled $C_{\mathrm{C}}$ in that circuit is removed. The high output impedance of the input stage $Q_{2}$, in combination with the combined capacitance seen at its output, forms a lowpass filter whose 3 dB point might fall somewhere in the range of 100 Hz to 10 kHz .

The decreasing reactance of this capacitance with increasing frequency gives rise to the characteristic $6 \mathrm{~dB} /$ octave rolloff: at sufficiently high frequencies (which may be below 1 kHz ), the capacitive loading dominates the collector load impedance, resulting in a voltage gain $G_{\mathrm{V}}=g_{m} X_{\mathrm{C}}$, i.e., the gain drops off as $1 / f$. It also produces a $90^{\circ}$ lagging phase shift at the output relative to the input signal. (You can think of this as the tail of an $R C$ low-

[^51]pass filter characteristic, where $R$ represents the equivalent source impedance driving the capacitive load. However, it is not necessary to have any actual resistors in the circuit.)

In a multistage amplifier there will be additional rolloffs at higher frequencies, caused by lowpass filter characteristics in the other amplifier stages, and the overall open-loop gain will look something like that shown in Figure 4.96. The open-loop gain begins dropping at $6 \mathrm{~dB} /$ octave at some low frequency $f_{1}$, because of capacitive loading of the firststage output. It continues dropping off with that slope until an internal $R C$ of another stage rears its ugly head at frequency $f_{2}$, beyond which the rolloff goes at $12 \mathrm{~dB} /$ octave, and so on.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-081.jpg?height=514&width=679&top_left_y=776&top_left_x=1130)

Figure 4.96. Multistage amplifier: gain versus frequency.
What is the significance of all this? Remember that an $R C$ lowpass filter has a phase shift that looks as shown in Figure 4.97. Each lowpass filter within the amplifier has a similar phase-shift characteristic, so the overall phase
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-081.jpg?height=633&width=615&top_left_y=1607&top_left_x=1167)

Figure 4.97. Bode plot: gain and phase versus frequency.
shift of the hypothetical amplifier will be as shown in Figure 4.98.

Now here's the problem: if you were to connect this amplifier as an op-amp follower, for instance, it would oscillate. That's because the open-loop phase shift reaches $180^{\circ}$ at some frequency at which the gain is still greater than 1 (negative feedback becomes positive feedback at that frequency). That's all you need to generate an oscillation, as any signal whatsoever at that frequency builds up each time around the feedback loop, just like a public address system with the gain turned up too far.

#### A. Stability criterion

The criterion for stability against oscillation for a feedback amplifier is that its open-loop phase shift must be less than $180^{\circ}$ at the frequency at which the loop gain is unity. This criterion is hardest to satisfy when the amplifier is connected as a follower, since the loop gain then equals the open-loop gain, the highest it can be. Internally compensated op-amps are designed to satisfy the stability criterion even when connected as followers; thus they are stable when connected for any closed-loop gain with a simple resistive feedback network. As we hinted earlier, this is accomplished by deliberately modifying an existing internal rolloff in order to put the 3 dB point at some low frequency, typically 1 Hz to 20 Hz . Let's see how that works.

### 4.9.2 Amplifier compensation methods

#### A. Dominant-pole compensation

The goal is to keep the open-loop phase shift much less than $180^{\circ}$ at all frequencies for which the loop gain is greater than 1. Assuming that the op-amp may be used as a follower, the words "loop gain" in the last sentence can be replaced with "open-loop gain." The easiest way to do this is to add enough additional capacitance at the
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-082.jpg?height=447&width=752&top_left_y=1784&top_left_x=142)

Figure 4.98. Gain and phase in a multistage amplifier.
point in the circuit that produces the initial $6 \mathrm{~dB} /$ octave rolloff, so that the open-loop gain drops to unity at about the 3 dB frequency of the next "natural" $R C$ filter. In this way the open-loop phase shift is held at a constant $90^{\circ}$ over most of the passband, increasing toward $180^{\circ}$ only as the gain approaches unity. Figure 4.99 shows the idea. Without compensation, the open-loop gain drops toward 1, first at $6 \mathrm{~dB} /$ octave, then at $12 \mathrm{~dB} /$ octave, etc., resulting in phase shifts of $180^{\circ}$ or more before the gain has reached 1. By moving the first rolloff down in frequency (forming a "dominant pole"), the rolloff is controlled so that the phase shift begins to rise above $90^{\circ}$ only as the open-loop gain approaches unity. Thus, by sacrificing open-loop gain, you buy stability. Because the natural rolloff of lowest frequency is usually caused by the Miller effect in the stage driven by the input differential amplifier, the usual method of dominant-pole compensation consists simply of adding additional feedback capacitance around the second-stage transistor, so the combined voltage gain of the two stages is $g_{m} X_{\mathrm{C}}$ or $g_{m} / 2 \pi f C_{\text {comp }}$ over the compensated region of the amplifier's frequency response (Figure 4.100). In practice, Darlington-connected transistors would probably be used for both stages.

By putting the dominant-pole unity-gain crossing at the 3 dB point of the next rolloff, you get a phase margin of about $45^{\circ}$ in the worst case (follower), since a single $R C$ filter has a $45^{\circ}$ lagging phase shift at its 3 dB frequency, i.e., the phase margin equals $180^{\circ}-\left(90^{\circ}+45^{\circ}\right)$, with the $90^{\circ}$ coming from the dominant pole.

An additional advantage of using a Miller-effect pole for
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-082.jpg?height=707&width=661&top_left_y=1529&top_left_x=1042)

Figure 4.99. "Dominant-pole" compensation.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-083.jpg?height=493&width=759&top_left_y=223&top_left_x=243)

Figure 4.100. Classic op-amp input stage with compensation.
compensation is that the compensation is inherently insensitive to changes in voltage gain with temperature or manufacturing spread of gain: higher gain causes the feedback capacitance to look larger, moving the pole downward in frequency in exactly the right way to keep the unity-gain crossing frequency unchanged. In fact, the actual 3 dB frequency of the compensation pole is quite irrelevant; what matters is the point at which it intersects the unity-gain axis (Figure 4.101).

#### B. Decompensated and uncompensated op-amps

If an op-amp is used in a circuit with closed-loop gain greater than unity (i.e., not a follower), it is not necessary to put the pole (the term for the "corner frequency" of a lowpass filter, see Chapter $1 x$ ) at such a low frequency as the stability criterion is relaxed because of the lower loop gain. Figure 4.102 shows the situation graphically.

For a closed-loop gain of 30 dB , the loop gain (which is the ratio of the open-loop gain to the closed-loop gain) is less than for a follower, so the dominant pole can be placed at a higher frequency. It is chosen so that the openloop gain reaches 30 dB (rather than 0 dB ) at the fre-
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-083.jpg?height=360&width=593&top_left_y=1792&top_left_x=321)

Figure 4.101. The compensation capacitor is chosen to set the open-loop unity-gain frequency; the low-frequency gain is unimportant.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-083.jpg?height=432&width=774&top_left_y=218&top_left_x=1082)

Figure 4.102. Stability is easier to achieve with larger closed-loop gain.
quency of the next natural pole of the op-amp. As the graph shows, this means that the open-loop gain is higher over most of the frequency range, and the resultant amplifier will work at higher frequencies. Some op-amps are available in "decompensated" (a better word might be "undercompensated") versions, which are internally compensated for closed-loop gains greater than some minimum $\left(A_{\mathrm{v}}>5\right.$ in the case of the OP37); these specify a minimum closed-loop gain, and require no external capacitor. Another example is the THS4021/2, a decompensated version $\left(G_{V} \geq 10\right)$ of the unity-gain stable THS4011/2. These are really speedy op-amps, with an $f_{\mathrm{T}}$ of 300 MHz (for the "slow" THS4011/2), and greater than 1 GHz for the THS4021/2. For the decompensated versions the manufacturer (TI) supplies recommended external capacitance values (sometimes in combination with a resistor; see below) for a selection of minimum closed-loop gains. ${ }^{43}$ Decompensated or uncompensated op-amps are worth using if you need the added bandwidth and your circuit operates at high gain; see Chapter $4 x$ for further discussion.

Some intuition: it may at first seem paradoxical that an op-amp circuit configured for a low-gain circuit is more prone to oscillation than one configured for high-gain. But it makes sense: the better stability of an op-amp connected for a closed-loop gain of $G_{\mathrm{CL}}=100(40 \mathrm{~dB})$, say, comes about because the feedback network (resistive divider) attenuates signals by a factor of 100 . So it's harder to sustain an oscillation going around the loop, compared with a follower (in which the feedback has unity gain).

[^52]
#### C. Pole-zero compensation

It is possible to do a bit better than with dominant-pole compensation by using a compensation network that begins dropping ( $6 \mathrm{~dB} /$ octave, a "pole") at some low frequency, then flattens out again (it has a "zero") at the frequency of the second natural pole of the op-amp. In this way the amplifier's second pole is "cancelled," giving a smooth $6 \mathrm{~dB} /$ octave rolloff up to the amplifier's third pole. Figure 4.103 shows a frequency-response plot. In practice, the zero is chosen to cancel the amplifier's second pole; then the position of the first pole is adjusted so that the overall response reaches unity gain at the frequency of the amplifier's third pole. A good set of datasheets for an opamp with external compensation will often give suggested component values (an $R$ and a $C$ ) for pole-zero compensation, as well as the usual capacitor values for dominantpole compensation. Moving the dominant pole downward in frequency actually causes the second pole of the amplifier to move upward somewhat in frequency, an effect known as "pole splitting." The frequency of the cancelling zero is then chosen accordingly.

### 4.9.3 Frequency response of the feedback network

In all of the discussion thus far we have assumed that the feedback network has a flat frequency response; this is usually the case, with the standard resistive voltage divider as a feedback network. However, there are occasions when some sort of equalization amplifier is desired (integrators and differentiators are in this category) or when the frequency response of the feedback network is modified to improve amplifier stability. In such cases it is important to remember that the Bode plot of loop gain versus frequency is what matters, rather than the curve of open-loop gain. To make a long story short, the curve of ideal closed-loop
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-084.jpg?height=453&width=805&top_left_y=1743&top_left_x=118)

Figure 4.103. Cancelling the amplifier's second pole in "pole-zero" compensation.
gain versus frequency should intersect the curve of openloop gain, with a difference in slopes of $6 \mathrm{~dB} /$ octave. As an example, it is common practice to put a small capacitor (a few picofarads) across the feedback resistor in the usual inverting or noninverting amplifier. Figure 4.104 shows the circuit and Bode plot.

The amplifier would have been close to instability with a flat feedback network since the loop gain would have been dropping at nearly $12 \mathrm{~dB} /$ octave where the curves meet. The capacitor causes the loop gain to drop at $6 \mathrm{~dB} /$ octave near the crossing, guaranteeing stability. This sort of consideration is very important when designing differentiators because an ideal differentiator has a closed-loop gain that rises at 6 dB /octave; it is necessary to roll off the differentiator action at some moderate frequency, preferably going over to a $6 \mathrm{~dB} /$ octave rolloff at high frequencies. Integrators, by comparison, are very friendly in this respect, owing to their $6 \mathrm{~dB} /$ octave closed-loop rolloff. It takes real talent to make a low-frequency integrator oscillate!

Exercise 4.29. Show on a Bode plot that the value of stabilizing resistor $R_{1}$ in Figure 4.69 stops the differentiator action (i.e., flattens the curve of closed-loop gain) before the crossing point of open-loop and closed-loop gains. Explain our value of minimum recommended resistance $R_{1}$.

#### A. What to do

In summary, you are generally faced with the choice of internally compensated or uncompensated op-amps. It is simplest to use the compensated variety, and that's the usual choice. You might begin by considering the
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-084.jpg?height=700&width=611&top_left_y=1528&top_left_x=1067)

Figure 4.104. A small feedback capacitor enhances stability.
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-085.jpg?height=909&width=1448&top_left_y=216&top_left_x=322)

Figure 4.105. Output amplifier for 60 Hz power source. The push-pull output transistors $Q_{1}$ and $Q_{2}$ are power Darlingtons in a plastic power package.
conventional LF411 (JFET, $\pm 5 \mathrm{~V}$ to $\pm 15 \mathrm{~V}$ supply) or an improved version (the LT1057), or the rail-to-rail input and output LMC6482 (CMOS, +3 V to +15 V supply), or perhaps the accurate and quiet LT1012, all internally compensated for unity gain. If you need greater bandwidth or slew rate, look for a faster compensated op-amp (see Table 4.2a on 271 for some choices). If it turns out that nothing is suitable and the closed-loop gain is greater than unity (as it usually is), you can use a decompensated (or uncompensated) op-amp, perhaps with an external capacitor as specified by the manufacturer for the gain you are using. Using our previous example, the popular OP27 low-noise precision op-amp (unity-gain-compensated) has $f_{\mathrm{T}}=8 \mathrm{MHz}$ and a slew rate of $2.8 \mathrm{~V} / \mu \mathrm{s}$; it is available as the decompensated OP37 (minimum gain of 5), with $f_{\mathrm{T}}=63 \mathrm{MHz}$ and a slew rate of $17 \mathrm{~V} / \mu \mathrm{s} .{ }^{44}$

#### B. Example: precision 60 Hz power source

Uncompensated op-amps, or op-amps with a compensation pin, also give you the flexibility of overcompensating, a

[^53]simple solution to the problem of additional phase shifts introduced by other stuff in the feedback loop. Figure 4.105 shows an example. This is a low-frequency amplifier designed to generate a precise and stable 115 volt ac power output from a variable frequency 60 Hz low-level sinewave input. ${ }^{45}$ The op-amp is wired as an ac-coupled noninverting amplifier, with its output driving a Darlington push-pull emitter-follower output stage $Q_{1} Q_{2}$, which in turn drives the low-voltage winding of a small power transformer, $T_{1}$, whose windings are in the ratio of $6.3 \mathrm{~V}: 115 \mathrm{~V}$. In this way we generate 115 V ac output without high-voltage op-amps or transistors. Of course, we pay the price in proportionally higher drive current; here the transistors need to supply about $3 \mathrm{~A}(\mathrm{rms})$ to produce a 15 W output.

To generate low distortion and a stable output voltage under load variations, we want to take feedback from the actual 115 V output sinewave. It is highly desirable, however, to keep the output fully isolated from circuit ground. So we use a second transformer $T_{2}$ to produce a lowvoltage replica of the 115 V output waveform, which is
${ }^{45}$ The original design was used to drive an astronomical telescope at sidereal (star-tracking) rate. Interesting trivia: contrary to popular belief, the Earth turns on its axis once every 23 hours, 56 minutes, and 4.1 seconds; figure out why it isn't 24:00:00!
then fed back via $R_{3}$ to give the needed voltage gain of 6 . Because of the unacceptably large phase shifts of the transformers at high frequencies, the circuit is rigged up so that at higher frequencies - above $\sim 3 \mathrm{kHz}$ - the feedback comes from the low-voltage input to the transformer (via $C_{1}$ ). Even though high-frequency feedback is taken directly from the push-pull output, there are still phase shifts associated with the reactive load (the transformer primary, a motor attached to the output, etc.) seen by the transistors. To ensure good stability, even with reactive loads at the 115 volt output, the op-amp can be overcompensated with a small capacitor, as shown. (The unusual LT1097 obligingly provides a pin for overcompensation.) The loss of bandwidth that results is unimportant in a low-frequency application like this.

The function of $R_{4}$ and $C_{2}$ may be puzzling: this bit of circuitry provides a dc feedback path for the op-amp, by averaging (lowpass filtering) the dc level applied to $T_{1}$, which then feeds back via the floating winding of $T_{2}$. We chose $C_{2}$ large enough so its impedance at 60 Hz is small compared with the 50 k feedback resistor; then we chose $R_{4}$ for adequate smoothing consistent with stability.

The performance of this amplifier is quite satisfying. Figure 4.106 shows the output regulation, i.e., the change of rms output amplitude versus load. For comparison we show the comparable curve when feedback is taken exclusively from the driving winding of $T_{1}$, from which you can see that the desired feedback path improves output amplitude regulation, under load variations from zero to full power, from a mediocre $10 \%$ to just $0.2 \%$. The output sinewave is very clean, with measured distortion well below $1 \%$ under all load conditions, including driving a synchronous motor (which represents a reactive load).

An application such as this represents a compromise,
![](https://cdn.mathpix.com/cropped/2024_11_07_c1b52fff14ddd9fabc48g-086.jpg?height=514&width=759&top_left_y=1677&top_left_x=141)

Figure 4.106. Measured output voltage versus load for 60 Hz power source.
because ideally you would like to have plenty of loop gain to stabilize the output voltage against variations in load current. But a large loop gain increases the tendency of the amplifier to oscillate, especially if a reactive load is attached. This is because the reactive load, in combination with the transformer's finite output impedance, causes additional phase shifts within the low-frequency feedback loop. Because this circuit was built to power a telescope's synchronous driving motors (highly inductive loads), the loop gain was intentionally kept low.

Some additional points.

- With power electronics you should design conservatively so that a fault condition (e.g., too heavy a load, or even a short-circuit) doesn't destroy the device. Here we've used the simplest current-limiting method - a pair of small resistors in the collectors of the drive stage - because we didn't want to clutter the diagram (and it worked well enough, anyway!). There are better ways, though, for example, by adding a pair of transistors to rob base current when the output current (as sensed by a series resistor) exceeds a preset limit; such a scheme is commonly used within the integrated circuitry of op-amps themselves see Figure 4.43. As we'll explain in $\S 9.13 .3$, there are still better protective circuits. The problem with simple current-limiting protection is that a short-circuit load would cause the transistors to experience the limit current with the full supply voltage across them; the resulting power dissipation is far greater than the maximum under ordinary operation, which requires conservative heatsinking and component selection. Foldback current limiting would be better, though a bit more complicated.
- A push-pull follower with the bases tied together has a crossover region in which the feedback loop is effectively broken (see §2.4.1A). With Darlington transistors the crossover region is four $V_{\mathrm{BE}}$ 's, about 2.5 V . The resistor $R_{2}$ in Figure 4.105 ensures that there is always some linear coupling from the op-amp to $T_{1}$, to prevent the feedback loop from rattling around under light load. Better still would be diode biasing, in the manner of Figures 2.71 or 2.72 ; see also the discussion of push-pull follower output stages in Chapter $2 x$.
- There is an elegant way to use a normal $\pm 15 \mathrm{~V}$ op-amp to generate larger voltage swings, by replacing the emitter followers in Figure 4.105 with a "pseudo-Darlington" configuration with modest noninverting gain (also known as a "series feedback pair," see §2.5.5C), say a factor of 5. Then you can run the power output stage from a $\pm 75 \mathrm{~V}$ supply while powering the op-amp from conventional $\pm 15 \mathrm{~V}$.

#### C. Motorboating

In ac-coupled feedback amplifiers, stability problems can also crop up at very low frequencies, because of the accumulated leading phase shifts caused by several capacitively coupled stages. Each blocking capacitor, in combination with the input resistance (from bias strings and the like), causes a leading phase shift that equals $45^{\circ}$ at the low-frequency 3 dB point and approaches $90^{\circ}$ at lower frequencies. If there is enough loop gain, the system can go into a low-frequency oscillation picturesquely known as "motorboating." With the widespread use of dc-coupled amplifiers, motorboating is almost extinct. However, oldtimers can tell you some good stories about it.

## Review of Chapter 4

An A-to-O summary of what we have learned in Chapter 4. This summary reviews basic principles and facts in Chapter 4 , but it does not cover application circuit diagrams and practical engineering advice presented there.

### IA. The Ideal Op-amp.

In Chapter 4 we explored the world of Operational Amplifiers ("Op-amps"), universal building blocks of analog circuits. A good op-amp approaches the ideal of an infinitegain wideband noiseless dc-coupled difference amplifier with zero input current and zero offset voltage. Op-amps are intended for use in circuits with negative feedback, where the feedback network determines the circuit's behavior. Op-amps figure importantly in the topics of Chapter 5 (Precision Circuits), Chapter 6 (Filters), Chapter 7 (Oscillators and Timers), Chapter 8 (Low-Noise Techniques), Chapter 9 (Voltage Regulation and Power Conversion), and Chapter 13 (Digital Meets Analog).

### |B. The "Golden Rules."

At a basic level (and ignoring imperfections, see $\pi I K-M$ below), an op-amp circuit with feedback can be simply understood by recognizing that feedback from the output operates to (I) make the voltage difference between the inputs zero; and, at the same level of ignoration, (II) the inputs draw no current. These rules are quite helpful, and for dc (or low-frequency circuits) they are in error only by typical offset voltages of a millivolt or less (rule I), and by typical input currents of order a picoamp for FET types or tens of nanoamps for BJT types (rule II).

### IC. Basic Op-amp Configurations.

In $\S 4.2$ and $\S 4.3$ we met the basic linear circuits (detailed in TIID-F below): inverting amplifier, non-inverting amplifier (and follower), difference amplifier, current source (transconductance, i.e., voltage-to-current), transresistance amplifier (i.e., current-to-voltage), and integrator. We saw also two important non-linear circuits: the Schmitt trigger, and the active rectifier. And in $\S 4.5$ we saw additional circuit building blocks: peak detector, sample-and-hold, active clamp, active full-wave rectifier (absolute-value circuit), and differentiator.

### 1D. Voltage Amplifiers.

The inverting amplifier (Figure 4.5) combines input current $V_{\text {in }} / R_{1}$ and feedback current $V_{\text {out }} / R_{2}$ into a summing junction; it has voltage gain $G_{\mathrm{V}}=-R_{2} / R_{1}$ and input impedance $R_{1}$. In the noninverting amplifier (Figure 4.6) a fraction of
the output is fed back to the inverting input; it has voltage gain $G_{\mathrm{V}}=1+R_{2} / R_{1}$ and near-infinite input impedance. For the follower (Figure 4.8) the feedback gain is unity, i.e., the resistive divider is replaced by a connection from output to inverting input. The difference amplifier (Figure 4.9) uses a pair of matched resistive dividers to generate an output $V_{\text {out }}=\left(R_{2} / R_{1}\right) \Delta V_{\text {in }}$; its input impedance is $R_{1}+R_{2}$, and its common-mode rejection depends directly on the accuracy of the resistor matching (e.g., $\sim 60 \mathrm{~dB}$ with $\pm 0.1 \%$ resistor tolerance). Difference amplifiers are treated in greater detail in $\S 5.14$. A pair of input followers can be used to achieve high input impedance, but a better 3-op-amp configuration is the instrumentation amplifier, see $\S 5.15$.

### ПE. Integrator and Differentiator.

The integrator (Figure 4.16) looks like an inverting amplifier in which the feedback resistor is replaced by a capacitor; thus the input current $V_{\text {in }} / R_{1}$ and feedback current $C d V_{\text {out }} / d t$ are combined at the summing junction. Ignoring the imperfections in $\mathbb{K}$ below, the integrator is "perfect," thus any non-zero average dc input voltage will cause the output to grow and eventually saturate. The integrator can be reset with a transistor switch across the feedback capacitor (Figure 4.18); alternatively you can use a large shunt resistor to limit the dc gain, but this defeats the integrator operation at low frequencies $\left(f \lesssim 1 / R_{\mathrm{f}} C\right)$. The integrator's input impedance is $R_{1}$.

The op-amp differentiator (Figure 4.68) is a similar configuration, but with $R$ and $C$ interchanged. Without additional components (Figure 4.69) this configuration is unstable (see $\mathbb{T I O}$, below).

IF. Transresistance and Transconductance Amplifiers.
By omitting the input resistor, an inverting voltage amplifier becomes a transresistance amplifier ${ }^{46}$, i.e., a current-to-voltage converter (Figure 4.22). Its gain is $V_{\text {out }} / I_{\mathrm{in}}=-R_{\mathrm{f}}$, and (ignoring imperfections) the impedance at its input (which drives the summing junction) is zero. Capacitance at the input creates issues of stability, bandwidth, and noise; see $\S 8.11$ and the discussion in Chapter $4 x$. Transresistance amplifiers are widely used in photodiode applications.

A transconductance amplifier (Figures 4.10-4.15) converts a voltage input to a current output; it is a voltagecontrolled current source. The simplest form uses an opamp and one resistor (Figure 4.10), but works only with a floating load. The Howland circuit and its variations (Figures 4.14 and 4.15) drive a load returned to ground, but

[^54]their accuracy depends on resistor matching. Circuits with an external transistor (Figures 4.12 and 4.13) drive loads returned to ground, do not require resistor matching, and, in contrast to the other circuits, benefit from the intrinsically high output impedance of the transistor. In Chapter $4 x$ we describe a nice variation on the transistor-assisted current source that achieves both high speed and bipolarity output (i.e., sinking and sourcing)

### |G. Nonlinear Circuits: Peak Detector, S/H, Clamp, Rectifier.

Because of their high gain, op-amps provide accuracy to nonlinear functions that can be performed with passive components alone; in these circuits one or more diodes select the regions in which feedback acts. The peak detector (Figure 4.58) captures and holds the highest (or lowest) voltage since the last reset; the sample-and-hold $(\mathrm{S} / \mathrm{H})$ circuit (Figure 4.60) responds to an input pulse by capturing and holding the value of an input signal voltage; the $a c$ tive clamp (Figure 4.61) bounds a signal to a maximum (or minimum) voltage; the active rectifier creates accurate half-wave (Figures 4.36 and 4.38) or full-wave (Figures 4.63 and 4.64 ) outputs. In practice the performance of these circuits is limited by the finite slew rate and output current of real op-amps (see $\llbracket$ IM, below).

### IH. Positive Feedback: Comparator, Schmitt Trigger, and Oscillator.

If the feedback path is removed, an op-amp acts as a comparator, with the output responding (by saturating near the corresponding supply rail) to a reversal of differential input voltage of a millivolt or less (Figure 4.32A). Adding some positive feedback (Figure 4.32B) creates a Schmitt trigger, which both speeds up the response and also suppresses noise-induced multiple transitions. Op-amps are optimized for use with negative feedback in linear applications (notably by a deliberate internal $-6 \mathrm{~dB} /$ octave rolloff "compensation," see $\llbracket$ ( O below), so special comparator ICs (lacking compensation) are preferred, see $\S 12.3$ and Tables 12.1 and 12.6. A combination of positive feedback (Schmitt trigger) and negative feedback (with an integrator) creates an oscillator (Figure 4.39), a subject treated in detail in Chapter 7.

### qII. Single-Supply and Rail-to-rail Op-amps.

For some op-amps both the input common-mode range and the output swing extend all the way down to the negative rail, making them particularly suited for operation with a single positive supply. Rail-to-rail op-amps allow input swings to both supply rails, or output swings to both rails,
or both; see Table 4.2a. The latter are especially useful in circuits with low supply voltages.

### IIJ. Some Cautions.

In linear op-amp circuits, the Golden Rules (see $\llbracket$ B, above) will be obeyed only if (a) feedback is negative and (b) the op-amp stays in the active region (i.e., not saturated). There must be feedback at dc, or the op-amp will saturate. Power supplies should be bypassed. Stability is degraded with capacitive loads, and by lagging phase shifts in the feedback path (e.g., by capacitance at the inverting terminal). And, most important, real op-amps have a host of limitations (IIIIK-N, below) that bound attainable circuit performance.

### IK. Departures from Ideal Behavior.

In the real world op-amps are not perfect. There is no "best" op-amp, thus one must trade off a range of parameters: input imperfections (offset voltage, drift, and noise; input current and noise; differential and common-mode range), output limitations (slew rate, output current, output impedance, output swing), amplifier characteristics (gain, phase shift, bandwidth, CMRR and PSRR), operating characteristics (supply voltage and current), and other considerations (package, cost, availability). See §4.4, Tables 4.1, 4.2 a , and 4.2 b , the more extensive tables in Chapters 5, and 8 , and IIIL-N below.

### IL. Input Limitations.

The input offset voltage ( $V_{\mathrm{os}}$ ), ranging from about $25 \mu \mathrm{~V}$ ("precision" op-amp) to 5 mV , is the voltage unbalance at the input terminals. It's an important parameter for precision circuits, and circuits with high closed-loop dc gain; the error seen at the output is $G_{\mathrm{CL}} V_{\mathrm{os}}$ ). Some op-amps provide pins for external trimming of offset voltage (e.g., see Figure 4.43).

The offset voltage drift, or tempco ( $\mathrm{TCV}_{\mathrm{os}}$, or $\left.\Delta V_{\mathrm{os}} / \Delta T\right)$, is the temperature coefficient of offset voltage; it ranges from about $0.1 \mu \mathrm{~V} /{ }^{\circ} \mathrm{C}$ ("precision" op-amp) to $10 \mu \mathrm{~V} /{ }^{\circ} \mathrm{C}$. Even if you're lucky and have an op-amp with low $V_{\text {os }}$ (or you've trimmed it to zero), $\mathrm{TC} V_{\text {os }}$ represents the growth of offset with changing temperature.

The input noise voltage density $\left(e_{\mathrm{n}}\right)$ represents a noisy voltage source in series with the input terminals. It ranges from about $1 \mathrm{nV} / \sqrt{\mathrm{Hz}}$ (low-noise bipolar op-amp) to $100 \mathrm{nV} / \sqrt{\mathrm{Hz}}$ or more (micropower op-amps). Noise voltage is important in audio and precision applications.

The input bias current $\left(I_{\mathrm{B}}\right)$ is the (non-zero) dc current at the input terminals. It ranges from a low of about 5 fA (CMOS low-bias op-amps, and "electrometer" op-amps) to

50 nA (typical ${ }^{47}$ BJT op-amps) to a high of $10 \mu \mathrm{~A}$ (wideband BJT-input op-amps). Bias current flowing through the circuit's dc source resistance causes a dc voltage offset; it also creates a current error in integrators and transresistance amplifiers.

The input noise current $\left(i_{n}\right)$ is the equivalent noise current added at the input. For most op-amps ${ }^{48}$ it is simply the shot noise of the bias current $\left(i_{n}=\sqrt{2 q I_{B}}\right)$; it ranges from about $0.1 \mathrm{fA} / \sqrt{\mathrm{Hz}}$ (CMOS low-bias op-amps, "electrometer" op-amps) to $1 \mathrm{pA} / \sqrt{\mathrm{Hz}}$ (wideband BJT op-amps). Input noise current flowing through the circuit's ac source impedance creates a noise voltage, which can dominate over $e_{\mathrm{n}}$. The ratio $r_{\mathrm{n}}=e_{\mathrm{n}} / i_{\mathrm{n}}$ is the op-amp's noise resistance; for signal source impedances greater than $r_{\mathrm{n}}$ the current noise dominates.

Op-amps function properly when both inputs are within the input common-mode voltage range $\left(V_{\mathrm{CM}}\right)$, which may extend to the negative rail ("single-supply" op-amps), or to both rails ("rail-to-rail" op-amps). Beware: many op-amps have a more restricted input differential voltage range, sometimes as little as just a few volts.

### ПM. Output Limitations.

The slew rate (SR) is the op-amp's $d V_{\text {out }} / d t$ with an applied differential voltage at the input. It is set by internal drive currents charging the compensation capacitor, and ranges from about $0.1 \mathrm{~V} / \mu \mathrm{s}$ (micropower op-amps) to $10 \mathrm{~V} / \mu \mathrm{s}$ (general purpose op-amps) to $5000 \mathrm{~V} / \mu \mathrm{s}$ (highspeed op-amps). Slew rate is important in high-speed applications generally, and in large-swing applications such as $\mathrm{A} / \mathrm{D}$ and D/A converters, S/H and peak detectors, and active rectifiers. It limits the large-signal output frequency: a sinewave of amplitude $A$ and frequency $f$ requires a slew rate of $\mathrm{SR}=2 \pi A f$; see Figure 4.54.

Op-amps are small devices, with output current deliberately limited to prevent overheating; see for example Figure 4.43, where $R_{5} Q_{9}$ and $R_{6} Q_{10}$ limit the output sourcing and sinking currents to $I_{\mathrm{lim}}=V_{\mathrm{BE}} / R \approx 25 \mathrm{~mA}$, illustrated in Figure 4.45. If you need more output current, there are a few high-current op-amps available; you can also add an external unity-gain power buffer like the LT1010 ( $I_{\text {out }}$ to $\pm 150 \mathrm{~mA}$ ), or a discrete push-pull follower.

The open-loop output impedance of an op-amp is generally in the neighborhood of $100 \Omega$, which is reduced by the loop gain to fractions of an ohm at low frequencies. Because an op-amp's open-loop gain $G_{\text {OL }}$ falls as $1 / f$ over

[^55]most of its bandwidth (see $\mathbb{T O}$ below), however, the circuit's closed-loop output impedance rises approximately proportional to frequency; it looks inductive (Figure 4.53).

In general the output swing for an op-amp like Figure 4.43 extends only to within a volt or so from either rail. Many CMOS and other low-voltage op-amps, however, specify unloaded rail-to-rail output swings, see Figure 4.46.

Op-amps can be grouped into several supply voltage ranges: "low-voltage" op-amps have a maximum total supply voltage (i.e., $V_{+}-V_{-}$) around 6 V , and generally operate down to 2 V ; "high-voltage" op-amps allow total supply voltages to 36 V , and generally operate down to $5-10 \mathrm{~V}$. In between there is a sparse class of what might be called "mid-voltage" op-amps, with total supply voltages in the neighborhood of $10-15 \mathrm{~V}$. See Table 5.5. There are also op-amps that are truly high-voltage (to hundreds of volts), see Table 4.2b.

### IN. Gain, Phase Shift, and Bandwidth.

Op-amps have large dc open-loop gain $G_{\mathrm{OL}(\mathrm{dc})}$, typically in the range of $10^{5}-10^{7}$ (the latter being typical of "precision" op-amps, see Chapter 5). To ensure stability (see $\mathbb{T I O}$, below) the op-amp's open-loop gain falls as $1 / f$, reaching unity at a frequency $f_{\mathrm{T}}$ (see Figure 4.47). This limits the closed-loop bandwidth to $\mathrm{BW}{ }_{\mathrm{CL}} \approx f_{\mathrm{T}} / G_{\mathrm{CL}}$. Over most of the operating frequency range the op-amp's open-loop phase shift is $-90^{\circ}$, eliminated in the closed-loop response by feedback.

### ПO. Feedback Stability, "Frequency Compensation," and Bode Plots

Finally, negative feedback can become positive feedback, promoting instability and oscillations, if the accumulated phase shift reaches $180^{\circ}$ at a frequency at which the loop gain is $\geq 1$. This topic is foreshadowed in $\S 4.6 .2$ in connection with capacitive loads, and it is discussed in detail in $\S 4.9$. The basic technique is dominant-pole compensation, in which a deliberate $-6 \mathrm{~dB} /$ octave (i.e., $\propto 1 / f$ ) rolloff is introduced within the op-amp in order to bring the gain down to unity at a frequency lower than that at which additional unintended phase shifts rear their ugly heads (Figure 4.99). Most op-amps include such compensation internally, such that they are stable at all closed-loop gains (the unity-gain follower configuration is most prone to instability, because there is no attenuation in the feedback path). "Decompensated" op-amps are less aggressively compensated, and are stable for closed-loop gains greater than some minimum (often specified as $G>2,5$, or 10 ;

Figure 4.95). Compensated op-amps exhibit an open-loop lagging phase shift of $90^{\circ}$ over most of their frequency range (beginning as low as 10 Hz or less). Thus an external feedback network that adds another $90^{\circ}$ of lagging phase shift at a frequency where the loop gain is unity will cause oscillation.

A favorite tool is the Bode Plot, a graph of gain (log) and phase (linear) versus frequency (log); see Figure 4.97. The stability criterion is that the difference of slopes between the open-loop gain curve and the ideal closed-loop gain curve, at their intersection, should ideally be $6 \mathrm{~dB} /$ octave, but in no case as much as $12 \mathrm{~dB} /$ octave.
