# CHAPTER 9 Operational Amplifiers

Operational amplifiers (op amps) are an integral part of many analog and mixed-signal systems. Op amps with vastly different levels of complexity are used to realize functions ranging from dc bias generation to high-speed amplification or filtering. The design of op amps continues to pose a challenge as the supply voltage and transistor channel lengths scale down with each generation of CMOS technologies.

This chapter deals with the analysis and design of CMOS op amps. Following a review of performance parameters, we describe simple op amps such as telescopic and folded-cascode topologies. Next, we study two-stage and gain-boosting configurations and the problem of common-mode feedback. Finally, we introduce the concept of slew rate and analyze the effect of supply rejection and noise in op amps. The reader is encouraged to read this chapter before dealing with more advanced designs in Chapter 11 .

## 9.1 ■ General Considerations

We loosely define an op amp as a "high-gain differential amplifier." By "high," we mean a value that is adequate for the application, typically in the range of $10^{1}$ to $10^{5}$. Since op amps are usually employed to implement a feedback system, their open-loop gain is chosen according to the precision required of the closed-loop circuit.

Up to three decades ago, most op amps were designed to serve as "general-purpose" building blocks, satisfying the requirements of many different applications. Such efforts sought to create an "ideal" op amp, e.g., with a very high voltage gain (several hundred thousand), high input impedance, and low output impedance, but at the cost of many other aspects of the performance, e.g., speed, output voltage swings, and power dissipation.

By contrast, today's op amp design proceeds with the recognition that the trade-offs between the parameters eventually require a multi dimensional compromise in the overall implementation, making it necessary to know the adequate value that must be achieved for each parameter. For example, if the speed is critical while the gain error is not, a topology is chosen that favors the former, possibly sacrificing the latter.

### 9.1.1 Performance Parameters

In this section, we describe a number of op amp design parameters, providing an understanding of why and where each may become important. For this discussion, we consider the differential cascode circuit
image_name:Figure 9.1 Cascode op amp.
description:
[
name: M1, type: NMOS, ports: {S: GND, D: d1s3, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: d2s4, G: Vin}
name: M3, type: NMOS, ports: {S: d1s3, D: Voutp, G: Vb1}
name: M4, type: NMOS, ports: {S: d2s4, D: Voutn, G: Vb1}
name: M5, type: PMOS, ports: {S: ssd5, D: Voutp, G: Vb2}
name: M6, type: PMOS, ports: {S: sdc6, D: Voutn, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: ssd5, G: Vb3}
name: M8, type: PMOS, ports: {S: VDD, D: sdc8, G: Vb3}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a differential cascode operational amplifier. It uses a combination of NMOS and PMOS transistors to achieve high gain and improved speed. The design includes current mirrors for biasing, as indicated by the voltages Vb1, Vb2, and Vb3. The current source Iss provides a constant bias current. The input signals are Vip and Vin, and the output signals are Voutp and Voutn.

Figure 9.1 Cascode op amp.
shown in Fig. 9.1 as a representative op amp design. ${ }^{1}$ The voltages $V_{b 1}-V_{b 3}$ are generated by the current mirror techniques described in Chapter 5.

Gain The open-loop gain of an op amp determines the precision of the feedback system employing the op amp. As mentioned before, the required gain may vary by four orders of magnitude according to the application. Trading with such parameters as speed and output voltage swings, the minimum required gain must therefore be known. As explained in Chapter 14, a high open-loop gain may also be necessary to suppress nonlinearity.

#### Example 9.1

The circuit of Fig. 9.2 is designed for a nominal gain of 10 , i.e., $1+R_{1} / R_{2}=10$. Determine the minimum value of $A_{1}$ for a gain error of $1 \%$.
image_name:Figure 9.2
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vin, InN: InN(A1), OutP: Vout, OutN: '}
name: R1, type: Resistor, value: R1, ports: {N1: Vout, N2: InN(A1)}
name: R2, type: Resistor, value: R2, ports: {N1: InN(A1), N2: GND'}
]
extrainfo:The circuit is a non-inverting amplifier with feedback resistors R1 and R2 determining the gain. The input is at Vin, and the output is at Vout. The inverting input of the op-amp is connected to the junction of R1 and R2.

Figure 9.2

#### Solution

The closed-loop gain is obtained from Chapter 8 as

$$
\begin{align*}
\frac{V_{\text {out }}}{V_{\text {in }}} & =\frac{A_{1}}{1+\frac{R_{2}}{R_{1}+R_{2}} A_{1}}  \tag{9.1}\\
& =\frac{R_{1}+R_{2}}{R_{2}} \frac{A_{1}}{\frac{R_{1}+R_{2}}{R_{2}}+A_{1}} \tag{9.2}
\end{align*}
$$

[^60]Predicting that $A_{1} \gg 10$, we approximate $(9.2)$ as

$$
\begin{equation*}
\frac{V_{\text {out }}}{V_{\text {in }}} \approx\left(1+\frac{R_{1}}{R_{2}}\right)\left(1-\frac{R_{1}+R_{2}}{R_{2}} \frac{1}{A_{1}}\right) \tag{9.3}
\end{equation*}
$$

The term $\left(R_{1}+R_{2}\right) /\left(R_{2} A_{1}\right)=\left(1+R_{1} / R_{2}\right) / A_{1}$ represents the relative gain error. To achieve a gain error less than $1 \%$, we must have $A_{1}>1000$.

It is instructive to compare the circuit of Fig. 9.2 with an open-loop implementation such as that in Fig. 9.3. While it is possible to obtain a nominal gain of $g_{m} R_{D}=10$ by a common-source stage, it is extremely difficult to guarantee an error less than $1 \%$. The variations in the mobility and gate-oxide thickness of the transistor and the value of the resistor typically yield an error greater than $20 \%$.
image_name:Figure 9.3 Simple common-source stage
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout, G: Vin}
name: RD, type: Resistor, value: RD, ports: {N1: VDD, N2: Vout}
name: VDD, type: VoltageSource, value: VDD, ports: {Np: VDD, Nn: GND}
]
extrainfo:This is a simple common-source amplifier circuit using an NMOS transistor. The input voltage Vin controls the NMOS, and the output voltage Vout is taken across the drain resistor RD.

Figure 9.3 Simple common-source stage.

Small-Signal Bandwidth The high-frequency behavior of op amps plays a critical role in many applications. For example, as the frequency of operation increases, the open-loop gain begins to drop (Fig. 9.4), creating larger errors in the feedback system. The small-signal bandwidth is usually defined as the "unitygain" frequency, $f_{u}$, which can reach several gigahertz in today's CMOS op amps. The $3-\mathrm{dB}$ frequency, $f_{3-\mathrm{dB}}$, may also be specified to allow easier prediction of the closed-loop frequency response.
image_name:Figure 9.4
description:The graph in Figure 9.4 is a Bode plot, which illustrates the gain roll-off of an operational amplifier with respect to frequency.

1. **Type of Graph and Function:**
- This is a Bode plot, showing the magnitude of gain in decibels (dB) against frequency on a logarithmic scale.

2. **Axes Labels and Units:**
- The vertical axis represents the gain in decibels, denoted as \(20 \log |A_v|\). The horizontal axis represents frequency, labeled as \(f\), on a logarithmic scale.
- The frequency axis has significant markers at \(f_{3-\mathrm{dB}}\) and \(f_{u}\), indicating key frequencies.

3. **Overall Behavior and Trends:**
- The graph shows a constant gain at lower frequencies, followed by a decrease in gain as frequency increases. This is typical of a single-pole amplifier.
- The gain begins to roll-off at the \(f_{3-\mathrm{dB}}\) point, indicating where the gain has decreased by 3 dB from its low-frequency value.
- The roll-off continues until it reaches the unity-gain frequency \(f_{u}\), where the gain is 0 dB.

4. **Key Features and Technical Details:**
- The \(f_{3-\mathrm{dB}}\) frequency is a critical point where the gain starts to decline significantly.
- The unity-gain frequency \(f_{u}\) is where the gain equals 1 (0 dB), and it represents the bandwidth of the amplifier.
- The slope of the roll-off beyond \(f_{3-\mathrm{dB}}\) is typically -20 dB/decade, characteristic of a single-pole system.

5. **Annotations and Specific Data Points:**
- The graph includes a dashed vertical line at \(f_{3-\mathrm{dB}}\) to highlight the -3 dB point.
- The unity-gain frequency \(f_{u}\) is marked on the frequency axis, indicating the point where the gain curve intersects the 0 dB line.

Figure 9.4 Gain roll-off with frequency.

#### Example 9.2

In the circuit of Fig. 9.5, assume that the op amp is a single-pole voltage amplifier. If $V_{i n}$ is a small step, calculate the time required for the output voltage to reach within $1 \%$ of its final value. What unity-gain bandwidth must the
image_name:Figure 9.5
description:
[
name: Vin, type: VoltageSource, ports: {Np: Vin, Nn: GND}
name: R1, type: Resistor, value: R1, ports: {N1: Vout, N2: InN(As)}
name: R2, type: Resistor, value: R2, ports: {N1: InN(As), N2: GND}
name: A(s), type: OpAmp, value: A(s), ports: {InP: Vin, InN: InN(As), OutP: Vout}
]
extrainfo:The circuit is a feedback amplifier with a single-pole op amp. The input is Vin, and the output is Vout. The op amp provides amplification with feedback resistors R1 and R2. The graph shows the step response of the output voltage Vout in relation to the input voltage Vin.
image_name:Figure 9.4
description:The graph in Figure 9.4 is a Bode plot depicting the gain roll-off of an operational amplifier with frequency. This type of graph is used to analyze the frequency response of a system.

1. **Axes Labels and Units:**
- The horizontal axis represents frequency, typically measured in hertz (Hz), and is displayed on a logarithmic scale. This allows for a wide range of frequencies to be visualized on the same plot.
- The vertical axis represents gain, measured in decibels (dB).

2. **Overall Behavior and Trends:**
- The graph shows a decreasing trend in gain as the frequency increases, which is characteristic of a low-pass filter behavior.
- The gain starts at a high level at low frequencies and rolls off at higher frequencies.

3. **Key Features and Technical Details:**
- The -3 dB point, also known as the cutoff frequency \(f_{3-\mathrm{dB}}\), is marked on the graph. This point indicates where the gain has dropped by 3 dB from its maximum value at low frequencies.
- The unity-gain frequency \(f_{u}\) is also indicated. This is the frequency at which the gain curve intersects the 0 dB line, signifying that the output signal is equal in amplitude to the input signal.

4. **Annotations and Specific Data Points:**
- Annotations highlight the critical frequencies, such as \(f_{3-\mathrm{dB}}\) and \(f_{u}\), which are crucial for understanding the bandwidth and stability of the amplifier.

Overall, this Bode plot provides a clear visualization of how the gain of the operational amplifier decreases with increasing frequency, marking important frequency points that are vital for designing and analyzing amplifier circuits.

Figure 9.5
op amp provide if $1+R_{1} / R_{2} \approx 10$ and the settling time is to be less than 5 ns ? For simplicity, assume that the low-frequency gain is much greater than unity.

#### Solution

Since

$$
\begin{equation*}
\left(V_{\text {in }}-V_{\text {out }} \frac{R_{2}}{R_{1}+R_{2}}\right) A(s)=V_{\text {out }} \tag{9.4}
\end{equation*}
$$

we have

$$
\begin{equation*}
\frac{V_{\text {out }}}{V_{\text {in }}}(s)=\frac{A(s)}{1+\frac{R_{2}}{R_{1}+R_{2}} A(s)} \tag{9.5}
\end{equation*}
$$

For a one-pole system, $A(s)=A_{0} /\left(1+s / \omega_{0}\right)$, where $\omega_{0}$ is the $3-\mathrm{dB}$ bandwidth and $A_{0} \omega_{0}$ the unity-gain bandwidth. Thus,

$$
\begin{align*}
\frac{V_{\text {out }}}{V_{\text {in }}}(s) & =\frac{A_{0}}{1+\frac{R_{2}}{R_{1}+R_{2}} A_{0}+\frac{s}{\omega_{0}}}  \tag{9.6}\\
& =\frac{\frac{A_{0}}{1+\frac{R_{2}}{R_{1}+R_{2}} A_{0}}}{1+\frac{S}{\left(1+\frac{R_{2}}{R_{1}+R_{2}} A_{0}\right) \omega_{0}}} \tag{9.7}
\end{align*}
$$

indicating that the closed-loop amplifier is also a one-pole system with a time constant equal to

$$
\begin{equation*}
\tau=\frac{1}{\left(1+\frac{R_{2}}{R_{1}+R_{2}} A_{0}\right) \omega_{0}} \tag{9.8}
\end{equation*}
$$

Recognizing that the quantity $R_{2} A_{0} /\left(R_{1}+R_{2}\right)$ is the low-frequency loop gain and usually much greater than unity, we have

$$
\begin{equation*}
\tau \approx\left(1+\frac{R_{1}}{R_{2}}\right) \frac{1}{A_{0} \omega_{0}} \tag{9.9}
\end{equation*}
$$

The output step response for $V_{i n}=a u(t)$ can now be expressed as

$$
\begin{equation*}
V_{\text {out }}(t) \approx a\left(1+\frac{R_{1}}{R_{2}}\right)\left(1-\exp \frac{-t}{\tau}\right) u(t) \tag{9.10}
\end{equation*}
$$

with the final value $V_{F} \approx a\left(1+R_{1} / R_{2}\right)$. For $1 \%$ settling, $V_{\text {out }}=0.99 V_{F}$, and hence

$$
\begin{equation*}
1-\exp \frac{-t_{1 \%}}{\tau}=0.99 \tag{9.11}
\end{equation*}
$$

yielding $t_{1 \%}=\tau \ln 100 \approx 4.6 \tau$. For a $1 \%$ settling of $5 \mathrm{~ns}, \tau \approx 1.09 \mathrm{~ns}$, and from $(9.9), A_{0} \omega_{0} \approx\left(1+R_{1} / R_{2}\right) / \tau=9.21$ $\mathrm{Grad} / \mathrm{s}(1.47 \mathrm{GHz})$.

The key point in the above example is that the bandwidth is dictated by both the required settling accuracy (e.g., $V_{\text {out }}=0.99 V_{F}$ ) and the closed-loop gain $\left(1+R_{1} / R_{2}\right)$.

#### Example 9.3

A student mistakenly swaps the inverting and non-inverting inputs of the op amp in Fig. 9.5. Explain how the circuit behaves.

#### Solution

Positive feedback may destabilize the circuit. For a one-pole op amp, we have

$$
\begin{equation*}
\left(V_{\text {out }} \frac{R_{2}}{R_{1}+R_{2}}-V_{\text {in }}\right) \frac{A_{0}}{1+\frac{s}{\omega_{0}}}=V_{\text {out }} \tag{9.12}
\end{equation*}
$$

and hence

$$
\begin{equation*}
\frac{V_{\text {out }}}{V_{\text {in }}}(s)=\frac{\frac{A_{0}}{1-\frac{R_{2}}{R_{1}+R_{2}} A_{0}}}{1-\frac{s}{\left(1+\frac{R_{2}}{R_{1}+R_{2}} A_{0}\right) \omega_{0}}} \tag{9.13}
\end{equation*}
$$

Interestingly, the closed-loop amplifier contains a pole in the right half plane, exhibiting a step response that grows exponentially with time:

$$
\begin{equation*}
V_{\text {out }}(t) \approx a\left(1+\frac{R_{1}}{R_{2}}\right)\left(\exp \frac{t}{\tau}-1\right) u(t) \tag{9.14}
\end{equation*}
$$

This growth continues until the op amp output saturates.

Large-Signal Behavior In many of today's applications, op amps must operate with large transient signals. Under these conditions, nonlinear phenomena make it difficult to characterize the speed merely by small-signal properties such as the open-loop response shown in Fig. 9.4. As an example, suppose the feedback circuit of Fig. 9.5 incorporates a realistic op amp (i.e., with finite output impedance) while driving a large load capacitance. How does the circuit behave if we apply a 1-V step at the input? Since the output voltage cannot change instantaneously, the voltage difference sensed by the op amp itself at $t \geq 0$ is equal to 1 V . Such a large difference momentarily drives the op amp into a nonlinear region of operation. (Otherwise, with an open-loop gain of, say, 1000, the op amp would produce 1000 V at the output.)

As explained in Sec. 9.9, the large-signal behavior is usually quite complex, calling for careful simulations.

Output Swing Most systems employing op amps require large voltage swings to accommodate a wide range of signal amplitudes. For example, a high-quality microphone that senses the music produced by an orchestra may generate instantaneous voltages that vary by more than four orders of magnitude, demanding that subsequent amplifiers and filters handle large swings (and/or achieve a low noise).

The need for large output swings has made fully differential op amps popular. Similar to the circuits described in Chapter 4, such op amps generate "complementary" outputs, roughly doubling the available swing. Nonetheless, as mentioned in Chapters 3 and 4 and explained later in this chapter, the maximum voltage swing trades with device size and bias currents and hence speed. Achieving large swings is the principal challenge in today's op amp design.

Linearity Open-loop op amps suffer from substantial nonlinearity. In the circuit of Fig. 9.1, for example, the input pair $M_{1}-M_{2}$ exhibits a nonlinear relationship between its differential drain current and its input voltage. As explained in Chapter 14, the issue of nonlinearity is tackled by two approaches: using fully
differential implementations to suppress even-order harmonics and allowing sufficient open-loop gain for the closed-loop feedback system to achieve adequate linearity. It is interesting to note that in many feedback circuits, the linearity requirement, rather than the gain error requirement, governs the choice of the open-loop gain.

Noise and Offset The input noise and offset of op amps determine the minimum signal level that can be processed with reasonable quality. In a typical op amp topology, several devices contribute noise and offset, necessitating large dimensions or bias currents. For example, in the circuit of Fig. 9.1, $M_{1}-M_{2}$ and $M_{7}-M_{8}$ contribute the most.

We should also recognize a trade-off between noise and output swing. For a given bias current, as the overdrive voltage of $M_{7}$ and $M_{8}$ in Fig. 9.1 is lowered to allow larger swings at the output, their transconductance increases and so does their drain noise current.

Supply Rejection Op amps are often employed in mixed-signal systems and sometimes connected to noisy digital supply lines. Thus, the performance of op amps in the presence of supply noise, especially as the noise frequency increases, is important. For this reason, fully differential topologies are preferred.

## 9.2 ■ One-Stage Op Amps

### 9.2.1 Basic Topologies

All of the differential amplifiers studied in Chapters 4 and 5 can be considered op amps. Figure 9.6 shows two such topologies with single-ended and differential outputs. The small-signal, low-frequency gain of both circuits is equal to $g_{m N}\left(r_{O N} \| r_{O P}\right)$, where the subscripts $N$ and $P$ denote NMOS and PMOS, respectively. This value hardly exceeds 10 in nanometer technologies. The bandwidth is usually determined by the load capacitance, $C_{L}$. Note that the circuit of Fig. 9.6(a) exhibits a mirror pole (Chapter 6) whereas that of Fig. 9.6(b) does not, a critical difference in terms of the stability of feedback systems using these topologies (Chapter 10).
image_name:Figure 9.6(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X1, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: Vip}
name: M3, type: PMOS, ports: {S: VDD, D: X1, G: X1}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: X1, Nn: GND}
]
extrainfo:The circuit is a simple op-amp topology with NMOS transistors M1 and M2, PMOS transistors M3 and M4, and a load capacitor CL. The current source ISS provides biasing. The circuit suffers from noise contributions from transistors M1 to M4. The low-frequency gain is determined by the transconductance and output resistances of the NMOS and PMOS transistors. The bandwidth is affected by the load capacitance CL. This topology exhibits a mirror pole, impacting the stability of feedback systems.
image_name:Figure 9.6(b)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout1, G: Vin1}
name: M2, type: NMOS, ports: {S: GND, D: Vout2, G: Vin2}
name: M3, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb}
name: M4, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb}
name: ISS, type: CurrentSource, ports: {Np: Vout1, Nn: GND}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout1, Nn: GND}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout2, Nn: GND}
]
extrainfo:Figure 9.6(b) shows a differential amplifier with two NMOS input transistors (M1 and M2) and two PMOS load transistors (M3 and M4). The circuit has two capacitive loads (CL) at the outputs Vout1 and Vout2. The current source ISS provides biasing current to the NMOS pair.

Figure 9.6 Simple op amp topologies.
The circuits of Fig. 9.6 suffer from noise contributions of $M_{1}-M_{4}$, as calculated in Chapter 7. Interestingly, in all op amp topologies, at least four devices contribute to the input noise: two input transistors and two "load" transistors.

#### Example 9.4

Calculate the input common-mode voltage range and the closed-loop output impedance of the unity-gain buffer depicted in Fig. 9.7.
image_name:Figure 9.7
description:The system block diagram in Figure 9.7 illustrates a unity-gain buffer, which is a type of operational amplifier configuration. This particular diagram consists of two main sections: a symbolic representation of the op-amp on the left and a detailed transistor-level implementation on the right.

1. **Main Components:**
- **Operational Amplifier (A1):** On the left side, the op-amp is shown with its inverting and non-inverting inputs labeled as \( V_{in} \) and \( V_{out} \), respectively. The output is also labeled \( V_{out} \).
- **Transistors:** The right side shows a transistor-level implementation with four MOSFETs labeled \( M_1, M_2, M_3, \) and \( M_4 \). These transistors form the core of the buffer circuit.
- **Current Source (I_SS):** A current source labeled \( I_{SS} \) is connected to the source of \( M_1 \) and \( M_2 \), providing biasing current to the NMOS pair.

2. **Flow of Information or Control:**
- **Input Signal (\( V_{in} \)):** The input voltage \( V_{in} \) is applied to the gate of transistor \( M_1 \).
- **Output Signal (\( V_{out} \)):** The output voltage \( V_{out} \) is taken from the drain of transistor \( M_2 \) and is fed back to the inverting input of the op-amp, forming a feedback loop.
- **Transistor Connections:**
- \( M_1 \) and \( M_2 \) are NMOS transistors forming a differential pair.
- \( M_3 \) and \( M_4 \) are PMOS transistors acting as active loads.
- **Feedback Loop:** The output \( V_{out} \) is connected back to the inverting input of the op-amp, ensuring unity gain.

3. **Labels, Annotations, and Key Indicators:**
- **Voltage Supply (\( V_{DD} = 1V \)):** The circuit is powered by a supply voltage \( V_{DD} \) of 1V.
- **Transistor Annotations:** The gates of \( M_3 \) and \( M_4 \) are labeled \( \chi_1 \), indicating control or biasing signals.

4. **Overall System Function:**
- The unity-gain buffer is designed to provide a high input impedance and low output impedance, effectively isolating the input from the output. The feedback loop ensures that the output voltage \( V_{out} \) closely follows the input voltage \( V_{in} \), achieving a gain of one. This configuration is useful for buffering signals without amplifying them, maintaining signal integrity across different stages of a circuit.
image_name:Figure 9.6
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vin, InN: Vout, OutP: Vout, OutN: '}
name: M1, type: NMOS, ports: {S: p, D: x1, G: Vin}
name: M2, type: NMOS, ports: {S: p, D: Vout, G: Vout}
name: M3, type: PMOS, ports: {S: VDD, D: x1, G: x1}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: x1}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: VDD, Nn: p'}
]
extrainfo:The circuit is a basic op-amp topology with a differential pair (M1, M2) and active loads (M3, M4). The current source Iss provides biasing current. The op-amp A1 is configured as a unity-gain buffer with feedback from Vout to the inverting input.

Figure 9.7

#### Solution

The minimum allowable input voltage is equal to $V_{I S S}+V_{G S 1}$, where $V_{I S S}$ is the voltage required across the current source. The maximum voltage is given by the level that places $M_{1}$ at the edge of the triode region: $V_{i n, \max }=$ $V_{D D}-\left|V_{G S 3}\right|+V_{T H 1}$. For example, if each device (including the current source) has a threshold voltage of 0.3 V and an overdrive of 0.1 V , then $V_{\text {in,min }}=0.1+0.1+0.3=0.5 \mathrm{~V}$ and $V_{i n, \max }=1-(0.1+0.3)+0.3=0.9 \mathrm{~V}$. Thus, the input CM range equals 0.4 V with a $1-\mathrm{V}$ supply.

Since the circuit employs voltage feedback at the output, the output impedance is equal to the open-loop value, $r_{O P} \| r_{O N}$, divided by one plus the loop gain, $1+g_{m N}\left(r_{O P} \| r_{O N}\right)$. In other words, for large open-loop gain, the closed-loop output impedance is approximately equal to $\left(r_{O P} \| r_{O N}\right) /\left[g_{m N}\left(r_{O P} \| r_{O N}\right)\right]=1 / g_{m N}$.

It is interesting to note that the closed-loop output impedance is relatively independent of the open-loop output impedance. This is an important observation, allowing us to design high-gain op amps by increasing the open-loop output impedance while still achieving a relatively low closed-loop output impedance. We also observe that, if driving a load capacitance of $C_{L}$, the op amp incurs a closed-loop output pole approximately given by $g_{m N} / C_{L}$.

In order to achieve a high gain, the differential cascode topologies of Chapters 4 and 5 can be used. Shown in Figs. 9.8(a) and (b) for single-ended and differential output generation, respectively, such circuits display a gain on the order of $g_{m N}\left[\left(g_{m N} r_{O N}^{2}\right) \|\left(g_{m P} r_{O P}^{2}\right)\right]$, but at the cost of output swing and
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: P, D: X, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Y, G: Vb}
name: M3, type: NMOS, ports: {S: Y, D: Vout, G: Vb}
name: M4, type: NMOS, ports: {S: Y, D: Vout, G: Vb}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: Vb}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: Vb}
name: M7, type: PMOS, ports: {S: VDD, D: X, G: Vb}
name: M8, type: PMOS, ports: {S: VDD, D: Y, G: Vb}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a single-ended telescopic cascode op amp. It features a high gain configuration with limited output swing and potential stability issues due to additional poles at nodes X and Y. The op amp is designed to drive a load capacitance, incurring a closed-loop output pole approximately given by gmN / CL.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: P, D: d1s4, G: Vip}
name: M2, type: NMOS, ports: {S: P, D: d2s4, G: Vin}
name: M3, type: NMOS, ports: {S: d1s3, D: Voutp, G: Vb1}
name: M4, type: NMOS, ports: {S: d2s4, D: Voutn, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: Voutp, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Voutn, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: ssd7, G: Vb3}
name: M8, type: PMOS, ports: {S: VDD, D: sbd8, G: Vb3}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit in Figure 9.8(b) is a fully differential telescopic cascode op amp. It is designed to provide a high gain using differential cascode topologies. Key nodes include Voutp and Voutn for the differential outputs, with bias voltages Vb1, Vb2, and Vb3 controlling different stages of the circuit. The circuit uses NMOS transistors M1-M4 and PMOS transistors M5-M8, with a current source Iss providing biasing current.

Figure 9.8 Cascode op amps.
additional poles. These configurations are also called "telescopic" cascode op amps to distinguish them from another cascode op amp described below. The circuit providing a single-ended output suffers from a mirror pole at node $X$ (and a pole at $Y$ ), creating stability issues (Chapter 10).

As calculated in Chapter 4 , the output swings of telescopic op amps are relatively limited. In the fully differential version of Fig. 9.8(b), for example, the output swing is given by $2\left[V_{D D}-\left(V_{O D 1}+V_{O D 3}+\right.\right.$ $\left.\left.V_{I S S}+\left|V_{O D 5}\right|+\left|V_{O D 7}\right|\right)\right]$, where $V_{O D j}$ denotes the overdrive voltage of $M_{j}$ and $V_{I S S}$ the minimum allowable voltage across $I_{S S}$. We must recognize the three conditions necessary for allowing this much swing: (1) the input CM level, $V_{i n, C M}$, is chosen low enough and equal to $V_{G S 1}+V_{I S S}$, (2) $V_{b 1}$ is also chosen low enough and equal to $V_{G S 3}+\left(V_{i n, C M}-V_{T H 1}\right)$, placing $M_{1}$ at the edge of saturation, and (3) $V_{b 2}$ is chosen high enough and equal to $V_{D D}-\left|V_{O D 7}\right|-\left|V_{G S 5}\right|$, placing $M_{7}$ at the edge of saturation. Thus, $V_{i n, C M}$ (and $V_{b 1}$ and $V_{b 2}$ ) must be controlled tightly, a serious issue.

Another drawback of telescopic cascodes is the difficulty in shorting their inputs and outputs, e.g., to implement a unity-gain buffer similar to the circuit of Fig. 9.7. To understand the issue, let us consider the unity-gain feedback topology shown in Fig. 9.9. Under what conditions are both $M_{2}$ and $M_{4}$ in saturation? We must have $V_{\text {out }} \leq V_{X}+V_{T H 2}$ and $V_{\text {out }} \geq V_{b}-V_{T H 4}$. Since $V_{X}=V_{b}-V_{G S 4}, V_{b}-V_{T H 4} \leq$ $V_{\text {out }} \leq V_{b}-V_{G S 4}+V_{T H 2}$. Depicted in Fig. 9.9, this voltage range is simply equal to $V_{\max }-V_{\min }=$ $V_{T H 4}-\left(V_{G S 4}-V_{T H 2}\right)$ (one threshold minus one overdrive), maximized by minimizing the overdrive of $M_{4}$ but always less than $V_{T H 2}$.
image_name:Figure 9.9
description:
[
name: M1, type: NMOS, ports: {S: p, D: x, G: Vin}
name: M2, type: NMOS, ports: {S: x, D: Vout, G: Vb}
name: M3, type: NMOS, ports: {S: Vb, D: x2, G: Vb}
name: M4, type: NMOS, ports: {S: x, D: Vout, G: x}
name: M5, type: PMOS, ports: {S: VDD, D: x2, G: x1}
name: M6, type: PMOS, ports: {S: VDD, D: Vout, G: x2}
name: M7, type: PMOS, ports: {S: VDD, D: x1, G: x1}
name: M8, type: PMOS, ports: {S: VDD, D: Vout, G: x2}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: p, Nn: GND}
]
extrainfo:The circuit is a telescopic cascode operational amplifier with input and output shorted. It consists of NMOS transistors M1, M2, M3, and M4, and PMOS transistors M5, M6, M7, and M8. The current source Iss provides biasing for the circuit. The allowable output voltage range is determined by the threshold and overdrive voltages of M4 and M2.
image_name:Allowable Range
description:The graph labeled "Allowable Range" is a voltage range diagram associated with a telescopic cascode operational amplifier circuit. The diagram visually represents the permissible output voltage range for which the transistors $M_2$ and $M_4$ operate in saturation.

Type of Graph:
This is a range diagram, not a traditional function graph like a Bode plot or time-domain waveform. It illustrates the relationship between different voltage levels in the circuit.

Axes Labels and Units:
The diagram does not have explicit axes like a typical graph; instead, it uses horizontal and vertical lines to denote specific voltage levels. The vertical dimension represents voltage levels, but no specific units or scales are marked, as it is a conceptual diagram.

Overall Behavior and Trends:
The diagram shows a vertical range of voltages. It indicates that the allowable range for $V_{\text{out}}$ is between $V_b - V_{TH4}$ and $V_b$. This range ensures that both $M_2$ and $M_4$ remain in saturation.

Key Features and Technical Details:
- **Top Boundary:** $V_b$ - This is the maximum voltage level for the output.
- **Bottom Boundary:** $V_b - V_{TH4}$ - This is the minimum voltage level for the output.
- **Allowable Range:** The shaded area between these two boundaries represents the range within which $V_{\text{out}}$ can vary while keeping the transistors in saturation.
- **Offset:** The distance from $V_b$ to the lower boundary is $V_{TH4}$, which indicates the threshold voltage for $M_4$.
- **Sub-range:** Within the allowable range, there is a smaller range marked by $V_{GS4} - V_{TH2}$, which indicates the overdrive voltage for $M_4$.

### Annotations and Specific Data Points:
The diagram includes annotations for $V_b$, $V_{TH4}$, and $V_{GS4} - V_{TH2}$, which are critical for understanding the operational limits of the amplifier circuit. These annotations help in identifying the voltage levels necessary to maintain the desired transistor operation.

Figure 9.9 Telescopic cascode op amp with input and output shorted.

#### Example 9.5

For the circuit of Fig. 9.9, explain in which region each transistor operates as $V_{i n}$ varies from below $V_{b}-V_{T H 4}$ to above $V_{b}-V_{G S 4}+V_{T H 2}$.

#### Solution

Since the op amp attempts to force $V_{\text {out }}$ to be equal to $V_{\text {in }}$, for $V_{\text {in }}<V_{b}-V_{T H 4}$, we have $V_{\text {out }} \approx V_{\text {in }}$, and $M_{4}$ is in the triode region while other transistors are saturated. Under this condition, the open-loop gain of the op amp is reduced.

As $V_{\text {in }}$ and hence $V_{\text {out }}$ exceed $V_{b}-V_{T H 4}, M_{4}$ enters saturation and the open-loop gain reaches a maximum. For $V_{b}-V_{T H 4}<V_{i n}<V_{b}-\left(V_{G S 4}-V_{T H 2}\right)$, both $M_{2}$ and $M_{4}$ are saturated, and for $V_{i n}>V_{b}-\left(V_{G S 4}-V_{T H 2}\right), M_{2}$ and $M_{1}$ enter the triode region, degrading the gain.

While a cascode op amp is rarely used as a unity-gain buffer, some other topologies (such as the switched-capacitor circuits of Chapter 13) reduce to the configuration shown in Fig. 9.9 for part of their operation period, as illustrated by the following example.

#### Example 9.6

Figure 9.10(a) shows a closed-loop amplifier utilizing a telescopic op amp. ${ }^{2}$ Assuming that the op amp has a high open-loop gain, determine the maximum allowable output voltage swing.
image_name:(a)
description:
[
name: R1, type: Resistor, value: R1, ports: {N1: Vip, N2: InP(A1)}
name: R2, type: Resistor, value: R2, ports: {N1: Vin, N2: InN(A1)}
name: R3, type: Resistor, value: R3, ports: {N1: OutN(A1), N2: Vb}
name: R4, type: Resistor, value: R4, ports: {N1: Y, N2: X4}
name: C1, type: Capacitor, value: C1, ports: {Np: X1, Nn: X2}
name: Cl, type: Capacitor, value: Cl, ports: {Np: X3, Nn: X4}
name: M1, type: NMOS, ports: {S: P, D: d1s3, G: X}
name: M2, type: NMOS, ports: {S: P, D: d1s4, G: Y}
name: M3, type: NMOS, ports: {S: d1s3, D: X, G: Vb}
name: M4, type: NMOS, ports: {S: d1s4, D: Y, G: Vb}
name: A1, type: OpAmp, value: A1, ports: {InP: InP(A1), InN: InN(A1), OutP: OutP(A1), OutN: OutN(A1)}
name: Ir, type: CurrentSource, value: Ir, ports: {Np: Vb, Nn: GND}
]
extrainfo:This circuit is a telescopic op amp configuration with a focus on maximizing output voltage swing. The op amp is connected in a feedback loop with resistors R1, R2, R3, and R4, and capacitors C1 and Cl for stability and filtering. The output swing is constrained by the saturation conditions of the NMOS transistors M1, M2, M3, and M4, as well as the bias voltage Vb. The current source Ir provides biasing current to the NMOS transistors.
image_name:(b)
description:
[
name: R1, type: Resistor, value: R1, ports: {N1: X1, N2: G1}
name: R2, type: Resistor, value: R2, ports: {N1: Y, N2: X4}
name: R3, type: Resistor, value: R3, ports: {N1: Vb, N2: X}
name: R4, type: Resistor, value: R4, ports: {N1: Y, N2: G2}
name: C1, type: Capacitor, value: C1, ports: {Np: X1, Nn: X2}
name: C2, type: Capacitor, value: C2, ports: {Np: X3, Nn: X4}
name: M1, type: NMOS, ports: {S: P, D: D1S3, G: Vb}
name: M2, type: NMOS, ports: {S: P, D: D1S3, G: Vb}
name: M3, type: NMOS, ports: {S: D1S3, D: X, G: Vb}
name: M4, type: NMOS, ports: {S: D1S4, D: Y, G: Vb}
name: A1, type: OpAmp, value: A1, ports: {InP: X1, InN: X2, OutP: X, OutN: Y}
name: Ir, type: CurrentSource, value: Ir, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit diagram shows a telescopic operational amplifier configuration. The NMOS transistors M1 and M2 are configured as a differential pair, while M3 and M4 act as cascode transistors. The current source Ir provides biasing current through the tail node P. The resistors R1 and R3 are connected to the bias voltage Vb, and capacitors C1 and C2 are used for AC coupling. The output voltage swing is influenced by the bias conditions and the saturation of the transistors.
image_name:(c)
description:The graph labeled (c) in Figure 9.10 is a time-domain waveform depicting the voltage $V_X$ over time $t$. The horizontal axis represents time, while the vertical axis represents voltage, although specific units are not given. The waveform is sinusoidal, indicating an oscillating voltage $V_X$.

Key Features:
- **Voltage Levels:**
- The waveform oscillates around a central voltage level denoted as $V_{CM}$, which is the common-mode voltage.
- The upper boundary for the waveform is marked as $V_b - V_{TH3,4}$, where $V_b$ is a bias voltage and $V_{TH3,4}$ represents the threshold voltage for transistors $M_3$ and $M_4$.

- **Regions of Operation:**
- The graph indicates that when $V_X$ exceeds the level of $V_b - V_{TH3,4}$, transistors $M_3$ and $M_4$ enter the triode region, which is a non-saturation operating mode.

Overall Behavior:
- The waveform shows a periodic oscillation, typical of AC signals, with peaks and troughs around the common-mode voltage $V_{CM}$.
- The upper limit of the waveform is critical for maintaining the transistors $M_3$ and $M_4$ in their desired operating regions.

Annotations:
- The graph includes annotations indicating the triode region for $M_3$ and $M_4$, highlighting the importance of maintaining $V_X$ within specified voltage bounds to ensure proper transistor operation.

This graph is crucial for understanding the voltage swing limitations and transistor operation in the given amplifier circuit configuration.
image_name:(d)
description:The graph in Figure 9.10(d) is a time-domain waveform representing the voltage $V_X$ as a function of time $t$. The horizontal axis is time $t$, and the vertical axis is the voltage $V_X$. The waveform is sinusoidal, indicating an oscillating voltage over time.

The graph features two horizontal dashed lines that represent critical voltage levels. The upper dashed line is labeled $V_b - (V_{GS3,4} - V_{TH1,2})$, and the lower dashed line is labeled $V_b - V_{TH3,4}$. These lines indicate the boundaries within which the voltage $V_X$ can swing to keep certain transistors in saturation.

The waveform is centered around a common-mode voltage level, $V_{CM}$, shown as a dashed line slightly below the upper boundary. The waveform oscillates between the lower boundary of $V_b - V_{TH3,4}$ and approaches the upper boundary of $V_b - (V_{GS3,4} - V_{TH1,2})$. The sinusoidal shape suggests that $V_X$ periodically reaches these boundaries, which are critical for maintaining the operation of the transistors in their desired regions.

The graph does not include specific numerical values for the voltages or time period, but it visually represents the concept of allowable voltage swing in relation to transistor saturation conditions.

Figure 9.10

#### Solution

Let us draw the circuit as shown in Fig. 9.10(b), noting that its input and output common-mode levels are equal (why?). Recall from the foregoing discussion that the voltage at the drains of $M_{3}$ and $M_{4}$ is bounded by $V_{b}-V_{T H 3,4}$ to keep $M_{3}$ and $M_{4}$ in saturation and $V_{b}-\left(V_{G S 3,4}-V_{T H 1,2}\right)$ to keep $M_{1}$ and $M_{2}$ in saturation. How should we set the output CM level, $V_{C M}$, in this range to maximize the output swing? If $V_{C M}=V_{b}-V_{T H 3,4}$, then $M_{3}$ and $M_{4}$ reside at the edge of the triode region and cannot tolerate any downward swing [Fig. 9.10(c)]. On the other hand, if we select $V_{C M}=V_{b}-\left(V_{G S 3,4}-V_{T H 1,2}\right)$ (placing $M_{1}$ and $M_{2}$ at the edge), then $V_{X}$ or $V_{Y}$ can fall to $V_{b}-V_{T H 3,4}$ while maintaining $M_{3}$ and $M_{4}$ in saturation [Fig. 9.10(d)].

With the latter choice, how high can $V_{X}$ or $V_{Y}$ go? If the gain of the op amp is large, the gate voltages of $M_{1}$ and $M_{2}$ swing negligibly. Thus, $V_{X}$ and $V_{Y}$ can arbitrarily rise from $V_{C M}=V_{b}-\left(V_{G S 3,4}-V_{T H 1,2}\right)$ without driving $M_{1}$ and $M_{2}$ into the triode region. (Of course, the PMOS loads constrain the upswing.) For symmetric up- and downswings, therefore, the circuit allows a voltage excursion of $\pm$ (one threshold - one overdrive) around $V_{C M}$.

[^61]
### 9.2.2 Design Procedure

At this point, the reader may wonder how exactly we design an op amp. With so many devices and performance parameters, it may not be clear where the starting point is and how the numbers are chosen. Indeed, the actual design methodology of an op amp somewhat depends on the specifications that the circuit must meet. For example, a high-gain op amp may be designed quite differently from a low-noise op amp. Nevertheless, in most cases, some aspects of the performance, e.g., output voltage swings and open-loop gain, are of primary concern, pointing to a specific design procedure. We will deal extensively with five parameters for each transistor: $I_{D}, V_{G S}-V_{T H}, W / L, g_{m}$, and $r_{O}$.

In the design of op amps (and many other circuits), it is helpful to begin with a power budget, even if none is specified. As seen later in this section, the resulting design can readily be "scaled" for lower or higher power dissipations. We describe a simple design here and deal with nanometer op amps in Chapter 11 .

#### Example 9.7

Design a fully differential telescopic op amp with the following specifications: $V_{D D}=3 \mathrm{~V}$, peak-to-peak differential output swing $=3 \mathrm{~V}$, power dissipation $=10 \mathrm{~mW}$, voltage gain $=2000$. Assume that $\mu_{n} C_{o x}=60 \mu \mathrm{~A} / \mathrm{V}^{2}, \mu_{p} C_{o x}=$ $30 \mu \mathrm{~A} / \mathrm{V}^{2}, \lambda_{n}=0.1 \mathrm{~V}^{-1}, \lambda_{p}=0.2 \mathrm{~V}^{-1}$ (for an effective channel length of $0.5 \mu \mathrm{~m}$ ), $\gamma=0$, and $V_{T H N}=\left|V_{T H P}\right|=$ 0.7 V .

#### Solution

Figure 9.11 shows the op amp topology along with two current mirrors defining the drain currents of $M_{7}-M_{9}$. We begin with the power budget, allocating 3 mA to $M_{9}$ and the remaining $330 \mu \mathrm{~A}$ to $M_{b 1}$ and $M_{b 2}$. Thus, each cascode branch of the op amp carries a current of 1.5 mA . Next, we consider the required output swings. Each of nodes $X$ and $Y$ must be able to swing by $1.5 \mathrm{~V}_{p p}$ without driving $M_{3}-M_{6}$ into the triode region. With a 3-V supply, therefore, the total voltage available for $M_{9}$ and each cascode branch is equal to 1.5 V , i.e., $\left|V_{O D 7}\right|+\left|V_{O D 5}\right|+V_{O D 3}+V_{O D 1}+V_{O D 9}=1.5 \mathrm{~V}$.
image_name:Figure 9.11
description:
[
name: Mb2, type: PMOS, ports: {S: VDD, D: X1, G: Vb2}
name: M7, type: PMOS, ports: {S: X1, D: ssd7, G: Vb2}
name: M8, type: PMOS, ports: {S: ssd7, D: sbd8, G: Vb2}
name: M5, type: PMOS, ports: {S: Vb2, D: ssd7, G: Vb2}
name: M6, type: PMOS, ports: {S: ssd7, D: sbd8, G: Vb2}
name: Mb1, type: NMOS, ports: {S: X2, D: X2, G: Vb1}
name: M3, type: NMOS, ports: {S: X, D: ds3, G: Vb1}
name: M4, type: NMOS, ports: {S: ds3, D: ds4, G: Vb1}
name: M1, type: NMOS, ports: {S: ds3, D: dq, G: Vip}
name: M2, type: NMOS, ports: {S: ds4, D: Vin, G: Vin}
name: M9, type: NMOS, ports: {S: dq, D: GND, G: Vin}
]
extrainfo:The circuit is a differential amplifier with cascode configuration. It features PMOS and NMOS transistors forming a differential pair with active loads. The output nodes X and Y provide differential output, with biasing provided by Vb1 and Vb2. The circuit is designed to handle a swing of 1.5Vpp at nodes X and Y, with a supply voltage of 3V.

Figure 9.11

Since $M_{9}$ carries the largest current, we choose $V_{O D 9} \approx 0.5 \mathrm{~V}$, leaving 1 V for the four transistors in the cascode. Moreover, since $M_{5}-M_{8}$ suffer from low mobility, we allocate an overdrive of approximately 300 mV to each, obtaining 400 mV for $V_{O D 1}+V_{O D 3}$. As an initial guess, $V_{O D 1}=V_{O D 3}=200 \mathrm{mV}$.

With the bias current and overdrive voltage of each transistor known, we can easily determine the aspect ratios from $I_{D}=(1 / 2) \mu C_{o x}(W / L)\left(V_{G S}-V_{T H}\right)^{2}$ or simulated I/V characteristics. To minimize the device capacitances, we choose the minimum length for each transistor, obtaining a corresponding width. We then have $(W / L)_{1-4}=1250$, and $(W / L)_{5-8}=1111$, and $(W / L)_{9}=400$.

The reader may think that the above choice of overdrives is arbitrary and leads to a wide design space. However, we must emphasize that each of the overdrives has but a small range. For example, we can change the allocated values by only a few tens of millivolts before the device dimensions become disproportionately large.

The design has thus far satisfied the swing, power dissipation, and supply voltage specifications. But, how about the gain? Using $A_{v} \approx g_{m 1}\left[\left(g_{m 3} r_{O 3} r_{O 1}\right) \|\left(g_{m 5} r_{O 5} r_{O 7}\right)\right]$ and assuming minimum channel length for all of the transistors, we have $A_{v}=1416$, quite a lot lower than the required value.

In order to increase the gain, we recognize that $g_{m} r_{O}=\sqrt{2 \mu C_{o x}(W / L) I_{D}} /\left(\lambda I_{D}\right)$. Now, recall that $\lambda \propto 1 / L$, and hence $g_{m} r_{O} \propto \sqrt{W L / I_{D}}$. We can therefore increase the width or length or decrease the bias current of the transistors. In practice, speed or noise requirements may dictate the bias current, leaving only the dimensions as the variables. Of course, the width of each transistor must at least scale with its length so as to maintain a constant overdrive voltage.

Which transistors in the circuit of Fig. 9.11 should be made longer? Since $M_{1}-M_{4}$ appear in the signal path, it is desirable to keep their capacitances to a minimum. The PMOS devices, $M_{5}-M_{8}$, on the other hand, affect the signal to a much lesser extent and can therefore have larger dimensions. ${ }^{3}$ Doubling the (effective) length and width of each of these transistors in fact doubles their $g_{m} r_{O}$ because $g_{m}$ remains constant while $r_{O}$ increases by a factor of 2. Choosing $(W / L)_{5-8}=2222 \mu \mathrm{~m} / 1.0 \mu \mathrm{~m}$ and hence $\lambda_{p}=0.1 \mathrm{~V}^{-1}$, we obtain $A_{v} \approx 4000$. Thus, the PMOS dimensions can be somewhat smaller. Note that with such large dimensions for PMOS transistors, we may revisit our earlier distribution of the overdrive voltages, possibly reducing that of $M_{9}$ by 100 to 200 mV and allocating more to the PMOS devices.

In the op amp of Fig. 9.11, the input CM level and the bias voltages $V_{b 1}$ and $V_{b 2}$ must be chosen so as to allow maximum output swings. The minimum allowable input CM level equals $V_{G S 1}+V_{O D 9}=V_{T H 1}+V_{O D 1}+V_{O D 9}=$ 1.4 V . The minimum value of $V_{b 1}$ is given by $V_{G S 3}+V_{O D 1}+V_{O D 9}=1.6 \mathrm{~V}$, placing $M_{1}-M_{2}$ at the edge of the triode region. Similarly, $V_{b 2, \max }=V_{D D}-\left(\left|V_{G S 5}\right|+\left|V_{O D 7}\right|\right)=1.7 \mathrm{~V}$. In practice, some margin must be included in the value of $V_{b 1}$ and $V_{b 2}$ to allow for process variations. Also, the increase in the threshold voltages due to body effect must be taken into account. Finally, we should remark that this op amp requires common-mode feedback (CMFB) (Section 9.7).

### 9.2.3 Linear Scaling

How do we modify the above design if the power budget is different but all other specifications remain the same? Suppose we are allowed to double the power dissipation and hence the bias current of each transistor. The key concept behind "linear scaling" is to double the widths of all of the transistors in the circuit while keeping the lengths constant. Returning to our five device design parameters, we observe that, in this example, (1) $I_{D}$ is doubled, (2) $W / L$ is doubled, (3) $V_{G S}-V_{T H}$ is constant, and so are the allowable voltage swings, (4) $g_{m}$ is doubled because both the bias current and the width are doubled (as if two identical transistors were placed in parallel), and (5) $r_{O}$ is halved (for the same reason that $g_{m}$ is doubled). We therefore conclude that linear scaling by adjusting the transistor widths simply scales the power dissipation while retaining the gain and swing values. This concept is used in Chapter 11 to optimize the performance of op amps.

#### Example 9.8

An engineer seeking a low-power op amp design scales down the transistor widths in Example 9.7 by a factor of 10 . Explain what aspects of the performance degrade.

#### Solution

Since the $g_{m}$ of each transistor falls by a factor of 10 , two aspects are sacrificed: (1) the speed of the op amp in driving a capacitive load (e.g., the output pole in Example 9.4) degrades proportionally, and (2) the input-referred noise voltage of the op amp rises by a factor of $\sqrt{10}$ (Sec. 9.12).

[^62]In nanometer technologies, op amp design can still follow the above procedure, but with greater reliance on simulated device characteristics. Unfortunately, the lower supply voltage severely limits the output swing, making the telescopic cascode less attractive. We return to these points in Chapter 11.

The gate bias voltages $V_{b 1}$ and $V_{b 2}$ in the telescopic cascode of Fig. 9.11 must be generated with some precision. We note that if, for example, $V_{b 1}$ is less than its nominal value, then $M_{1}$ and $M_{2}$ enter the triode region. The same occurs even if $V_{b 1}$ is fixed, but the input CM level is slightly higher than expected. To ensure that $V_{b 1}$ "tracks" the input CM level, we can generate $V_{b 1}$ as shown in Fig. 9.12(a). Here, a small current $I_{1}$ flows through the diode-connected device, $M_{b 1}$, producing $V_{b 1}=V_{P}+V_{G S, b 1}$. Since $V_{P}$ tracks the input CM level $\left(V_{P}=V_{i n, C M}-V_{G S 1,2}\right)$, we have

$$
\begin{equation*}
V_{b 1}=V_{i n, C M}-V_{G S 1,2}+V_{G S, b 1} \tag{9.15}
\end{equation*}
$$

which should be chosen equal to $V_{i n, C M}-V_{T H 1,2}+V_{G S 3,4}$ to allow $M_{1}$ and $M_{2}$ to operate in saturation. It follows that

$$
\begin{equation*}
V_{G S, b 1}=\left(V_{G S 1,2}-V_{T H 1,2}\right)+V_{G S 3,4} \tag{9.16}
\end{equation*}
$$

indicating that $M_{b 1}$ must be "weak" enough to sustain a $V_{G S}$ equal to one overdrive plus the gate-source voltage of $M_{3}$ and $M_{4}$. This is accomplished by choosing $M_{b 1}$ to be a narrrow, long device.
image_name:Figure 9.12
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: g1}
name: M2, type: NMOS, ports: {S: GND, D: P, G: g2}
name: M3, type: NMOS, ports: {S: d1s3, D: Vb1, G: d1s3}
name: M4, type: NMOS, ports: {S: d2s4, D: Vb1, G: d2s4}
name: Mb1, type: NMOS, ports: {S: P, D: Vb1, G: Vb1}
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: Vb1}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a cascode gate voltage generator with NMOS transistors M1, M2, M3, M4, and Mb1. It uses current sources I1 and Iss to establish biasing and operation conditions. It is designed to generate a stable gate voltage for cascode configurations.

Figure 9.12 Generation of cascode gate voltage.

### 9.2.4 Folded-Cascode Op Amps

In order to alleviate the drawbacks of telescopic cascode op amps, namely, limited output swings and difficulty in choosing equal input and output CM levels, a "folded-cascode" op amp can be used. As described in Chapter 3 and illustrated in Fig. 9.13, in an NMOS or PMOS cascode amplifier, the input device is replaced by the opposite type while still converting the input voltage to a current. In the four circuits shown in Fig. 9.13, the small-signal current generated by $M_{1}$ flows through $M_{2}$ and subsequently the load, producing an output voltage approximately equal to $g_{m 1} R_{o u t} V_{i n}$. The primary advantage of the folded structure lies in the choice of the voltage levels because it does not "stack" the cascode transistor on top of the input device. We will return to this point later.

The folding idea depicted in Fig. 9.13 can easily be applied to differential pairs, and hence to operational amplifiers as well. Shown in Fig. 9.14, the resulting circuit replaces the input NMOS pair with a PMOS counterpart. Note two important differences between the two circuits. (1) In Fig. 9.14(a), one bias current, $I_{S S}$, provides the drain current of both the input transistors and the cascode devices, whereas in Fig. 9.14(b), the input pair requires an additional bias current. In other words, $I_{S S 1}=I_{S S} / 2+I_{D 3}=I_{S S} / 2+I_{1}$. Thus, the folded-cascode configuration generally consumes more power. (2) In Fig. 9.14(a), the input CM level
image_name:Figure 9.14 (a)
description:
[
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: d1d2}
name: M1, type: NMOS, ports: {S: GND, D: d1d2, G: Vin}
name: M2, type: PMOS, ports: {S: VDD, D: d1d2, G: Vb}
]
extrainfo:The circuit is a telescopic op amp topology with a single bias current I1 providing the drain current for both the input transistors and the cascode devices. The input common-mode level cannot exceed Vb - Vgs3 + Vth1.
image_name:Figure 9.14 (b)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: dis2, G: Vin}
name: M2, type: NMOS, ports: {S: dis2, D: Vout, G: Vb}
name: I1, type: CurrentSource, value: I1, ports: {Np: Vout, Nn: GND}
name: I2, type: CurrentSource, value: I2, ports: {Np: VDD, Nn: dis2}
]
extrainfo:The circuit is a folded-cascode op amp topology. It uses NMOS transistors M1 and M2, with current sources I1 and I2 providing biasing. The input is at Vin and the output is at Vout. The node dis2 is a shared node for the drain of M1 and the source of M2.

Figure 9.13 Folded-cascode amplifiers.
image_name:Figure 9.14 (a)
description:
[
name: M1, type: NMOS, ports: {S: Vin, D: s1s2, G: Vip}
name: M2, type: NMOS, ports: {S: Vin, D: d2s3, G: Vin}
name: M3, type: NMOS, ports: {S: d1s3, D: VoutP, G: Vb1}
name: M4, type: NMOS, ports: {S: d2s4, D: VoutN, G: Vb1}
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: VoutP}
name: I2, type: CurrentSource, value: I2, ports: {Np: VDD, Nn: VoutN}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: Vin, Nn: GND}
]
extrainfo:The circuit is a telescopic op amp topology. It uses NMOS transistors M1 to M4, with current sources I1 and I2 providing biasing. The input is at Vip and Vin, and the output is at VoutP and VoutN.
image_name:Figure 9.14 (b)
description:
[
name: M1, type: NMOS, ports: {S: s1s2, D: d1s4, G: vip}
name: M2, type: NMOS, ports: {S: vin, D: d2s3, G: vin}
name: M3, type: NMOS, ports: {S: d1s4, D: voutp, G: vb1}
name: M4, type: NMOS, ports: {S: d2s3, D: voutn, G: vb1}
name: I1, type: CurrentSource, value: I1, ports: {Np: voutp, Nn: vdd}
name: I2, type: CurrentSource, value: I2, ports: {Np: vdd, Nn: voutn}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: s1s2, Nn: gnd}
name: Iss1, type: CurrentSource, value: Iss1, ports: {Np: d1s4, Nn: gnd}
name: Iss2, type: CurrentSource, value: Iss2, ports: {Np: d2s3, Nn: gnd}
]
extrainfo:The circuit is a folded-cascode op amp topology. It uses NMOS transistors M1 and M2, with current sources I1 and I2 providing biasing. The input is at Vin and the output is at Vout. The node dis2 is a shared node for the drain of M1 and the source of M2.

Figure 9.14 (a) Telescopic and (b) folded-cascode op amp topologies.
cannot exceed $V_{b 1}-V_{G S 3}+V_{T H 1}$, whereas in Fig. 9.14(b), it cannot be less than $V_{b 1}-V_{G S 3}-\left|V_{T H P}\right|$. It is therefore possible to design the latter to allow shorting its input and output terminals with negligible swing limitation. This is in contrast to the behavior depicted in Fig. 9.9. In Fig. 9.14(b), it is possible to tie the $n$-wells of $M_{1}$ and $M_{2}$ to their common source point. We return to this idea in Chapters 14 and 19 .

Let us now calculate the maximum output voltage swing of the folded-cascode op amp shown in Fig. 9.15, where $M_{5}-M_{10}$ replace the ideal current sources of Fig. 9.14(b). With proper choice of $V_{b 1}$ and $V_{b 2}$, the lower end of the swing is given by $V_{O D 3}+V_{O D 5}$ and the upper end by $V_{D D}-\left(\left|V_{O D 7}\right|+\left|V_{O D 9}\right|\right)$. Thus, the peak-to-peak swing on each side is equal to $V_{D D}-\left(V_{O D 3}+V_{O D 5}+\left|V_{O D 7}\right|+\left|V_{O D 9}\right|\right)$. In the telescopic cascode of Fig. 9.14(a), on the other hand, the swing is less by the overdrive of the tail current source. We should nonetheless note that, carrying a large current, $M_{5}$ and $M_{6}$ in Fig. 9.15 may require a high overdrive voltage if their capacitance contribution to nodes $X$ and $Y$ is to be minimized.

We now determine the small-signal voltage gain of the folded-cascode op amp of Fig. 9.15. Using the half circuit depicted in Fig. 9.16(a) and writing $\left|A_{v}\right|=G_{m} R_{\text {out }}$, we must calculate $G_{m}$ and $R_{\text {out }}$. As shown in Fig. 9.16(b), the output short-circuit current is approximately equal to the drain current of $M_{1}$ because the impedance seen looking into the source of $M_{3}$, that is, $\left(g_{m 3}+g_{m b 3}\right)^{-1} \| r_{O 3}$, is typically much lower than $r_{O 1} \| r_{O 5}$. Thus, $G_{m} \approx g_{m 1}$. To calculate $R_{\text {out }}$, we use Fig. 9.16(c), with $R_{O P} \approx\left(g_{m 7}+g_{m b 7}\right) r_{O 7} r_{O 9}$, to write $R_{\text {out }} \approx R_{O P} \|\left[\left(g_{m 3}+g_{m b 3}\right) r_{O 3}\left(r_{O 1} \| r_{O 5}\right)\right]$. It follows that

$$
\begin{equation*}
\left|A_{v}\right| \approx g_{m 1}\left\{\left[\left(g_{m 3}+g_{m b 3}\right) r_{O 3}\left(r_{O 1} \| r_{O 5}\right)\right] \|\left[\left(g_{m 7}+g_{m b 7}\right) r_{O 7} r_{O 9}\right]\right\} \tag{9.17}
\end{equation*}
$$

image_name:Figure 9.15
description:
[
name: M1, type: PMOS, ports: {S: S1Sr, D: X, G: Vip}
name: M2, type: PMOS, ports: {S: S1Sr, D: Y, G: Vin}
name: M3, type: NMOS, ports: {S: X, D: VoutP, G: Vb1}
name: M4, type: NMOS, ports: {S: Y, D: VoutN, G: Vb1}
name: M5, type: NMOS, ports: {S: GND, D: X, G: Vb4}
name: M6, type: NMOS, ports: {S: GND, D: Y, G: Vb4}
name: M7, type: PMOS, ports: {S: VDD, D: VoutP, G: Vb2}
name: M8, type: PMOS, ports: {S: VDD, D: VoutN, G: Vb2}
name: M9, type: PMOS, ports: {S: VDD, D: Sd9, G: Vb3}
name: M10, type: PMOS, ports: {S: VDD, D: Sd10, G: Vb3}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: S1Sr, Nn: GND}
]
extrainfo:The circuit is a folded-cascode operational amplifier with cascode PMOS loads. It includes differential pair inputs (M1, M2), current mirrors, and cascode configurations for enhanced gain and bandwidth.

Figure 9.15 Folded-cascode op amp with cascode PMOS loads.
image_name:(a)
description:
[
name: M1, type: PMOS, ports: {S: X, D: X, G: Vin}
name: M3, type: NMOS, ports: {S: GND, D: X, G: Vb1}
name: M7, type: NMOS, ports: {S: Sd9, D: Vout, G: Vb2}
name: M9, type: PMOS, ports: {S: VDD, D: Sd9, G: Vb3}
name: R_OP, type: Resistor, value: R_OP, ports: {N1: Vout, N2: Vout}
name: R_out, type: Resistor, value: R_out, ports: {N1: Vout, N2: Vout}
]
extrainfo:The circuit is a folded-cascode operational amplifier with cascode PMOS loads. It includes differential pair inputs (M1, M2), current mirrors, and cascode configurations for enhanced gain and bandwidth.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: X, D: X, G: Vin}
name: M3, type: PMOS, ports: {S: GND, D: X, G: Vb1}
name: r_05||r_01, type: Resistor, value: r_05||r_01, ports: {N1: X, N2: GND}
]
extrainfo:The circuit diagram (b) shows the half circuit of a folded cascode op amp. It includes an NMOS transistor M1 and a PMOS transistor M3 forming a cascode configuration. The resistor r_05||r_01 is used for output resistance calculation. The input is applied to M1, and the output is taken at the node marked X.
image_name:(c)
description:
[
name: M1, type: PMOS, ports: {S: X, D: X, G: Vin}
name: M3, type: NMOS, ports: {S: GND, D: X, G: Vb1}
name: ROP, type: Resistor, value: ROP, ports: {N1: Vout, N2: X}
name: r05||r01, type: Resistor, value: r05||r01, ports: {N1: X, N2: GND}
]
extrainfo:The circuit diagram (c) is part of a folded-cascode operational amplifier configuration. It includes a PMOS input differential pair and NMOS cascode for improved output resistance and gain. The resistor ROP is used for load, and the configuration is aimed at enhancing gain and bandwidth.

Figure 9.16 (a) Half circuit of folded cascode op amp, (b) equivalent circuit for $G_{m}$ calculation, and (c) equivalent circuit for $R_{\text {out }}$ calculation.

The reader is encouraged to repeat this calculation without neglecting the current drawn by $r_{O 5} \| r_{O 1}$ in Fig. 9.16(b).

How does this value compare with the gain of a telescopic op amp? For comparable device dimensions and bias currents, the PMOS input differential pair exhibits a lower transconductance than does an NMOS pair. Furthermore, $r_{O 1}$ and $r_{O 5}$ appear in parallel, reducing the output impedance, especially because $M_{5}$ carries the currents of both the input device and the cascode branch. As a consequence, the gain in (9.17) is usually two to three times lower than that of a comparable telescopic cascode.

It is also worth noting that the pole at the "folding point," i.e., the sources of $M_{3}$ and $M_{4}$, is quite closer to the origin than that associated with the source of cascode devices in a telescopic topology. In Fig. 9.17(a), $C_{t o t}$ arises from $C_{G S 3}, C_{S B 3}, C_{D B 1}$, and $C_{G D 1}$. By contrast, in Fig. 9.17(b), $C_{t o t}$ contains additional contributions due to $C_{G D 5}$ and $C_{D B 5}$, typically significant components because $M_{5}$ must be wide enough to carry a large current with a small overdrive.
image_name:(a)
description:
[
name: M3, type: NMOS, ports: {S: LOAD, D: d1s3, G: Vb}
name: M1, type: NMOS, ports: {S: p, D: d1s3, G: Vin}
name: Ctot, type: Capacitor, value: Ctot, ports: {Np: d1s3, Nn: GND}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: p, Nn: GND}
]
extrainfo:The circuit is a folded-cascode op amp configuration with NMOS input devices. It features a load connected to the source of M3 and a current source Iss connected to the source of M1.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: S1, D: X, G: Vin}
name: M3, type: NMOS, ports: {S: X, D: LOAD, G: Vb1}
name: M5, type: NMOS, ports: {S: GND, D: X, G: Vb4}
name: Ctot, type: Capacitor, value: Ctot, ports: {Np: X, Nn: GND}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: VDD, Nn: S1}
]
extrainfo:The circuit is a folded-cascode operational amplifier with NMOS input devices and PMOS cascode transistors. It is designed to provide higher gain due to the greater mobility of NMOS devices.

Figure 9.17 Effect of device capacitance on the nondominant pole in telescopic and folded-cascode op amps.

A folded-cascode op amp may incorporate NMOS input devices and PMOS cascode transistors. Illustrated in Fig. 9.18, such a circuit potentially provides a higher gain than the op amp of Fig. 9.15 because of the greater mobility of NMOS devices, but at the cost of lowering the pole at the folding points. To understand why, note that the pole at node $X$ is given by the product of $1 /\left(g_{m 3}+g_{m b 3}\right)$ and the total capacitance at this node (if the output pole is dominant). The magnitude of both of these components is relatively high: $M_{3}$ suffers from a low transconductance, and $M_{5}$ contributes substantial capacitance because it must be wide enough to carry the drain currents of both $M_{1}$ and $M_{3}$. In fact, for comparable bias currents, $M_{5}-M_{6}$ in Fig. 9.18 may be several times wider than $M_{5}-M_{6}$ in Fig. 9.15. For applications sensitive to flicker noise, the PMOS-input op amp is preferable (Sec. 9.12).
image_name:Figure 9.18 Realization of a folded-cascode op amp.
description:
[
name: M1, type: NMOS, ports: {S: X1, D: X, G: Vip}
name: M2, type: NMOS, ports: {S: X1, D: Y, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: Y, G: Vb2}
name: M4, type: PMOS, ports: {S: VDD, D: Voutp, G: Vb2}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: X3}
name: M6, type: PMOS, ports: {S: VDD, D: X3, G: X3}
name: M7, type: NMOS, ports: {S: S7d9, D: Voutp, G: Vb1}
name: M8, type: NMOS, ports: {S: S8d10, D: Voutn, G: Vb1}
name: M9, type: NMOS, ports: {S: X4, D: S7d9, G: X4}
name: M10, type: NMOS, ports: {S: X4, D: S8d10, G: X4}
name: M11, type: NMOS, ports: {S: X1, D: X1, G: X1}
name: Mb1, type: NMOS, ports: {S: GND, D: X1, G: X1}
name: Mb2, type: PMOS, ports: {S: VDD, D: X3, G: X3}
name: Mb3, type: NMOS, ports: {S: X4, D: X4, G: X4}
]
extrainfo:The circuit is a realization of a folded-cascode operational amplifier. It includes differential input pairs, current mirrors, and biasing transistors. The circuit is designed to provide high voltage swing and low power dissipation.

Figure 9.18 Realization of a folded-cascode op amp.

### 9.2.5 Folded-Cascode Properties

Our study thus far suggests that the overall voltage swing of a folded-cascode op amp is only slightly higher than that of a telescopic configuration. This advantage comes at the cost of higher power dissipation, lower voltage gain, lower pole frequencies, and, as explained in Sec. 9.12, higher noise. Nonetheless, folded-cascode op amps are used more widely for two reasons: (1) their input and output CM levels can be chosen equal without limiting the output swings, and (2) compared to telescopic cascodes, they can accommodate a wider input CM range. Let us elaborate on these properties.

Consider the closed-loop amplifier of Fig. 9.19(a), assuming a folded-cascode op amp. We can draw the circuit as shown in Fig. 9.19(b) or Fig. 9.19(c), noting that the input and output CM levels are equal. With a high open-loop gain, the gate voltages of $M_{1}$ and $M_{2}$ swing negligibly while $V_{X}$ and $V_{Y}$ can reach within two overdrives of ground or $V_{D D}$. This should be compared with the swings in Fig. 9.10.
image_name:(a)
description:
[
name: C1, type: Capacitor, value: C1, ports: {Np: Vip, Nn: X1}
name: R1, type: Resistor, value: R1, ports: {N1: X1, N2: InP(A1)}
name: C2, type: Capacitor, value: C2, ports: {Np: Vin, Nn: X2}
name: R2, type: Resistor, value: R2, ports: {N1: X2, N2: InN(A1)}
name: R3, type: Resistor, value: R3, ports: {N1: OutP(A1), N2: InP(A1)}
name: R4, type: Resistor, value: R4, ports: {N1: OutN(A1), N2: InN(A1)}
name: A1, type: OpAmp, value: A1, ports: {InP: InP(A1), InN: InN(A1), OutP: OutP(A1), OutN: OutN(A1)}
]
extrainfo:This circuit is a differential amplifier using a folded-cascode op-amp configuration. The capacitors C1 and C2 are used for AC coupling, allowing the DC bias to be set independently. Resistors R3 and R4 provide feedback to stabilize the amplifier and set the gain.

(a)
image_name:Figure 9.19 (b)
description:
[
name: M1, type: NMOS, ports: {S: p, D: d1s3, G: x1}
name: M2, type: NMOS, ports: {S: p, D: d2s4, G: x2}
name: M3, type: PMOS, ports: {S: VDD, D: x, G: Vb4}
name: M4, type: PMOS, ports: {S: VDD, D: y, G: Vb4}
name: M5, type: NMOS, ports: {S: s5d7, D: x1, G: Vb2}
name: M6, type: NMOS, ports: {S: s6d8, D: x2, G: Vb2}
name: M7, type: NMOS, ports: {S: GND, D: s5d7, G: Vb3}
name: M8, type: NMOS, ports: {S: GND, D: s6d8, G: Vb3}
name: M9, type: PMOS, ports: {S: VDD, D: x1, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: x2, G: Vb1}
name: R1, type: Resistor, value: R1, ports: {N1: g1, N2: GND}
name: R2, type: Resistor, value: R2, ports: {N1: g2, N2: GND}
name: R3, type: Resistor, value: R3, ports: {N1: x, N2: g1}
name: R4, type: Resistor, value: R4, ports: {N1: y, N2: g2}
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: p}
]
extrainfo:This circuit is a differential amplifier using a folded-cascode op-amp configuration. It features AC coupling capacitors for DC bias independence and feedback resistors for stability and gain setting.

(b)
(c)

Figure 9.19 (a) Feedback amplifier, (b) implementation using a folded-cascode op amp, and (c) alternative drawing to find allowable swings.

In feedback topologies where the input and output CM levels need not be equal, the folded cascode allows a wider input CM range than does the telescopic cascode. In Fig. 9.18, for example, $V_{i n, C M}$ must exceed $V_{G S 1,2}+\left(V_{G S 11}-V_{T H 11}\right)$, but it can be as high as $V_{b 2}+\left|V_{G S 3}\right|+V_{T H 1,2}$ before $M_{1}$ and $M_{2}$ enter the triode region. Note that this upper bound can be greater than $V_{D D}$ (why?). Similarly, a PMOS-input configuration can handle input CM levels as low as zero.

### 9.2.6 Design Procedure

We now deal with the design of folded-cascode op amps to reinforce the foregoing concepts.

#### Example 9.9

Design a folded-cascode op amp with an NMOS input pair (Fig. 9.18) to satisfy the following specifications: $V_{D D}=3 \mathrm{~V}$, differential output swing $=3 \mathrm{~V}$, power dissipation $=10 \mathrm{~mW}$, and voltage gain $=2000$. Use the same device parameters as in Example 9.5.

#### Solution

As with the telescopic cascode of the previous example, we begin with the power and swing specifications. Allocating 1.5 mA to the input pair, 1.5 mA to the two cascode branches, and the remaining $330 \mu \mathrm{~A}$ to the three current mirrors, we first consider the devices in each cascode branch. Since $M_{5}$ and $M_{6}$ must each carry 1.5 mA , we allow an overdrive of 500 mV for these transistors so as to keep their width to a reasonable value. To $M_{3}-M_{4}$, we allocate 400 mV and to $M_{7}-M_{10}, 300 \mathrm{mV}$. Thus, $(W / L)_{5,6}=400,(W / L)_{3,4}=313$, and $(W / L)_{7-10}=278$. Since the minimum and maximum output levels are equal to 0.6 V and 2.1 V , respectively, the optimum output common-mode level is 1.35 V .

The minimum dimensions of $M_{1}-M_{2}$ are dictated by the minimum input common-mode level, $V_{G S 1}+V_{O D 11}$. For example, if the input and the output CM levels are equal (Fig. 9.20), then $V_{G S 2}+V_{O D 11}=1.35 \mathrm{~V}$. With
image_name:Figure 9.20 Folded-cascode op amp with input and output shorted
description:
[
name: M1, type: NMOS, ports: {S: X1, D: d1, G: Vin}
name: M11, type: NMOS, ports: {S: GND, D: X1, G: g11}
name: M2, type: NMOS, ports: {S: X2, D: Y, G: X1}
name: M8, type: NMOS, ports: {S: s8d10, D: X2, G: g8}
name: M10, type: NMOS, ports: {S: GND, D: s8d10, G: g10}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: g4}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: g6}
]
extrainfo:The circuit is a folded-cascode operational amplifier with input and output shorted. It uses NMOS and PMOS transistors to achieve the desired operation. The key nodes are Vin, X1, X2, Y, and VDD. The circuit is designed to optimize the output common-mode level to 1.35 V, with a minimum and maximum output level of 0.6 V and 2.1 V, respectively.

Figure 9.20 Folded-cascode op amp with input and output shorted.
$V_{O D 11}=0.4 \mathrm{~V}$ as an initial guess, we have $V_{G S 1}=0.95 \mathrm{~V}$, obtaining $V_{O D 1,2}=0.95-0.7=0.25 \mathrm{~V}$, and hence $(W / L)_{1,2}=400$. The maximum dimensions of $M_{1}$ and $M_{2}$ are determined by the tolerable input capacitance and the capacitance at nodes $X$ and $Y$ in Fig. 9.18.

We now calculate the small-signal gain. Using $g_{m}=2 I_{D} /\left(V_{G S}-V_{T H}\right)$, we have $g_{m 1,2}=0.006 \mathrm{~A} / \mathrm{V}, g_{m 3,4}=$ $0.0038 \mathrm{~A} / \mathrm{V}$, and $g_{m 7,8}=0.05 \mathrm{~A} / \mathrm{V}$. For $L=0.5 \mu \mathrm{~m}, r_{O 1,2}=r_{O 7-10}=13.3 \mathrm{k} \Omega$, and $r_{O 3,4}=2 r_{O 5,6}=6.67 \mathrm{k} \Omega$. It follows that the impedance seen looking into the drain of $M_{7}$ (or $M_{8}$ ) is equal to $8.8 \mathrm{M} \Omega$ whereas, owing to the limited intrinsic gain of $M_{3}$ (or $M_{4}$ ), that seen looking into the drain of $M_{3}$ is equal to $66.5 \mathrm{k} \Omega$. The overall gain is therefore limited to about 400 .

In order to increase the gain, we first observe that $r_{O 5,6}$ is quite lower than $r_{O 1,2}$. Thus, the length of $M_{5}-$ $M_{6}$ must be increased. Also, the transconductance of $M_{1}-M_{2}$ is relatively low and can be increased by widening these transistors. Finally, we may decide to double the intrinsic gain of $M_{3}$ and $M_{4}$ by doubling both their length and their width, but at the cost of increasing the capacitance at nodes $X$ and $Y$. We leave the exact choice of the device dimensions as an exercise for the reader. Note that the op amp must incorporate common-mode feedback (Sec. 9.7).

Telescopic and folded-cascode op amps can also be designed to provide a single-ended output. Shown in Fig. 9.21(a) is an example, where a PMOS cascode current mirror converts the differential currents of $M_{3}$
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: p, D: d1s3, G: Vip}
name: M2, type: NMOS, ports: {S: p, D: d2s4, G: Vin}
name: M3, type: NMOS, ports: {S: d1s3, D: X, G: Vb}
name: M4, type: NMOS, ports: {S: d2s4, D: Vout, G: Vb}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M6, type: PMOS, ports: {S: VDD, D: Vout, G: X}
name: M7, type: PMOS, ports: {S: VDD, D: Y, G: Y}
name: M8, type: PMOS, ports: {S: VDD, D: s5d8, G: Y}
name: Iss, type: CurrentSource, ports: {Np: VDD, Nn: p}
]
extrainfo:The circuit is a cascode op amp with a single-ended output. It uses a PMOS cascode current mirror to convert differential currents to a single-ended output voltage. The op amp incorporates common-mode feedback and is designed to limit the maximum output voltage swing.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: p, D: d1s3, G: Vip}
name: M2, type: NMOS, ports: {S: p, D: d2s4, G: Vin}
name: M3, type: NMOS, ports: {S: d1s3, D: X, G: Vb1}
name: M4, type: NMOS, ports: {S: d2s4, D: Vout, G: Vb1}
name: M5, type: PMOS, ports: {S: X, D: Ssd7, G: Vb2}
name: M6, type: PMOS, ports: {S: Vout, D: Ssd8, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: Ssd7, G: Y}
name: M8, type: PMOS, ports: {S: VDD, D: Ssd8, G: Y}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: p, Nn: GND}
]
extrainfo:This is a folded-cascode operational amplifier with a single-ended output. The design uses a PMOS cascode current mirror to convert differential currents to a single-ended output voltage. Common-mode feedback is likely employed to stabilize the output.

Figure 9.21 Cascode op amps with single-ended output.
and $M_{4}$ to a single-ended output voltage. In this implementation, however, $V_{X}=V_{D D}-\left|V_{G S 5}\right|-\left|V_{G S 7}\right|$, limiting the maximum value of $V_{\text {out }}$ to $V_{D D}-\left|V_{G S 5}\right|-\left|V_{G S 7}\right|+\left|V_{T H 6}\right|$ and "wasting" one PMOS threshold voltage in the swing (Chapter 5). To resolve this issue, the PMOS load can be modified to a low-voltage cascode (Chapter 5), as shown in Fig. 9.21(b), so that $M_{7}$ and $M_{8}$ are biased at the edge of the triode region. Similar ideas apply to folded-cascode op amps as well.

The circuit of Fig. 9.21(a) suffers from two disadvantages with respect to its differential counterpart in Fig. 9.8(b). First, it provides only half the output voltage swing. Second, it contains a mirror pole at node $X$ (Chapter 5), thus limiting the speed of feedback systems employing such an amplifier. It is therefore preferable to use the differential topology, although it requires a feedback loop to define the output common-mode level (Sec. 9.7).

### 9.3 Two-Stage Op Amps

The op amps studied thus far exhibit a "one-stage" nature in that they allow the small-signal current produced by the input pair to flow directly through the output impedance, i.e., they perform voltage-tocurrent conversion only once. The gain of these topologies is therefore limited to the product of the input pair transconductance and the output impedance. We have also observed that cascoding in such circuits increases the gain while limiting the output swings.

In some applications, the gain and/or the output swings provided by cascode op amps are not adequate. For example, a modern op amp must operate with supply voltages as low as 0.9 V while delivering singleended output swings as large as 0.8 V . In such cases, we resort to "two-stage" op amps, with the first stage providing a high gain and the second, large swings (Fig. 9.22). In contrast to cascode op amps, a two-stage configuration isolates the gain and swing requirements.
image_name:Figure 9.22 Two-stage op amp
description:The diagram labeled "Figure 9.22 Two-stage op amp" illustrates a two-stage operational amplifier (op amp) configuration. This system comprises two main stages: Stage 1 and Stage 2, each serving distinct functions to achieve high gain and large output swings, respectively.

1. **Main Components:**
- **Stage 1 (High Gain):** This block is responsible for providing a high gain to the input signal. It is the first stage in the op amp configuration and processes the input voltage, denoted as \( V_{in} \).
- **Stage 2 (High Swing):** This block follows Stage 1 and is designed to allow large output voltage swings. It processes the amplified signal from Stage 1 and outputs it as \( V_{out} \).

2. **Flow of Information or Control:**
- The input signal \( V_{in} \) is fed into Stage 1, where it undergoes amplification.
- The amplified signal from Stage 1 is then directed to Stage 2, which is optimized for high output swings.
- The final output, \( V_{out} \), is taken from Stage 2.

3. **Labels, Annotations, and Key Indicators:**
- The diagram clearly labels the input and output ports as \( V_{in} \) and \( V_{out} \), respectively.
- The stages are marked with their primary functions: "High Gain" for Stage 1 and "High Swing" for Stage 2.

4. **Overall System Function:**
- The primary function of this two-stage op amp system is to separately handle high gain and large output swings. Stage 1 ensures that the input signal is sufficiently amplified, while Stage 2 ensures that the amplified signal can swing to large output levels. This separation of tasks allows the op amp to operate effectively even with low supply voltages, making it suitable for modern applications requiring both high gain and large output swings.

Figure 9.22 Two-stage op amp.
Each stage in Fig. 9.22 can incorporate various amplifier topologies studied in previous sections, but the second stage is typically configured as a simple common-source stage so as to allow maximum output swings. Figure 9.23 shows an example, where the first and second stages exhibit gains equal to $g_{m 1,2}\left(r_{O 1,2} \| r_{O 3,4}\right)$ and $g_{m 5,6}\left(r_{O 5,6} \| r_{O 7,8}\right)$, respectively. The overall gain is therefore comparable to that
image_name:Figure 9.23
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: db, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: Vout1}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: db}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vb2}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vb2}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
]
extrainfo:This is a two-stage operational amplifier. The first stage consists of a differential pair (M1 and M2) with a current source (Iss) for biasing. The second stage is a common-source amplifier with M6 and M8 providing the gain. PMOS transistors M3, M4, M5, and M6 are used for active loads and biasing.

Figure 9.23 Simple implementation of a two-stage op amp.
of a cascode op amp, but the swing at $V_{\text {out } 1}$ and $V_{\text {out } 2}$ is equal to $V_{D D}-\left|V_{O D 5,6}\right|-V_{O D 7,8}$, the highest possible value. ${ }^{4}$

To obtain a higher gain, the first stage can incorporate cascode devices, as depicted in Fig. 9.24. With a gain of, say, 10 in the output stage, the voltage swings at $X$ and $Y$ are quite small, allowing optimization of $M_{1}-M_{8}$ for higher gain. The overall voltage gain can be expressed as

$$
\begin{align*}
A_{v} \approx & \left\{g_{m 1,2}\left[\left(g_{m 3,4}+g_{m b 3,4}\right) r_{O 3,4} r_{O 1,2}\right] \|\left[\left(g_{m 5,6}+g_{m b 5,6}\right) r_{O 5,6} r_{O 7,8}\right]\right\} \\
& \times\left[g_{m 9,10}\left(r_{O 9,10} \| r_{O 11,12}\right)\right] \tag{9.18}
\end{align*}
$$

image_name:Figure 9.24 Two-stage op amp employing cascoding
description:
[
name: M1, type: NMOS, ports: {S: Vin, D: Vip, G: Vb1}
name: M2, type: NMOS, ports: {S: Vin, D: Vin, G: Vb1}
name: M3, type: NMOS, ports: {S: Vip, D: X, G: Vb1}
name: M4, type: NMOS, ports: {S: Vin, D: Y, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: ssd7, G: Vb3}
name: M8, type: PMOS, ports: {S: VDD, D: sbd8, G: Vb3}
name: M9, type: PMOS, ports: {S: VDD, D: X, G: Vout1}
name: M10, type: PMOS, ports: {S: VDD, D: Y, G: Vout2}
name: M11, type: NMOS, ports: {S: GND, D: Vout1, G: Vb4}
name: M12, type: NMOS, ports: {S: GND, D: Vout2, G: Vb4}
name: ISS, type: CurrentSource, ports: {Np: Vin, Nn: GND}
]
extrainfo:The circuit is a two-stage operational amplifier employing cascoding. It utilizes differential inputs and provides a single-ended output. The current mirror formed by M7 and M8 is used for converting differential currents to a single-ended output. The amplifier is optimized for high gain with small voltage swings at nodes X and Y.

Figure 9.24 Two-stage op amp employing cascoding.

A two-stage op amp can provide a single-ended output. One method is to convert the differential currents of the two output stages to a single-ended voltage. Illustrated in Fig. 9.25, this approach maintains the differential nature of the first stage, using only the current mirror $M_{7}-M_{8}$ to generate a single-ended output.
image_name:Figure 9.25 Two-stage op amp with single-ended output
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X1, G: Vb}
name: M4, type: PMOS, ports: {S: VDD, D: X2, G: Vb}
name: M5, type: PMOS, ports: {S: VDD, D: X3, G: X1}
name: M6, type: PMOS, ports: {S: VDD, D: Vout, G: X2}
name: M7, type: NMOS, ports: {S: GND, D: X3, G: X3}
name: M8, type: NMOS, ports: {S: GND, D: Vout, G: X3}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
]
extrainfo:This is a two-stage operational amplifier with a single-ended output. The first stage is differential with NMOS transistors M1 and M2, and the second stage utilizes a current mirror formed by M7 and M8 to generate a single-ended output. PMOS transistors M3 to M6 are used for active loading and biasing, with M3 and M4 providing a cascode configuration. The circuit is optimized for high gain with small voltage swings at nodes X1 and X2.

Figure 9.25 Two-stage op amp with single-ended output.

[^63]Can we cascade more than two stages to achieve a higher gain? As explained in Chapter 10, each gain stage introduces at least one pole in the open-loop transfer function, making it difficult to guarantee stability in a feedback system using such an op amp. For this reason, op amps having more than two stages are rarely used. Exceptions are described in [1, 2, 3].

### 9.3.1 Design Procedure

The design of two-stage op amps is somewhat more complex. We present a simple example here and more detailed designs in Chapter 11.

#### Example 9.10

Design the two-stage op amp of Fig. 9.23 for $V_{D D}=1 \mathrm{~V}, P=1 \mathrm{~mW}$, a differential output swing of $1 \mathrm{~V}_{p p}$, and a gain of 100 . Use the same device parameters as in Example 9.7, but assume that $V_{T H N}=0.3 \mathrm{~V}$ and $V_{T H P}=-0.35 \mathrm{~V}$.

#### Solution

We allocate a bias current of $960 \mu \mathrm{~A}$ to $M_{1}-M_{8}$, leaving $40 \mu \mathrm{~A}$ for the bias branches that generate $V_{b 1}$ and $V_{b 2}$. Let us split the current budget equally between the first and second stages, i.e., assume that $I_{D 1}=\cdots=I_{8}=120 \mu \mathrm{~A}$.

Since the second stage is likely to provide a voltage gain of 5 to 10 , the output swing of the first stage need not be large. Specifically, if the second stage is designed for a gain of 5 and a single-ended output swing of $0.5 \mathrm{~V}_{p p}$, the first stage need only sustain $0.1 \mathrm{~V}_{p p}$ at $X$ (or $Y$ ). The choice of overdrive voltages for $M_{1}-M_{4}$ and $I_{S S}$ is therefore quite relaxed, i.e., $\left|V_{O D 3}\right|+\left|V_{O D 1}\right|+V_{I S S}=1 \mathrm{~V}-0.1 \mathrm{~V}=0.9 \mathrm{~V}$. But we must consider two points: (1) recall from Chapter 7 that the noise contributed by current sources $M_{3}$ and $M_{4}$ is minimized by maximizing their overdrive voltage, and (2) the gain (and noise) requirements dictate a high $g_{m}$ for $M_{1}$ and $M_{2}$ and, inevitably, a low overdrive voltage. In fact, the latter point typically translates to subthreshold operation for the input devices, yielding a maximum $g_{m}$ of $I_{D} /\left(\xi V_{T}\right) \approx(325 \Omega)^{-1}$ with $\xi=1.5$. But, we ignore subthreshold operation in this example.

How large can the overdrive of $M_{3}$ and $M_{4}$ be? Since $V_{D S 3,4}=V_{G S 5,6}$ in this case, the upper bound may be imposed by $M_{5}$ and $M_{6}$ rather than by the first stage. For example, if the design of the second stage eventually yields $\left|V_{G S 5,6}\right|=400 \mathrm{mV}$, and if $V_{X}$ (or $V_{Y}$ ) can rise by 50 mV (for a $100-\mathrm{mV}_{p p}$ swing), then $M_{3}$ and $M_{4}$ experience a minimum $\left|V_{D S}\right|$ of 350 mV . We must therefore revisit this allocation after the second stage is designed.

For a single-ended output swing of $0.5 \mathrm{~V}_{p p}$, we can choose 200 mV and 300 mV for the overdrives of the output NMOS and PMOS devices, respectively. With $I_{D}=120 \mu \mathrm{~A}$, we then compute the $W / L$ values of these transistors. However, this allocation faces two issues: (1) the large overdrive of $M_{5}$ and $M_{6}$ may translate to an inadequately low $g_{m}=2 I_{D} /\left(V_{G S}-V_{T H}\right)$, and (2) the small overdrive of $M_{7}$ and $M_{8}$ gives them a high noise current. For these reasons, we swap the overdrive allocation, giving 300 mV to $M_{7}$ and $M_{8}$ and 200 mV to $M_{5}$ and $M_{6}$. The penalty is the larger $W / L$ of the latter pair and hence a greater capacitance at $X$ and $Y$.

We begin the calculations from the output stage. With $\left|I_{D}\right|=120 \mu \mathrm{~A}$ and the above overdrives, we have $g_{m 5,6}=2\left|I_{D} /\left(V_{G S}-V_{T H}\right)\right|=(833 \Omega)^{-1}, r_{O 5,6}=1 /\left(\lambda\left|I_{D}\right|\right)=42 \mathrm{k} \Omega$, and $r_{O 7,8}=83 \mathrm{k} \Omega$ (for the minimum channel length of $0.5 \mu \mathrm{~m}$ ). The second stage thus provides a gain of about 33 , allowing even smaller voltage swings for the first stage. The corresponding device dimensions are $(W / L)_{5,6}=200$ and $(W / L)_{7,8}=44$.

Returning to the first stage in Fig. 9.23, we note that $V_{D S 3,4}=\left|V_{G S 5,6}\right|=550 \mathrm{mV}$. Transistors $M_{3}$ and $M_{4}$ can therefore operate with an overdrive as high as 500 mV (if we still assume $V_{X}$ or $V_{Y}$ can rise by 50 mV from the bias value) but require a $\left|V_{G S}\right|$ of $500 \mathrm{mV}+\left|V_{T H P}\right|=850 \mathrm{mV}$, and hence $V_{b 1}=150 \mathrm{mV}$. Such a low $V_{b 1}$ may cause difficulty in the design of the current mirror driving $M_{3}$ and $M_{4}$. Instead, we choose $\left|V_{G S 3,4}-V_{T H P}\right|=400 \mathrm{mV}$, obtaining $(W / L)_{3,4}=50, g_{m 3,4}=1 /(1.7 \mathrm{k} \Omega)$, and $r_{O 3,4}=83 \mathrm{k} \Omega$ (for $L=0.5 \mu \mathrm{~m}$ ).

The input transistors, $M_{1}$ and $M_{2}$, exhibit an output resistance of $83 \mathrm{k} \Omega$ (with $L=0.5 \mu \mathrm{~m}$ ) and can have an overdrive as large as 0.5 V . However, with such an overdrive, $g_{m 1,2} / g_{m 3,4}=\left|V_{G S 3,4}-V_{T H P}\right| /\left(V_{G S 1,2}-V_{T H N}\right)=$ $4 / 5$, implying that the PMOS devices contribute substantial noise. For this reason, we choose an overdrive of 100 mV for $M_{1}$ and $M_{2}$, arriving at $g_{m 1,2}=1 /(420 \Omega),(W / L)_{1,2}=400$, and a voltage gain of $g_{m 1,2}\left(r_{O 1} \| r_{O 3}\right)=66$ for the first stage.

This design provides an overall gain of more than 2,000, primarily because of the low bias current and the use of an older technology. As explained in Chapter 11, nanometer two-stage op amps suffer from much lower gains.

## 9.4 ■ Gain Boosting

### 9.4.1 Basic Idea

The limited gain of the one-stage op amps studied in Sec. 9.2 and the difficulties in using two-stage op amps at high speeds have motivated extensive work on new topologies. Recall that in one-stage op amps, such as telescopic and folded-cascode topologies, the objective is to maximize the output impedance so as to attain a high voltage gain. The idea behind gain boosting is to further increase the output impedance without adding more cascode devices [4, 5]. We neglect body effect for simplicity, but it can be readily included at the end.

First Perspective Suppose a transistor is preceded by an ideal voltage amplifier as shown in Fig. 9.26(a).
image_name:(a)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vin, InN: GND, OutP: g2, OutN: '}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: g2}
name: rO, type: Resistor, value: rO, ports: {N1: X1, N2: X2'}
]
extrainfo:The circuit in (a) shows a voltage amplifier A1 driving an NMOS transistor M2. The output current Iout flows through the load connected to the drain of M2. The equivalent circuit in (b) represents the combination of A1 and M2 as a single device with transconductance A1*gm and output resistance rO.
image_name:(b)
description:
[
name: A1, type: OpAmp, ports: {InP: s2, InN: GND, OutP: d2, OutN: s2}
name: M2, type: NMOS, ports: {S: s2, D: d2, G: d2}
name: rO, type: Resistor, value: rO, ports: {N1: x1, N2: x2}
]
extrainfo:The circuit represents a voltage amplifier followed by an NMOS transistor, modeled as a supertransistor with transconductance A1gm and output resistance rO.

Figure 9.26 (a) Transistor preceded by a voltage amplifier, and (b) equivalent circuit.

We note that the overall circuit exhibits a transconductance of $A_{1} g_{m}$ and a voltage gain of $-A_{1} g_{m} r_{O}$ (why?). We thus surmise that this arrangement can be viewed as a three-terminal device (a "supertransistor") having a transconductance of $A_{1} g_{m}$ and an output resistance of $r_{O}$ [Fig. 9.26(b)]. We neglect body effect in this section.

Let us now incorporate this new device in a familiar topology and examine the circuit's behavior. We begin with the degenerated stage depicted in Fig. 9.27(a) and wish to compute its transconductance (with the output shorted to ac ground). Since $R_{S}$ carries $I_{\text {out }}$, the small-signal gate voltage is given by $\left(V_{\text {in }}-R_{S} I_{\text {out }}\right) A_{1}$, yielding a gate-source voltage of $\left(V_{\text {in }}-R_{S} I_{\text {out }}\right) A_{1}-R_{S} I_{\text {out }}$ and hence $I_{\text {out }}=$ $g_{m}\left[\left(V_{\text {in }}-R_{S} I_{\text {out }}\right) A_{1}-R_{S} I_{\text {out }}\right]$. It follows that

$$
\begin{equation*}
\frac{I_{\text {out }}}{V_{\text {in }}}=\frac{A_{1} g_{m}}{1+\left(A_{1}+1\right) g_{m} R_{S}} \tag{9.19}
\end{equation*}
$$

image_name:(a)
description:
[
name: Vin, type: VoltageSource, ports: {Np: Vin, Nn: GND}
name: RS, type: Resistor, value: RS, ports: {N1: S2, N2: GND}
name: M2, type: NMOS, ports: {S: S2, D: GND, G: OutP}
name: A1, type: OpAmp, value: A1, ports: {InP: Vin, InN: S2, OutP: OutP}
]
extrainfo:The circuit is designed to calculate transconductance. The input voltage Vin is amplified by the op-amp A1 and used to control the NMOS M2. The resistor RS is connected to the source of M2, and the output current Iout is measured.
image_name:(b)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vin, InN: S2, OutP: GND, OutN: '}
name: M2, type: NMOS, ports: {S: S2, D: Vx, G: GND}
name: RS, type: Resistor, value: RS, ports: {N1: S2, N2: GND'}
]
extrainfo:The circuit diagram represents a transconductance amplifier configuration. The OpAmp A1 is used to amplify the input voltage Vin. The NMOS transistor M2 is configured to control the current flow based on the amplified voltage. The resistor RS is connected to the source of M2, providing feedback.

Figure 9.27 Arrangements for calculation of (a) transconductance, and (b) output resistance.

Without $A_{1}$, the transconductance would be equal to $g_{m} /\left(1+g_{m} R_{S}\right)$. Interestingly, the equivalent transconductance has risen by a factor of $A_{1}$ in the numerator and $A_{1}+1$ in the denominator, revealing that the model shown in Fig. 9.26(b) is not quite correct. However, since in practice $A_{1} \gg 1$, the error introduced by this model is acceptably low.

How about the output resistance of the degenerated stage? From the setup in Fig. 9.27(b), we can express the voltage drop across $R_{S}$ as $I_{X} R_{S}$ and the gate voltage of $M_{2}$ as $-A_{1} I_{X} R_{S}$. That is, $I_{0}=$ $\left(-A_{1} R_{S} I_{X}-R_{S} I_{X}\right) g_{m}$. Also, $r_{O}$ carries a current equal to $\left(V_{X}-R_{S} I_{X}\right) / r_{O}$. We now have

$$
\begin{equation*}
I_{X}=\left(-A_{1} R_{S}-R_{S}\right) g_{m} I_{X}+\frac{V_{X}-R_{S} I_{X}}{r_{O}} \tag{9.20}
\end{equation*}
$$

and

$$
\begin{equation*}
R_{\text {out }}=r_{O}+\left(A_{1}+1\right) g_{m} r_{O} R_{S}+R_{S} \tag{9.21}
\end{equation*}
$$

Without $A_{1}$, the output resistance would be equal to $r_{O}+g_{m} r_{O} R_{S}+R_{S}$.
Equation (9.21) is a remarkable result, suggesting that the output resistance of the circuit is "boosted," as if the transconductance of $M_{2}$ were raised by a factor of $A_{1}+1$. This increase in $R_{\text {out }}$ is afforded while the degenerated stage retains its voltage headroom. We can see that the allowable voltage swing at the drain of $M_{2}$ is approximately the same for this structure and a simple degenerated transistor.

#### Example 9.11

Determine the resistance seen at the source of $M_{2}$ in Fig. 9.28(a) if $\gamma=0$.
image_name:(a)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vin, InN: s1, OutP: g2, OutN: '}
name: M2, type: NMOS, ports: {S: s2, D: d2, G: g2}
name: RD, type: Resistor, value: RD, ports: {N1: VDD, N2: d2}
name: RX, type: Resistor, value: RX, ports: {N1: s2, N2: GND'}
]
extrainfo:The circuit is a feedback amplifier with an NMOS transistor M2 and an op-amp A1. The op-amp provides feedback to control the gate of M2, and the circuit includes resistors RD and RX. The output is taken at the source of M2, connected to RX.
image_name:(b)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vx, InN: GND, OutP: d2, OutN: GND}
name: M2, type: NMOS, ports: {S: Vx, D: d2, G: d2}
name: RD, type: Resistor, value: RD, ports: {N1: VDD, N2: d2}
name: RX, type: Resistor, value: RX, ports: {N1: Vx, N2: GND}
]
extrainfo:The circuit diagram shows a configuration with an NMOS transistor M2 and an operational amplifier A1. The resistor RD is connected between VDD and the drain of M2. The input voltage Vx is fed to the positive terminal of the op-amp and the source of M2. The circuit is designed to boost the output resistance by utilizing the transconductance of M2.

Figure 9.28

#### Solution

In the setup shown in Fig. 9.28(b), the small-signal gate voltage is equal to $-A_{1} V_{X}$, and hence $I_{0}=\left(-A_{1} V_{X}-V_{X}\right) g_{m}$. Also, $R_{D}$ carries a current of $I_{X}$, generating a voltage equal to $I_{X} R_{D}$ at the drain with respect to ground. Since the current flowing downward through $r_{O}$ is given by $\left(I_{X} R_{D}-V_{X}\right) / r_{O}$, we have at the source node

$$
\begin{equation*}
\frac{I_{X} R_{D}-V_{X}}{r_{O}}+\left(-A_{1} V_{X}-V_{X}\right) g_{m}+I_{X}=0 \tag{9.22}
\end{equation*}
$$

and

$$
\begin{equation*}
R_{X}=\frac{R_{D}+r_{O}}{1+\left(A_{1}+1\right) g_{m} r_{O}} \tag{9.23}
\end{equation*}
$$

Without $A_{1}$, this resistance would be equal to $\left(R_{D}+r_{O}\right) /\left(1+g_{m} r_{O}\right)$. This example too suggests that the transconductance of $M_{2}$ is raised by a factor of $A_{1}+1$.

In summary, the addition of the auxiliary amplifier in Fig. 9.26(b) raises the equivalent $g_{m}$ of $M_{2}$ by a factor of $A_{1}+1$, thereby boosting the output impedance of the stage. We surmise from $A_{v}=-G_{m} R_{\text {out }}$ that the voltage gain can also be boosted, but where should the input be applied? As in a simple cascode stage, let us replace the degeneration resistor with a voltage-to-current converter (Fig. 9.29), obtaining an output impedance equal to $r_{O 2}+\left(A_{1}+1\right) g_{m 2} r_{O 2} r_{O 1}+r_{O 1}$. The short-circuit transconductance is nearly equal to $g_{m 1}$ because the resistance seen looking into the source of $M_{2}$ is obtained from (9.23) with $R_{D}=0$ and is given by $r_{O 2} /\left[1+\left(A_{1}+1\right) g_{m 2} r_{O 2}\right] \approx\left[\left(A_{1}+1\right) g_{m 2}\right]^{-1}$, a value much less than $r_{O 1}$. It follows that

$$
\begin{align*}
\left|A_{v}\right| & \approx g_{m 1}\left[r_{O 2}+\left(A_{1}+1\right) g_{m 2} r_{O 2} r_{O 1}+r_{O 1}\right]  \tag{9.24}\\
& \approx g_{m 1} g_{m 2} r_{O 1} r_{O 2}\left(A_{1}+1\right) \tag{9.25}
\end{align*}
$$

As explained later in this section, this "gain-boosting" technique can be applied to cascode differential pairs and op amps as well.
image_name:Figure 9.29 Basic gain-boosted stage
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vb, InN: P, OutP: P, OutN: ', Vdd: , -Vdd:}
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: P}
name: J1, type: CurrentSource, value: J1, ports: {Np: VDD, Nn: Vout'}
]
extrainfo:The circuit is a gain-boosted stage using a super transistor configuration. The op-amp A1 is used to increase the output resistance by controlling the gate voltage of M2. The current source J1 provides a constant current from VDD to Vout.

Figure 9.29 Basic gain-boosted stage.
Second Perspective Consider the degenerated stage shown in Fig. 9.30(a). We wish to increase the output resistance without stacking more cascode devices. Recall from Chapter 3 that if the drain voltage changes by $\Delta V$, then the source voltage changes by $\Delta V_{S}=R_{S} /\left[r_{O}+\left(1+g_{m} r_{O}\right) R_{S}\right]$ (with $\gamma=0$ ), producing a change in the voltage across $R_{S}$ and hence in the drain current. We can loosely view the effect as voltage division between $R_{S}$ and $g_{m} r_{O} R_{S}$.
image_name:(a)
description:
[
name: M2, type: NMOS, ports: {S: P, D: Vx, G: Vb}
name: Rs, type: Resistor, value: Rs, ports: {N1: P, N2: GND}
name: ro, type: Resistor, value: ro, ports: {N1: Vx, N2: Io}
name: A1, type: OpAmp, value: A1, ports: {InP: Vb, InN: P, OutP: Vx, OutN: Io}
]
extrainfo:The circuit is a degenerated common-source stage with an NMOS transistor M2 and a resistor Rs. An op-amp A1 is used for gain boosting by comparing the voltage Vb to a reference. The output resistance is increased without stacking more cascode devices.
image_name:(b)
description:
[
name: M2, type: NMOS, ports: {S: P, D: Vx, G: Vb}
name: ro, type: Resistor, value: ro, ports: {N1: Vx, N2: Vx}
name: RS, type: Resistor, value: RS, ports: {N1: P, N2: GND}
name: A1, type: OpAmp, value: A1, ports: {InP: P, InN: Vb, OutP: Vx, OutN: GND}
name: Vx, type: VoltageSource, value: Vx, ports: {Np: Vx, Nn: GND}
]
extrainfo:The circuit diagram (b) is a gain-boosted stage that uses an op-amp to stabilize the voltage across Rs and maintain the current flowing through Rs equal to the drain current of M2. This configuration increases the output resistance without stacking more cascode devices.

Figure 9.30 Response of (a) degenerated CS stage and (b) gain-boosted stage to a change in output voltage.
We now make an important observation. The change in the drain current in response to $\Delta V$ can be suppressed if two conditions hold: (a) the voltage across $R_{S}$ remains constant, and (b) the current flowing through $R_{S}$ remains equal to the drain current. ${ }^{5}$ How should we keep $V_{P}$ constant? We can compare $V_{P}$ to

[^64]a "reference" voltage by means of an op amp and return the resulting error to a point in the circuit so as to ensure that $V_{P}$ "tracks" the reference. Illustrated in Fig. 9.30(b), the idea is to apply the error, $A_{1}\left(V_{b}-V_{P}\right)$, to the gate of $M_{2}$, forcing $V_{P}$ to be equal to $V_{b}$ if the loop gain is large. The above two conditions are thus satisfied. For example, if the drain voltage rises, $V_{P}$ also tends to rise, but, as a result, the gate voltage falls, reducing the current drawn by $M_{2}$. As derived below, this effect can be approximately viewed as voltage division between $R_{S}$ and $A_{1} g_{m} r_{O} R_{S}$. For $A_{1} \rightarrow \infty, V_{P}$ is "pinned" to $V_{b}$ and the drain current is exactly equal to $V_{b} / R_{S}$ regardless of the drain voltage. This topology is also called a "regulated cascode" as amplifier $A_{1}$ monitors and regulates the output current.

#### Example 9.12

Figure 9.31 shows the regulated cascode subjected to an output impedance test. Determine the small-signal values of $V_{P}, V_{G}, I_{0}$, and $I_{r o}$. Assume that $\left(A_{1}+1\right) g_{m} r_{O} R_{S}$ is large.
image_name:Figure 9.31
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vx, InN: P, OutP: VG, OutN: '}
name: M2, type: NMOS, ports: {S: P, D: Vx, G: VG}
name: Ro, type: Resistor, value: Ro, ports: {N1: Vx, N2: Ix}
name: Rs, type: Resistor, value: Rs, ports: {N1: P, N2: GND}
name: Vx, type: VoltageSource, value: Vx, ports: {Np: Ix, Nn: GND'}
]
extrainfo:The circuit is a regulated cascode topology with an operational amplifier A1 regulating the output current through NMOS M2. The output impedance is tested by measuring small-signal values at nodes Vp, Vg, Io, and Iro.

Figure 9.31

#### Solution

We know from our analysis of Fig. 9.27(b) that

$$
\begin{equation*}
V_{X}=\left[r_{O}+\left(A_{1}+1\right) g_{m} r_{O} R_{S}+R_{S}\right] I_{X} \tag{9.26}
\end{equation*}
$$

and hence

$$
\begin{align*}
V_{P} & =I_{X} R_{S}  \tag{9.27}\\
& =\frac{R_{S}}{r_{O}+\left(A_{1}+1\right) g_{m} r_{O} R_{S}+R_{S}} V_{X} \tag{9.28}
\end{align*}
$$

If $\left(A_{1}+1\right) g_{m} r_{O} R_{S}$ is large, then $V_{P} \approx V_{X} /\left[\left(A_{1}+1\right) g_{m} r_{O}\right]$, implying that the amplifier suppresses the change in the voltage across $R_{S}$ by another factor of $A_{1}+1$ compared to the case of a simple degenerated transistor. We also have

$$
\begin{align*}
V_{G} & =-A_{1} V_{P}  \tag{9.29}\\
& =\frac{-A_{1} R_{S}}{r_{O}+\left(A_{1}+1\right) g_{m} r_{O} R_{S}+R_{S}} V_{X} \tag{9.30}
\end{align*}
$$

The small-signal gate-source voltage is equal to $V_{G}-V_{P} \approx-V_{X} /\left(g_{m} r_{O}\right)$, yielding $I_{0} \approx-V_{X} / r_{O}$. Moreover,

$$
\begin{align*}
I_{r o} & =\frac{V_{X}-V_{P}}{r_{O}}  \tag{9.31}\\
& =\frac{r_{O}+\left(A_{1}+1\right) g_{m} r_{O} R_{S}}{r_{O}+\left(A_{1}+1\right) g_{m} r_{O} R_{S}+R_{S}} \frac{V_{X}}{r_{O}}  \tag{9.32}\\
& \approx \frac{V_{X}}{r_{O}} \tag{9.33}
\end{align*}
$$

Interestingly, $I_{0}$ and $I_{r o}$ are nearly equal and opposite. That is, the amplifier adjusts the gate voltage such that the change in the intrinsic drain current, $I_{0}$, almost cancels the current drawn by $r_{O}$. We say that the small-signal current of $M_{2}$ circulates through $r_{O}$.

In summary, the above two perspectives portray two principles behind the gain-boosting technique: the amplifier boosts the $g_{m}$ of the cascode device, or the amplifier regulates the output current by monitoring and pinning the source voltage.

### 9.4.2 Circuit Implementation

In this section, we deal with the implementation of the auxiliary amplifier in the regulated cascode and extend the gain-boosting technique to op amps. The simplest realization of $A_{1}$ is a common-source stage, as shown in Fig. 9.32(a). If $I_{1}$ is ideal, then $\left|A_{1}\right|=g_{m 3} r_{O 3}$, yielding $\left|V_{\text {out }} / V_{i n}\right| \approx g_{m 1} r_{O 1} g_{m 2} r_{O 2}\left(g_{m 3} r_{O 3}+1\right)$, as in a triple cascode. However, this topology limits the output voltage swing because the minimum voltage at node $P$ is dictated by $V_{G S 3}$ rather than the overdrive of $M_{1}$. We note that $V_{\text {out }}$ must remain above $V_{G S 3}+\left(V_{G S 2}-V_{T H 2}\right)$ here.
image_name:(a)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: G, InN: GND, OutP: G, OutN: GND}
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: GND}
name: I2, type: CurrentSource, value: I2, ports: {Np: VDD, Nn: Vout}
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: G}
name: M3, type: PMOS, ports: {S: VDD, D: G, G: P}
]
extrainfo:The circuit is a gain-boosted amplifier using an NMOS common-source stage. It consists of a cascode configuration with an additional gain stage (A1) to enhance the overall gain. The current sources I1 and I2 provide biasing for the amplifier stages.
image_name:(b)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: G, InN: GND, OutP: P, OutN: '}
name: I1, type: CurrentSource, value: I1, ports: {Np: G, Nn: GND}
name: I2, type: CurrentSource, value: I2, ports: {Np: VDD, Nn: Vout}
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: G}
name: M3, type: PMOS, ports: {S: VDD, D: G, G: P'}
]
extrainfo:The circuit in diagram (b) is a gain-boosted amplifier using a PMOS common-source stage. It addresses the headroom limitation by allowing the voltage at node P to be as low as the overdrive of M1. The PMOS transistor M3 is used in the gain-boosting stage, and the NMOS transistors M1 and M2 form the main amplification path. The current sources I1 and I2 provide biasing for the amplifier.
image_name:(c)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: G, InN: d3s4, OutP: d3s4, OutN: ', Vdd: VDD, -Vdd: GND}
name: I1, type: CurrentSource, value: I1, ports: {Np: d3s4, Nn: GND}
name: I2, type: CurrentSource, value: I2, ports: {Np: VDD, Nn: Vout}
name: I3, type: CurrentSource, value: I3, ports: {Np: VDD, Nn: G}
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: G}
name: M3, type: PMOS, ports: {S: VDD, D: d3s4, G: G}
name: M4, type: NMOS, ports: {S: GND, D: d3s4, G: Vb'}
]
extrainfo:The circuit is a folded-cascode stage with gain-boosting using an OpAmp A1. The current sources I1, I2, and I3 provide biasing. M1 and M2 form the main signal path, while M3 and M4 are part of the gain-boosted cascode configuration. The circuit aims to improve gain while managing output voltage swing and headroom limitations.

Figure 9.32 Gain-boosted amplifier using (a) an NMOS CS stage, (b) a PMOS CS stage, and (c) a folded-cascode stage.

To avoid this headroom limitation, we consider a PMOS common-source stage for $A_{1}$ [Fig. 9.32(b)]. The operation and gain-boosting properties remain the same, but $V_{P}$ can now be as low as the overdrive of $M_{1}$. Unfortunately, $M_{3}$ may enter the triode region here because the gate voltage of $M_{2}$ tends to be too high for the drain of $M_{3}$. Specifically, if we target $V_{P}=V_{G S 1}-V_{T H 1}$, then $V_{G}=V_{G S 2}+V_{G S 1}-V_{T H 1}$,
revealing that the drain of $M_{3}$ is higher than its gate by $V_{G S 2}$. If $V_{G S 2}>\left|V_{T H 3}\right|, M_{3}$ resides in the triode region.

The above analysis implies that we must insert one more stage in the feedback loop so as to reach compatible bias levels between consecutive stages. Let us interpose an NMOS common-gate stage between $M_{3}$ and the gate of $M_{2}$ [Fig. 9.32(c)]. The reader recognizes the resulting $A_{1}$ topology as a folded cascode, but we also observe that $M_{4}$ provides an upward level shift from its source to its drain, allowing $V_{G}$ to be higher than the drain voltage of $M_{3}$.

#### Example 9.13

Determine the allowable range for $V_{b}$ in Fig. 9.32(c).

#### Solution

The minimum value of $V_{b}$ places $I_{1}$ at the edge of the triode region, i.e., $V_{b, \min }=V_{G S 4}+V_{I 1}$. The maximum value biases $M_{4}$ at the edge of the triode region, i.e., $V_{b, \max }=V_{G S 2}+V_{P}+V_{T H 4}$. Thus, $V_{b}$ has a comfortably wide range and need not be precise.

We now apply gain boosting to a differential cascode stage, as shown in Fig. 9.33(a). Since the signals at nodes $X$ and $Y$ are differential, we surmise that the two single-ended gain-boosting amplifiers $A_{1}$ and $A_{2}$ can be replaced by one differential amplifier [Fig. 9.33(b)]. Following the topology of Fig. 9.32(a), we implement the differential auxiliary amplifier as shown in Fig. 9.33(c), but noting that the minimum level at the drain of $M_{3}$ is equal to $V_{O D 3}+V_{G S 5}+V_{I S S 2}$, where $V_{I S S 2}$ denotes the voltage required across $I_{S S 2}$. In a simple differential cascode, on the other hand, the minimum would be approximately one threshold voltage lower.
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: P, D: X, G: Vin+}
name: M2, type: NMOS, ports: {S: P, D: Y, G: Vin-}
name: M3, type: NMOS, ports: {S: X, D: g3, G: A1}
name: M4, type: NMOS, ports: {S: Y, D: g4, G: A2}
name: A1, type: OpAmp, value: A1, ports: {InP: Vin+, InN: X, OutP: g3, OutN: ', Vdd: , -Vdd:}
name: A2, type: OpAmp, value: A2, ports: {InP: Vin-, InN: Y, OutP: g4, OutN: , Vdd: , -Vdd:}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: P, Nn: GND'}
]
extrainfo:This circuit is a differential amplifier with two NMOS transistors (M1, M2) at the input and two NMOS transistors (M3, M4) at the output, connected to op-amps A1 and A2 for gain boosting. A current source ISS is connected to the common source node P.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: P, D: X, G: Vin+}
name: M2, type: NMOS, ports: {S: P, D: Y, G: Vin-}
name: M3, type: NMOS, ports: {S: X, D: gs, G: g3}
name: M4, type: NMOS, ports: {S: Y, D: gd4, G: g4}
name: A1, type: OpAmp, value: A1, ports: {InP: X, InN: Y, OutP: gs, OutN: gd4}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
]
extrainfo:This circuit diagram (b) represents a differential amplifier with NMOS transistors M1 and M2 forming the input differential pair. The output impedance is boosted by NMOS transistors M3 and M4, which are controlled by operational amplifier A1. The current source Iss provides biasing for the differential pair.
image_name:(c)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: g3, InN: X, OutP: gs, OutN: X}
name: A2, type: OpAmp, value: A2, ports: {InP: g4, InN: Y, OutP: gd6, OutN: Y}
name: M1, type: NMOS, ports: {S: P1, D: X, G: Vin+}
name: M2, type: NMOS, ports: {S: P1, D: Y, G: Vin-}
name: M3, type: NMOS, ports: {S: gs, D: X, G: g3}
name: M4, type: NMOS, ports: {S: gd6, D: Y, G: g4}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P1, Nn: GND}
name: M5, type: NMOS, ports: {S: s3d5, D: gs, G: X}
name: M6, type: NMOS, ports: {S: s4d6, D: gd6, G: Y}
name: Iss1, type: CurrentSource, value: Iss1, ports: {Np: P1, Nn: GND}
name: Iss2, type: CurrentSource, value: Iss2, ports: {Np: P2, Nn: GND}
name: I1, type: CurrentSource, value: I1, ports: {Np: s3d5, Nn: VDD}
name: I2, type: CurrentSource, value: I2, ports: {Np: s4d6, Nn: VDD}
]
extrainfo:The circuit diagram (c) represents a differential cascode stage with gain-boosting amplifiers A1 and A2. It includes NMOS transistors M1 to M6, with current sources Iss, Iss1, Iss2, I1, and I2. The gain-boosting amplifiers increase the output impedance, while the current sources manage biasing and load currents. The differential inputs are labeled Vin+ and Vin-, and the outputs are taken from nodes X and Y.

Figure 9.33 Boosting the output impedance of a differential cascode stage.

The voltage swing limitation in Fig. 9.33(c) results from the fact that the gain-boosting amplifier incorporates an NMOS differential pair. If nodes $X$ and $Y$ are sensed by a PMOS pair, the minimum value of $V_{X}$ and $V_{Y}$ is not dictated by the gain-boosting amplifier. Now recall from Sec. 9.2 that the minimum input CM level of a folded-cascode stage using a PMOS input pair can be zero. Thus, we employ such a topology for the gain-boosting amplifier, arriving at the circuit shown in Fig. 9.34. Here, the minimum allowable level of $V_{X}$ and $V_{Y}$ is given by $V_{O D 1,2}+V_{I S S 1}$.
image_name:Figure 9.34
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: X}
name: M2, type: NMOS, ports: {S: GND, D: P, G: Y}
name: M3, type: NMOS, ports: {S: d3, D: X, G: g3d7}
name: M4, type: NMOS, ports: {S: d4, D: Y, G: g4d8}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: s5b5}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: s5b6}
name: M7, type: NMOS, ports: {S: GND, D: d5s1, G: Vb}
name: M8, type: NMOS, ports: {S: GND, D: d6s8, G: Vb}
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: g3d7}
name: I2, type: CurrentSource, value: I2, ports: {Np: VDD, Nn: g4d8}
name: Iss1, type: CurrentSource, value: Iss1, ports: {Np: P, Nn: GND}
name: Iss2, type: CurrentSource, value: Iss2, ports: {Np: d3, Nn: s5b6}
name: Iss3, type: CurrentSource, value: Iss3, ports: {Np: d5s1, Nn: GND}
name: Iss4, type: CurrentSource, value: Iss4, ports: {Np: d6s8, Nn: GND}
]
extrainfo:The circuit is a folded-cascode amplifier with NMOS differential pair M1 and M2. It uses PMOS transistors M5 and M6 as load devices. The current sources Iss1, Iss2, Iss3, and Iss4 provide biasing currents. The circuit is designed for high output impedance and gain.

Figure 9.34 Folded-cascode circuit used as auxiliary amplifier.

#### Example 9.14

Calculate the output impedance of the circuit shown in Fig. 9.34.

#### Solution

Using the half-circuit concept and replacing the ideal current sources with transistors, we obtain the equivalent depicted in Fig. 9.35. The voltage gain from $X$ to $P$ is approximately equal to $g_{m 5} R_{\text {out } 1}$, where $R_{\text {out } 1} \approx\left[g_{m 7} r_{O 7}\right.$ $\left.\left(r_{O 9} \| r_{O 5}\right)\right] \|\left(g_{m 11} r_{O 11} r_{O 13}\right)$. Thus, $R_{\text {out }} \approx g_{m 3} r_{O 3} r_{O 1} g_{m 5} R_{\text {out } 1}$. In essence, since the output impedance of a cascode is boosted by a folded-cascode stage, the overall output impedance is similar to that of a "quadruple" cascode.
image_name:Figure 9.35
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X, G: Vin}
name: M3, type: NMOS, ports: {S: X, D: P, G: X}
name: M5, type: PMOS, ports: {S: X, D: X1, G: Vb2}
name: M7, type: PMOS, ports: {S: X1, D: P, G: Vb2}
name: M9, type: NMOS, ports: {S: GND, D: X1, G: Vb1}
name: M11, type: PMOS, ports: {S: P, D: S11D13, G: Vb3}
name: M13, type: PMOS, ports: {S: VDD, D: S11D13, G: Vb4}
name: Rout, type: Resistor, ports: {N1: P, N2: LOAD}
]
extrainfo:The circuit is a regulated cascode amplifier with an auxiliary amplifier section. It boosts the output impedance through a folded-cascode stage, achieving high voltage gain. The nodes are interconnected to form a complex impedance network, enhancing the performance of the amplifier.

Figure 9.35

Regulated cascodes can also be utilized in the load current sources of a cascode op amp. Shown in Fig. 9.36(a), such a topology boosts the output impedance of the PMOS current sources as well, thereby achieving a very high voltage gain. To allow maximum swings at the output, amplifier $A_{2}$ must employ an NMOS-input folded-cascode differential pair. Similar ideas apply to folded-cascode op amps [Fig. 9.36(b)].
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: d1, G: vip}
name: M2, type: NMOS, ports: {S: GND, D: d2, G: vin}
name: M3, type: NMOS, ports: {S: d1, D: voutp, G: g3}
name: M4, type: NMOS, ports: {S: d2, D: voutn, G: g4}
name: M5, type: NMOS, ports: {S: voutp, D: ssd1, G: gs}
name: M6, type: NMOS, ports: {S: voutn, D: s6d8, G: g6}
name: M7, type: PMOS, ports: {S: VDD, D: ssd1, G: Vb}
name: M8, type: PMOS, ports: {S: VDD, D: s6d8, G: Vb}
name: A1, type: OpAmp, value: A1, ports: {InP: d1, InN: d2, Out: p}
name: A2, type: OpAmp, value: A2, ports: {InP: gs, InN: g6, Out: g6}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: p, Nn: GND}
]
extrainfo:The circuit diagram shows a regulated cascode topology applied to a folded-cascode op amp. The PMOS transistors M7 and M8 are used as current sources to boost the output impedance. The NMOS transistors M1 and M2 form the input differential pair. The circuit employs gain boosting amplifiers A1 and A2 to increase the voltage gain without adding additional stages. The current source Iss provides the bias current for the differential pair.
image_name:(b)
description:
[
name: M1p, type: NMOS, ports: {S: disbd8, D: d2s5d7, G: vip}
name: M2, type: NMOS, ports: {S: d2s5d7, D: Vin, G: g3}
name: M3, type: NMOS, ports: {S: Vin, D: g3g4, G: g3}
name: M4, type: NMOS, ports: {S: g3g4, D: s3d9, G: g4}
name: M5, type: PMOS, ports: {S: d2s5d7, D: voutp, G: g5}
name: M6, type: PMOS, ports: {S: voutn, D: g6, G: g6}
name: M7, type: PMOS, ports: {S: VDD, D: disbd8, G: s5d7}
name: M8, type: PMOS, ports: {S: VDD, D: s5d7, G: s5d7}
name: M9, type: NMOS, ports: {S: s3d9, D: Vb2, G: Vb2}
name: M10, type: NMOS, ports: {S: s4d10, D: Vb2, G: Vb2}
name: A1, type: OpAmp, value: A1, ports: {InP: g3, InN: g4, OutP: Vout, OutN: '}
name: A2, type: OpAmp, value: A2, ports: {InP: g5, InN: g6, Out: s5d7}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: Vin, Nn: GND'}
]
extrainfo:The circuit diagram represents a folded-cascode operational amplifier with gain boosting applied to both the signal path and load devices. It includes current sources, NMOS and PMOS transistors, and operational amplifiers for enhanced performance and high voltage gain. The design facilitates maximum output swings by utilizing an NMOS-input folded-cascode differential pair.

Figure 9.36 Gain boosting applied to both signal path and load devices.

### 9.4.3 Frequency Response

Recall that the premise behind gain boosting is to increase the gain without adding a second stage or more cascode devices. Does this mean that the op amps of Fig. 9.36 have a one-stage nature? After all, the gain-boosting amplifier introduces its own pole(s). In contrast to two-stage op amps, where the entire signal experiences the poles associated with each stage, in a gain-boosted op amp, most of the signal flows directly through the cascode devices to the output. Only a small "error" component is processed by the auxiliary amplifier and "slowed down."

In order to analyze the frequency response of the regulated cascode, we simplify the circuit to that shown in Fig. 9.37, where the auxiliary amplifier contains one pole at $\omega_{0}, A_{1}(s)=A_{0} /\left(1+s / \omega_{0}\right)$, and only the load capacitance, $C_{L}$, is included. We wish to determine $V_{\text {out }} / V_{\text {in }}=-G_{m} Z_{\text {out }}$. To compute $G_{m}(s)$ (with the output node grounded), we note from Example 9.11 that the impedance seen looking into the source of $M_{2}$ is equal to $r_{O 2} /\left[1+\left(A_{1}+1\right) g_{m 2} r_{O 2}\right]$, and divide the drain current of $M_{1}$ between this impedance and $r_{O 1}$ :

$$
\begin{align*}
G_{m}(s) & =g_{m 1} \frac{r_{O 1}}{r_{O 1}+\frac{r_{O 2}}{1+\left(A_{1}+1\right) g_{m 2} r_{O 2}}}  \tag{9.34}\\
& =\frac{g_{m 1} r_{O 1}\left[1+\left(A_{1}+1\right) g_{m 2} r_{O 2}\right]}{r_{O 1}+\left(A_{1}+1\right) g_{m 2} r_{O 2} r_{O 1}+r_{O 2}} \tag{9.35}
\end{align*}
$$

image_name:Figure 9.37
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: Vb}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
name: A1, type: OpAmp, value: A1(s), ports: {InP: Vb, InN: P, OutP: Vb, OutN: GND}
]
extrainfo:The circuit consists of a two-stage amplifier with NMOS transistors M1 and M2, and a capacitive load CL. The op-amp A1(s) is used to control the gate of M2. The input voltage is applied at Vin, and the output is taken at Vout. The circuit is designed to analyze frequency response with Zout representing the output impedance.

Figure 9.37 Circuit for analysis of frequency response.

Now, we calculate $Z_{\text {out }}(s)$ as the parallel combination of $C_{L}$ and the impedance seen looking into the drain of $M_{2}$. From Eq. (9.21), we have

$$
\begin{equation*}
Z_{\text {out }}=\left[r_{O 1}+\left(A_{1}+1\right) g_{m 2} r_{O 2} r_{O 1}+r_{O 2}\right] \| \frac{1}{C_{L} s} \tag{9.36}
\end{equation*}
$$

It follows that

$$
\begin{align*}
\frac{V_{\text {out }}}{V_{\text {in }}}(s) & =-G_{m}(s) Z_{\text {out }}(s)  \tag{9.37}\\
& =\frac{-g_{m 1} r_{O 1}\left[1+\left(A_{1}+1\right) g_{m 2} r_{O 2}\right]}{\left(r_{O 1}+r_{O 2}\right) C_{L} s+\left(A_{1}+1\right) g_{m 2} r_{O 2} r_{O 1} C_{L} s+1} \tag{9.38}
\end{align*}
$$

While it is tempting to assume that $A_{1} \gg 1$ and hence neglect some terms, we must bear in mind that $A_{1}$ falls at high frequencies. Replacing $A_{1}$ with $A_{0} /\left(1+s / \omega_{0}\right)$ yields

$$
\begin{equation*}
\frac{V_{\text {out }}}{V_{\text {in }}}(s)=\frac{-g_{m 1} r_{O 1}\left[\left(1+g_{m 2} r_{O 2}\right) \frac{s}{\omega_{0}}+\left(A_{0}+1\right) g_{m 2} r_{O 2}+1\right]}{\frac{\left(r_{O 1}+r_{O 2}\right) C_{L}}{\omega_{0}}\left[1+g_{m 2}\left(r_{O 2} \| r_{O 1}\right)\right] s^{2}+\left[\left(r_{O 1}+r_{O 2}\right) C_{L}+\left(A_{0}+1\right) g_{m 2} r_{O 2} r_{O 1} C_{L}+\frac{1}{\omega_{0}}\right] s+1} \tag{9.39}
\end{equation*}
$$

It is interesting to note that, if we had assumed $A_{1}$ to be large for $G_{m}$ and $Z_{\text {out }}$ calculations, we would have obtained a first-order transfer function. The circuit exhibits a zero in the left half plane given by

$$
\begin{equation*}
\left|\omega_{z}\right| \approx\left(A_{0}+1\right) \omega_{0} \tag{9.40}
\end{equation*}
$$

if $g_{m 2} r_{O 2} \gg 1$. Produced by the path through $A_{1}$, this zero is on the order of the unity-gain bandwidth of the auxiliary amplifier.

To estimate pole frequencies, we assume that one is much greater than the other and apply the dominantpole approximation (Chapter 6). The dominant pole is given by the inverse of the coefficient of $s$ in the denominator of (9.39):

$$
\begin{align*}
\left|\omega_{p 1}\right| & =\frac{1}{\left[r_{O 1}+\left(A_{0}+1\right) g_{m 2} r_{O 2} r_{O 1}+r_{O 2}\right] C_{L}+\frac{1}{\omega_{0}}}  \tag{9.41}\\
& \approx \frac{1}{A_{0} g_{m 2} r_{O 2} r_{O 1} C_{L}} \tag{9.42}
\end{align*}
$$

The first time constant in the denominator of (9.41) corresponds to the output pole if $A_{1}$ were ideal, i.e., if $\omega_{0}=\infty$. The nondominant pole is equal to the ratio of the coefficients of $s$ and $s^{2}$ :

$$
\begin{align*}
\left|\omega_{p 2}\right| & =\frac{\left[r_{O 1}+\left(A_{0}+1\right) g_{m 2} r_{O 2} r_{O 1}+r_{O 2}\right] C_{L}+\frac{1}{\omega_{0}}}{\frac{\left(r_{O 1}+r_{O 2}\right) C_{L}}{\omega_{0}}\left[1+g_{m 2}\left(r_{O 1} \| r_{O 2}\right)\right]}  \tag{9.43}\\
& \approx\left(A_{0}+1\right) \omega_{0}+\frac{1}{g_{m 2} r_{O 2} r_{O 1} C_{L}} \tag{9.44}
\end{align*}
$$

if $g_{m 2}\left(r_{O 1} \| r_{O 2}\right) \gg 1$ (not necessarily a good approximation, but just to see trends). We observe that the second pole is somewhat above the unity-gain bandwidth of the original cascode, $\left(g_{m 2} r_{O 2} r_{O 1} C_{L}\right)^{-1}$. Note that the term $1 /\left(g_{m 2} r_{O 2} r_{O 1} C_{L}\right)$ also represents the output pole in the absence of $A_{1}$.

#### Example 9.15

Is the dominant-pole approximation valid here?

#### Solution

Assuming $\left(A_{0}+1\right) g_{m 2} r_{O 2} r_{O 1} \gg r_{O 1}, r_{O 2}$, we find the ratio of (9.44) and (9.41):

$$
\begin{align*}
\frac{\omega_{p 2}}{\omega_{p 1}} & \approx\left[\left(A_{0}+1\right) \omega_{0}+\frac{1}{g_{m 2} r_{O 2} r_{O 1} C_{L}}\right]\left[\left(A_{0}+1\right) g_{m 2} r_{O 2} r_{O 1} C_{L}+\frac{1}{\omega_{0}}\right]  \tag{9.45}\\
& \approx\left(A_{0}+1\right)^{2} g_{m 2} r_{O 2} r_{O 1} C_{L} \omega_{0}+2\left(A_{0}+1\right)+\frac{1}{g_{m 2} r_{O 2} r_{O 1} C_{L} \omega_{0}} \tag{9.46}
\end{align*}
$$

The second term is typically much greater than unity, making the approximation valid.

Figure 9.38 plots the approximate frequency response of the cascode structure before and after gain boosting. The key point here is that the auxiliary amplifier contributes a second pole located above the original $-3-\mathrm{dB}$ bandwidth by an amount equal to $A_{0} \omega_{0}$.
image_name:Figure 9.38 Frequency response of gain-boosted stage
description:The graph depicted in Figure 9.38 is a Bode plot, illustrating the frequency response of a gain-boosted cascode amplifier stage. The plot is characterized by a logarithmic scale on both the horizontal axis (frequency, \( \omega \)) and the vertical axis (magnitude of gain, \( \frac{V_{out}}{V_{in}} \), in decibels).

Axes:
- **Horizontal Axis (\( \omega \))**: Represents frequency on a logarithmic scale.
- **Vertical Axis (\( \frac{V_{out}}{V_{in}} \))**: Represents the gain in decibels, also on a logarithmic scale.
Overall Behavior and Trends:
- The graph shows two main regions corresponding to the frequency response of the original cascode and the regulated cascode.
- The gain of the original cascode is depicted by a horizontal dashed line at \( g_{m1}r_{o1}g_{m2}r_{o2} \).
- The gain of the regulated cascode is higher, represented by a horizontal solid line at \( A_{0}g_{m1}r_{o1}g_{m2}r_{o2} \).
- As frequency increases, there is a distinct drop in gain, indicating the presence of poles that reduce the gain.
Key Features and Technical Details:
- **Original Cascode Gain**: \( g_{m1}r_{o1}g_{m2}r_{o2} \).
- **Regulated Cascode Gain**: \( A_{0}g_{m1}r_{o1}g_{m2}r_{o2} \).
- **Poles**: Indicated by vertical dashed lines at frequencies \( \frac{1}{A_{0}g_{m1}r_{o1}g_{m2}r_{o2}C_{L}} \), \( \frac{1}{g_{m2}r_{o2}r_{o1}C_{L}} \), and \( \frac{1}{g_{m2}r_{o2}r_{o1}C_{L}} + A_{0}\omega_{0} \).
- The second pole introduced by the auxiliary amplifier is located above the original \(-3 \text{ dB}\) bandwidth, enhancing the bandwidth by an amount equal to \( A_{0}\omega_{0} \).
Annotations and Specific Data Points:
- The graph highlights the improved gain and bandwidth of the regulated cascode compared to the original cascode.
- The frequency markers on the horizontal axis are essential for understanding the bandwidth enhancement due to gain boosting.

Figure 9.38 Frequency response of gain-boosted stage.

## 9.5 ■ Comparison

Our study of op amps in this chapter has introduced four principal topologies: telescopic cascode, folded cascode, two-stage op amp, and gain boosting. It is instructive to compare various performance aspects of these circuits to gain a better view of their applicability. Table 9.1 comparatively presents important attributes of each op amp topology. We study the speed differences in Chapter 10.

## 9.6 ■ Output Swing Calculations

In today's low-voltage op amp designs, the output voltage swing proves the most important factor. We have seen in previous sections how to assume a certain required output swing and accordingly allocate overdrive voltages to the transistors. But how do we verify that the final design indeed accommodates the

Table 9.1 Comparison of performance of various op amp topologies.

|  | Gain | Output <br> Swing | Speed | Power <br> Dissipation | Noise |
| :--- | :---: | :---: | :---: | :---: | :---: |
| Telescopic | Medium | Medium | Highest | Low | Low |
| Folded-Cascode | Medium | Medium | High | Medium | Medium |
| Two-Stage | High | Highest | Low | Medium | Low |
| Gain-Boosted | High | Medium | Medium | High | Medium |

specified swing? To answer this question, we must first ask, what exactly happens if the circuit cannot sustain the swing? Since the border between the saturation and triode regions begins to diminish in nanometer devices, we cannot readily decide on the operation region of the transistors at the extremes of the output swing. A more rigorous approach is therefore necessary.

If the output voltage excursion pushes a transistor into the triode region, then the voltage gain drops. We can thus use simulations to examine the gain as the output swing grows. Illustrated in Fig. 9.39(a), the idea is to apply to the input a growing sinusoid (or different sinusoidal amplitudes in different simulations), monitor the resulting output, and calculate $\left|V_{\text {out }} / V_{\text {in }}\right|$ as $V_{\text {in }}$ and $V_{\text {out }}$ grow. The gain begins to drop as the output swing reaches its maximum "allowable" voltage, $V_{1}$. We may even choose $V_{1}$ to allow a small drop in the gain, say, $10 \%$ (about 1 dB ). Beyond $V_{1}$, the gain falls further, causing significant nonlinearity.
image_name:(a)
description:The system block diagram labeled "(a)" illustrates a simulation of gain versus input amplitude for an amplifier. The diagram consists of the following components and elements:

1. **Main Components:**
- **Amplifier Block:** The central component is an amplifier represented by a triangle with positive (+) and negative (-) input terminals. This indicates a differential input, commonly seen in operational amplifiers.
- **Input and Output Signals:** The diagram shows sinusoidal waveforms representing the input and output signals. The input signal is applied to the amplifier, and the output is taken from the amplifier's output terminal.

2. **Flow of Information or Control:**
- The input sinusoidal signal is fed into the amplifier's input terminals. The amplifier processes this signal and produces an amplified output, which is also sinusoidal.
- The flow of information is linear, from the input through the amplifier to the output.

3. **Labels, Annotations, and Key Indicators:**
- **|V_out / V_in|:** A graph on the right side of the diagram shows the ratio of output voltage to input voltage (gain) plotted against the input voltage (V_in).
- **V_1:** A vertical dashed line on the graph indicates a critical point, V_1, where the gain begins to drop. This point marks the maximum allowable output voltage beyond which the gain decreases significantly, indicating nonlinearity.

4. **Overall System Function:**
- The primary function of this system is to simulate and analyze the behavior of an amplifier as the input amplitude increases. The graph shows how the gain remains constant up to a certain input level (V_1) and then begins to decrease, demonstrating the amplifier's limitations in handling larger input signals without distortion. This analysis is crucial for understanding the linearity and distortion characteristics of the amplifier in various applications.
image_name:(b)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: GND, InN: Vin, OutP: Vout, OutN: GND}
name: R1, type: Resistor, value: R1, ports: {N1: Vin, N2: InN(A1)}
name: R2, type: Resistor, value: R2, ports: {N1: Vout, N2: InN(A1)}
]
extrainfo:The circuit diagram shows a feedback amplifier configuration with an op-amp A1, where R1 and R2 form a feedback loop. The input voltage Vin is applied to the inverting terminal of the op-amp, and the non-inverting terminal is grounded. The output voltage Vout is taken across the op-amp's output terminal.

Figure 9.39 (a) Simulation of gain versus input amplitude, and (b) feedback amplifier.
The reader may wonder how much gain reduction is acceptable. In some applications, the reduction of the open-loop gain, and hence the gain error of the closed-loop system, are critical (Chapter 13). In other applications, we are concerned with the output distortion of the closed-loop circuit. In such a case, we place the op amp in the closed-loop environment of interest, e.g., the inverting configuration of Fig. 9.39(b), apply a sinusoid to the input, and measure the distortion (harmonics) at the output in simulations. The maximum output amplitude that yields an acceptable distortion is considered the maximum output swing.

## 9.7 ■ Common-Mode Feedback

### 9.7.1 Basic Concepts

In this and previous chapters, we have described many advantages of fully differential circuits over their single-ended counterparts. In addition to greater output swings, differential op amps avoid mirror poles, thus achieving a higher closed-loop speed. However, high-gain differential circuits require "commonmode feedback" (CMFB).

To understand the need for CMFB, let us begin with a simple realization of a differential amplifier [Fig. 9.40(a)]. In some applications, we short the inputs and outputs for part of the operation [Fig. 9.40(b)],
image_name:Figure 9.40 (a)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: Vip, InN: Vin, OutP: Voutp, OutN: Voutn}
name: RD1, type: Resistor, value: RD, ports: {N1: VDD, N2: Voutp}
name: RD2, type: Resistor, value: RD, ports: {N1: VDD, N2: Voutn}
name: M1, type: NMOS, ports: {S: GND, D: Voutp, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: Voutn, G: Vin}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: VDD, Nn: GND}
]
extrainfo:The circuit is a simple differential amplifier with NMOS transistors M1 and M2, and resistive loads RD1 and RD2. It uses a current source ISS for biasing. The output nodes are Voutp and Voutn, providing differential output.
image_name:Figure 9.40 (b)
description:
[
name: A1, type: OpAmp, ports: {InP: VoutP, InN: VoutN, OutP: VoutP, OutN: VoutN}
name: RD1, type: Resistor, value: RD, ports: {N1: VDD, N2: VoutP}
name: RD2, type: Resistor, value: RD, ports: {N1: VDD, N2: VoutN}
name: M1, type: NMOS, ports: {S: GND, D: VoutP, G: VoutP}
name: M2, type: NMOS, ports: {S: GND, D: VoutN, G: VoutN}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: GND, Nn: GND}
]
extrainfo:The circuit is a differential amplifier with feedback where inputs and outputs are shorted, providing differential negative feedback. The common-mode level at the nodes is defined by VDD and ISS.

Figure 9.40 (a) Simple differential pair; (b) circuit with inputs shorted to outputs.
providing differential negative feedback. The input and output common-mode levels in this case are fairly well defined, equal to $V_{D D}-I_{S S} R_{D} / 2$.

Now suppose the load resistors are replaced by PMOS current sources so as to increase the differential voltage gain [Fig. 9.41(a)]. What is the common-mode level at nodes $X$ and $Y$ ? Since each of the input transistors carries a current of $I_{S S} / 2$, the CM level depends on how close $I_{D 3}$ and $I_{D 4}$ are to this value. In practice, as exemplified by Fig. 9.41(b), mismatches in the PMOS and NMOS current mirrors defining $I_{S S}$ and $I_{D 3,4}$ create a finite error between $I_{D 3,4}$ and $I_{S S} / 2$. Suppose, for example, that the drain currents of $M_{3}$ and $M_{4}$ in the saturation region are slightly greater than $I_{S S} / 2$. As a result, to satisfy Kirchhoff's current law at nodes $X$ and $Y$, both $M_{3}$ and $M_{4}$ must enter the triode region so that their drain currents fall to $I_{S S} / 2$. Conversely, if $I_{D 3,4}<I_{S S} / 2$, then both $V_{X}$ and $V_{Y}$ must drop so that $M_{5}$ enters the triode region, thereby producing only $2 I_{D 3,4}$.
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X, G: Voutp}
name: M2, type: NMOS, ports: {S: GND, D: Y, G: Voutn}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: Vb}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vb}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: GND, Nn: P}
]
extrainfo:The circuit is a high-gain differential pair with inputs shorted to outputs. M3 and M4 are PMOS transistors acting as a current source, while M1 and M2 are NMOS transistors forming the differential pair. The current source Iss provides biasing current from ground.

(a)
image_name:Figure 9.41 (a)
description:
[
name: Mb1, type: NMOS, ports: {S: GND, D: X3, G: X3}
name: Mb2, type: PMOS, ports: {S: VDD, D: X1, G: X1}
name: M1, type: NMOS, ports: {S: X3, D: X, G: X2}
name: M2, type: NMOS, ports: {S: X3, D: Y, G: X2}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: X1}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: X1}
name: M5, type: NMOS, ports: {S: X3, D: GND, G: X2}
name: R1, type: Resistor, value: R1, ports: {N1: X1, N2: X3}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: VDD, Nn: GND}
]
extrainfo:The circuit is a high-gain differential pair with inputs shorted to outputs. It uses PMOS transistors M3 and M4 as a current source and NMOS transistors M1 and M2 as a differential pair. The current source Iss provides biasing current from ground.

(b)

Figure 9.41 (a) High-gain differential pair with inputs shorted to outputs, and (b) effect of current mismatches.

The above difficulties fundamentally arise because in high-gain amplifiers, we wish a $p$-type current source [e.g., $M_{3}$ and $M_{4}$ in Fig. 9.41(b)] to balance an $n$-type current source (e.g., $M_{5}$ ). As illustrated in Fig. 9.42, the difference between $I_{P}$ and $I_{N}$ must flow through the intrinsic output impedance of the
image_name:Figure 9.42
description:
[
name: IP, type: CurrentSource, ports: {Np: VDD, Nn: X1}
name: IN, type: CurrentSource, ports: {Np: X1, Nn: GND}
name: RP, type: Resistor, value: RP, ports: {N1: VDD, N2: X2}
name: RN, type: Resistor, value: RN, ports: {N1: X2, N2: GND}
]
extrainfo:The circuit shows a simplified high-gain amplifier model with a differential current source configuration. IP and IN are p-type and n-type current sources, respectively, with their difference flowing between nodes X1 and X2, through resistors RP and RN.

Figure 9.42 Simplified model of highgain amplifier.
amplifier, creating an output voltage change of $\left(I_{P}-I_{N}\right)\left(R_{P} \| R_{N}\right)$. Since the current error depends on mismatches and $R_{P} \| R_{N}$ is quite high, the voltage error may be large, thus driving the $p$-type or $n$-type current source into the triode region. As a general rule, if the output CM level cannot be determined by "visual inspection" and requires calculations based on device properties, then it is poorly defined. This is the case in Fig. 9.41 but not in Fig. 9.40. We emphasize that differential feedback cannot define the CM level.

Students often make two mistakes here. First, they assume that differential feedback corrects the output common-mode level. As explained for the simple circuit of Fig. 9.41(a), differential feedback from $X$ and $Y$ to the inputs cannot prohibit the output CM level from taking off toward $V_{D D}$ or ground. Second, they finely adjust $V_{b}$ in simulations so as to bring $V_{X}$ and $V_{Y}$ to around $V_{D D} / 2$ concluding that the circuit does not need CM feedback. We have recognized, however, that random mismatches between the top and bottom current sources cause the CM level to fall or rise considerably. Such mismatches are always present in actual circuits and cause the op amp to fail if no CMFB is used.

#### Example 9.16

Consider the telescopic op amp designed in Example 9.5 and repeated in Fig. 9.43 with bias current mirrors. Suppose $M_{9}$ suffers from a $1 \%$ current mismatch with respect to $M_{10}$, producing $I_{S S}=2.97 \mathrm{~mA}$ rather than 3 mA . Assuming perfect matching for other transistors, explain what happens in the circuit.
image_name:Figure 9.43
description:
[
name: M1, type: NMOS, ports: {S: X2, D: Vb1, G: Vip}
name: M2, type: NMOS, ports: {S: X2, D: Vout, G: Vin}
name: M3, type: NMOS, ports: {S: Vb1, D: X, G: Vb1}
name: M4, type: NMOS, ports: {S: Vout, D: Y, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: X1, G: X1}
name: M8, type: PMOS, ports: {S: VDD, D: Y, G: X1}
name: M9, type: NMOS, ports: {S: X3, D: X2, G: X3}
name: M10, type: NMOS, ports: {S: GND, D: X3, G: X3}
name: M11, type: PMOS, ports: {S: VDD, D: X1, G: X1}
name: R1, type: Resistor, value: 300 μA, ports: {N1: VDD, N2: X1}
]
extrainfo:The circuit is a telescopic operational amplifier with bias current mirrors. The mismatch in current between M9 and M10 causes a change in the output voltage. The circuit is designed to amplify differential input signals (Vip and Vin) with high gain and high output impedance.

Figure 9.43

#### Solution

From Example 9.5, the single-ended output impedance of the circuit equals $266 \mathrm{k} \Omega$. Since the difference between the drain currents of $M_{3}$ and $M_{5}$ (and $M_{4}$ and $M_{6}$ ) is $30 \mu \mathrm{~A} / 2=15 \mu \mathrm{~A}$, the output voltage error would be $266 \mathrm{k} \Omega \times 15 \mu \mathrm{~A}=3.99 \mathrm{~V}$. Since this large error cannot be produced, $V_{X}$ and $V_{Y}$ must rise so much that $M_{5}-M_{6}$ and $M_{7}-M_{8}$ enter the triode region, yielding $I_{D 7,8}=1.485 \mathrm{~mA}$. We should also mention that another important source
of CM error in the simple biasing scheme of Fig. 9.43 is the deterministic error between $I_{D 7,8}$ and $I_{D 11}$ (and also between $I_{D 9}$ and $I_{D 10}$ ) due to their different drain-source voltages. This error can nonetheless be reduced by means of the current mirror techniques of Chapter 5.

The foregoing study implies that in high-gain amplifiers, the output CM level is sensitive to device properties and mismatches and it cannot be stabilized by means of differential feedback. Thus, a commonmode feedback network must be added to sense the CM level of the two outputs and adjust one of the bias currents in the amplifier. Following our view of feedback systems in Chapter 8, we divide the task of CMFB into three operations: sensing the output CM level, comparison with a reference, and returning the error to the amplifier's bias network. Figure 9.44 conceptually illustrates the idea.
image_name:Figure 9.44 Conceptual topology for common-mode feedback
description:
[
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: Vout1}
name: I2, type: CurrentSource, value: I2, ports: {Np: VDD, Nn: Vout2}
name: I3, type: CurrentSource, value: I1, ports: {Np: GND, Nn: M1S}
name: M1, type: NMOS, ports: {S: M1S, D: Vout1, G: Vip}
name: M2, type: NMOS, ports: {S: M1S, D: Vout2, G: Vin}
name: A1, type: OpAmp, value: A1, ports: {InP: CM_Level_Sense, InN: VREF, OutP: I3, OutN: GND}
]
extrainfo:The circuit is a common-mode feedback topology. It includes two NMOS transistors (M1 and M2) with their sources connected together and to a current source I3. The drains of M1 and M2 are connected to the outputs Vout1 and Vout2 respectively. The op-amp A1 is used for common-mode level sensing, comparing the sensed CM level with a reference voltage VREF and adjusting the bias current through I3.

Figure 9.44 Conceptual topology for common-mode feedback.

### 9.7.2 CM Sensing Techniques

In order to sense the output CM level, we recall that $V_{\text {out }, C M}=\left(V_{\text {out } 1}+V_{\text {out } 2}\right) / 2$, where $V_{\text {out } 1}$ and $V_{\text {out } 2}$ are the single-ended outputs. It therefore seems plausible to employ a resistive divider as shown in Fig. 9.45, generating $V_{\text {out }, C M}=\left(R_{1} V_{\text {out } 2}+R_{2} V_{\text {out } 1}\right) /\left(R_{1}+R_{2}\right)$, which reduces to $\left(V_{\text {out } 1}+V_{\text {out } 2}\right) / 2$ if $R_{1}=R_{2}$. The difficulty, however, is that $R_{1}$ and $R_{2}$ must be much greater than the output impedance of the op amp so as to avoid lowering the open-loop gain. For example, in the design of Fig. 9.43, the output impedance equals $266 \mathrm{k} \Omega$, necessitating a value of several megaohms for $R_{1}$ and $R_{2}$. As explained in Chapter 18, such large resistors occupy a very large area and, more important, suffer from substantial parasitic capacitance to the substrate.
image_name:Figure 9.45 Common-mode feedback with resistive sensing
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: d1s3, G: Vb1}
name: M2, type: PMOS, ports: {S: VDD, D: d2s4, G: Vb1}
name: M3, type: NMOS, ports: {S: d1s3, D: Vout1, G: Vb2}
name: M4, type: PMOS, ports: {S: d2s4, D: Vout2, G: Vb2}
name: M5, type: NMOS, ports: {S: Vout1, D: GND, G: Vb3}
name: M6, type: NMOS, ports: {S: Vout2, D: GND, G: Vb3}
name: M7, type: NMOS, ports: {S: Vout,CM, D: GND, G: Vb4}
name: M8, type: NMOS, ports: {S: Vout,CM, D: GND, G: Vb4}
name: R1, type: Resistor, value: R1, ports: {N1: Vout1, N2: Vout,CM}
name: R2, type: Resistor, value: R2, ports: {N1: Vout2, N2: Vout,CM}
]
extrainfo:This circuit is a common-mode feedback circuit with resistive sensing. It uses PMOS and NMOS transistors to control the common-mode voltage at the output. The PMOS transistors M1 and M2 are used as current sources, while NMOS transistors M3 to M8 are used for differential amplification and feedback. Resistors R1 and R2 are used for sensing the common-mode voltage.

Figure 9.45 Common-mode feedback with resistive sensing.

To eliminate the resistive loading, we can interpose source followers between each output and its corresponding resistor. Illustrated in Fig. 9.46, this technique produces a CM level that is in fact lower than the output CM level by $V_{G S 7,8}$, but this shift can be taken into account in the comparison operation. Note that $R_{1}$ and $R_{2}$ or $I_{1}$ and $I_{2}$ must be large enough to ensure that $M_{7}$ or $M_{8}$ is not "starved" when
image_name:Figure 9.46
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb1}
name: M2, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb1}
name: M9, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb2}
name: M10, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb2}
name: M3, type: NMOS, ports: {S: GND, D: Vb3, G: Vb3}
name: M4, type: NMOS, ports: {S: Vb3, D: Vout1, G: Vb3}
name: M5, type: NMOS, ports: {S: GND, D: Vb4, G: Vb4}
name: M6, type: NMOS, ports: {S: Vb4, D: Vout2, G: Vb4}
name: M7, type: NMOS, ports: {S: GND, D: S9, G: Vout1}
name: M8, type: NMOS, ports: {S: GND, D: S8, G: Vout2}
name: R1, type: Resistor, value: R1, ports: {N1: S8, N2: Vout,CM}
name: R2, type: Resistor, value: R2, ports: {N1: Vout,CM, N2: S7}
name: I1, type: CurrentSource, value: I1, ports: {Np: S9, Nn: GND}
name: I2, type: CurrentSource, value: I2, ports: {Np: S7, Nn: GND}
]
extrainfo:This circuit is a common-mode feedback amplifier using source followers to reduce resistive loading. The circuit uses PMOS and NMOS transistors to manage the output common-mode level, and resistors R1 and R2 to sense the common-mode voltage. The current sources I1 and I2 help maintain the necessary current levels for proper operation.

Figure 9.46 Common-mode feedback using source followers.
a large differential swing appears at the output. As conceptually depicted in Fig. 9.47, if, say, $V_{\text {out } 2}$ is quite higher than $V_{\text {out } 1}$, then $I_{1}$ must sink both $I_{X} \approx\left(V_{\text {out } 2}-V_{\text {out } 1}\right) /\left(R_{1}+R_{2}\right)$ and $I_{D 7}$. Consequently, if $R_{1}+R_{2}$ or $I_{1}$ is not sufficiently large, $I_{D 7}$ drops to zero and $V_{o u t, C M}$ no longer represents the true output CM level.
image_name:Figure 9.47
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: Vout1, G: g1}
name: M2, type: PMOS, ports: {S: VDD, D: Vout2, G: g2}
name: M3, type: NMOS, ports: {S: S3, D: Vout1, G: g3}
name: M4, type: NMOS, ports: {S: S4, D: Vout2, G: g4}
name: M7, type: NMOS, ports: {S: I1, D: S7, G: Vout1}
name: M8, type: NMOS, ports: {S: I2, D: S8, G: Vout2}
name: R1, type: Resistor, value: R1, ports: {N1: Vout,CM, N2: S7}
name: R2, type: Resistor, value: R2, ports: {N1: Vout,CM, N2: S8}
name: I1, type: CurrentSource, value: I1, ports: {Np: S7, Nn: GND}
name: I2, type: CurrentSource, value: I2, ports: {Np: S8, Nn: GND}
]
extrainfo:The circuit is a differential amplifier with source followers and current sources for biasing. It features two PMOS transistors (M1 and M2) as loads and four NMOS transistors (M3, M4, M7, M8) for differential amplification and feedback. The resistors R1 and R2 are used for sensing the common-mode voltage Vout,CM. The current sources I1 and I2 provide biasing for the NMOS transistors M7 and M8.

Figure 9.47 Current starvation of source followers for large swings.

The sensing method of Fig. 9.46 nevertheless suffers from an important drawback: it limits the differential output swings (even if $R_{1,2}$ and $I_{1,2}$ are large enough). To understand why, let us determine the minimum allowable level of $V_{\text {out } 1}$ (and $V_{\text {out } 2}$ ), noting that without CMFB, it would be equal to $V_{O D 3}+V_{O D 5}$. With the source followers in place, $V_{\text {out } 1, \text { min }}=V_{G S 7}+V_{I 1}$, where $V_{I 1}$ denotes the minimum voltage required across $I_{1}$. This is roughly equal to two overdrive voltages plus one threshold voltage. Thus, the swing at each output is reduced by approximately $V_{T H}$, a significant value in low-voltage design.

Looking at Fig. 9.45, the reader may wonder if the output CM level can be sensed by means of capacitors, rather than resistors, so as to avoid degrading the low-frequency open-loop gain of the op amp. This is indeed possible in some cases and will be studied in Chapter 13.

Another type of CM sensing is depicted in Fig. 9.48(a). Here, identical transistors $M_{7}$ and $M_{8}$ operate in the deep triode region, introducing a total resistance between $P$ and ground equal to

$$
\begin{align*}
R_{t o t} & =R_{o n 7} \| R_{o n 8}  \tag{9.47}\\
& =\frac{1}{\mu_{n} C_{o x} \frac{W}{L}\left(V_{o u t 1}-V_{T H}\right)} \| \frac{1}{\mu_{n} C_{o x} \frac{W}{L}\left(V_{o u t 2}-V_{T H}\right)}  \tag{9.48}\\
& =\frac{1}{\mu_{n} C_{o x} \frac{W}{L}\left(V_{o u t 2}+V_{o u t 1}-2 V_{T H}\right)} \tag{9.49}
\end{align*}
$$

image_name:(a)
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: s1d2, G: Vb1}
name: M2, type: PMOS, ports: {S: VDD, D: d2s4, G: Vb1}
name: M3, type: PMOS, ports: {S: s1d2, D: Vout1, G: Vb2}
name: M4, type: NMOS, ports: {S: GND, D: d2s4, G: Vout2}
name: M5, type: NMOS, ports: {S: GND, D: s4d9, G: Vb3}
name: M6, type: NMOS, ports: {S: s4d9, D: Vout1, G: Vb4}
name: M7, type: NMOS, ports: {S: GND, D: P, G: Vout1}
name: M8, type: NMOS, ports: {S: GND, D: P, G: Vout2}
name: M9, type: NMOS, ports: {S: GND, D: d2s4, G: Vb2}
name: M10, type: NMOS, ports: {S: GND, D: s6d10, G: Vb4}
]
extrainfo:The circuit is a common-mode sensing circuit using MOSFETs operating in the deep triode region. It consists of a differential pair with PMOS transistors M1 and M2 at the top and NMOS transistors M9 and M10 at the bottom. The outputs are Vout1 and Vout2, and the resistance between node P and ground is determined by the parallel combination of M7 and M8.
image_name:(b)
description:
[
name: M7, type: NMOS, ports: {S: GND, D: P, G: Vout1}
name: M8, type: NMOS, ports: {S: GND, D: P, G: Vout2}
]
extrainfo:The circuit diagram (b) shows a common-mode sensing circuit using NMOS transistors M7 and M8 operating in the deep triode region. The total resistance between node P and ground is determined by the parallel combination of the resistances of M7 and M8, which depends on the sum of Vout1 and Vout2.

Figure 9.48 (a) Common-mode sensing using MOSFETs operating in the deep triode region, and (b) output levels placing $M_{7}$ at the edge of saturation.
where $W / L$ denotes the aspect ratio of $M_{7}$ and $M_{8}$. Equation (9.49) indicates that $R_{t o t}$ is a function of $V_{\text {out } 2}+V_{\text {out } 1}$ but independent of $V_{\text {out } 2}-V_{\text {out } 1}$. From Fig. 9.48(a), we observe that if the outputs rise together, then $R_{t o t}$ drops, whereas if they change differentially, one $R_{o n}$ increases and the other decreases. This resistance can thus be utilized as a measure of the output CM level.

In the circuit of Fig. 9.48(a), the use of $M_{7}$ and $M_{8}$ limits the output voltage swings. Here, it may seem that $V_{\text {out, } \min }=V_{T H 7,8}$, which is relatively close to two overdrive voltages, but the difficulty arises from the assumption above that both $M_{7}$ and $M_{8}$ operate in the deep triode region. In fact, if, say, $V_{\text {out } 1}$ drops from the equilibrium CM level to about one threshold voltage above ground [Fig. 9.48(b)] and $V_{\text {out } 2}$ rises by the same amount, then $M_{7}$ enters the saturation region, thus exhibiting a variation in its on-resistance that is not counterbalanced by that of $M_{8}$.

It is important to bear in mind that CM sensing must produce a quantity independent of the differential signals. The following example illustrates this point.

#### Example 9.17

A student simulates the step response of a closed-loop op amp circuit [e.g., that in Fig. 9.48(a)] and observes the output waveforms shown in Fig. 9.49. Explain why $V_{\text {out } 1}$ and $V_{\text {out } 2}$ do not change symmetrically.
image_name:Figure 9.49
description:The graph in Figure 9.49 is a time-domain waveform illustrating the step response of a closed-loop operational amplifier circuit. The x-axis represents time (t), while the y-axis represents voltage levels, specifically \( V_{\text{out}1} \), \( V_{\text{out}2} \), and the common-mode voltage \( V_{CM} \). The time axis is marked with two significant points, \( t_1 \) and \( t_2 \), which are indicated by vertical dashed lines.

The waveform shows the behavior of two output voltages, \( V_{\text{out}1} \) and \( V_{\text{out}2} \), as well as the common-mode voltage \( V_{CM} \). Initially, at time \( t_1 \), both output voltages start from a common point but diverge as time progresses. \( V_{\text{out}1} \) increases, while \( V_{\text{out}2} \) decreases, indicating an asymmetric change in the output voltages. This divergence suggests a differential response in the circuit.

The common-mode voltage \( V_{CM} \) is depicted as a dotted line and exhibits a change in its level between \( t_1 \) and \( t_2 \). This change indicates a nonlinear response in the common-mode sensing mechanism of the circuit. The graph highlights how the CM level is interpreted differently at \( t_1 \) and \( t_2 \), which may be due to one of the transistors, such as \( M_7 \) or \( M_8 \), not remaining in the deep triode region at \( t_2 \). This results in \( V_{CM} \) becoming dependent on the differential signals, causing the observed behavior in the waveform.

Figure 9.49

#### Solution

As evident from the waveforms, the output CM level changes from $t_{1}$ to $t_{2}$, indicating that the CM sensing mechanism is nonlinear and interprets the CM levels at $t_{1}$ and $t_{2}$ differently. For example, if $M_{7}$ or $M_{8}$ in Fig. 9.48 does not remain in the deep triode region at $t_{2}$, then Eq. (9.49) no longer holds and $V_{C M}$ becomes a function of the differential signals.

Another CM sensing method is illustrated in Fig. 9.50. Here, the differential pairs compare the inputs with $V_{R E F}$, generating a current, $I_{C M}$, in proportion to the input CM level. To prove this point, we write the small-signal drain currents of $M_{2}$ and $M_{4}$ as $\left(g_{m} / 2\right) V_{\text {out } 1}$ and $\left(g_{m} / 2\right) V_{\text {out } 2}$, respectively, concluding that $I_{C M} \propto V_{\text {out } 1}+V_{\text {out } 2}$. This current can be copied to current sources within the op amp with negative feedback so as to keep $V_{\text {out }, C M}$ approximately equal to $V_{\text {REF }}$.
image_name:Figure 9.50 CM sensing circuit with high nonlinearity
description:
[
name: M1, type: NMOS, ports: {S: GND, D: p1, G: Vout1}
name: M2, type: NMOS, ports: {S: p1, D: Vb, G: x1}
name: M3, type: NMOS, ports: {S: GND, D: p2, G: Vout2}
name: M4, type: NMOS, ports: {S: p2, D: Vb, G: x1}
name: M5, type: PMOS, ports: {S: VDD, D: x1, G: x1}
name: I1, type: CurrentSource, value: I1, ports: {Np: p1, Nn: GND}
name: I2, type: CurrentSource, value: I2, ports: {Np: p2, Nn: GND}
]
extrainfo:The circuit is a common-mode sensing circuit with high nonlinearity. It uses NMOS transistors M1, M2, M3, and M4 to sense the common-mode voltage and generate a current I_CM. The PMOS transistor M5 mirrors this current to the current sources in the op-amp. The circuit faces nonlinearity issues due to large swings in Vout1 and Vout2, affecting the proportionality of I_out to the sum of Vout1 and Vout2.

Figure 9.50 CM sensing circuit with high nonlinearity.

The foregoing topology faces serious issues. As $V_{\text {out } 1}$ and $V_{\text {out } 2}$ experience large swings, $I_{\text {out }}$ no longer remains proportional to $V_{\text {out } 1}+V_{\text {out } 2}$ due to the nonlinearity of the differential pairs. In fact, if $I_{D 1}$ and $I_{D 2}$ are expressed as $f\left(V_{\text {out } 1}-V_{R E F}\right)$ and $f\left(V_{\text {out } 2}-V_{R E F}\right)$, respectively, we observe that $I_{D 1}+I_{D 2}$ depends on the individual values of $V_{\text {out } 1}$ and $V_{\text {out } 2}$ unless $f()$ is a linear function. As a result, the reconstructed CM level does not remain constant in the presence of large differential output swings.

### 9.7.3 CM Feedback Techniques

We now study techniques of comparing the measured CM level with a reference and returning the error to the op amp's bias network. In the circuit of Fig. 9.51, we employ a simple amplifier to detect the difference between $V_{\text {out }, C M}$ and a reference voltage, $V_{R E F}$, applying the result to the NMOS current sources with negative feedback. If both $V_{\text {out } 1}$ and $V_{\text {out } 2}$ rise, so does $V_{E}$, thereby increasing the drain currents of $M_{3}-M_{4}$ and lowering the output $C M$ level. In other words, if the loop gain is large, the feedback network forces the CM level of $V_{\text {out } 1}$ and $V_{\text {out } 2}$ to approach $V_{R E F}$. Note that the feedback can be applied to the PMOS current sources as well. Also, the feedback may control only a fraction of the current to allow optimization of
image_name:Figure 9.51
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout1, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: Vout2, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb1}
name: M4, type: NMOS, ports: {S: VE, D: GND, G: Vb3}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb2}
name: M7, type: NMOS, ports: {S: VE, D: Vout2, G: Vb3}
name: M8, type: NMOS, ports: {S: GND, D: VE, G: Vout1}
name: M9, type: NMOS, ports: {S: GND, D: VE, G: Vout2}
name: M10, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb1}
name: R1, type: Resistor, value: R1, ports: {N1: Vout1, N2: Vout2}
name: R2, type: Resistor, value: R2, ports: {N1: Vout2, N2: Vout,CM}
name: A1, type: OpAmp, value: A1, ports: {InP: Vout,CM, InN: VREF, Out: VE}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: Vout1, Nn: GND}
]
extrainfo:This circuit is a folded-cascode operational amplifier with common-mode feedback. The feedback network adjusts the CM level of Vout1 and Vout2 to approach VREF. The op-amp A1 controls the tail current of the input differential pair M1 and M2. The NMOS transistors M8 and M9 are used for common-mode feedback control, while PMOS transistors M3 to M6 form the folded cascode structure.

Figure 9.51 Sensing and controlling output CM level.
the settling behavior. For example, each of $M_{3}$ and $M_{4}$ can be decomposed into two parallel devices, one biased at a constant current and the other driven by the error amplifier.

In a folded-cascode op amp, the CM feedback may control the tail current of the input differential pair. Illustrated in Fig. 9.52, this method increases the tail current if $V_{\text {out } 1}$ and $V_{\text {out } 2}$ rise, lowering the drain currents of $M_{5}-M_{6}$ and restoring the output CM level.
image_name:Figure 9.52
description:
[
name: M1, type: NMOS, ports: {S: Vin, D: Vout,CM, G: Vip}
name: M2, type: NMOS, ports: {S: Vin, D: Vout,CM, G: Vin}
name: M3, type: NMOS, ports: {S: GND, D: Vin, G: Vout,CM}
name: M4, type: NMOS, ports: {S: Vout1, D: Vb3, G: Vb3}
name: M5, type: NMOS, ports: {S: VDD, D: Vout1, G: Vb2}
name: M6, type: NMOS, ports: {S: VDD, D: Vout2, G: Vb2}
name: M7, type: NMOS, ports: {S: Vout2, D: Vb3, G: Vb3}
name: M8, type: NMOS, ports: {S: GND, D: Vb3, G: Vb4}
name: M9, type: NMOS, ports: {S: GND, D: Vb3, G: Vb4}
name: M10, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb1}
name: M11, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb1}
name: R1, type: Resistor, value: R1, ports: {N1: Vout1, N2: Vout,CM}
name: R2, type: Resistor, value: R2, ports: {N1: Vout,CM, N2: Vout2}
name: OpAmp, type: OpAmp, ports: {InP: Vout,CM, InN: VREF, OutP: Vb3}
]
extrainfo:The circuit is a folded-cascode operational amplifier with CM feedback controlling the tail current of the input differential pair. The NMOS and PMOS transistors are configured to manage the output common-mode level. Resistors R1 and R2 are used to adjust the bias current of M5 and M6, thereby controlling the output CM level.

Figure 9.52 Alternative method of controlling output CM level.
How do we perform comparison and feedback with the sensing scheme of Fig. 9.48? Here, the output CM voltage is directly converted to a resistance or a current, prohibiting comparison with a reference voltage. A simple feedback topology utilizing this technique is depicted in Fig. 9.53, where $R_{o n 7} \| R_{o n 8}$ adjusts the bias current of $M_{5}$ and $M_{6}$. The output CM level sets $R_{o n 7} \| R_{\text {on } 8}$ such that $I_{D 5}$ and $I_{D 6}$ exactly balance $I_{D 9}$ and $I_{D 10}$, respectively. For example, if $V_{\text {out } 1}$ and $V_{\text {out } 2}$ rise, $R_{o n 7} \| R_{o n 8}$ falls and the drain currents of $M_{5}$ and $M_{6}$ increase, pulling $V_{\text {out } 1}$ and $V_{\text {out } 2}$ down. Assuming that $I_{D 9}=I_{D 10}=I_{D}$, we must have $V_{b}-V_{G S 5}=2 I_{D}\left(R_{o n 7} \| R_{\text {on } 8}\right)$, and hence $R_{o n 7} \| R_{o n 8}=\left(V_{b}-V_{G S 5}\right) /\left(2 I_{D}\right)$. From (9.49),

$$
\begin{equation*}
\frac{1}{\mu_{n} C_{o x}\left(\frac{W}{L}\right)_{7,8}\left(V_{\text {out } 2}+V_{\text {out } 1}-2 V_{T H}\right)}=\frac{V_{b}-V_{G S 5}}{2 I_{D}} \tag{9.50}
\end{equation*}
$$

image_name:Figure 9.53
description:
[
name: M1, type: PMOS, ports: {S: Vb2, D: s1d9, G: Vb1}
name: M2, type: PMOS, ports: {S: Vb2, D: s2d10, G: Vb1}
name: M3, type: NMOS, ports: {S: s3d5, D: Vout1, G: Vb3}
name: M4, type: NMOS, ports: {S: s4d6, D: Vout2, G: Vb3}
name: M5, type: NMOS, ports: {S: GND, D: s3d5, G: Vb}
name: M6, type: NMOS, ports: {S: GND, D: s4d6, G: Vb}
name: M7, type: NMOS, ports: {S: Vout1, D: GND, G: P}
name: M8, type: NMOS, ports: {S: Vout2, D: GND, G: P}
name: M9, type: PMOS, ports: {S: VDD, D: s1d9, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: s2d10, G: Vb1}
]
extrainfo:This circuit is a common-mode feedback (CMFB) network using triode devices. It features PMOS transistors M1, M2, M9, and M10, and NMOS transistors M3, M4, M5, M6, M7, and M8. The circuit aims to stabilize the common-mode level of the outputs Vout1 and Vout2. The biasing is provided through the nodes Vb1, Vb2, Vb3, and Vb. The circuit uses a combination of transistors to manage the output voltage levels and maintain stability.

Figure 9.53 CMFB using triode devices.
that is,

$$
\begin{equation*}
V_{\text {out } 1}+V_{\text {out } 2}=\frac{2 I_{D}}{\mu_{n} C_{o x}\left(\frac{W}{L}\right)_{7,8}} \frac{1}{V_{b}-V_{G S 5}}+2 V_{T H} \tag{9.51}
\end{equation*}
$$

The CM level can thus be obtained by noting that $V_{G S 5}=\sqrt{2 I_{D} /\left[\mu_{n} C_{o x}(W / L)_{5}\right]}+V_{T H 5}$.
The CMFB network of Fig. 9.53 suffers from several drawbacks. First, the value of the output CM level is a function of device parameters. Second, the voltage drop across $R_{o n 7} \| R_{o n 8}$ limits the output voltage swings. Third, to minimize this drop, $M_{7}$ and $M_{8}$ are usually quite wide devices, introducing substantial capacitance at the output. The second issue can be alleviated by applying the feedback to the tail current of the input differential pair (Fig. 9.54), but the other two remain.
image_name:Figure 9.54
description:
[
name: M1, type: NMOS, ports: {S: X1, D: X3, G: Vip}
name: M2, type: NMOS, ports: {S: X1, D: X4, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X3, G: Vb1}
name: M4, type: PMOS, ports: {S: VDD, D: X4, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb2}
name: M7, type: NMOS, ports: {S: GND, D: Vout2, G: X2}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: X2}
name: M9, type: NMOS, ports: {S: X1, D: X2, G: Vb}
name: M10, type: NMOS, ports: {S: GND, D: Vout1, G: Vb4}
name: M11, type: NMOS, ports: {S: GND, D: Vout2, G: Vb4}
name: M12, type: NMOS, ports: {S: Vout1, D: Vb3, G: Vb3}
name: M13, type: NMOS, ports: {S: Vout2, D: Vb4, G: Vb3}
]
extrainfo:The circuit diagram is a differential amplifier with common-mode feedback (CMFB) using NMOS and PMOS transistors. The circuit controls the output common-mode level by adjusting the tail current of the input differential pair. The PMOS transistors M3, M4, M5, and M6 provide current sources, while NMOS transistors M7, M8, M10, and M11 are used for differential to single-ended conversion. The bias voltages Vb1, Vb2, Vb3, and Vb4 are used to control various stages in the circuit.

Figure 9.54 Alternative method of controlling output CM level.

How is $V_{b}$ generated in Fig. 9.54? We note that $V_{\text {out }, C M}$ is somewhat sensitive to the value of $V_{b}$ : if $V_{b}$ is higher than expected, the tail current of $M_{1}$ and $M_{2}$ increases and the output CM level falls. Since the feedback through $M_{7}$ and $M_{8}$ attempts to correct this error, the overall change in $V_{\text {out }, C M}$ depends on the loop gain in the CMFB network. This is studied in the following example.

#### Example 9.18

For the circuit of Fig. 9.54, determine the sensitivity of $V_{\text {out }, C M}$ to $V_{b}$, i.e., $d V_{\text {out }, C M} / d V_{b}$.

#### Solution

Setting $V_{i n}$ to zero and opening the loop at the gates of $M_{7}$ and $M_{8}$, we simplify the circuit as shown in Fig. 9.55. Note that $g_{m 7}$ and $g_{m 8}$ must be calculated in the triode region: $g_{m 7}=g_{m 8}=\mu_{n} C_{o x}(W / L)_{7,8} V_{D S 7,8}$, where $V_{D S 7,8}$ denotes the bias value of the drain-source voltage of $M_{7}$ and $M_{8}$. Since $M_{7}$ and $M_{8}$ operate in the deep triode region, $V_{D S 7,8}$ is typically less than 100 mV .

In a well-designed circuit, the loop gain must be relatively high. We therefore surmise that the closed-loop gain is approximately equal to $1 / \beta$, where $\beta$ represents the feedback factor. We write from Chapter 8 :

$$
\begin{align*}
\beta & =\left.\frac{V_{2}}{V_{1}}\right|_{I 2=0}  \tag{9.52}\\
& =-\left(g_{m 7}+g_{m 8}\right)\left(R_{\text {on7 }} \| R_{\text {on8 }}\right) \tag{9.53}
\end{align*}
$$

image_name:Figure 9.55
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X1, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: X1, G: Vin}
name: M5, type: PMOS, ports: {S: VDD, D: X1, G: Vout,CM}
name: M6, type: PMOS, ports: {S: VDD, D: X1, G: Vout,CM}
name: M9, type: NMOS, ports: {S: GND, D: Sq, G: Vb}
name: Ron7, type: Resistor, value: Ron7, ports: {N1: Sq, N2: GND}
name: Ron8, type: Resistor, value: Ron8, ports: {N1: Sq, N2: GND}
name: IF, type: CurrentSource, value: IF, ports: {Np: Sq, Nn: GND}
name: ro3, type: Resistor, value: ro3, ports: {N1: X1, N2: Vout,CM}
name: ro4, type: Resistor, value: ro4, ports: {N1: X1, N2: Vout,CM}
name: d56, type: Diode, value: d56, ports: {Na: Vout,CM, Nc: GND}
]
extrainfo:This circuit is a feedback network with NMOS and PMOS transistors forming a differential pair. The feedback network includes resistors Ron7 and Ron8, a current source IF, and a diode d56. The feedback factor is related to the transconductance of the transistors and the resistances Ron7 and Ron8.

Figure 9.55

$$
\begin{align*}
& =-2 \mu_{n} C_{o x}\left(\frac{W}{L}\right)_{7,8} V_{D S 7,8} \cdot \frac{1}{2 \mu_{n} C_{o x}(W / L)_{7,8}\left(V_{G S 7,8}-V_{T H 7,8}\right)}  \tag{9.54}\\
& =-\frac{V_{D S 7,8}}{V_{G S 7,8}-V_{T H 7,8}} \tag{9.55}
\end{align*}
$$

where $V_{G S 7,8}-V_{T H 7,8}$ denotes the overdrive voltage of $M_{7}$ and $M_{8}$. Thus,

$$
\begin{equation*}
\left|\frac{d V_{\text {out }, C M}}{d V_{b}}\right|_{\text {closed }} \approx \frac{V_{G S 7,8}-V_{T H 7,8}}{V_{D S 7,8}} \tag{9.56}
\end{equation*}
$$

This is an important result. Since $V_{G S 7,8}$ (i.e., the output CM level) is typically in the vicinity of $V_{D D} / 2$, the above equation suggests that $V_{D S 7,8}$ must be maximized to minimize this sensitivity, but at the cost of the loop gain.

We now introduce a modification to the circuit of Fig. 9.54 that both makes the output level relatively independent of device parameters and lowers the sensitivity to the value of $V_{b}$. Illustrated in Fig. 9.56(a), the idea is to define $V_{b}$ by a current mirror arrangement such that $I_{D 9}$ "tracks" $I_{1}$ and $V_{R E F}$. For simplicity, $\operatorname{suppose}(W / L)_{15}=(W / L)_{9}$ and $(W / L)_{16}=(W / L)_{7}+(W / L)_{8}$. Thus, $I_{D 9}=I_{1}$ only if $V_{\text {out }, C M}=V_{R E F}$. In other words, as with Fig. 9.52, the circuit produces an output CM level equal to a reference but it requires no resistors in sensing $V_{\text {out }, C M}$. The overall design can be simplified as shown in Fig. 9.56(b).

In practice, since $V_{D S 15} \neq V_{D S 9}$, channel-length modulation results in a finite error. Figure 9.57 depicts a modification that suppresses this error. Here, transistors $M_{17}$ and $M_{18}$ reproduce at the drain of $M_{15}$ a voltage equal to the source voltage of $M_{1}$ and $M_{2}$, ensuring that $V_{D S 15}=V_{D S 9}$.

To arrive at another CM feedback topology, let us consider the simple differential pair shown in Fig. 9.58(a). Here, the output CM level, $V_{D D}-\left|V_{G S 3,4}\right|$, is relatively well defined, but the voltage gain is quite low. To increase the differential gain, the PMOS devices must operate as current sources for differential signals. We therefore modify the circuit as depicted in Fig. 9.58(b), where for differential changes at $V_{\text {out } 1}$ and $V_{\text {out } 2}$, node $P$ is a virtual ground and the gain can be expressed as $g_{m 1,2}\left(r_{O 1,2}\left\|r_{O 3,4}\right\| R_{F}\right)$. We preferably choose $R_{F} \gg r_{O 1,2} \| r_{O 3,4}$. For common-mode levels, on the other hand, $M_{3}$ and $M_{4}$ operate as diode-connected devices. The circuit proves useful in low-gain applications.
image_name:Figure 9.58 (a)
description:
[
name: M1, type: NMOS, ports: {S: X1, D: X2, G: Vip}
name: M2, type: NMOS, ports: {S: X1, D: X3, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X4, G: Vb1}
name: M4, type: PMOS, ports: {S: VDD, D: X4, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Vout2, G: Vb2}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: X1}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: X1}
name: M9, type: NMOS, ports: {S: X1, D: Vin, G: Vb}
name: M10, type: NMOS, ports: {S: GND, D: Vb3, G: Vb4}
name: M11, type: NMOS, ports: {S: GND, D: Vb3, G: Vb4}
name: M12, type: NMOS, ports: {S: Vb3, D: Vout1, G: Vb3}
name: M13, type: NMOS, ports: {S: Vb3, D: Vout2, G: Vb3}
name: M15, type: NMOS, ports: {S: GND, D: Vb, G: Vb}
name: M16, type: NMOS, ports: {S: GND, D: Vb, G: Vb}
name: I1, type: CurrentSource, ports: {Np: VDD, Nn: Vb}
]
extrainfo:The circuit in Figure 9.58 (a) is a differential pair using diode-connected loads. It is designed for low-gain applications with differential signals. The PMOS transistors M3 and M4 are diode-connected for common-mode levels. The circuit is modified to handle differential changes at Vout1 and Vout2 with node P acting as a virtual ground. The gain expression is gm1,2(ro1,2 || ro3,4 || RF), with RF preferably much larger than ro1,2 || ro3,4.
image_name:Figure 9.58 (b)
description:
[
name: M1, type: NMOS, ports: {S: X3, D: X1, G: Vip}
name: M2, type: NMOS, ports: {S: X3, D: Vin, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X2, G: Vb1}
name: M4, type: PMOS, ports: {S: VDD, D: X2, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: X3, G: Vb1}
name: M6, type: PMOS, ports: {S: VDD, D: X3, G: Vb1}
name: M7, type: NMOS, ports: {S: Vout1, D: X1, G: Vb}
name: M8, type: NMOS, ports: {S: Vout1, D: X1, G: Vb}
name: M9, type: NMOS, ports: {S: X1, D: Vin, G: Vb}
name: M10, type: NMOS, ports: {S: GND, D: Vout2, G: Vb3}
name: M11, type: NMOS, ports: {S: GND, D: Vout2, G: Vb3}
name: M12, type: NMOS, ports: {S: GND, D: Vout1, G: Vb2}
name: M13, type: NMOS, ports: {S: GND, D: Vout1, G: Vb2}
name: M15, type: NMOS, ports: {S: GND, D: Vb, G: Vb}
name: M16, type: NMOS, ports: {S: GND, D: Vb, G: Vb}
name: I1, type: CurrentSource, ports: {Np: VDD, Nn: Vb}
]
extrainfo:The circuit in Figure 9.58(b) is a differential amplifier with diode-connected loads for common-mode feedback. It uses both NMOS and PMOS transistors for differential and common-mode signal processing. The PMOS transistors M3-M6 form the load for the differential pair M1 and M2. The circuit is designed for low-gain applications with a virtual ground at node P for differential signals. The gain is determined by the transconductance and output resistances of the transistors and the feedback resistor RF, which is chosen to be much larger than the output resistances.

Figure 9.56 Modification of CMFB for more accurate définition of output CM level.
image_name:Figure 9.56
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout1, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout2, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: Vout2, G: Vout1}
name: M4, type: PMOS, ports: {S: VDD, D: Vout1, G: Vout2}
name: M5, type: PMOS, ports: {S: VDD, D: Vout2, G: Vout2}
name: M6, type: PMOS, ports: {S: VDD, D: Vout1, G: Vout1}
name: M7, type: NMOS, ports: {S: GND, D: Vb, G: Vb}
name: M8, type: NMOS, ports: {S: GND, D: Vb, G: Vb}
name: M9, type: NMOS, ports: {S: GND, D: Vb, G: Vb}
name: M10, type: NMOS, ports: {S: GND, D: Vout1, G: Vb}
name: M11, type: NMOS, ports: {S: GND, D: Vout2, G: Vb}
name: M12, type: NMOS, ports: {S: GND, D: Vout1, G: Vout1}
name: M13, type: NMOS, ports: {S: GND, D: Vout2, G: Vout2}
name: M15, type: NMOS, ports: {S: GND, D: Vb, G: VREF}
name: M16, type: NMOS, ports: {S: GND, D: Vb, G: VREF}
name: M17, type: NMOS, ports: {S: GND, D: Vin, G: Vin}
name: M18, type: NMOS, ports: {S: GND, D: Vin, G: Vin}
name: I1, type: CurrentSource, ports: {Np: VDD, Nn: Vout1}
]
extrainfo:The circuit is a differential amplifier with PMOS loads (M3-M6) and NMOS differential pair (M1, M2). It includes common-mode feedback (CMFB) with NMOS transistors (M7-M13) and uses current source I1 for biasing. The NMOS transistors M15 and M16 are used for reference voltage VREF.

Figure 9.57 Modification to suppress error due to channel-length modulation.
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Voutp, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: Voutn, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: Voutp, G: Voutp}
name: M4, type: PMOS, ports: {S: VDD, D: Voutn, G: Voutn}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: Vout, Nn: GND}
]
extrainfo:The circuit is a differential amplifier with PMOS loads (M3, M4) and an NMOS differential pair (M1, M2). It includes a current source ISS for biasing. The configuration allows for differential input with outputs Voutp and Voutn.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: ISS, D: Voutp, G: Vip}
name: M2, type: NMOS, ports: {S: ISS, D: Voutn, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: Voutp, G: Voutp}
name: M4, type: PMOS, ports: {S: VDD, D: Voutn, G: Voutn}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: ISS, Nn: GND}
name: RF, type: Resistor, value: RF, ports: {N1: Voutp, N2: Voutn}
]
extrainfo:The circuit is a differential amplifier with a resistive common-mode feedback (CMFB). It uses PMOS transistors M3 and M4 as diode-connected loads and an NMOS differential pair (M1, M2). The current source ISS provides biasing. The resistors RF provide feedback from the outputs to stabilize the common-mode voltage.
image_name:(c)
description:
[
name: M3, type: PMOS, ports: {S: VDD, D: d3, G: d3}
name: M4, type: PMOS, ports: {S: VDD, D: d4, G: d4}
name: RF, type: Resistor, value: RF, ports: {N1: d3, N2: P}
name: RF, type: Resistor, value: RF, ports: {N1: d4, N2: P}
name: LOAD1, type: Resistor, value: LOAD1, ports: {N1: P, N2: GND}
name: LOAD2, type: Resistor, value: LOAD2, ports: {N1: P, N2: GND}
name: I1, type: CurrentSource, value: I1, ports: {Np: P, Nn: GND}
]
extrainfo:This circuit is a modification of a differential amplifier to allow low-voltage operation. It includes PMOS transistors (M3, M4) as loads and uses resistors (RF) for feedback. The current source (I1) is used for biasing.

Figure 9.58 (a) Differential pair using diode-connected loads, (b) resistive CMFB, and (c) modification to allow low-voltage operation.

#### Example 9.19

Determine the maximum allowable output swings in Fig. 9.58(b).

#### Solution

Each output can fall to two overdrive voltages above ground if $V_{i n, C M}$ is chosen to place $I_{S S}$ at the edge of the triode region. The highest level allowed at the output is equal to the output CM level plus $\left|V_{T H 3,4}\right|$, i.e., $V_{D D}-\left|V_{G S 3,4}\right|+\left|V_{T H 3,4}\right|=V_{D D}-\left|V_{G S 3,4}-V_{T H 3,4}\right|$.

In some applications, we wish to operate the circuit of Fig. 9.58(b) with a low supply voltage, but for small signals. This stage dictates a minimum $V_{D D}$ of $\left|V_{G S 3,4}\right|$ plus two overdrive voltages. We modify the circuit by drawing a small current from the two resistors and PMOS devices as illustrated in Fig. 9.58(c). Here, $V_{P}$ is still equal to $V_{D D}-\left|V_{G S 3,4}\right|$, but the drain voltages are higher than $V_{P}$ by an amount equal to $I_{1} R_{F} / 2$. For example, if $I_{1} R_{F} / 2=\left|V_{T H 3,4}\right|$, then the PMOS devices operate at the edge of saturation, allowing a minimum $V_{D D}$ of three overdrive voltages.

#### Example 9.20

Facing voltage headroom limitations, a student constructs the circuit shown in Fig. 9.59(a), where the tail current source is replaced by two triode devices that sense the output CM level, $V_{\text {out }, C M}$. Determine the small-signal gain from the input CM level to the output CM level.
image_name:(a)
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: P, G: Vb1}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: Vb2}
name: M3, type: PMOS, ports: {S: VDD, D: x1, G: g5}
name: M4, type: PMOS, ports: {S: VDD, D: x1, G: g6}
name: M5, type: NMOS, ports: {S: g5, D: GND, G: Vin,CM}
name: M6, type: NMOS, ports: {S: g6, D: GND, G: Vin,CM}
name: I1, type: CurrentSource, value: I1, ports: {Np: x1, Nn: GND}
name: Rtail, type: Resistor, value: Rtail, ports: {N1: P, N2: GND}
name: ro3,4, type: Resistor, value: ro3,4/2, ports: {N1: Vout, N2: d12}
]
extrainfo:The circuit is a differential amplifier with PMOS and NMOS transistors. It uses a current source I1 and resistors Rtail and ro3,4/2. The PMOS transistors M3 and M4 are arranged in a cascode configuration to enhance output impedance. The NMOS transistors M5 and M6 serve as a tail current source, sensing the output common-mode level.
image_name:(b)
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: Vout, G: Vin,CM}
name: M2, type: PMOS, ports: {S: VDD, D: Vout, G: Vin,CM}
name: M3, type: PMOS, ports: {S: VDD, D: Vout,CM, G: g1}
name: M4, type: PMOS, ports: {S: VDD, D: Vout,CM, G: g1}
name: M5, type: NMOS, ports: {S: GND, D: P, G: Vout}
name: M6, type: NMOS, ports: {S: GND, D: P, G: Vout}
name: I1, type: CurrentSource, value: I1, ports: {Np: VDD, Nn: GND}
name: Rtail, type: Resistor, value: Rtail, ports: {N1: P, N2: GND}
name: ro3,4, type: Resistor, value: ro3,4/2, ports: {N1: Vout,CM, N2: d12}
name: gm,tail, type: VoltageControlledCurrentSource, value: gm,tail, ports: {Np: Vout,CM, Nn: GND}
]
extrainfo:The circuit in Figure 9.59(b) is a differential amplifier with PMOS input pairs (M1, M2) and NMOS tail current sources (M5, M6). The PMOS transistors M3 and M4 form a current mirror, providing a bias current to the output. The circuit is designed to amplify the common-mode input voltage (Vin,CM) to the common-mode output voltage (Vout,CM). The resistors Rtail and ro3,4/2, along with the voltage-controlled current source gm,tail, help to stabilize the output common-mode level.
image_name:(c)
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: d12, G: Vin,CM}
name: M2, type: PMOS, ports: {S: VDD, D: d12, G: Vin,CM}
name: M5, type: NMOS, ports: {S: GND, D: P, G: Vout,CM}
name: M6, type: NMOS, ports: {S: GND, D: P, G: Vout,CM}
name: I1, type: CurrentSource, ports: {Np: d12, Nn: P}
name: r03,4, type: Resistor, value: r03,4, ports: {N1: d12, N2: Vout,CM}
name: Rtail, type: Resistor, value: Rtail, ports: {N1: P, N2: GND}
]
extrainfo:The circuit in diagram (c) is a differential amplifier with a tail current source replaced by two NMOS transistors M5 and M6. It senses the output common-mode level Vout,CM. The PMOS transistors M1 and M2 form the input differential pair. The resistor r03,4 is connected to the output node Vout,CM. The circuit aims to control the output common-mode voltage using the transconductance gm,tail.

Figure 9.59

#### Solution

If the circuit is symmetric, the output nodes can be shorted, leading to the topology in Fig. 9.59(b). ${ }^{6}$ To model the composite transistor $M_{5}+M_{6}$, we define a transconductance $g_{m, \text { tail }}=g_{m 5}+g_{m 6}=2 \mu_{n} C_{o x}(W / L)_{5,6} V_{P}$, where $V_{P}$ is the dc voltage at node $P$. We also approximate their total channel resistance by $R_{\text {tail }}=\left[2 \mu_{n} C_{o x}(W / L)_{5,6}\left(V_{\text {out }, C M}-\right.\right.$ $\left.\left.V_{T H 5,6}\right)\right]^{-1}$. The circuit therefore reduces to that shown in Fig. 9.59(c).

Assuming for simplicity that $\lambda=\gamma=0$ for $M_{1}$ and $M_{2}$, we express the small-signal current drawn by $M_{1}+M_{2}$ as $-V_{\text {out }, C M} /\left(r_{O 3,4} / 2\right)$. This current translates to a gate-source voltage of $-V_{\text {out }} /\left(2 g_{m 1,2} r_{O 3,4} / 2\right)=$ $-V_{\text {out }} /\left(g_{m 1,2} r_{O 3,4}\right)$, yielding a voltage of $V_{\text {in }, C M}+V_{\text {out }} /\left(g_{m 1,2} r_{O 3,4}\right)$ at node $P$ and hence a current of $\left[V_{\text {in }, C M}+\right.$ $\left.V_{\text {out }} /\left(g_{m 1,2} r_{O 3,4}\right)\right] / R_{\text {tail }}$ through $R_{\text {tail }}$. Since this current and $g_{m, \text { tail }} V_{\text {out }, C M}$ must add up to $-V_{\text {out }, C M} /\left(r_{O 3,4} / 2\right)$, we obtain

$$
\begin{equation*}
\frac{V_{\text {out }, C M}}{V_{\text {in }, C M}}=-\frac{1}{\frac{2 R_{\text {tail }}}{r_{O 3,4}}+g_{m, \text { tail }} R_{\text {tail }}+\left(g_{m 1,2} r_{O 3,4}\right)^{-1}} \tag{9.57}
\end{equation*}
$$

It is important to note that all of the three terms in the denominator are less than one (why?), revealing that $V_{\text {out }, C M} / V_{\text {in, } C M}$ is roughly around unity. That is, an error in the input CM level reaches the output without significant attenuation. This observation suggests a poor CMRR; the reader is encouraged to assume a $g_{m}$ mismatch between $M_{1}$ and $M_{2}$ and compute the CMRR as outlined in Chapter 4.

### 9.7.4 CMFB in Two-Stage Op Amps

Offering nearly rail-to-rail output swings, two-stage op amps find wider application than other topologies in today's designs. However, such op amps require more complex common-mode feedback. To understand the issues, we consider three different CMFB methods in the context of the simple circuit shown in Fig. 9.60(a).

First, suppose the CM level of $V_{\text {out } 1}$ and $V_{\text {out } 2}$ is sensed and the result is used to control only $V_{b 2}$; i.e., the second stage incorporates CMFB, but not the first stage [Fig. 9.60(b)]. In this case, no mechanism exists that controls the CM level at $X$ and $Y$. For example, if $I_{S S}$ happens to be less than the sum of the currents that $M_{3}$ and $M_{4}$ wish to draw, then $V_{X}$ and $V_{Y}$ rise, driving these transistors into the triode region so that $I_{D 3}+I_{D 4}$ eventually becomes equal to $I_{S S}$. This effect also reduces $\left|V_{G S 5,6}\right|$, establishing in $M_{5}-M_{8}$ a current that may be well below the nominal value. This CMFB method is therefore not desired.

Second, we still sense the CM level $V_{\text {out } 1}$ and $V_{\text {out } 2}$ but return the result to the first stage, e.g., to $I_{S S}$ [Fig. 9.60(c)]. Suppose, for example, that $V_{\text {out } 1}$ and $V_{\text {out } 2}$ begin too high. Then, the error amplifier, $A_{e}$, reduces $I_{S S}$, allowing $V_{X}$ and $V_{Y}$ to rise, $\left|I_{D 5}\right|$ and $\left|I_{D 6}\right|$ to fall, and $V_{\text {out } 1}$ and $V_{\text {out } 2}$ to go down. It is interesting to note that here $M_{5}$ and $M_{6}$ in fact sense the CM level at $X$ and $Y$, helping the global loop control both stages' CM level. (If $M_{3}$ and $M_{4}$ had a tail current, as in a regular differential pair, this property would vanish and the CMFB loop would fail.)

While used in some designs, the second technique suffers from a critical drawback. Let us draw the equivalent circuit for common-mode levels (Fig. 9.61). How many poles does the CM feedback loop contain? We count one pole at $X$ or $Y$, one at the main output, and at least one associated with the error amplifier. Moreover, since $R_{C M}$ is so large as not to load the second stage, it forms with the input capacitance of $A_{e}$ a pole that may not be negligible. Thus, even if the pole at the source of $M_{1}$ and $M_{2}$ is discounted, the CMFB loop still contains three or four poles. As explained in Chapter 10, this many poles make it difficult for the loop be stable.

In order to avoid stability issues, we can employ two separate CMFB loops for the first and second stages of the op amp. Figure 9.62 illustrates a simple example [7], where, in a manner similar to Fig. 9.58(b),

[^65]image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: p, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: p, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: Vb2}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vb2}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vb2}
name: I_SS, type: CurrentSource, ports: {Np: p, Nn: GND}
name: A_e, type: OpAmp, ports: {InP: Vout1, InN: Vout2, Out: VREF}
]
extrainfo:The circuit is a two-stage operational amplifier with a common-mode feedback (CMFB) loop. The first stage uses NMOS transistors M1 and M2, with PMOS loads M3 and M4. The second stage uses NMOS transistors M7 and M8, with PMOS loads M5 and M6. The CMFB loop is implemented using an op-amp A_e, which senses the common-mode voltage at the outputs and adjusts the bias voltage Vb2.
image_name:(b)
description:
[
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vb2}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vb1}
name: Ae, type: OpAmp, value: Ae, ports: {InP: VREF, InN: CM Sense, Out: Vb2}
]
extrainfo:The diagram represents a CMFB loop around the second stage of a two-stage op amp. The CMFB loop uses a common-mode sense block and an operational amplifier to control the gate voltages of NMOS transistors M7 and M8, stabilizing the output common-mode voltage.
image_name:(c)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: p, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: p, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: p}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: p}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vb2}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vb2}
name: Iss, type: CurrentSource, ports: {Np: p, Nn: GND}
name: Ae, type: OpAmp, ports: {InP: Vout2, InN: VREF, Out: Vb2}
]
extrainfo:This circuit diagram represents a two-stage operational amplifier with a common-mode feedback (CMFB) loop. The first stage uses transistors M1, M2, M3, and M4, while the second stage involves M5, M6, M7, and M8. The CMFB loop is implemented using an operational amplifier (Ae) to stabilize the output common-mode voltage by adjusting the gate voltage Vb2 of the NMOS transistors M7 and M8.

Figure 9.60 (a) Two-stage op amp, (b) CMFB around second stage, and (c) CMFB from second stage to first stage.
image_name:Figure 9.60 (a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X, G: Vin2}
name: M2, type: NMOS, ports: {S: GND, D: Y, G: Vin2}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: Vin1}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vin1}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1, G: X}
name: M6, type: PMOS, ports: {S: VDD, D: Vout2, G: Y}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vin3}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vin3}
name: I1, type: CurrentSource, value: I1, ports: {Np: GND, Nn: X}
name: Ae, type: OpAmp, value: Ae, ports: {InP: Vout1, InN: VREF, OutP: Vb2}
name: RCM, type: Resistor, value: RCM, ports: {N1: Vb2, N2: Vout2}
]
extrainfo:The circuit is a two-stage operational amplifier with a common-mode feedback (CMFB) loop. The first stage consists of NMOS transistors M1 and M2, and PMOS transistors M3 and M4. The second stage includes PMOS transistors M5 and M6, and NMOS transistors M7 and M8. The CMFB loop is implemented using an operational amplifier (Ae) to stabilize the output common-mode voltage by adjusting the gate voltage Vb2 of the NMOS transistors M7 and M8. Resistor RCM is used for CMFB sensing.
image_name:Figure 9.60 (b)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X, G: Vin2}
name: M2, type: NMOS, ports: {S: GND, D: Y, G: Vin2}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: Vin1}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vin1}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1, G: Vout2}
name: M6, type: PMOS, ports: {S: VDD, D: Vout2, G: Vout1}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vin3}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vin3}
name: I1, type: CurrentSource, value: I1, ports: {Np: GND, Nn: X}
name: Ae, type: OpAmp, value: Ae, ports: {InP: Vout2, InN: VREF, OutP: Vb2, OutN: ', Vdd: , -Vdd:}
name: RCM, type: Resistor, value: RCM, ports: {N1: Vb2, N2: Vout2'}
]
extrainfo:The circuit is a two-stage operational amplifier with a common-mode feedback (CMFB) loop. The first stage consists of transistors M1, M2, M3, and M4, while the second stage includes M5, M6, M7, and M8. The CMFB loop is implemented using an operational amplifier (Ae) to stabilize the output common-mode voltage by adjusting the gate voltage Vb2 of the NMOS transistors M7 and M8. Resistor RCM provides feedback for the second stage.
image_name:Figure 9.60 (c)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X,Y, G: Vin2}
name: M2, type: NMOS, ports: {S: GND, D: X,Y, G: Vin2}
name: M3, type: PMOS, ports: {S: VDD, D: X,Y, G: Vin1}
name: M4, type: PMOS, ports: {S: VDD, D: X,Y, G: Vin1}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1,Vout2, G: X,Y}
name: M6, type: PMOS, ports: {S: VDD, D: Vout1,Vout2, G: X,Y}
name: M7, type: NMOS, ports: {S: GND, D: Vout1,Vout2, G: Vin3}
name: M8, type: NMOS, ports: {S: GND, D: Vout1,Vout2, G: Vin3}
name: I1, type: CurrentSource, value: I1, ports: {Np: GND, Nn: X,Y}
name: A_e, type: OpAmp, ports: {InP: Vout1,Vout2, InN: VREF, OutP: Vb2}
]
extrainfo:The circuit is a two-stage operational amplifier with a common-mode feedback (CMFB) loop. The first stage uses transistors M1, M2, M3, and M4, while the second stage involves M5, M6, M7, and M8. The CMFB loop is implemented using an operational amplifier (Ae) to stabilize the output common-mode voltage by adjusting the gate voltage Vb2 of the NMOS transistors M7 and M8.

Figure 9.61 Equivalent CMFB loop to determine the number of poles.
$R_{1}$ and $R_{2}$ provide CMFB for the first stage and $R_{3}$ and $R_{4}$ for the second. Interestingly, all of the drain currents in this topology are copied from $I_{S S}$. Assuming a symmetric circuit, we recognize that (1) resistors $R_{1}$ and $R_{2}$ adjust $V_{G S 3,4}$ until $\left|I_{D 3}\right|=\left|I_{D 4}\right|=I_{S S} / 2$; (2) since $V_{G S 3,4}=V_{G S 5,6}, M_{5}$ and $M_{6}$ copy their currents from $M_{3}$ and $M_{4}$ as in a current mirror; and (3) resistors $R_{3}$ and $R_{4}$ adjust $V_{G S 7,8}$ until $I_{D 7}=I_{D 8}=\left|I_{D 5}\right|=\left|I_{D 6}\right|$. The differential voltage gain is equal to $g_{m 1}\left(r_{O 1}\left\|r_{O 3}\right\| R_{1}\right) g_{m 5}\left(r_{O 5}\left\|r_{O 7}\right\| R_{3}\right)$. Another CMFB technique for two-stage op amps is described in Chapter 11.
image_name:Figure 9.62 Simple CMFB loops
description:
[
name: M1, type: NMOS, ports: {S: P, D: X, G: Vip}
name: M2, type: NMOS, ports: {S: P, D: Y, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Y}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: Y}
name: M7, type: NMOS, ports: {S: GND, D: Q, G: dn}
name: M8, type: NMOS, ports: {S: GND, D: Q, G: d8}
name: R1, type: Resistor, value: R1, ports: {N1: X, N2: Y}
name: R2, type: Resistor, value: R2, ports: {N1: X, N2: Y}
name: R3, type: Resistor, value: R3, ports: {N1: dn, N2: Q}
name: R4, type: Resistor, value: R4, ports: {N1: d8, N2: Q}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit diagram represents a simple common-mode feedback (CMFB) loop around each stage of a two-stage operational amplifier. It includes current mirrors and differential amplifier configurations to manage current and voltage levels, with resistors R3 and R4 adjusting Vgs7,8 until Id7 = Id8 = |Id5| = |Id6|. The differential voltage gain is given by gm1(ro1||ro3||R1) gm5(ro5||ro7||R3). The output common-mode level is determined by Vg7,8, and the circuit is designed to maintain a balanced output swing.

Figure 9.62 Simple CMFB loops
around each stage.

#### Example 9.21

A student delighted by the simplicity of the op amp in Fig. 9.62 designs the circuit for a given power budget, but realizes that the output CM level is inevitably well below $V_{D D} / 2$, and hence the output swings are limited. Explain why and devise a solution.

#### Solution

The output CM level is equal to $V_{G 7,8}$ (recall that $R_{3}$ and $R_{4}$ carry no current in the absence of signals). Since $M_{7}$ and $M_{8}$ are chosen wide enough for a small overdrive voltage, $V_{G S 7,8}$ is only slightly greater than one threshold voltage and far from $V_{D D} / 2$.

This issue can be resolved by drawing a small current from node $Q$ (Fig. 9.63). Now, $R_{3}$ and $R_{4}$ sustain a drop of $R_{3} I_{Q} / 2\left(=R_{4} I_{Q} / 2\right)$, producing an upward shift of the same amount in the output CM level [7]. Thus, $I_{Q}$ can be chosen to create an output CM level around $V_{D D} / 2$
image_name:Figure 9.63
description:
[
name: M7, type: NMOS, ports: {S: GND, D: d1, G: Q}
name: M8, type: NMOS, ports: {S: GND, D: d8, G: Q}
name: R3, type: Resistor, value: R3, ports: {N1: d1, N2: Q}
name: R4, type: Resistor, value: R4, ports: {N1: d8, N2: Q}
name: IQ, type: CurrentSource, value: IQ, ports: {Np: Q, Nn: GND}
]
extrainfo:The circuit is designed to adjust the output common-mode level by using resistors R3 and R4 in conjunction with a current source IQ. The NMOS transistors M7 and M8 are configured to draw current through nodes d1 and d8, respectively, with their gates connected to node Q.

Figure 9.63

If the first stage incorporates a telescopic cascode to achieve a high gain, then the CMFB loops can be realized as shown in Fig. 9.64. While not precise, the CM sensing of $X$ and $Y$ avoids loading the high impedances at these nodes, thereby maintaining a high voltage gain.

## 9.8 ■ Input Range Limitations

The op amp circuits studied thus far have evolved to achieve large differential output swings. While the differential input swings are usually much smaller (by a factor equal to the open-loop gain), the input common-mode level may need to vary over a wide range in some applications. For example, consider the simple unity-gain buffer shown in Fig. 9.65, where the input swing is nearly equal to the output swing. Interestingly, in this case the voltage swings are limited by the input differential pair rather than the output
image_name:Figure 9.64 CMFB loops around cascode and output stages
description:
[
name: M1, type: PMOS, ports: {S: VDD, D: x, G: Vb2}
name: M2, type: PMOS, ports: {S: VDD, D: x, G: Vb1}
name: M3, type: PMOS, ports: {S: VDD, D: y, G: Vb1}
name: M4, type: PMOS, ports: {S: VDD, D: y, G: Vb2}
name: M5, type: PMOS, ports: {S: VDD, D: X, G: Vbx}
name: M6, type: PMOS, ports: {S: VDD, D: Y, G: Vbx}
name: M7, type: NMOS, ports: {S: x, D: p, G: Vin1}
name: M8, type: NMOS, ports: {S: y, D: p, G: Vin2}
name: M9, type: NMOS, ports: {S: p, D: X, G: Vin1}
name: M10, type: NMOS, ports: {S: p, D: Y, G: Vin2}
name: M11, type: NMOS, ports: {S: GND, D: x, G: p}
name: M12, type: NMOS, ports: {S: GND, D: y, G: p}
name: M13, type: NMOS, ports: {S: GND, D: Vout1, G: p2}
name: M14, type: NMOS, ports: {S: GND, D: Vout2, G: p2}
name: R1, type: Resistor, value: R1, ports: {N1: Vout1, N2: p2}
name: R2, type: Resistor, value: R2, ports: {N1: Vout2, N2: p2}
name: I1, type: CurrentSource, value: I1, ports: {Np: p2, Nn: GND}
]
extrainfo:The circuit is a CMFB loop around cascode and output stages. It uses a combination of PMOS and NMOS transistors to achieve differential output swings, with inputs Vin1 and Vin2. The circuit also includes resistors R1 and R2 and a current source I1 for biasing and stabilization.

Figure 9.64 CMFB loops around cascode and output stages.
image_name:Figure 9.65 Unity-gain buffer
description:The system block diagram titled "Figure 9.65 Unity-gain buffer" illustrates a unity-gain buffer circuit, which is designed to provide a voltage output equal to the voltage input, effectively isolating the input from the output. This configuration is often used to prevent loading effects in circuits.

Main Components:
1. **Operational Amplifier (A1):**
- The core component of the unity-gain buffer. It is configured in a negative feedback loop with its output connected directly to its inverting input.
- The non-inverting input receives the input signal \(V_{in}\), and the output \(V_{out}\) is fed back to the inverting input, ensuring the output follows the input.

2. **MOS Transistors (M1 to M10):**
- **M1 and M2:** Act as differential pair transistors receiving the input signal \(V_{in}\) and contributing to the differential amplification process.
- **M3 to M8:** Form cascode and biasing structures to enhance the gain and bandwidth, and improve the output impedance characteristics.
- **M9 and M10:** Operate as load transistors, setting the output stage characteristics and providing bias voltages \(V_{b1}\) and \(V_{b2}\).

3. **Current Source (I_{SS}):**
- Provides a constant current for biasing the differential pair (M1 and M2), stabilizing the operation of the circuit.

Flow of Information or Control:
- The input voltage \(V_{in}\) is applied to the non-inverting terminal of the operational amplifier and the gate of M1.
- The operational amplifier ensures that \(V_{out}\) is maintained equal to \(V_{in}\) by adjusting the output through its feedback loop.
- The differential pair (M1 and M2) processes the input signal, with the current source \(I_{SS}\) providing necessary biasing.
- The cascode arrangement (M3 to M8) enhances the performance by increasing output impedance and improving gain.
- The output signal \(V_{out}\) is taken from the drain of M2, buffered and stabilized by the output stage transistors (M9 and M10).

Labels, Annotations, and Key Indicators:
- **\(V_{in}\) and \(V_{out}\):** Indicate the input and output voltages.
- **\(V_{b1}, V_{b2}, V_{b3}:** Bias voltages provided to various transistors to set their operating points.
- **\(I_{SS}:** Current source providing biasing current.

Overall System Function:
The primary function of this unity-gain buffer is to provide an output voltage \(V_{out}\) that is equal to the input voltage \(V_{in}\) with high input impedance and low output impedance. This is achieved through the feedback configuration of the operational amplifier and the use of MOS transistors in cascode and differential pair configurations to maintain signal integrity and stability across the buffer.
image_name:Figure 9.64 CMFB loops around cascode and output stages
description:
[
name: A1, type: OpAmp, ports: {InP: Vin, InN: Vout, OutP: Vout}
name: M1, type: NMOS, ports: {S: p, D: X, G: Vin}
name: M2, type: NMOS, ports: {S: p, D: Y, G: Vout}
name: M3, type: PMOS, ports: {S: VDD, D: Vout, G: Vb2}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: Vb2}
name: M5, type: NMOS, ports: {S: s3d7, D: Vout, G: Vb3}
name: M6, type: NMOS, ports: {S: s3d8, D: Vout, G: Vb3}
name: M7, type: NMOS, ports: {S: GND, D: s3d7, G: Vb3}
name: M8, type: NMOS, ports: {S: GND, D: s3d8, G: Vb3}
name: M9, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: Iss, type: CurrentSource, ports: {Np: p, Nn: GND}
]
extrainfo:The circuit is a CMFB loop around cascode and output stages. It uses a combination of PMOS and NMOS transistors to achieve differential output swings, with inputs Vin and Vout. The circuit also includes a current source Iss for biasing and stabilization. The OpAmp A1 is used for feedback control.

Figure 9.65 Unity-gain buffer.
cascode branch. Specifically, $V_{\text {in,min }} \approx V_{\text {out,min }}=V_{G S 1,2}+V_{I S S}$, approximately one threshold voltage higher than the allowable minimum provided by $M_{5}-M_{8}$.

What happens if $V_{i n}$ falls below the minimum given above? The MOS transistor operating as $I_{S S}$ enters the triode region, decreasing the bias current of the differential pair and hence lowering the transconductance. We then postulate that the limitation is overcome if the transconductance can somehow be restored.

A simple approach to extending the input CM range is to incorporate both NMOS and PMOS differential pairs such that when one is "dead," the other is "alive." Illustrated in Fig. 9.66, the idea is to combine two folded-cascode op amps with NMOS and PMOS input differential pairs. Here, as the input CM level approaches the ground potential, the NMOS pair's transconductance drops, eventually falling to zero. Nonetheless, the PMOS pair remains active, allowing normal operation. Conversely, if the input CM level approaches $V_{D D}, M_{1 P}$ and $M_{2 P}$ begin to turn off, but $M_{1}$ and $M_{2}$ function properly.

An important concern in the circuit of Fig. 9.66 is the variation of the overall transconductance of the two pairs as the input CM level changes. Considering the operation of each pair, we anticipate the behavior depicted in Fig. 9.67. Thus, many properties of the circuit, including gain, speed, and noise, vary. More sophisticated techniques of minimizing this variation are described in [8].
image_name:Figure 9.66
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X, G: Vin1}
name: M2, type: NMOS, ports: {S: GND, D: Y, G: Vin2}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: Vb2}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vb2}
name: M5, type: NMOS, ports: {S: X2, D: X2, G: Vb3}
name: M6, type: NMOS, ports: {S: X2, D: Y1, G: Vb3}
name: M7, type: NMOS, ports: {S: GND, D: X1, G: X1}
name: M8, type: NMOS, ports: {S: GND, D: X2, G: X2}
name: M9, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: M1p, type: PMOS, ports: {S: VDD, D: X1, G: Vin1}
name: M2p, type: PMOS, ports: {S: VDD, D: Y1, G: Vin2}
name: ISS1, type: CurrentSource, value: ISS1, ports: {Np: X, Nn: GND}
name: ISS2, type: CurrentSource, value: ISS2, ports: {Np: Y, Nn: GND}
name: P1, type: Resistor, value: P1, ports: {N1: X, N2: Y}
name: P2, type: Resistor, value: P2, ports: {N1: X1, N2: Y1}
]
extrainfo:The circuit in Figure 9.66 is designed to extend the input common-mode range of differential pairs. It uses both NMOS and PMOS transistors to achieve this, with current sources ISS1 and ISS2 providing biasing. The circuit aims to maintain performance metrics such as gain, speed, and noise across varying input common-mode levels.

Figure 9.66 Extension of input CM range.
image_name:Figure 9.67 Variation of equivalent transconductance with the input CM level
description:The graph in Figure 9.67 illustrates the variation of equivalent transconductance with the input common-mode (CM) level. It is a line graph that shows how the total transconductance, denoted as \( G_{m,tot} \), changes as the input common-mode voltage \( V_{in,CM} \) varies from 0 to \( V_{DD} \).

**Axes Labels and Units:**
- The horizontal axis represents the input common-mode voltage \( V_{in,CM} \), with units presumably in volts. It is marked from 0 to \( V_{DD} \), indicating the supply voltage range.
- The vertical axis represents the transconductance, though it is not explicitly labeled with units, it typically would be in siemens (S).

**Overall Behavior and Trends:**
- The graph begins at a point labeled \( g_{mp} \) when \( V_{in,CM} = 0 \), indicating the transconductance contributed by the PMOS transistors.
- As \( V_{in,CM} \) increases, the transconductance rises to a peak, labeled \( G_{m,tot} \), illustrating the maximum total transconductance of the circuit.
- Beyond this peak, the transconductance decreases, approaching a value labeled \( g_{mn} \) as \( V_{in,CM} \) reaches \( V_{DD} \), indicating the transconductance contributed by the NMOS transistors.

**Key Features and Technical Details:**
- The peak \( G_{m,tot} \) represents the optimal operating point where the combined transconductance of the NMOS and PMOS is at its maximum.
- The graph shows a symmetrical rise and fall, suggesting a balanced contribution from both types of transistors over the input common-mode range.

**Annotations and Specific Data Points:**
- The graph is marked with specific transconductance values at the endpoints (\( g_{mp} \) and \( g_{mn} \)) and at the peak (\( G_{m,tot} \)), providing a clear indication of the critical points of interest in the circuit's performance across different input CM levels.

Figure 9.67 Variation of equivalent transconductance with the input CM level.

## 9.9 ■ Slew Rate

Op amps used in feedback circuits exhibit a large-signal behavior called "slewing." We first describe an interesting property of linear systems that vanishes during slewing. Consider the simple RC network shown in Fig. 9.68, where the input is an ideal voltage step of height $V_{0}$. Since $V_{\text {out }}=V_{0}[1-\exp (-t / \tau)]$, where $\tau=R C$, we have

$$
\begin{equation*}
\frac{d V_{\text {out }}}{d t}=\frac{V_{0}}{\tau} \exp \frac{-t}{\tau} \tag{9.58}
\end{equation*}
$$

That is, the slope of the step response is proportional to the final value of the output; if we apply a larger input step, the output rises more rapidly. This is a fundamental property of linear systems: if the input amplitude is, say, doubled while other parameters remain constant, the output signal level must double at every point, leading to a twofold increase in the slope.
image_name:Figure 9.68
description:The graph in Figure 9.68 illustrates the response of a linear circuit to an input step function. It is a time-domain waveform that shows how the output voltage \( V_{\text{out}} \) changes over time \( t \) in response to a sudden change in the input voltage \( V_{\text{in}} \).

**Axes Labels and Units:**
- The horizontal axis represents time \( t \), but no specific units are provided, suggesting a general analysis.
- The vertical axis represents voltage, with \( V_{\text{in}} \) as the input step and \( V_{\text{out}} \) as the output response.

**Overall Behavior and Trends:**
- The graph shows a step input \( V_{\text{in}} \), which is a sudden increase in voltage.
- The output \( V_{\text{out}} \) initially rises rapidly, following the input step, and then gradually approaches a steady-state value, indicating an exponential rise.
- This behavior is typical of a first-order linear system responding to a step input, where the rate of change is initially high and decreases over time as the system reaches equilibrium.

**Key Features and Technical Details:**
- The response \( V_{\text{out}} \) is characterized by an initial slope that is proportional to the input step, reflecting the relationship described by the differential equation \( \frac{d V_{\text{out}}}{d t} = \frac{V_{0}}{\tau} \exp \left(-\frac{t}{\tau}\right) \).
- A dashed line indicates the initial slope, showing the rapid increase in \( V_{\text{out}} \) immediately following the step in \( V_{\text{in}} \).
- The response curve flattens as it approaches the final value, demonstrating the system's tendency to stabilize over time.

**Annotations and Specific Data Points:**
- The initial slope is marked by a dashed line, emphasizing the proportional relationship between input amplitude and rate of change in output.
- Although specific numerical values are not provided, the graph effectively illustrates the fundamental behavior of a linear system's response to a step input.
image_name:Figure 9.69
description:The graph in Figure 9.69 represents the response of a linear operational amplifier circuit to a step input. The graph is a time-domain waveform showing how the output voltage \( V_{out} \) changes over time \( t \) in response to a step change in the input voltage \( V_{in} \).

1. **Type of Graph and Function:**
- The graph is a time-domain response graph, illustrating the transient behavior of the output voltage in response to a step input.

2. **Axes Labels and Units:**
- The horizontal axis represents time \( t \), though units are not explicitly labeled, it is typically in seconds or milliseconds.
- The vertical axis represents voltage, with \( V_{in} \) and \( V_{out} \) labeled, indicating input and output voltages respectively, likely in volts.

3. **Overall Behavior and Trends:**
- The input voltage \( V_{in} \) is shown as a step function, indicating an instantaneous change in voltage at a particular moment in time.
- The output voltage \( V_{out} \) displays a characteristic exponential rise towards a steady state, typical of a first-order linear system response.
- Initially, \( V_{out} \) rises rapidly, and then the rate of increase slows as it approaches its final value.

4. **Key Features and Technical Details:**
- The slope of the initial rise of \( V_{out} \) is marked with a dashed line, showing the initial rate of change which is proportional to the final value of the output.
- This behavior exemplifies the principle that the slope of the response is proportional to the amplitude of the step input, a fundamental property of linear systems.

5. **Annotations and Specific Data Points:**
- The graph includes a dashed line that represents the tangent at the initial point of the output response, illustrating the initial slope and indicating the system's time constant \( \tau \).
- The graph does not explicitly mark numerical values, but the shape and slope provide insight into the dynamics of the system's response to a step input.

Figure 9.68 Response of a linear circuit to an input step.
image_name:Figure 9.69
description:
[
name: A, type: OpAmp, value: A, ports: {InP: Vin, InN: Vout, Out: Vout}
name: Rout, type: Resistor, value: Rout, ports: {N1: Vout, N2: Vout}
name: R1, type: Resistor, value: R1, ports: {N1: Vout, N2: Vout}
name: R2, type: Resistor, value: R2, ports: {N1: Vout, N2: GND}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
]
extrainfo:The circuit is a linear op amp configuration with feedback resistors R1 and R2, and a load capacitor CL. The op amp amplifies the input voltage Vin and provides an output voltage Vout. The circuit is used to study the response of the op amp to a step input.

Figure 9.69 Response of linear op amp to step response.

The foregoing observation applies to linear feedback systems as well. Shown in Fig. 9.69 is an example, where the op amp is assumed linear. Here, we can write

$$
\begin{equation*}
\left[\left(V_{\text {in }}-V_{\text {out }} \frac{R_{2}}{R_{1}+R_{2}}\right) A-V_{\text {out }}\right] \frac{1}{R_{\text {out }}}=\frac{V_{\text {out }}}{R_{1}+R_{2}}+V_{\text {out }} C_{L} s \tag{9.59}
\end{equation*}
$$

Assuming $R_{1}+R_{2} \gg R_{\text {out }}$, we have

$$
\begin{equation*}
\frac{V_{\text {out }}}{V_{\text {in }}}(s) \approx \frac{A}{\left(1+A \frac{R_{2}}{R_{1}+R_{2}}\right)\left[1+\frac{R_{\text {out }} C_{L}}{1+A R_{2} /\left(R_{1}+R_{2}\right)} s\right]} \tag{9.60}
\end{equation*}
$$

As expected, both the low-frequency gain and the time constant are divided by $1+A R_{2} /\left(R_{1}+R_{2}\right)$. The step response is therefore given by

$$
\begin{equation*}
V_{\text {out }} \approx V_{0} \frac{A}{1+A \frac{R_{2}}{R_{1}+R_{2}}}\left[1-\exp \frac{-t}{\frac{C_{L} R_{\text {out }}}{1+A R_{2} /\left(R_{1}+R_{2}\right)}}\right] u(t) \tag{9.61}
\end{equation*}
$$

indicating that the slope is proportional to the final value. This type of response is called "linear settling."
With a realistic op amp, on the other hand, the step response of the circuit begins to deviate from (9.61) as the input amplitude increases. Illustrated in Fig. 9.70, the response to sufficiently small inputs follows the exponential of Eq. (9.61), but with large input steps, the output displays a linear ramp having a constant slope. Under this condition, we say that the op amp experiences slewing and call the slope of the ramp the "slew rate."
image_name:Actual Op Amp
description:
[
name: A, type: OpAmp, value: A, ports: {InP: Vin, InN: GND, OutP: Vout, OutN: GND}
name: Rout, type: Resistor, value: Rout, ports: {N1: Vout, N2: Vout}
name: R1, type: Resistor, value: R1, ports: {N1: Vout, N2: GND}
name: R2, type: Resistor, value: R2, ports: {N1: GND, N2: GND}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
]
extrainfo:The circuit represents an operational amplifier with feedback, showing the effect of slewing in response to input changes. The op amp has a feedback network consisting of resistors R1 and R2, and a load capacitor CL, which affects the output response.
image_name:Figure 9.70
description:The graph in Figure 9.70 illustrates the step response of an operational amplifier (op amp) circuit, focusing on the phenomenon of slewing. This is a time-domain waveform graph.

1. **Axes Labels and Units:**
- The horizontal axis represents time \(t\), but specific units are not labeled. It is implied to be in seconds or milliseconds, typical for time-domain analysis.
- The vertical axis represents voltage, specifically the input voltage \(V_{in}\) and output voltage \(V_{out}\), though units are not explicitly marked, they are typically in volts.

2. **Overall Behavior and Trends:**
- The graph shows two distinct behaviors of the op amp's output in response to a step change in the input voltage.
- For small input steps, the output voltage \(V_{out}\) follows an exponential curve, indicating a typical first-order system response where the output gradually approaches a new steady-state value.
- For large input steps, the output exhibits a linear ramp instead of an exponential rise. This linear region is characterized by a constant slope, representing the op amp's slew rate.

3. **Key Features and Technical Details:**
- The transition from exponential to linear behavior highlights the op amp's slew rate limitation. The slope of the linear ramp is a critical parameter known as the slew rate, which limits how fast the output can change.
- The exponential curve is typical of a system with a single time constant, showing a smooth rise towards the final value.
- The linear ramp indicates the maximum rate of change of the output voltage due to the op amp's internal limitations.

4. **Annotations and Specific Data Points:**
- The graph includes annotations indicating the regions of exponential and ramp behavior.
- There are no specific numerical values provided for the slew rate or time constant, but the graph visually distinguishes between the two response types.

This graph effectively demonstrates the concept of slewing in op amps, where the output can only change at a limited rate due to internal constraints, resulting in a linear ramp for large input steps instead of the usual exponential response seen for smaller inputs.

Figure 9.70 Slewing in an op amp circuit.

To understand the origin of slewing, let us replace the op amp of Fig. 9.70 by a simple CMOS implementation (Fig. 9.71), assuming for simplicity that $R_{1}+R_{2}$ is very large. We first examine the circuit with a small input step. If $V_{i n}$ experiences a change of $\Delta V, I_{D 1}$ increases by $g_{m} \Delta V / 2$ and $I_{D 2}$ decreases by $g_{m} \Delta V / 2$. Since the mirror action of $M_{3}$ and $M_{4}$ raises $\left|I_{D 4}\right|$ by $g_{m} \Delta V / 2$, the total smallsignal current provided by the op amp equals $g_{m} \Delta V$. This current begins to charge $C_{L}$, but as $V_{\text {out }}$ rises, so does $V_{X}$, reducing the difference between $V_{G 1}$ and $V_{G 2}$ and hence the output current of the op amp. As a result, $V_{\text {out }}$ varies according to (9.61).
image_name:Figure 9.71
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X1, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: X1}
name: M3, type: PMOS, ports: {S: VDD, D: X1, G: Vout}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: Iss, type: CurrentSource, ports: {Np: X1, Nn: GND}
name: R1, type: Resistor, value: R1, ports: {N1: Vout, N2: X}
name: R2, type: Resistor, value: R2, ports: {N1: X, N2: GND}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
]
extrainfo:The circuit is a simple operational amplifier with a differential input stage formed by NMOS transistors M1 and M2, and a current mirror load formed by PMOS transistors M3 and M4. The output is connected to a load capacitor CL and resistors R1 and R2 form a feedback network. The current source Iss provides biasing current to the differential pair.
image_name:(9.61)
description:The graph titled "(9.61)" appears to be a time-domain waveform illustrating the behavior of the output voltage \( V_{\text{out}} \) of an operational amplifier (op amp) circuit in response to a step input voltage \( \Delta V \). The waveform is depicted on the right side of the diagram, showing the output voltage over time.

1. **Type of Graph and Function:**
- The graph is a time-domain waveform representing the output voltage \( V_{\text{out}} \) as a function of time.

2. **Axes Labels and Units:**
- The horizontal axis represents time, although specific units (e.g., seconds, milliseconds) are not labeled.
- The vertical axis represents voltage, specifically the output voltage \( V_{\text{out}} \), but again, specific units (e.g., volts) are not labeled.

3. **Overall Behavior and Trends:**
- The waveform shows a ramp-like increase in the output voltage \( V_{\text{out}} \) over time, indicating a linear rise.
- This behavior suggests a constant current charging a capacitor \( C_{L} \), leading to a linear increase in voltage.

4. **Key Features and Technical Details:**
- The slope of the ramp is determined by the current \( I_{SS} \) and the capacitance \( C_{L} \), specifically \( I_{SS} / C_{L} \).
- The graph does not show any oscillations or exponential behavior, suggesting stable operation under the given conditions.

5. **Annotations and Specific Data Points:**
- There are no specific annotations or data points marked on the waveform.
- The linear region of the graph is indicative of the op amp's operation where \( M_{2} \) is turned off, and \( M_{1} \) absorbs all of \( I_{SS} \), resulting in a constant current charging \( C_{L} \).

Overall, the graph effectively illustrates the linear response of the op amp's output voltage under the specified conditions, highlighting the influence of the constant current charging the load capacitance.

Figure 9.71 Small-signal operation of a simple op amp.
Now suppose $\Delta V$ is so large that $M_{1}$ absorbs all of $I_{S S}$, turning off $M_{2}$. The circuit then reduces to that shown in Fig. 9.72(a), generating a ramp output with a slope equal to $I_{S S} / C_{L}$ (if the channel-length modulation of $M_{4}$ and the current drawn by $R_{1}+R_{2}$ are neglected). Note that so long as $M_{2}$ remains off, the feedback loop is broken and the current charging $C_{L}$ is constant and independent of the input level. As $V_{\text {out }}$ rises, $V_{X}$ eventually approaches $V_{i n}, M_{2}$ turns on, and the circuit returns to linear operation.
image_name:(a)
description:The graph in Figure 9.72(a) represents a circuit diagram illustrating the slewing behavior during a low-to-high transition. The circuit consists of a MOSFET-based configuration with transistors labeled as \( M_1, M_2, M_3, \) and \( M_4 \). The input voltage \( V_{in} \) is applied to the gate of \( M_1 \), while the output voltage \( V_{out} \) is taken across the load capacitor \( C_L \).

1. **Type of Graph and Function:**
- The graph is a time-domain waveform showing the behavior of the output voltage \( V_{out} \) over time as a response to a step input at \( V_{in} \).

2. **Axes Labels and Units:**
- The horizontal axis represents time (though not explicitly labeled in the image), and the vertical axis represents voltage, specifically \( V_{out} \).
- The slope of the ramp is given by \( \frac{I_{SS}}{C_L} \), indicating a linear increase in voltage over time.

3. **Overall Behavior and Trends:**
- The graph shows a ramp-up behavior where \( V_{out} \) increases linearly with time. This indicates that the output voltage is charging the capacitor \( C_L \) at a constant rate determined by the current \( I_{SS} \) divided by the capacitance \( C_L \).
- The slope of the ramp is constant as long as \( M_2 \) remains off, indicating that the feedback loop is broken, and the charging current is independent of the input level.

4. **Key Features and Technical Details:**
- The graph features a linear ramp with a slope \( \frac{I_{SS}}{C_L} \), which is a critical parameter for the charging rate of the capacitor.
- The circuit transitions from a non-linear to a linear operation once \( M_2 \) turns on as \( V_{out} \) approaches \( V_{in} \).
- The circuit diagram highlights the roles of resistors \( R_1 \) and \( R_2 \) in the feedback loop, although their current draw is neglected in the slope calculation.

5. **Annotations and Specific Data Points:**
- The diagram includes annotations for \( V_{out} \) and the slope \( \frac{I_{SS}}{C_L} \). These are crucial for understanding the rate of voltage change and the operational state of the circuit.

The graph provides a clear visual representation of the slewing behavior during a low-to-high transition in the circuit, emphasizing the linear charging of the capacitor \( C_L \) and the conditions under which this behavior occurs.
image_name:(b)
description:The graph in Figure 9.72(b) illustrates the behavior of an electronic circuit during a high-to-low transition, specifically focusing on the slewing effect. The graph is a time-domain waveform that represents the output voltage, \( V_{\text{out}} \), over time.

1. **Axes Labels and Units:**
- The horizontal axis represents time, though the specific units are not labeled, it is typically in seconds or milliseconds for such waveforms.
- The vertical axis represents voltage, specifically the output voltage \( V_{\text{out}} \), again with no specific units labeled, but it is generally in volts.

2. **Overall Behavior and Trends:**
- The graph shows a descending curve, indicating a decrease in the output voltage over time.
- Initially, there is a rapid drop in voltage, which then transitions into a more gradual decline, illustrating the slewing behavior.
- The slope of the initial part of the curve is determined by the current \( I_{SS} \) and the load capacitance \( C_{L} \), as indicated by the label \( \frac{I_{SS}}{C_{L}} \).

3. **Key Features and Technical Details:**
- The graph starts at a high voltage level and quickly drops, showing the circuit's response to a falling edge at the input.
- The rate of voltage change is initially steep, followed by a leveling off as the voltage approaches a lower steady state.
- This behavior reflects the circuit's transition from a non-linear to a linear operating mode as \( M_1 \) turns back on when the voltage difference between \( V_X \) and \( V_{\text{in}} \) becomes small.

4. **Annotations and Specific Data Points:**
- The slope of the initial drop is annotated with \( \frac{I_{SS}}{C_{L}} \), indicating the rate at which the capacitor \( C_{L} \) discharges during the slewing phase.
- The graph does not provide specific numerical values for voltage levels or time intervals, focusing instead on the qualitative behavior of the circuit during the transition.

Figure 9.72 Slewing during (a) low-to-high and (b) high-to-low transitions.
In Fig. 9.71, slewing occurs for falling edges at the input as well. If the input drops so much that $M_{1}$ turns off, then the circuit is simplified as in Fig. 9.72(b), discharging $C_{L}$ by a current approximately equal to $I_{S S}$. After $V_{\text {out }}$ decreases sufficiently, the difference between $V_{X}$ and $V_{i n}$ is small enough to allow $M_{1}$ to turn on, leading to linear behavior thereafter.

The foregoing observations explain why slewing is a nonlinear phenomenon. If the input amplitude, say, doubles, the output level does not double at all points because the ramp exhibits a slope independent of the input.

Slewing is an undesirable effect in high-speed circuits that process large signals. While the small-signal bandwidth of a circuit may suggest a fast time-domain response, the large-signal speed may be limited by the slew rate simply because the current available to charge and discharge the dominant capacitor in the circuit is small. Moreover, since the input-output relationship during slewing is nonlinear, the output of a slewing amplifier exhibits substantial distortion. For example, if a circuit is to amplify a sinusoid $V_{0} \sin \omega_{0} t$ (in the steady state), then its slew rate must exceed $V_{0} \omega_{0}$.

#### Example 9.22

Consider the feedback amplifier depicted in Fig. 9.73(a), where $C_{1}$ and $C_{2}$ set the closed-loop gain. (The bias network for the gate of $M_{2}$ is not shown.) (a) Determine the small-signal step response of the circuit. (b) Calculate the positive and negative slew rates.
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: Vout}
name: M3, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: GND}
name: C2, type: Capacitor, value: C2, ports: {Np: Vout, Nn: GND}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a feedback amplifier with a differential pair formed by NMOS transistors M1 and M2, and a PMOS current mirror formed by M3 and M4. Capacitors C1 and C2 set the closed-loop gain. The current source Iss provides biasing.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: P}
name: M3, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: X}
name: C2, type: Capacitor, value: C2, ports: {Np: X, Nn: GND}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
name: Rout, type: Resistor, value: Rout, ports: {N1: P, N2: Vout}
name: Av, type: VoltageControlledVoltageSource, value: AvV1, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit in diagram (b) is a feedback amplifier with two capacitors, C1 and C2, setting the closed-loop gain. The amplifier consists of a voltage-controlled voltage source and a resistor Rout. The NMOS transistors M1 and M2 are configured in a differential pair, while PMOS transistors M3 and M4 form a current mirror. The current source Iss provides biasing current. The circuit amplifies the input voltage Vin to produce the output voltage Vout.
image_name:(c)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: P}
name: M3, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X1}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: GND}
name: C2, type: Capacitor, value: C2, ports: {Np: X, Nn: GND}
name: Rout, type: Resistor, value: Rout, ports: {N1: Vout, N2: Vout}
name: Av, type: VoltageControlledVoltageSource, value: Av, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a feedback amplifier with NMOS and PMOS transistors forming a differential pair. The capacitors C1 and C2 set the closed-loop gain. The current source Iss biases the circuit. The output voltage is taken across the capacitors, and the gain is controlled by the voltage-controlled voltage source Av.
image_name:(d)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: P}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: X}
name: C2, type: Capacitor, value: C2, ports: {Np: X, Nn: GND}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a feedback amplifier with NMOS transistors M1 and M2. Capacitors C1 and C2 set the closed-loop gain. The current source Iss provides biasing. The input is applied to the gate of M1, and the output is taken from the drain of M2.

Figure 9.73

#### Solution

(a) Modeling the op amp as in Fig. 9.73(b), where $A_{v}=g_{m 1,2}\left(r_{O 2} \| r_{O 4}\right)$ and $R_{\text {out }}=r_{O 2} \| r_{O 4}$, we have $V_{X}=$ $C_{1} V_{\text {out }} /\left(C_{1}+C_{2}\right)$, and hence

$$
\begin{equation*}
V_{P}=\left(V_{\text {in }}-\frac{C_{1}}{C_{1}+C_{2}} V_{\text {out }}\right) A_{v} \tag{9.62}
\end{equation*}
$$

obtaining

$$
\begin{equation*}
\left[\left(V_{\text {in }}-\frac{C_{1}}{C_{1}+C_{2}} V_{\text {out }}\right) A_{v}-V_{\text {out }}\right] \frac{1}{R_{\text {out }}}=V_{\text {out }} \frac{C_{1} C_{2}}{C_{1}+C_{2}} s \tag{9.63}
\end{equation*}
$$

It follows that

$$
\begin{align*}
\frac{V_{\text {out }}}{V_{\text {in }}}(s) & =\frac{A_{v}}{1+A_{v} \frac{C_{1}}{C_{1}+C_{2}}+\frac{C_{1} C_{2}}{C_{1}+C_{2}} R_{\text {out }} s}  \tag{9.64}\\
& =\frac{A_{v} /\left(1+A_{v} \frac{C_{1}}{C_{1}+C_{2}}\right)}{1+\frac{C_{1} C_{2}}{C_{1}+C_{2}} R_{\text {out }} s /\left(1+A_{v} \frac{C_{1}}{C_{1}+C_{2}}\right)} \tag{9.65}
\end{align*}
$$

revealing that both the low-frequency gain and the time constant of the circuit have decreased by a factor of $1+A_{v} C_{1} /\left(C_{1}+C_{2}\right)$. The response to a step of height $V_{0}$ is thus given by

$$
\begin{equation*}
V_{\text {out }}(t)=\frac{A_{v}}{1+A_{v} \frac{C_{1}}{C_{1}+C_{2}}} V_{0}\left(1-\exp \frac{-t}{\tau}\right) u(t) \tag{9.66}
\end{equation*}
$$

where

$$
\begin{equation*}
\tau=\frac{C_{1} C_{2}}{C_{1}+C_{2}} R_{\text {out }} /\left(1+A_{v} \frac{C_{1}}{C_{1}+C_{2}}\right) \tag{9.67}
\end{equation*}
$$

(b) Suppose a large positive step is applied to the gate of $M_{1}$ in Fig. 9.73(a) while the initial voltage across $C_{1}$ is zero. Then, $M_{2}$ turns off and, as shown in Fig. 9.73(c), $V_{\text {out }}$ rises according to $V_{\text {out }}(t)=I_{S S} /\left[C_{1} C_{2} /\left(C_{1}+C_{2}\right)\right] t$. Similarly, for a large negative step at the input, Fig. 9.73(d) yields $V_{\text {out }}=-I_{S S} /\left[C_{1} C_{2} /\left(C_{1}+C_{2}\right)\right] t$.

As another example, let us find the slew rate of the telescopic op amp shown in Fig. 9.74(a). When a large differential input is applied, $M_{1}$ or $M_{2}$ turns off, reducing the circuit to that shown in Fig. 9.74(b). Thus, $V_{\text {out } 1}$ and $V_{\text {out } 2}$ appear as ramps with slopes equal to $\pm I_{S S} /\left(2 C_{L}\right)$, and consequently $V_{\text {out } 1}-V_{\text {out } 2}$ exhibits a slew rate equal to $I_{S S} / C_{L}$. (Of course, the circuit is usually used in closed-loop form.)
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: P, D: Voutp, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Voutn, G: Vin}
name: M3, type: NMOS, ports: {S: Voutp, D: Vout, G: Vb3}
name: M4, type: NMOS, ports: {S: Voutn, D: Vout, G: Vb3}
name: M5, type: PMOS, ports: {S: VDD, D: Voutp, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Voutn, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: Vb2, G: Vb1}
name: M8, type: PMOS, ports: {S: VDD, D: Vb2, G: Vb1}
name: CL1, type: Capacitor, value: CL, ports: {Np: Voutp, Nn: GND}
name: CL2, type: Capacitor, value: CL, ports: {Np: Voutn, Nn: GND}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: VDD, Nn: P}
]
extrainfo:The circuit is a telescopic operational amplifier with differential input and output. It utilizes NMOS and PMOS transistors for amplification and biasing. The slew rate is determined by the current source ISS and the load capacitors CL.

(a)
image_name:Figure 9.74
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin1}
name: M3, type: NMOS, ports: {S: d2d5, D: d2d5, G: Vb3}
name: M5, type: PMOS, ports: {S: VDD, D: d2d5, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: d6, G: Vbr}
name: M7, type: PMOS, ports: {S: VDD, D: vb1, G: Vb1}
name: M8, type: PMOS, ports: {S: VDD, D: vb1, G: Vb1}
name: CL, type: Capacitor, value: CL, ports: {Np: d6, Nn: GND}
name: ISS, type: CurrentSource, value: ISS, ports: {Np: VDD, Nn: P}
]
extrainfo:The circuit is a telescopic operational amplifier with differential input and output. It utilizes NMOS and PMOS transistors for amplification and biasing. The slew rate is determined by the current source ISS and the load capacitors CL.

(b)

Figure 9.74 Slewing in telescopic op amp.
It is also instructive to study the slewing behavior of a folded-cascode op amp with single-ended output [Fig. 9.75(a)]. Figures 9.75(a) and (b) depict the equivalent circuit for positive and negative input steps,
image_name:Figure 9.75(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X, G: Vin}
name: M2, type: NMOS, ports: {S: GND, D: Vout, G: X}
name: M3, type: PMOS, ports: {S: VDD, D: Vout, G: Vb2}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vb2}
name: M5, type: NMOS, ports: {S: X1, D: X1, G: Vb3}
name: M6, type: NMOS, ports: {S: X1, D: Vout, G: Vb3}
name: M7, type: NMOS, ports: {S: GND, D: X1, G: X1}
name: M8, type: NMOS, ports: {S: GND, D: Vout, G: X1}
name: M9, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: X, Nn: GND}
]
extrainfo:The circuit is a folded-cascode op amp with single-ended output. PMOS current sources provide a current of IP, and the current that charges or discharges CL is equal to ISS, yielding a slew rate of ISS/CL. The slew rate is independent of IP if IP ≥ ISS. In practice, IP is chosen to be approximately equal to ISS.
image_name:Figure 9.75(b)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: P, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: X}
name: M3, type: PMOS, ports: {S: X, D: Vout, G: Vb2}
name: M4, type: PMOS, ports: {S: Y, D: Vout, G: Vb2}
name: M5, type: NMOS, ports: {S: S5d7, D: X1, G: Vb3}
name: M6, type: NMOS, ports: {S: S6d8, D: Vout, G: Vb3}
name: M7, type: NMOS, ports: {S: X1, D: X1, G: X1}
name: M8, type: NMOS, ports: {S: X1, D: X1, G: X1}
name: M9, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
name: Iss, type: CurrentSource, value: Iss, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a folded-cascode operational amplifier with a single-ended output. It utilizes NMOS and PMOS transistors for amplification and biasing. The slew rate is determined by the current source Iss and the load capacitor CL. The PMOS current sources provide a current of IP, and the current that charges or discharges CL is equal to Iss, yielding a slew rate of Iss/CL.

Figure 9.75 Slewing in folded-cascode op amp.
respectively. Here, the PMOS current sources provide a current of $I_{P}$, and the current that charges or discharges $C_{L}$ is equal to $I_{S S}$, yielding a slew rate of $I_{S S} / C_{L}$. Note that the slew rate is independent of $I_{P}$ if $I_{P} \geq I_{S S}$. In practice, we choose $I_{P} \approx I_{S S}$.

In Fig. 9.75(a), if $I_{S S}>I_{P}$, then during slewing, $M_{3}$ turns off and $V_{X}$ falls to a low level such that $M_{1}$ and the tail current source enter the triode region. Thus, for the circuit to return to equilibrium after $M_{2}$ turns on, $V_{X}$ must experience a large swing, slowing down the settling. This phenomenon is illustrated in Fig. 9.76.
image_name:Figure 9.76
description:**Type of Graph and Function:**
Figure 9.76 is a time-domain waveform graph illustrating the behavior of a circuit during the settling period following a slewing event.

**Axes Labels and Units:**
- The horizontal axis represents time, likely in microseconds or milliseconds, although the specific units are not provided in the image.
- The vertical axis represents voltage, with the units presumably in volts.

**Overall Behavior and Trends:**
- The graph shows a waveform that begins with a sharp drop in voltage, indicating a slewing event where the circuit rapidly changes state.
- Following the initial drop, the waveform exhibits an oscillatory behavior as it attempts to settle back to its equilibrium state.
- The oscillations gradually decrease in amplitude over time, indicating damping as the circuit stabilizes.

**Key Features and Technical Details:**
- The initial sharp drop signifies the entry into a slewing condition, where the output voltage falls rapidly.
- The subsequent oscillations suggest the presence of underdamped behavior, which is typical in circuits recovering from overdrive.
- The waveform does not return to its original voltage level immediately, indicating a delay in settling due to the overdrive recovery process.

**Annotations and Specific Data Points:**
- There are no specific numerical values or annotations given in the graph, but the behavior is consistent with a prolonged settling time due to the circuit's recovery from slewing.
- The waveform's oscillatory nature and the gradual decrease in amplitude are key indicators of the circuit's dynamic response to the initial disturbance.

Figure 9.76 Long settling due to overdrive recovery after slewing.
To alleviate this issue, two "clamp" transistors can be added as shown in Fig. 9.77(a) [9]. The idea is that the difference between $I_{S S}$ and $I_{P}$ now flows through $M_{11}$ or $M_{12}$, requiring only enough drop in $V_{X}$ or $V_{Y}$ to turn on one of these transistors. Figure 9.77(b) illustrates a more aggressive approach, where $M_{11}$ and $M_{12}$ clamp the two nodes directly to $V_{D D}$. Since the equilibrium value of $V_{X}$ and $V_{Y}$ is usually higher than $V_{D D}-V_{T H N}, M_{11}$ and $M_{12}$ are off during small-signal operation.

What trade-offs are encountered in increasing the slew rate? In the examples of Figs. 9.74 and 9.75, for a given load capacitance, $I_{S S}$ must be increased, and to maintain the same maximum output swing, all of the transistors must be made proportionally wider. As a result, the power dissipation and the input capacitance are increased. Note that if the device currents and widths scale together, $g_{m} r_{O}$ of each transistor, and hence the open-loop gain of the op amp, remain constant.

How does an op amp leave the slewing regime and enter the linear-settling regime? Since the point at which one of the input transistors "turns on" is ambiguous, the distinction between slewing and linear settling is somewhat arbitrary. The following example illustrates the point.
image_name:(a)
description:
[
name: M9, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: M11, type: NMOS, ports: {S: X, D: VDD, G: Y}
name: M12, type: NMOS, ports: {S: Y, D: VDD, G: X}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: Vb2}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: Vb2}
]
extrainfo:The circuit is a clamp circuit designed to limit voltage swings at nodes X and Y. It uses PMOS and NMOS transistors to achieve this functionality. The circuit has a symmetrical structure with respect to X and Y.
image_name:(b)
description:
[
name: M9, type: PMOS, ports: {S: VDD, D: X, G: Vb1}
name: M10, type: PMOS, ports: {S: VDD, D: Y, G: Vb1}
name: M11, type: NMOS, ports: {S: X, D: VDD, G: X}
name: M12, type: NMOS, ports: {S: Y, D: VDD, G: Y}
name: M3, type: PMOS, ports: {S: X, D: LOAD, G: Vb2}
name: M4, type: PMOS, ports: {S: Y, D: LOAD, G: Vb2}
]
extrainfo:The circuit diagram (b) is a clamp circuit designed to limit voltage swings at nodes X and Y. It consists of PMOS and NMOS transistors configured to control the voltage levels at these nodes, with bias voltages Vb1 and Vb2 controlling the gates of the PMOS transistors.

Figure 9.77 Clamp circuit to limit swings at $X$ and $Y$.

#### Example 9.23

Consider the circuit of Fig. 9.73(a) in the slewing regime [Fig. 9.73(c)]. As $V_{\text {out }}$ rises, so does $V_{X}$, eventually turning $M_{2}$ on. As $I_{D 2}$ increases from zero, the differential pair becomes more linear. Considering $M_{1}$ and $M_{2}$ to operate linearly if the difference between their drain currents is less than $\alpha I_{S S}$ (e.g., $\alpha=0.1$ ), determine how long the circuit takes to enter linear settling. Assume the input step has an amplitude of $V_{0}$.

#### Solution

The circuit displays a slew rate of $I_{S S} /\left[C_{1} C_{2} /\left(C_{1}+C_{2}\right)\right]$ until $\left|V_{i n 1}-V_{i n 2}\right|$ is sufficiently small. From Chapter 4, we can write

$$
\begin{equation*}
\alpha I_{S S}=\frac{1}{2} \mu_{n} C_{o x} \frac{W}{L}\left(V_{i n 1}-V_{i n 2}\right) \sqrt{\frac{4 I_{S S}}{\mu_{n} C_{o x} \frac{W}{L}}-\left(V_{i n 1}-V_{i n 2}\right)^{2}} \tag{9.68}
\end{equation*}
$$

obtaining

$$
\begin{equation*}
\Delta V_{G}^{4}-\Delta V_{G}^{2} \frac{4 I_{S S}}{\mu_{n} C_{o x} \frac{W}{L}}+\left(\frac{2 \alpha I_{S S}}{\mu_{n} C_{o x} \frac{W}{L}}\right)^{2}=0 \tag{9.69}
\end{equation*}
$$

where $\Delta V_{G}=V_{i n 1}-V_{i n 2}$. Thus,

$$
\begin{equation*}
\Delta V_{G} \approx \alpha \sqrt{\frac{I_{S S}}{\mu_{n} C_{o x} \frac{W}{L}}} \tag{9.70}
\end{equation*}
$$

(Recall that $\sqrt{I_{S S} /\left[\mu_{n} C_{o x}(W / L)\right]}$ is the equilibrium overdrive voltage of each transistor in the differential pair.) Alternatively, we recognize that for a small difference, $\alpha I_{S S}$, between $I_{D 1}$ and $I_{D 2}$, a small-signal approximation is valid: $\alpha I_{S S}=g_{m} \Delta V_{G}$. Thus, $\Delta V_{G}=\alpha I_{S S} / g_{m} \approx \alpha I_{S S} / \sqrt{\mu_{n} C_{o x}(W / L) I_{S S}}$. Note that this is a rough calculation because as $M_{2}$ turns on, the current charging the load capacitance is no longer constant.

Since $V_{X}$ must rise to $V_{0}-\Delta V_{G}$ for $M_{2}$ to carry the required current, $V_{\text {out }}$ increases by $\left(V_{0}-\Delta V_{G}\right)\left(1+C_{2} / C_{1}\right)$, requiring a time given by

$$
\begin{equation*}
t=\frac{C_{2}}{I_{S S}}\left(V_{0}-\alpha \sqrt{\frac{I_{S S}}{\mu_{n} C_{o x} \frac{W}{L}}}\right) \tag{9.71}
\end{equation*}
$$

In the earlier example, the value of $\alpha$ that determines the onset of linear settling depends, among other things, on the actual required linearity. In other words, for a nonlinearity of $1 \%, \alpha$ can be quite a lot larger than for a nonlinearity of $0.1 \%$.

The slewing behavior of two-stage op amps is somewhat different from that of the circuits studied earlier. This case is studied in Chapter 10.

### 9.10 ■ High-Slew-Rate Op Amps

Our formulation of the slew rate in various op amp topologies implies that, for a given capacitance, slewlimited settling can be improved only by raising the bias current and hence the power consumption. This trade-off can be mitigated if the current available to charge the capacitor of interest automatically rises during slewing and falls back to its original value thereafter. In this section, we study op amp topologies that exploit this idea.

### 9.10.1 One-Stage Op Amps

We begin with a simple common-source stage incorporating a current-source load biased at a value of $I_{0}$ [Fig. 9.78(a)]. In the absence of an input signal, $I_{D 1}=I_{0}$, but if $V_{i n}$ jumps down to turn $M_{1}$ off, then $I_{0}$ flows through $C_{L}$, yielding a slew rate of $I_{0} / C_{L} .^{7}$ Can we automatically increase the drain current of $M_{2}$ during this transient? To this end, we must allow $V_{b}$ to change and, in fact, follow the jump in $V_{i n}$. For example, as shown in Fig. 9.78(b), we can simply apply $V_{i n}$ to both transistors so that a downward jump in $V_{i n}$ also raises $\left|I_{D 2}\right|$. This complementary topology was studied in Chapter 3 and found to suffer from poor power supply rejection. We pursue other topologies here.
image_name:(a)
description:
[
name: M2, type: PMOS, ports: {S: VDD, D: Vout, G: Vb}
name: M1, type: NMOS, ports: {S: GND, D: Vout, G: Vin}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
name: VDD, type: VoltageSource, value: VDD, ports: {Np: VDD, Nn: GND}
name: I0, type: CurrentSource, value: I0, ports: {Np: VDD, Nn: Vout}
]
extrainfo:The circuit is a common-source amplifier with a PMOS load (M2) and an NMOS driver (M1). The output is taken at the drain of M1 and the source of M2, connected to the capacitor CL. The input is applied to the gate of M1.

(a)
image_name:Figure 9.78(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout, G: Vin}
name: M2, type: PMOS, ports: {S: VDD, D: Vout, G: Vin}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
]
extrainfo:The circuit is a common-source amplifier with a PMOS load (M2) and an NMOS driver (M1). The output is taken at the drain of M1 and the source of M2, connected to the capacitor CL. The input is applied to the gate of M1.

(b)

Figure 9.78 Slewing in (a) a simple CS stage and (b) a complementary CS stage.
Let us control $M_{2}$ in Fig. 9.78(a) by current mirror action, as depicted in Fig. 9.79(a), and ask how $I_{b}$ must be controlled by $V_{i n}$. Can $I_{b}$ be derived from another common-source device [Fig. 9.79(b)]? No; as $V_{i n}$ jumps down in this circuit, $I_{b}$ decreases. We must therefore include an additional signal inversion in the path controlling $I_{b}$. Alternatively, we can consider a differential topology, where both the input signal, $V_{i n}^{+}$, and its inverted version, $V_{i n}^{-}$, are available. Illustrated in Fig. 9.79(c), the idea is to control the bias current of $M_{2}$ by $V_{i n}^{-}$and that of $M_{4}$ by $V_{i n}^{+}$. For example, if $V_{i n}^{+}$jumps down and $V_{i n}^{-}$jumps up, then (1) $M_{5}$ draws less current from $M_{8}$, lowering $\left|I_{D 4}\right|$, (2) $M_{3}$ draws more current, discharging its load capacitance, (3) $M_{6}$ draws more current from $M_{7}$, raising $\left|I_{D 2}\right|$, and (4) $M_{1}$ draws less current, allowing its drain capacitance to be charged by $M_{2}$.

The circuits of Figs. 9.78(b) and 9.79(c) are called "push-pull" stages as they turn the load current source into an "active" pull-up device. Loosely speaking, we also refer to them as "class-AB" amplifiers. ${ }^{8}$

[^66]image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout, G: Vin}
name: M2, type: PMOS, ports: {S: VDD, D: Vout, G: X}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: X}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
name: Ib, type: CurrentSource, value: Ib, ports: {Np: X, Nn: GND}
]
extrainfo:The circuit is a common-source stage with current mirror biasing, where M3 and M2 form a current mirror. The output is taken across the capacitor CL, and the input is applied to the gate of M1.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: Vout, G: Vin}
name: M2, type: PMOS, ports: {S: VDD, D: Vout, G: X}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M4, type: NMOS, ports: {S: GND, D: Vin, G: Vin}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout, Nn: GND}
name: Ib, type: CurrentSource, value: Ib, ports: {Np: X, Nn: GND}
]
extrainfo:The circuit diagram (b) is a push-pull stage with current mirror biasing. It includes a capacitor CL connected to the output Vout and a current source Ib connected to node X. The NMOS M1 and M4 are connected to the input Vin, while PMOS M2 and M3 are connected to the supply voltage VDD. This configuration is used to enhance the slew rate and improve speed-power consumption trade-offs.
image_name:(c)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: d1d2, G: Vin+}
name: M2, type: PMOS, ports: {S: VDD, D: d1d2, G: X}
name: M3, type: PMOS, ports: {S: VDD, D: d3d4, G: Y}
name: M4, type: PMOS, ports: {S: VDD, D: Vout2, G: Y}
name: M5, type: NMOS, ports: {S: GND, D: d3d4, G: Vin-}
name: M6, type: NMOS, ports: {S: GND, D: Vout2, G: Vin}
name: M7, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M8, type: PMOS, ports: {S: VDD, D: Y, G: Y}
name: CL, type: Capacitor, value: CL, ports: {Np: d1d2, Nn: GND}
name: CL, type: Capacitor, value: CL, ports: {Np: d3d4, Nn: GND}
name: Ib, type: CurrentSource, value: Ib, ports: {Np: X, Nn: GND}
name: Iss1, type: CurrentSource, value: Iss1, ports: {Np: p1, Nn: GND}
name: Iss2, type: CurrentSource, value: Iss2, ports: {Np: p2, Nn: GND}
]
extrainfo:The circuit is a push-pull stage with current mirror biasing. It includes additional tail current sources to improve input common-mode rejection. The circuit has two differential inputs (Vin+ and Vin-) and two outputs (Vout1 and Vout2). The push-pull configuration allows for improved speed and reduced power consumption.
image_name:(d)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: d1, G: Vin+}
name: M2, type: PMOS, ports: {S: VDD, D: Vout1, G: X}
name: M3, type: PMOS, ports: {S: VDD, D: d3, G: Y}
name: M4, type: NMOS, ports: {S: GND, D: Vout2, G: Vin-}
name: CL, type: Capacitor, value: CL, ports: {Np: Vout1, Nn: d1}
name: M5, type: NMOS, ports: {S: GND, D: d1, G: Vin-}
name: M6, type: NMOS, ports: {S: GND, D: d3, G: Vin+}
name: M7, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M8, type: PMOS, ports: {S: VDD, D: Y, G: Y}
name: Ib, type: CurrentSource, value: Ib, ports: {Np: X, Nn: GND}
name: Iss1, type: CurrentSource, value: Iss1, ports: {Np: p1, Nn: GND}
name: Iss2, type: CurrentSource, value: Iss2, ports: {Np: p2, Nn: GND}
]
extrainfo:The circuit is a differential amplifier with current mirror loads and tail current sources, designed to improve input common-mode rejection. It uses PMOS and NMOS transistors in a push-pull configuration to achieve class-AB operation, enhancing slew rate and balancing speed and power consumption.

Figure 9.79 (a) CS stage with current mirror biasing, (b) injection of signal into the mirror with incorrect polarity, (c) injection of signal into the mirror with ccrrect polarity, and (d) addition of tail current sources.

By virtue of the temporary boost in the slew rate, such circuits alleviate the trade-off between the speed and the average power consumption.

In order to improve the input common-mode rejection, we add tail current sources to $M_{1}$ and $M_{3}$ and to $M_{5}$ and $M_{6}$ [Fig. 9.79(d)]. We now wish to calculate the circuit's slew rate with a large input step. If, for example, $V_{i n}^{+}$jumps up and $M_{1}$ and $M_{5}$ absorb all of their respective tail currents, then $M_{2}$ is off and $V_{\text {out } 1}$ falls at a rate of $I_{S S 1} / C_{L}$ while $M_{3}$ is off and $V_{\text {out } 2}$ rises at a rate of $I_{S S 2}\left(W_{4} / W_{8}\right) / C_{L}$ (if $\left.L_{4}=L_{8}\right)$. The differential slew rate is thus equal to $\left[I_{S S 1}+I_{S S 2}\left(W_{4} / W_{8}\right)\right] / C_{L}$. Without the push-pull action, on the other hand, this slew rate would be limited to $I_{S S 1} / C_{L}$. If we choose $W_{4} / W_{8}$ equal to, say, 5 and $I_{S S 2}$ equal to $I_{S S 1}$, then the SR increases by a factor of 6 with a twofold power penalty. ${ }^{9}$

#### Example 9.24

Calculate the small-signal voltage gain of the class-AB op amp shown in Fig. 9.79(d).

#### Solution

In addition to the main path, the mirror path contributes gain as well. Since the mirror action amplifies the drain currents of $M_{5}$ and $M_{6}$ by a factor of $W_{4} / W_{8}$, we approximate the gain in this path as $\left(W_{4} / W_{8}\right) g_{m 5}\left(r_{O 3} \| r_{O 4}\right)$ and add it to that of the main path:

$$
\begin{align*}
\left|A_{v}\right| & \approx g_{m 1}\left(r_{O 3} \| r_{O 4}\right)+\left(W_{4} / W_{8}\right) g_{m 5}\left(r_{O 3} \| r_{O 4}\right)  \tag{9.72}\\
& \approx\left[g_{m 1}+\left(W_{4} / W_{8}\right) g_{m 5}\right]\left(r_{O 3} \| r_{O 4}\right) \tag{9.73}
\end{align*}
$$

The mirror path thus raises the apparent transconductance from $g_{m 1}$ to $g_{m 1}+\left(W_{4} / W_{8}\right) g_{m 5}$.

[^67]Let us now determine the transfer function of the above circuit and examine the effect of the mirror pole. We write the transfer function from the input through the mirror path to the output as

$$
\begin{equation*}
H_{\text {mirr }}(s)=\frac{W_{4}}{W_{8}} g_{m 5}\left(r_{O 3} \| r_{O 4}\right) \frac{1}{1+\frac{s}{\omega_{p, X}}} \frac{1}{1+\frac{s}{\omega_{\text {out }}}} \tag{9.74}
\end{equation*}
$$

where $\omega_{p, X} \approx g_{m 8} / C_{Y}$ and $\omega_{\text {out }}=\left[\left(r_{O 3} \| r_{O 4}\right) C_{L}\right]^{-1}$. For the main path, we simply have

$$
\begin{equation*}
H_{\text {main }}(s)=g_{m 1}\left(r_{O 3} \| r_{O 4}\right) \frac{1}{1+\frac{s}{\omega_{\text {out }}}} \tag{9.75}
\end{equation*}
$$

It follows that

$$
\begin{align*}
H_{\text {tot }}(s) & =H_{\text {main }}(s)+H_{\text {mirr }}(s)  \tag{9.76}\\
& =\frac{r_{O 3} \| r_{O 4}}{1+\frac{s}{\omega_{\text {out }}}}\left[\frac{W_{4}}{W_{8}} \frac{g_{m 5}}{1+\frac{s}{\omega_{p, X}}}+g_{m 1}\right]  \tag{9.77}\\
& =\frac{r_{O 3} \| r_{O 4}}{1+\frac{s}{\omega_{\text {out }}}} \cdot \frac{\left(W_{4} / W_{8}\right) g_{m 5}+g_{m 1}+g_{m 1} s / \omega_{p, X}}{1+\frac{s}{\omega_{p, X}}} \tag{9.78}
\end{align*}
$$

As seen in other examples in Chapter 6, the presence of the additional signal path leads to a zero in the transfer function. This zero frequency is given by

$$
\begin{equation*}
\left|\omega_{z}\right|=\left(\frac{W_{4}}{W_{8}} \frac{g_{m 5}}{g_{m 1}}+1\right) \omega_{p, X} \tag{9.79}
\end{equation*}
$$

Unfortunately, it is not possible to equate $\omega_{z}$ to $\omega_{p, X}$ because $\left(W_{4} / W_{8}\right)\left(g_{m 5} / g_{m 1}\right)$ is typically around unity or higher. Also, in practice, $\omega_{\text {out }}<\omega_{p, X}$.

It is tempting to raise the SR in Fig. 9.79(d) by increasing $W_{4} / W_{8}$, but we must note that, as a result, the pole frequency associated with the mirror nodes falls. Approximating this pole by $g_{m 8} / C_{Y}$ and writing $g_{m 8}=\sqrt{I_{S S 2} \mu_{n} C_{o x}(W / L)_{8}}$ and $C_{Y} \approx 2\left(W_{4}+W_{8}\right) L C_{o x}+C_{D B 8}+C_{D B 5}$, we recognize that the mirror pole frequency is inversely proportional to $W_{4}$.

### 9.10.2 Two-Stage Op Amps

In order to achieve a high slew rate, we can apply push-pull operation to the second stage of a twostage op amp. To this end, we view the arrangement shown in Fig. 9.79(c) as the second stage and precede it with a differential pair, arriving at the topology depicted in Fig. 9.80. This circuit provides a voltage gain of

$$
\begin{equation*}
\left|A_{v}\right|=g_{m 9}\left(r_{O 9} \| r_{O 11}\right)\left[g_{m 1}+\left(W_{4} / W_{8}\right) g_{m 5}\right]\left(r_{O 1} \| r_{O 2}\right) \tag{9.80}
\end{equation*}
$$

But how about the slew rate? Suppose, for example, $V_{i n 1}$ and $V_{i n 2}$ experience a large differential step such that the entire $I_{S S}$ flows through node $P$. If this node is "agile" enough, i.e., if its capacitance is relatively small, $V_{P}$ rises rapidly, applying a large overdrive to $M_{1}$ and $M_{5}$ and creating a high slew rate at the output. In other words, since $V_{P}$ (or $V_{Q}$ ) can reach near $V_{D D}$ when only $M_{9}$ (or $M_{10}$ ) is on, the available current is much larger than the bias current of the output stage. This behavior stands in contrast to that
image_name:Figure 9.80 Two-stage op amp with slew enhancement
description:
[
name: M9, type: PMOS, ports: {S: VDD, D: P, G: Vin1}
name: M10, type: PMOS, ports: {S: VDD, D: Q, G: Vin2}
name: M11, type: NMOS, ports: {S: GND, D: P, G: Vb}
name: M12, type: NMOS, ports: {S: GND, D: Q, G: Vb}
name: M7, type: PMOS, ports: {S: VDD, D: X, G: X1}
name: M2, type: PMOS, ports: {S: VDD, D: X1, G: X}
name: M5, type: NMOS, ports: {S: GND, D: P, G: P}
name: M1, type: NMOS, ports: {S: GND, D: X1, G: P}
name: M4, type: PMOS, ports: {S: VDD, D: Y, G: X1}
name: M8, type: PMOS, ports: {S: VDD, D: X1, G: Y}
name: M3, type: NMOS, ports: {S: GND, D: Q, G: Q}
name: M6, type: NMOS, ports: {S: GND, D: X1, G: Q}
name: ISS, type: CurrentSource, ports: {Np: VDD, Nn: P}
name: CL, type: Capacitor, value: CL, ports: {Np: X1, Nn: GND}
name: CL, type: Capacitor, value: CL, ports: {Np: X1, Nn: GND}
]
extrainfo:The circuit is a two-stage operational amplifier with slew rate enhancement. It features a differential input stage with PMOS transistors M9 and M10, and NMOS transistors M11 and M12. The output stage is enhanced by additional capacitors CL for improved slew rate. The current source ISS provides biasing for the differential pair.

Figure 9.80 Two-stage op amp with slew enhancement.
of the circuit in Fig. 9.79(d), where the available current is a multiple of the tail currents and cannot be raised further "upon demand."

We return to this two-stage op amp in Chapter 10 and analyze its slew rate in the presence of frequency compensation.

### 9.11 ■ Power Supply Rejection

As with other analog circuits, op amps are often supplied from noisy lines and must therefore "reject" the noise adequately. For this reason, it is important to understand how noise on the supply manifests itself at the output of an op amp.

Let us consider the simple op amp shown in Fig. 9.81, assuming that the supply voltage varies slowly. If the circuit is perfectly symmetric, $V_{\text {out }}=V_{X}$. Since the diode-connected device "clamps" node $X$ to $V_{D D}, V_{X}$ and hence $V_{\text {out }}$ experience approximately the same change as does $V_{D D}$. In other words, the gain from $V_{D D}$ to $V_{\text {out }}$ is close to unity. The power supply rejection ratio (PSRR) is defined as the gain from the input to the output divided by the gain from the supply to the output. At low frequencies:

$$
\begin{equation*}
\operatorname{PSRR} \approx g_{m N}\left(r_{O P} \| r_{O N}\right) \tag{9.81}
\end{equation*}
$$

image_name:Figure 9.81
description:
[
name: M1, type: NMOS, ports: {S: P, D: X, G: Vin1}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: Vin2}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit is a differential amplifier with an active current mirror load. It uses NMOS transistors M1 and M2 for differential input and PMOS transistors M3 and M4 as active loads. The current source Iss provides biasing.

Figure 9.81 Supply rejection of differential pair with active current mirror.

Example 9.25
Calculate the low-frequency PSRR of the feedback circuit shown in Fig. 9.82(a).
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: P, D: X, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: Vout, G: X}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: P}
name: C2, type: Capacitor, value: C2, ports: {Np: P, Nn: GND}
name: VDD, type: VoltageSource, value: VDD, ports: {Np: VDD, Nn: GND}
name: 1/gm3, type: Resistor, value: 1/gm3, ports: {N1: VDD, N2: X}
name: ro4, type: Resistor, value: ro4, ports: {N1: Vout, N2: X}
name: gm1V1, type: VoltageControlledCurrentSource, ports: {Np: X, Nn: X1}
name: gm2V2, type: VoltageControlledCurrentSource, ports: {Np: Vout, Nn: P}
name: gm4V4, type: VoltageControlledCurrentSource, ports: {Np: Vout, Nn: X}
name: V1, type: VoltageSource, value: V1, ports: {Np: X1, Nn: GND}
name: V2, type: VoltageSource, value: V2, ports: {Np: P, Nn: GND}
]
extrainfo:The circuit diagram (a) is a differential amplifier with an active current mirror load. NMOS transistors M1 and M2 are used for differential input, while PMOS transistors M3 and M4 serve as active loads. The current source Iss provides biasing. Capacitors C1 and C2 are connected at the output and intermediate nodes to stabilize the circuit.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: X1, D: X, G: V1}
name: M2, type: NMOS, ports: {S: X1, D: Vout, G: V2}
name: M3, type: PMOS, ports: {S: VDD, D: X, G: X}
name: M4, type: PMOS, ports: {S: VDD, D: Vout, G: X}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: P}
name: C2, type: Capacitor, value: C2, ports: {Np: P, Nn: GND}
name: Iss, type: CurrentSource, ports: {Np: X1, Nn: GND}
name: VDD, type: VoltageSource, ports: {Np: VDD, Nn: GND}
name: 1/gm3, type: Resistor, value: 1/gm3, ports: {N1: VDD, N2: X}
name: gm1V1, type: CurrentSource, ports: {Np: X1, Nn: GND}
name: gm2V2, type: CurrentSource, ports: {Np: X1, Nn: Vout}
name: gm4V4, type: CurrentSource, ports: {Np: Vout, Nn: VDD}
name: ro4, type: Resistor, value: ro4, ports: {N1: Vout, N2: VDD}
name: V1, type: VoltageSource, ports: {Np: X1, Nn: GND}
name: V2, type: VoltageSource, ports: {Np: Vout, Nn: P}
]
extrainfo:The circuit is a feedback differential amplifier with an active current mirror load. It uses NMOS transistors M1 and M2 for differential input and PMOS transistors M3 and M4 as active loads. The capacitors C1 and C2 form part of the feedback network, and the current sources gm1V1, gm2V2, and gm4V4 represent transconductance effects. The resistors 1/gm3 and ro4 are part of the biasing and output impedance networks, respectively.

Figure 9.82

#### Solution

From the foregoing analysis, we may surmise that a change $\Delta V$ in $V_{D D}$ appears unattenuated at the output. But, we should note that if $V_{\text {out }}$ changes, so do $V_{P}$ and $I_{D 2}$, thereby opposing the change. Using Fig. 9.82(b) and neglecting channel-length modulation in $M_{1}-M_{3}$ for simplicity, we can write

$$
\begin{equation*}
V_{\text {out }} \frac{C_{1}}{C_{1}+C_{2}}-V_{2}=-V_{1} \tag{9.82}
\end{equation*}
$$

and $g_{m 1} V_{1}+g_{m 2} V_{2}=0$. Thus, if the circuit is symmetric,

$$
\begin{equation*}
V_{2}=\frac{V_{\text {out }}}{2} \frac{C_{1}}{C_{1}+C_{2}} \tag{9.83}
\end{equation*}
$$

We also have

$$
\begin{equation*}
-\frac{g_{m 1} V_{1}}{g_{m 3}} g_{m 4}-\frac{V_{D D}-V_{\text {out }}}{r_{O 4}}+g_{m 2} V_{2}=0 \tag{9.84}
\end{equation*}
$$

It follows that

$$
\begin{equation*}
\frac{V_{\text {out }}}{V_{D D}}=\frac{1}{g_{m 2} r_{O 4} \frac{C_{1}}{C_{1}+C_{2}}+1} \tag{9.85}
\end{equation*}
$$

Thus,

$$
\begin{align*}
\operatorname{PSRR} & \approx\left(1+\frac{C_{2}}{C_{1}}\right)\left(g_{m 2} r_{O 4} \frac{C_{1}}{C_{1}+C_{2}}+1\right)  \tag{9.86}\\
& \approx g_{m 2} r_{O 4} \tag{9.87}
\end{align*}
$$

The denominator of Eq. (9.85) looks like one plus a loop gain. Is that true? Let us set the main input in Fig. 9.82(a) to zero and view the path from $V_{D D}$ to $V_{\text {out }}$ as an amplifier [Fig. 9.83(a)], omitting $C_{1}$ and $C_{2}$. In this case, the gain, $\partial V_{o u t} / \partial V_{D D}$, is equal to unity. Now, as depicted in Fig. 9.83(b), we sense $V_{\text {out }}$ by means of a capacitive divider and return the result to some node within the amplifier. We expect the gain to drop by one plus the loop gain associated with the feedback loop. Indeed, this loop gain is equal to $\left[C_{1} /\left(C_{1}+C_{2}\right)\right] g_{m 2} r_{O 4}$ if channel-length modulation is neglected for $M_{1}-M_{3}$. We therefore recognize that feedback reduces $\partial V_{\text {out }} / \partial V_{D D}$ and $\partial V_{\text {out }} / \partial V_{\text {in }}$ by the same factor, leaving the PSRR relatively constant.
image_name:(a)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: VDD, InN: GND, OutP: Vout, OutN: ', Vdd: VDD, -Vdd: GND}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: X1}
name: C2, type: Capacitor, value: C2, ports: {Np: X1, Nn: GND'}
]
extrainfo:The circuit diagram (a) shows an op-amp powered by VDD with the output labeled as Vout. Diagram (b) includes feedback with capacitors C1 and C2 forming a feedback network connected to the op-amp.
image_name:(b)
description:
[
name: A1, type: OpAmp, value: A1, ports: {InP: VDD, InN: GND, OutP: Vout, OutN: ', Vdd: VDD, -Vdd: GND}
name: C1, type: Capacitor, value: C1, ports: {Np: Vout, Nn: X1}
name: C2, type: Capacitor, value: C2, ports: {Np: X1, Nn: GND'}
]
extrainfo:The circuit is a feedback loop with an operational amplifier (A1) connected to capacitors C1 and C2. The feedback path goes from the output (Vout) through C1 and C2 to ground, with node X1 as an intermediate point.

Figure 9.83 Equivalent circuits for path from $V_{D D}$ to output.

### 9.12 ■ Noise in Op Amps

In low-noise applications, the input-referred noise of op amps becomes critical. We now extend the noise analysis of differential amplifiers in Chapter 7 to more sophisticated topologies. With many transistors in an op amp, it may seem difficult to intuitively identify the dominant sources of noise. A simple rule for inspection is to (mentally) change the gate voltage of each transistor by a small amount and predict the effect at the output.

Let us first consider the telescopic op amp shown in Fig. 9.84. At relatively low frequencies, the cascode devices contribute negligible noise, leaving $M_{1}-M_{2}$ and $M_{7}-M_{8}$ as the primary noise sources. The input-referred noise voltage per unit bandwidth is therefore similar to that in Fig. 7.59(a) and given by

$$
\begin{equation*}
\overline{V_{n}^{2}}=4 k T\left(2 \frac{\gamma}{g_{m 1,2}}+2 \frac{\gamma g_{m 7,8}}{g_{m 1,2}^{2}}\right)+2 \frac{K_{N}}{(W L)_{1,2} C_{o x} f}+2 \frac{K_{P}}{(W L)_{7,8} C_{o x} f} \frac{g_{m 7,8}^{2}}{g_{m 1,2}^{2}} \tag{9.88}
\end{equation*}
$$

where $K_{N}$ and $K_{P}$ denote the $1 / f$ noise coefficients of NMOS and PMOS devices, respectively.
image_name:Figure 9.84 Noise in a telescopic op amp.
description:
[
name: M1, type: NMOS, ports: {S: P, D: Voutp, G: Vip}
name: M2, type: NMOS, ports: {S: P, D: Voutn, G: Vin}
name: M3, type: NMOS, ports: {S: Vb1, D: Voutp, G: Vb1}
name: M4, type: NMOS, ports: {S: Vb1, D: Voutn, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: Voutp, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Voutn, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: Vb2, G: Vb3}
name: M8, type: PMOS, ports: {S: VDD, D: Vb2, G: Vb3}
name: Iss, type: CurrentSource, ports: {Np: P, Nn: GND}
]
extrainfo:This is a telescopic op-amp circuit with differential inputs Vip and Vin, and outputs Voutp and Voutn. It contains NMOS transistors M1-M4 and PMOS transistors M5-M8, with a current source Iss for biasing.

Figure 9.84 Noise in a telescopic op amp.

Next, we study the noise behavior of the folded-cascode op amp of Fig. 9.85(a), considering only thermal noise at this point. Again, the noise of the cascode devices is negligible at low frequencies, leaving $M_{1}-M_{2}, M_{7}-M_{8}$, and $M_{9}-M_{10}$ as potentially significant sources. Do both pairs $M_{7}-M_{8}$ and $M_{9}-M_{10}$ contribute noise? Using our simple rule, we change the gate voltage of $M_{7}$ by a small amount [Fig. 9.85(b)], noting that the output indeed changes considerably. The same observation applies to $M_{8}-$ $M_{10}$ as well. To determine the input-referred thermal noise, we first refer the noise of $M_{7}-M_{8}$ to the
image_name:(a)
description:
[
name: M1, type: NMOS, ports: {S: GND, D: X1, G: Vip}
name: M2, type: NMOS, ports: {S: GND, D: Vin, G: Vin}
name: M3, type: NMOS, ports: {S: GND, D: Voutp, G: Vb1}
name: M4, type: NMOS, ports: {S: GND, D: Voutn, G: Vb1}
name: M5, type: PMOS, ports: {S: VDD, D: Voutp, G: Vb2}
name: M6, type: PMOS, ports: {S: VDD, D: Voutn, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: X2, G: Vb3}
name: M8, type: PMOS, ports: {S: VDD, D: X3, G: Vb3}
name: M9, type: NMOS, ports: {S: GND, D: Voutp, G: Vb4}
name: M10, type: NMOS, ports: {S: GND, D: Voutn, G: Vb4}
name: M11, type: NMOS, ports: {S: GND, D: X1, G: Vb5}
]
extrainfo:The circuit is a folded-cascode operational amplifier with differential input and differential output. It uses PMOS transistors (M5, M6, M7, M8) for the cascode configuration and NMOS transistors (M1, M2, M3, M4, M9, M10, M11) for the input and current mirror stages. The bias voltages are Vb1, Vb2, Vb3, Vb4, and Vb5.
image_name:(b)
description:
[
name: M1, type: NMOS, ports: {S: x1, D: x2, G: Vip}
name: M2, type: NMOS, ports: {S: x1, D: x3, G: Vin}
name: M3, type: NMOS, ports: {S: GND, D: Voutp, G: Vb1}
name: M4, type: NMOS, ports: {S: GND, D: Voutn, G: Vb1}
name: M5, type: PMOS, ports: {S: x2, D: Voutp, G: Vb2}
name: M6, type: PMOS, ports: {S: x3, D: Voutn, G: Vb2}
name: M7, type: PMOS, ports: {S: VDD, D: x2, G: Vb3}
name: M8, type: PMOS, ports: {S: VDD, D: x3, G: Vb3}
name: M9, type: NMOS, ports: {S: GND, D: Voutp, G: Vb4}
name: M10, type: NMOS, ports: {S: GND, D: Voutn, G: Vb4}
name: M11, type: NMOS, ports: {S: GND, D: x1, G: Vb5}
]
extrainfo:The circuit is a folded-cascode operational amplifier. It includes differential input pairs (M1, M2) and current mirrors (M5, M6, M7, M8) for biasing. The output stage consists of transistors M3, M4, M9, and M10. The circuit features bias voltages Vb1, Vb2, Vb3, Vb4, and Vb5 for different transistor gates.

Figure 9.85 Noise in a folded-cascode op amp.
output:

$$
\begin{equation*}
\left.\overline{V_{n, \text { out }}^{2}}\right|_{M 7,8}=2\left(4 k T \frac{\gamma}{g_{m 7,8}} g_{m 7,8}^{2} R_{\text {out }}^{2}\right) \tag{9.89}
\end{equation*}
$$

where the factor 2 accounts for the (uncorrelated) noise of $M_{7}$ and $M_{8}$ and $R_{o u t}$ denotes the open-loop output resistance of the op amp. Similarly,

$$
\begin{equation*}
\left.\overline{V_{n, \text { out }}^{2}}\right|_{M 9,10}=2\left(4 k T \frac{\gamma}{g_{m 9,10}} g_{m 9,10}^{2} R_{\text {out }}^{2}\right) \tag{9.90}
\end{equation*}
$$

Dividing these quantities by $g_{m 1,2}^{2} R_{\text {out }}^{2}$ and adding the contribution of $M_{1}-M_{2}$, we obtain the overall noise:

$$
\begin{equation*}
\overline{V_{n, i n t}^{2}}=8 k T\left(\frac{\gamma}{g_{m 1,2}}+\gamma \frac{g_{m 7,8}}{g_{m 1,2}^{2}}+\gamma \frac{g_{m 9,10}}{g_{m 1,2}^{2}}\right) \tag{9.91}
\end{equation*}
$$

The effect of flicker noise can be included in a similar manner (Problem 9.15). Note that the foldedcascode topology potentially suffers from greater noise than its telescopic counterpart. In applications
where flicker noise is critical, we opt for a PMOS-input op amp as PMOS transistors typically exhibit less flicker noise than do NMOS devices.

As observed for the differential amplifiers in Chapter 7, the noise contribution of the PMOS and NMOS current sources increases in proportion to their transconductance. This trend results in a tradeoff between output voltage swings and input-referred noise: for a given current, as implied by $g_{m}=$ $2 I_{D} /\left(V_{G S}-V_{T H}\right)$, if the overdrive voltage of the current sources is minimized to allow large swings, then their transconductance is maximized.
image_name:Figure 9.86 Noise in a two-stage op amp
description:
[
name: M1, type: NMOS, ports: {S: p, D: x1, G: Vin}
name: M2, type: NMOS, ports: {S: p, D: x2, G: Vip}
name: M3, type: PMOS, ports: {S: VDD, D: x1, G: Vb}
name: M4, type: PMOS, ports: {S: VDD, D: x2, G: Vb}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1, G: x1}
name: M6, type: PMOS, ports: {S: VDD, D: Vout2, G: x2}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vb}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vb}
name: Iss, type: CurrentSource, ports: {Np: VDD, Nn: p}
]
extrainfo:This is a two-stage operational amplifier circuit. The first stage is a differential amplifier formed by M1 and M2, with active loads M3 and M4. The second stage consists of a common-source amplifier with active loads M5 and M6. The current source Iss provides biasing for the differential pair. The circuit uses PMOS transistors for the current mirrors and NMOS transistors for the differential pair and output stage.

Figure 9.86 Noise in a two-stage op amp.
As another case, we calculate the input-referred thermal noise of the two-stage op amp shown in Fig. 9.86. Beginning with the second stage, we note that the noise current of $M_{5}$ and $M_{7}$ flows through $r_{O 5} \| r_{O 7}$. Dividing the resulting output noise voltage by the total gain, $g_{m 1}\left(r_{O 1} \| r_{O 3}\right) \times g_{m 5}\left(r_{O 5} \| r_{O 7}\right)$, and doubling the power, we obtain the input-referred contribution of $M_{5}-M_{8}$ :

$$
\begin{align*}
\left.\overline{V_{n}^{2}}\right|_{M 5-8} & =2 \times 4 k T \gamma\left(g_{m 5}+g_{m 7}\right)\left(r_{O 5} \| r_{O 7}\right)^{2} \frac{1}{g_{m 1}^{2}\left(r_{O 1} \| r_{O 3}\right)^{2} g_{m 5}^{2}\left(r_{O 5} \| r_{O 7}\right)^{2}}  \tag{9.92}\\
& =8 k T \gamma \frac{g_{m 5}+g_{m 7}}{g_{m 1}^{2} g_{m 5}^{2}\left(r_{O 1} \| r_{O 3}\right)^{2}} \tag{9.93}
\end{align*}
$$

The noise due to $M_{1}-M_{4}$ is simply equal to

$$
\begin{equation*}
\left.\overline{V_{n}^{2}}\right|_{M 1-4}=2 \times 4 k T \gamma \frac{g_{m 1}+g_{m 3}}{g_{m 1}^{2}} \tag{9.94}
\end{equation*}
$$

It follows that

$$
\begin{equation*}
\overline{V_{n, t o t}^{2}}=8 k T \gamma \frac{1}{g_{m 1}^{2}}\left[g_{m 1}+g_{m 3}+\frac{g_{m 5}+g_{m 7}}{g_{m 5}^{2}\left(r_{O 1} \| r_{O 3}\right)^{2}}\right] \tag{9.95}
\end{equation*}
$$

Note that the noise resulting from the second stage is usually negligible because it is divided by the gain of the first stage when referred to the main input.

#### Example 9.26

A simple amplifier is constructed as shown in Fig. 9.87. Note that the first stage incorporates diode-connected—rather than current-source-loads. Assuming that all of the transistors are in saturation and $(W / L)_{1,2}=50 / 0.6,(W / L)_{3,4}=$ 10/0.6, $(W / L)_{5,6}=20 / 0.6$, and $(W / L)_{7,8}=56 / 0.6$, calculate the input-referred noise voltage if $\mu_{n} C_{o x}=$ $75 \mu \mathrm{~A} / \mathrm{V}^{2}, \mu_{p} C_{o x}=30 \mu \mathrm{~A} / \mathrm{V}^{2}$, and $\gamma=2 / 3$.
image_name:Figure 9.87
description:
[
name: M1, type: NMOS, ports: {S: P, D: X1, G: Vin}
name: M2, type: NMOS, ports: {S: P, D: X2, G: Vin}
name: M3, type: PMOS, ports: {S: VDD, D: X1, G: X1}
name: M4, type: PMOS, ports: {S: VDD, D: X2, G: X2}
name: M5, type: PMOS, ports: {S: VDD, D: Vout1, G: X1}
name: M6, type: PMOS, ports: {S: VDD, D: Vout2, G: X2}
name: M7, type: NMOS, ports: {S: GND, D: Vout1, G: Vb}
name: M8, type: NMOS, ports: {S: GND, D: Vout2, G: Vb}
name: Iss, type: CurrentSource, value: 0.5 mA, ports: {Np: VDD, Nn: P}
]
extrainfo:The circuit is a simple amplifier with diode-connected loads in the first stage. It features two stages with NMOS transistors M1 and M2 forming the differential pair, and PMOS transistors M3 and M4 as diode-connected loads. The second stage includes PMOS transistors M5 and M6 as load transistors, and NMOS transistors M7 and M8 as current sinks. The circuit is biased with a current source Iss of 0.5 mA.

Figure 9.87

#### Solution

We first calculate the small-signal gain of the first stage:

$$
\begin{align*}
A_{v 1} & \approx \frac{g_{m 1}}{g_{m 3}}  \tag{9.96}\\
& =\sqrt{\frac{50 \times 75}{10 \times 30}}  \tag{9.97}\\
& \approx 3.54 \tag{9.98}
\end{align*}
$$

The noise of $M_{5}$ and $M_{7}$ referred to the gate of $M_{5}$ is equal to $4 k T(2 / 3)\left(g_{m 5}+g_{m 7}\right) / g_{m 5}^{2}=2.87 \times 10^{-17} \mathrm{~V}^{2} / \mathrm{Hz}$, which is divided by $A_{v 1}^{2}$ when referred to the main input: $\left.\overline{V_{n}^{2}}\right|_{M 5,7}=2.29 \times 10^{-18} \mathrm{~V}^{2} / \mathrm{Hz}$. Transistors $M_{1}$ and $M_{3}$ produce an input-referred noise of $\left.\overline{V_{n}^{2}}\right|_{M 1,3}=(8 k T / 3)\left(g_{m 3}+g_{m 1}\right) / g_{m 1}^{2}=1.10 \times 10^{-17} \mathrm{~V}^{2} / \mathrm{Hz}$. Thus, the total input-referred noise equals

$$
\begin{align*}
\overline{V_{n, i n}^{2}} & =2\left(2.29 \times 10^{-18}+1.10 \times 10^{-17}\right)  \tag{9.99}\\
& =2.66 \times 10^{-17} \mathrm{~V}^{2} / \mathrm{Hz} \tag{9.100}
\end{align*}
$$

where the factor of 2 accounts for the noise produced by both odd-numbered and even-numbered transistors in the circuit. This value corresponds to an input noise voltage of $5.16 \mathrm{nV} / \sqrt{\mathrm{Hz}}$.

The noise-power trade-off described in Chapter 7 is present in op amps as well. Specifically, the devices and bias currents in an op amp can be linearly scaled so as to trade power consumption for noise. For example, if all of the transistor widths and $I_{S S}$ in Fig. 9.87 are halved, then so is the power, while $\overline{V_{n, i n}^{2}}$ is doubled and the voltage gain and swings remain unchanged. This simple scaling can be applied to all of the op amps studied in this chapter. We exploit this principle in the nanometer op amps designed in Chapter 11.
